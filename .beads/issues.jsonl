{"id":"migrate-egghead-00a","title":"Modernize tooling: bun, oxlint, biome","description":"Align with Jared Palmer's fast stack:\n- bun (replace tsx/node)\n- oxlint (replace eslint) \n- biome (formatting)\n- turbopack (already using via Next.js)\n\nCurrent: tsx, vitest, eslint\nTarget: bun, vitest (or bun test), oxlint, biome\n\nLow priority - tooling works, but speed gains are real.","status":"in_progress","priority":3,"issue_type":"chore","created_at":"2025-12-13T09:39:17.543528-08:00","updated_at":"2025-12-13T09:40:17.72783-08:00"}
{"id":"migrate-egghead-04y","title":"Auth Cutover Runbook","description":"Explicit auth cutover strategy. Users must be able to log in seamlessly during and after migration.\n\nKey considerations:\n- OAuth tokens (GitHub, Discord) need re-linking flow\n- Session tokens in flight during cutover\n- OAuth-only users (never set password) need special handling\n- Password reset email campaign timing\n- Support playbook for locked-out users","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:53:25.98898-08:00","updated_at":"2025-12-12T09:26:03.788608-08:00","closed_at":"2025-12-12T09:26:03.788608-08:00"}
{"id":"migrate-egghead-04y.1","title":"Build OAuth provider re-linking flow (GitHub, Discord)","description":"## Context\n\nAfter user migration, users will need to re-link their OAuth providers (GitHub, potentially Discord) because:\n- Rails stores OAuth data in `users.provider` and `users.uid` fields (single provider per user)\n- Coursebuilder uses NextAuth's `Account` table (multiple providers per user)\n- We cannot migrate OAuth tokens (they're session-bound and expire)\n- Users must grant fresh OAuth permissions to the new Coursebuilder app\n\n**Rails OAuth structure:**\n- Single provider: `users.provider` ('github' or 'SAML')\n- Single UID: `users.uid` (GitHub user ID)\n- Handled by Devise + Omniauth\n- GitHub OAuth config in `config/initializers/devise.rb` (line 231)\n- Callback flow in `app/controllers/users/omniauth_callbacks_controller.rb`\n\n**Coursebuilder OAuth structure:**\n- Multiple providers via `Account` table (NextAuth standard)\n- Composite PK: `(provider, providerAccountId)`\n- Supports: GitHub, Discord, Twitter, email (egghead provider)\n- Config in `course-builder/apps/egghead/src/server/auth.ts`\n- Account linking event fires on each provider connection\n\n## Files to Reference\n\n**Rails (read-only - understand legacy flow):**\n- `egghead-rails/app/models/user.rb` (lines 280-287: `update_from_omniauth`)\n- `egghead-rails/app/models/omniauth_user.rb` (entire file - find_or_create logic)\n- `egghead-rails/app/controllers/users/omniauth_callbacks_controller.rb` (GitHub callback)\n- `egghead-rails/config/initializers/devise.rb` (line 231: GitHub OAuth config)\n\n**Coursebuilder (implementation target):**\n- `course-builder/apps/egghead/src/server/auth.ts` (lines 61-63: linkAccount event, lines 116-121: providers array)\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/auth/accounts.ts` (Account schema)\n- `course-builder/apps/egghead/src/app/login/page.tsx` (or create new re-link flow page)\n\n**Reference implementations (other CB apps with Discord):**\n- `course-builder/apps/go-local-first/src/server/auth.ts` (Discord + GitHub example, token refresh pattern lines 142-175)\n- `course-builder/apps/go-local-first/src/inngest/functions/discord/discord-account-linked.ts` (post-link automation)\n\n## Implementation Details\n\n### 1. **Create OAuth Re-Linking UI** (HIGH PRIORITY)\n**Component**: `apps/egghead/src/app/account/oauth-providers.tsx`\n- List currently linked providers (query `Account` table by userId)\n- Show \"Connect GitHub\" / \"Connect Discord\" buttons for unlinked providers\n- Display provider connection status (connected date, email from provider)\n- Allow unlinking (with confirmation)\n\n**Pattern to follow:**\n```typescript\n// Query user's accounts\nconst userAccounts = await db.query.accounts.findMany({\n  where: eq(accounts.userId, user.id)\n})\n\n// Determine which providers are missing\nconst linkedProviders = new Set(userAccounts.map(a =\u003e a.provider))\nconst availableProviders = ['github', 'discord', 'egghead']\nconst unllinkedProviders = availableProviders.filter(p =\u003e !linkedProviders.has(p))\n```\n\n### 2. **Migration Banner/Prompt**\n**Component**: `apps/egghead/src/components/migration-oauth-prompt.tsx`\n- Show banner to users who:\n  - Migrated from Rails (`User.fields.migratedFromRails === true`)\n  - Have no GitHub `Account` record\n  - Previously had `users.provider = 'github'` in Rails (store in migration metadata)\n- Message: \"Please reconnect your GitHub account to continue accessing egghead\"\n- CTA button ‚Üí OAuth linking flow\n- Dismissible but persistent until linked\n\n### 3. **Handle Account Linking Events**\n**File**: `course-builder/apps/egghead/src/server/auth.ts` (extend lines 61-63)\n\nCurrent linkAccount event logs only. Extend to:\n```typescript\nlinkAccount: async ({ account, user, profile }) =\u003e {\n  console.log('linkAccount', { account, user, profile })\n  \n  // Track successful re-link for migrated users\n  const dbUser = await db.query.users.findFirst({\n    where: eq(users.id, user.id)\n  })\n  \n  if (dbUser?.fields?.migratedFromRails \u0026\u0026 !dbUser?.fields?.oauthRelinked) {\n    await db.update(users)\n      .set({\n        fields: {\n          ...dbUser.fields,\n          oauthRelinked: true,\n          oauthRelinkedAt: new Date().toISOString(),\n          oauthRelinkedProvider: account.provider\n        }\n      })\n      .where(eq(users.id, user.id))\n    \n    // Optional: trigger Inngest event for analytics\n    await inngest.send({\n      name: 'user.oauth.relinked',\n      data: { userId: user.id, provider: account.provider }\n    })\n  }\n}\n```\n\n### 4. **GitHub OAuth App Registration**\n**Critical**: Coursebuilder needs its own GitHub OAuth app (separate from Rails)\n- Create new GitHub OAuth App at https://github.com/settings/developers\n- Callback URL: `https://egghead.io/api/auth/callback/github`\n- Set `GITHUB_CLIENT_ID` and `GITHUB_CLIENT_SECRET` in `.env`\n- Scopes: `user:email` (same as Rails - see devise.rb line 231)\n\n### 5. **Discord Support (OPTIONAL - Phase 2)**\nRails has no Discord integration. If adding Discord:\n- Follow `go-local-first` pattern (see references)\n- Add DiscordProvider to `auth.ts` providers array\n- Set up Discord Bot for role management (if needed for paid tiers)\n- Create `DISCORD_CLIENT_ID` and `DISCORD_CLIENT_SECRET` env vars\n\n### 6. **Email Matching During Re-Link**\nNextAuth `allowDangerousEmailAccountLinking: true` is already enabled (auth.ts line 120)\n- This auto-links OAuth providers to existing users if email matches\n- SAFE in this context because users are already authenticated when re-linking\n- Rails did similar matching in `OmniauthUser.find_or_create` (omniauth_user.rb line 7)\n\n## Acceptance Criteria\n\n- [ ] OAuth providers page shows linked/unlinked status for GitHub, Discord, email\n- [ ] \"Connect GitHub\" button initiates NextAuth OAuth flow\n- [ ] Successful GitHub link creates `Account` record with `provider='github'`\n- [ ] Migration banner appears ONLY for migrated users without GitHub linked\n- [ ] Banner dismisses permanently after successful GitHub link\n- [ ] `linkAccount` event updates `User.fields.oauthRelinked` flag\n- [ ] Email matching works: linking GitHub with same email as User.email doesn't create duplicate\n- [ ] User can unlink OAuth provider (deletes `Account` record)\n- [ ] Analytics/logging: track OAuth re-link success rate for migrated users\n\n## Dependencies\n\n**MUST BE COMPLETED FIRST:**\n- migrate-egghead-04y: User/Account migration pipeline (data must exist before OAuth can link)\n- GitHub OAuth app registration (cannot test without valid client ID/secret)\n\n**NICE TO HAVE (can proceed without):**\n- Discord OAuth app setup (optional provider)\n- Inngest events for analytics (can log to console initially)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:26.023733-08:00","updated_at":"2025-12-11T11:04:36.449662-08:00","dependencies":[{"issue_id":"migrate-egghead-04y.1","depends_on_id":"migrate-egghead-04y","type":"parent-child","created_at":"2025-12-11T09:53:26.02412-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-04y.2","title":"Implement session invalidation strategy for cutover","description":"## Context\n\nDuring the cutover from Rails to Coursebuilder, all active Rails sessions must be invalidated to force users to re-authenticate. This is **critical for security** because:\n\n1. **Session mechanisms differ completely:**\n   - Rails: `session_activations` table + Warden manager (Devise)\n   - Coursebuilder: NextAuth sessions (DB-backed or JWT)\n   \n2. **Authentication tokens are incompatible:**\n   - Rails: `users.authentication_token` (UUID, lines 201-203 in user.rb)\n   - Coursebuilder: NextAuth session tokens (different format, different signing)\n\n3. **Security risk if not invalidated:**\n   - Rails session cookies would be orphaned (point to non-existent Rails DB)\n   - Potential for session fixation attacks if cookies persist\n   - Users could appear \"logged in\" but with broken session state\n\n**Rails session model:**\n- Table: `session_activations` (20 sessions max per user - see model line 2)\n- Lifecycle hooks in Devise initializer (lines 259-277):\n  - `Warden::Manager.after_set_user` ‚Üí activates session\n  - `Warden::Manager.after_fetch` ‚Üí validates session still active\n  - `Warden::Manager.before_logout` ‚Üí deactivates session\n- Stored in `users.session_activations` association\n\n**Coursebuilder session model:**\n- Table: `Session` (NextAuth standard schema)\n- Fields: `sessionToken`, `userId`, `expires`\n- No explicit activation/deactivation - relies on `expires` timestamp\n- Auth config: `course-builder/apps/egghead/src/server/auth.ts`\n\n## Files to Reference\n\n**Rails (understand session lifecycle):**\n- `egghead-rails/app/models/session_activation.rb` (entire file - 30 lines)\n- `egghead-rails/app/models/user.rb` (lines 120, 165-175: session methods)\n- `egghead-rails/config/initializers/devise.rb` (lines 259-277: Warden session hooks)\n\n**Coursebuilder:**\n- `course-builder/apps/egghead/src/server/auth.ts` (NextAuth config)\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/auth/sessions.ts` (Session schema)\n- `course-builder/apps/egghead/src/db/schema.ts` (exports sessions table)\n\n**Migration scripts (to create):**\n- `scripts/cutover/invalidate-rails-sessions.ts` (NEW - pre-cutover cleanup)\n- `scripts/cutover/verify-session-state.ts` (NEW - post-cutover validation)\n\n## Implementation Details\n\n### 1. **Pre-Cutover: Invalidate All Rails Sessions**\n**When**: Final step before DNS cutover (after user data migrated, before switching traffic)\n\n**Script**: `scripts/cutover/invalidate-rails-sessions.ts`\n```typescript\nimport { db as railsDb } from '@/investigation/src/db/rails-connection'\n\nasync function invalidateAllRailsSessions() {\n  console.log('Starting Rails session invalidation...')\n  \n  // 1. Count active sessions\n  const sessionCount = await railsDb.raw(`\n    SELECT COUNT(*) as count FROM session_activations\n  `)\n  console.log(`Found ${sessionCount[0].count} active Rails sessions`)\n  \n  // 2. Delete all session_activations\n  await railsDb.raw(`TRUNCATE TABLE session_activations`)\n  \n  // 3. Optional: Clear authentication tokens (forces Doorkeeper re-auth too)\n  // This might be too aggressive - discuss before enabling\n  // await railsDb.raw(`\n  //   UPDATE users SET authentication_token = NULL\n  // `)\n  \n  console.log('‚úÖ All Rails sessions invalidated')\n}\n```\n\n**Run command**: `pnpm tsx scripts/cutover/invalidate-rails-sessions.ts`\n\n### 2. **Session Cookie Cleanup Strategy**\n\n**Problem**: Users will have stale Rails session cookies after cutover\n**Solutions** (pick one or combine):\n\n**Option A: Cookie Domain Mismatch (RECOMMENDED)**\n- Rails cookies: domain=`.egghead.io`, path=/\n- Coursebuilder cookies: domain=`egghead.io` (no leading dot)\n- Browser won't send Rails cookies to new app (different domain scope)\n- Rails cookies expire naturally after user closes browser\n\n**Option B: Explicit Cookie Clearing** (if Option A insufficient)\n- Add middleware to Coursebuilder: `middleware.ts`\n```typescript\nimport { NextResponse } from 'next/server'\nimport type { NextRequest } from 'next/server'\n\nexport function middleware(request: NextRequest) {\n  const response = NextResponse.next()\n  \n  // Clear legacy Rails session cookies\n  const railsCookieNames = [\n    '_egghead_session',\n    'auth_id', // Warden session ID\n    'remember_user_token'\n  ]\n  \n  railsCookieNames.forEach(name =\u003e {\n    if (request.cookies.has(name)) {\n      response.cookies.delete(name)\n    }\n  })\n  \n  return response\n}\n```\n\n**Option C: Show \"Please Log In Again\" Banner** (UX-focused)\n- Detect: user has old cookies but no valid NextAuth session\n- Show friendly message: \"We've upgraded egghead! Please log in again.\"\n- Clear cookies on button click\n\n### 3. **Post-Cutover: Verify Session State**\n\n**Script**: `scripts/cutover/verify-session-state.ts`\n```typescript\nimport { db } from '@/db'\n\nasync function verifySessionState() {\n  // 1. Check no Rails sessions exist (sanity check)\n  // Requires Rails DB still accessible (read-only)\n  const railsSessions = await railsDb.raw(`\n    SELECT COUNT(*) FROM session_activations\n  `)\n  if (railsSessions[0].count \u003e 0) {\n    throw new Error(`‚ö†Ô∏è Found ${railsSessions[0].count} Rails sessions still active!`)\n  }\n  \n  // 2. Check Coursebuilder sessions are being created\n  const recentSessions = await db.query.sessions.findMany({\n    where: (sessions, { gte }) =\u003e \n      gte(sessions.expires, new Date()),\n    limit: 10\n  })\n  \n  console.log(`‚úÖ Found ${recentSessions.length} active Coursebuilder sessions`)\n  \n  // 3. Track cutover analytics\n  const sessionsLast24h = await db.query.sessions.findMany({\n    where: (sessions, { gte }) =\u003e \n      gte(sessions.createdAt, new Date(Date.now() - 24 * 60 * 60 * 1000))\n  })\n  \n  console.log(`üìä Sessions created in last 24h: ${sessionsLast24h.length}`)\n}\n```\n\n### 4. **Cutover Timeline: Session Handling**\n\n**T-24 hours: Announce maintenance**\n- Email blast: \"egghead is upgrading tomorrow!\"\n- Banner on site: \"Brief maintenance window on [DATE]\"\n\n**T-1 hour: Freeze Rails writes** (if applicable)\n- Set Rails to read-only mode\n- Disable new subscription purchases\n- Show \"Maintenance in progress\" banner\n\n**T-0: Execute cutover**\n1. Run `invalidate-rails-sessions.ts` ‚úÖ\n2. Export final user data snapshot\n3. Run user migration pipeline\n4. Update DNS to point to Coursebuilder\n5. Run `verify-session-state.ts` after 1 hour\n\n**T+1 hour: Monitor session creation**\n- Watch Coursebuilder logs for auth errors\n- Track session creation rate in DB\n- Check user support tickets for login issues\n\n**T+24 hours: Cleanup**\n- Remove Rails session invalidation script (one-time use)\n- Archive Rails DB (read-only backup)\n- Document cutover learnings\n\n### 5. **Rollback Strategy**\n\nIf cutover fails and we must roll back to Rails:\n1. Revert DNS to point to Rails\n2. Rails sessions are already invalidated (acceptable - users re-login)\n3. Coursebuilder sessions are orphaned (delete them):\n   ```sql\n   TRUNCATE TABLE Session;\n   ```\n4. Users re-authenticate to whichever system is live\n\n**Key insight**: Session invalidation is **idempotent** - safe to do multiple times.\n\n### 6. **Edge Cases to Handle**\n\n**\"Remember Me\" tokens:**\n- Rails: `users.remember_created_at` + `remember_user_token` cookie\n- Coursebuilder: NextAuth handles via session expiry\n- **Action**: Clear `remember_user_token` cookies in middleware (see Option B above)\n\n**API tokens (Doorkeeper):**\n- Rails: `oauth_access_tokens` table for egghead-next frontend\n- Coursebuilder: Will use NextAuth session tokens instead\n- **Action**: Doorkeeper tokens may still work if Rails API is kept as read-only legacy service (discuss if needed)\n\n**Mobile app sessions** (if any):\n- Check if egghead has iOS/Android apps\n- If yes: coordinate app update with session invalidation\n- Likely: no mobile apps exist (web-only platform)\n\n## Acceptance Criteria\n\n- [ ] Script `invalidate-rails-sessions.ts` successfully clears all `session_activations` records\n- [ ] Script `verify-session-state.ts` confirms 0 Rails sessions post-cutover\n- [ ] Coursebuilder session creation works (users can log in via email/OAuth)\n- [ ] Legacy Rails cookies are cleared (middleware or natural expiry)\n- [ ] No \"ghost sessions\" - users can't appear logged in with broken state\n- [ ] Cutover runbook documents session invalidation timing\n- [ ] Rollback plan tested (can revert to Rails if needed)\n- [ ] Support team briefed on \"please log in again\" messaging\n- [ ] Analytics tracked: session invalidation count, post-cutover login success rate\n\n## Dependencies\n\n**MUST BE COMPLETED FIRST:**\n- migrate-egghead-04y: User/Account migration (cannot create Coursebuilder sessions without User records)\n- NextAuth session creation tested and working in staging\n\n**COORDINATED WITH:**\n- migrate-egghead-04y.1: OAuth re-linking (users will re-auth via OAuth during cutover)\n- DNS cutover plan (session invalidation happens just before DNS switch)\n\n**NO DEPENDENCIES:**\n- Can test session invalidation script on staging Rails DB independently","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:26.058007-08:00","updated_at":"2025-12-11T11:05:26.59051-08:00","dependencies":[{"issue_id":"migrate-egghead-04y.2","depends_on_id":"migrate-egghead-04y","type":"parent-child","created_at":"2025-12-11T09:53:26.058363-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-04y.3","title":"Build OAuth-only user detection and password set flow","description":"Build flow to detect OAuth-only users and prompt them to set a password.\n\n## Context\n\nMany egghead users signed up via GitHub OAuth and never set a password. When we migrate to Coursebuilder's NextAuth, they need a way to authenticate if OAuth re-linking fails.\n\n## Rails Data Analysis\n\n```sql\n-- Users with OAuth but no password\nSELECT COUNT(*) FROM users \nWHERE provider IS NOT NULL \nAND encrypted_password IS NULL;\n-- Result: ~45K users\n```\n\n## Implementation\n\n### 1. Detection Query\n```typescript\n// lib/migration/oauth-only-users.ts\nexport async function getOAuthOnlyUsers() {\n  return railsDb.query(`\n    SELECT id, email, provider, uid, first_name\n    FROM users \n    WHERE provider IS NOT NULL \n    AND (encrypted_password IS NULL OR encrypted_password = '')\n  `)\n}\n```\n\n### 2. Password Set Flow (Coursebuilder)\n```typescript\n// app/api/auth/set-password/route.ts\nexport async function POST(req: Request) {\n  const { token, password } = await req.json()\n  \n  // Verify token (sent via email)\n  const userId = await verifyPasswordSetToken(token)\n  if (!userId) return Response.json({ error: 'Invalid token' }, { status: 400 })\n  \n  // Hash and save password\n  const hashedPassword = await bcrypt.hash(password, 12)\n  await db.update(users)\n    .set({ password: hashedPassword })\n    .where(eq(users.id, userId))\n  \n  return Response.json({ success: true })\n}\n```\n\n### 3. UI Component\n```tsx\n// components/auth/set-password-form.tsx\nexport function SetPasswordForm({ token }: { token: string }) {\n  const [password, setPassword] = useState('')\n  const [confirm, setConfirm] = useState('')\n  \n  async function handleSubmit(e: FormEvent) {\n    e.preventDefault()\n    if (password !== confirm) {\n      toast.error('Passwords do not match')\n      return\n    }\n    \n    const res = await fetch('/api/auth/set-password', {\n      method: 'POST',\n      body: JSON.stringify({ token, password }),\n    })\n    \n    if (res.ok) {\n      toast.success('Password set! You can now sign in.')\n      router.push('/login')\n    }\n  }\n  \n  return (\n    \u003cform onSubmit={handleSubmit}\u003e\n      \u003cInput type=\"password\" value={password} onChange={...} placeholder=\"New password\" /\u003e\n      \u003cInput type=\"password\" value={confirm} onChange={...} placeholder=\"Confirm password\" /\u003e\n      \u003cButton type=\"submit\"\u003eSet Password\u003c/Button\u003e\n    \u003c/form\u003e\n  )\n}\n```\n\n### 4. Detection on Login Failure\n```typescript\n// In NextAuth signIn callback\nasync signIn({ user, account }) {\n  if (account?.provider === 'github') {\n    // Check if OAuth re-link failed\n    const existingUser = await db.query.users.findFirst({\n      where: eq(users.email, user.email)\n    })\n    \n    if (existingUser \u0026\u0026 !existingUser.githubId) {\n      // User exists but OAuth not linked - redirect to re-link flow\n      throw new Error('OAUTH_RELINK_REQUIRED')\n    }\n  }\n  return true\n}\n```\n\n## Files to Create\n- `apps/egghead/src/app/api/auth/set-password/route.ts`\n- `apps/egghead/src/app/(auth)/set-password/page.tsx`\n- `apps/egghead/src/components/auth/set-password-form.tsx`\n- `apps/egghead/src/lib/auth/password-set-token.ts`\n\n## Acceptance Criteria\n- [ ] OAuth-only users can request password set email\n- [ ] Token expires after 24 hours\n- [ ] Password meets minimum requirements (8+ chars)\n- [ ] User can sign in with email/password after setting\n- [ ] Flow integrates with existing NextAuth setup","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:26.091729-08:00","updated_at":"2025-12-11T12:00:42.257849-08:00","dependencies":[{"issue_id":"migrate-egghead-04y.3","depends_on_id":"migrate-egghead-04y","type":"parent-child","created_at":"2025-12-11T09:53:26.092033-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-04y.4","title":"Create password reset email campaign (timing: 48h before cutover)","description":"Send proactive email campaign to OAuth-only users 48 hours before cutover.\n\n## Context\n\n~45K users have OAuth-only accounts. We need to give them a heads-up and a way to set a password BEFORE cutover, not after they're locked out.\n\n## Email Campaign Strategy\n\n### Timing\n- **T-48h**: Send initial email to all OAuth-only users\n- **T-24h**: Send reminder to users who haven't set password\n- **T-0**: Cutover happens\n\n### Email Content\n\n```typescript\n// emails/password-set-reminder.tsx (React Email)\nexport function PasswordSetReminder({ \n  firstName, \n  email, \n  token,\n  provider \n}: Props) {\n  return (\n    \u003cHtml\u003e\n      \u003cHead /\u003e\n      \u003cBody\u003e\n        \u003cContainer\u003e\n          \u003cHeading\u003eAction Required: Set Your egghead Password\u003c/Heading\u003e\n          \n          \u003cText\u003e\n            Hey {firstName || 'there'},\n          \u003c/Text\u003e\n          \n          \u003cText\u003e\n            You've been signing into egghead with {provider}. We're upgrading \n            our authentication system, and we need you to set a password as \n            a backup sign-in method.\n          \u003c/Text\u003e\n          \n          \u003cText\u003e\n            \u003cstrong\u003eThis takes 30 seconds and ensures you won't lose access \n            to your account.\u003c/strong\u003e\n          \u003c/Text\u003e\n          \n          \u003cButton href={`https://egghead.io/set-password?token=${token}`}\u003e\n            Set Your Password Now\n          \u003c/Button\u003e\n          \n          \u003cText\u003e\n            If you don't set a password, you can still sign in with {provider}, \n            but you may need to re-authorize the connection.\n          \u003c/Text\u003e\n          \n          \u003cText\u003e\n            Questions? Reply to this email or contact support@egghead.io\n          \u003c/Text\u003e\n        \u003c/Container\u003e\n      \u003c/Body\u003e\n    \u003c/Html\u003e\n  )\n}\n```\n\n### Inngest Function\n\n```typescript\n// inngest/functions/auth/send-password-campaign.ts\nexport const sendPasswordCampaign = inngest.createFunction(\n  { id: 'send-password-campaign', concurrency: 50 },\n  { event: 'auth/password-campaign.start' },\n  async ({ step }) =\u003e {\n    // Get all OAuth-only users\n    const users = await step.run('get-oauth-users', async () =\u003e {\n      return db.query.users.findMany({\n        where: and(\n          isNotNull(users.oauthProvider),\n          isNull(users.password)\n        )\n      })\n    })\n    \n    // Send in batches\n    for (const batch of chunk(users, 100)) {\n      await step.run(`send-batch-${batch[0].id}`, async () =\u003e {\n        for (const user of batch) {\n          const token = await generatePasswordSetToken(user.id)\n          await resend.emails.send({\n            from: 'egghead \u003csupport@egghead.io\u003e',\n            to: user.email,\n            subject: 'Action Required: Set Your egghead Password',\n            react: PasswordSetReminder({\n              firstName: user.name?.split(' ')[0],\n              email: user.email,\n              token,\n              provider: user.oauthProvider,\n            }),\n          })\n        }\n      })\n      \n      // Rate limit: 100 emails per second max\n      await step.sleep('rate-limit', '1s')\n    }\n    \n    return { sent: users.length }\n  }\n)\n```\n\n### Tracking\n\n```typescript\n// Track who has set password\nawait db.update(users)\n  .set({ \n    passwordSetAt: new Date(),\n    fields: sql`JSON_SET(fields, '$.passwordSetVia', 'campaign')`\n  })\n  .where(eq(users.id, userId))\n```\n\n## Files to Create\n- `apps/egghead/src/emails/password-set-reminder.tsx`\n- `apps/egghead/src/inngest/functions/auth/send-password-campaign.ts`\n- `apps/egghead/src/lib/auth/password-set-token.ts`\n\n## Acceptance Criteria\n- [ ] Email renders correctly in major clients (Gmail, Outlook, Apple Mail)\n- [ ] Token in email is valid for 72 hours\n- [ ] Campaign can be triggered manually via Inngest dashboard\n- [ ] Progress tracked (X of Y users emailed)\n- [ ] Users who already set password are excluded from reminder\n- [ ] Unsubscribe link works (can_contact = false)","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:26.124375-08:00","updated_at":"2025-12-11T12:00:58.55197-08:00","dependencies":[{"issue_id":"migrate-egghead-04y.4","depends_on_id":"migrate-egghead-04y","type":"parent-child","created_at":"2025-12-11T09:53:26.124718-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-04y.5","title":"Write support playbook for locked-out users","description":"Create support playbook for handling locked-out users during and after cutover.\n\n## Context\n\nEven with proactive measures, some users WILL get locked out. Support needs a clear playbook to resolve issues quickly.\n\n## Support Playbook Document\n\n### Scenario 1: \"I can't sign in with GitHub/Google\"\n\n**Diagnosis:**\n1. Check if user exists in Coursebuilder: `SELECT * FROM User WHERE email = ?`\n2. Check if OAuth is linked: `SELECT * FROM Account WHERE userId = ? AND provider = 'github'`\n\n**Resolution:**\n- If user exists but OAuth not linked ‚Üí Send re-link email\n- If user doesn't exist ‚Üí Check Rails DB, may need manual migration\n- If OAuth linked but still failing ‚Üí Check GitHub/Google OAuth app status\n\n**Support Action:**\n```\n/support oauth-relink user@example.com github\n```\n\n### Scenario 2: \"I never set a password and can't sign in\"\n\n**Diagnosis:**\n1. Check if user has password: `SELECT password FROM User WHERE email = ?`\n2. Check if they received the campaign email\n\n**Resolution:**\n- Send password reset email immediately\n- If email not received, check spam/can_contact flag\n\n**Support Action:**\n```\n/support send-password-reset user@example.com\n```\n\n### Scenario 3: \"My subscription is gone\"\n\n**Diagnosis:**\n1. Check Coursebuilder: `SELECT * FROM Subscription WHERE userId = ?`\n2. Check Rails: `SELECT * FROM account_subscriptions WHERE account_id IN (SELECT account_id FROM account_users WHERE user_id = ?)`\n\n**Resolution:**\n- If exists in Rails but not CB ‚Üí Manual migration needed\n- If exists in both ‚Üí Check entitlement sync\n- If doesn't exist ‚Üí Check Stripe directly\n\n**Support Action:**\n```\n/support sync-subscription user@example.com\n```\n\n### Scenario 4: \"My progress is missing\"\n\n**Diagnosis:**\n1. Check CB: `SELECT COUNT(*) FROM LessonProgress WHERE userId = ?`\n2. Check Rails: `SELECT COUNT(*) FROM lesson_progresses WHERE user_id = ?`\n\n**Resolution:**\n- If count mismatch ‚Üí Trigger progress re-sync\n- If both empty ‚Üí User may have cleared browser, check by lesson\n\n**Support Action:**\n```\n/support sync-progress user@example.com\n```\n\n## Front Plugin Actions\n\nAdd these quick actions to the Front support plugin:\n\n```typescript\n// Support plugin actions\nconst supportActions = {\n  'oauth-relink': async (email: string, provider: string) =\u003e {\n    const user = await getUserByEmail(email)\n    const token = await generateOAuthRelinkToken(user.id, provider)\n    await sendOAuthRelinkEmail(user, provider, token)\n    return `Sent ${provider} re-link email to ${email}`\n  },\n  \n  'send-password-reset': async (email: string) =\u003e {\n    await sendPasswordResetEmail(email)\n    return `Sent password reset to ${email}`\n  },\n  \n  'sync-subscription': async (email: string) =\u003e {\n    const user = await getUserByEmail(email)\n    await inngest.send({ \n      name: 'migration/sync-user-subscription',\n      data: { userId: user.id }\n    })\n    return `Triggered subscription sync for ${email}`\n  },\n  \n  'sync-progress': async (email: string) =\u003e {\n    const user = await getUserByEmail(email)\n    await inngest.send({\n      name: 'migration/sync-user-progress', \n      data: { userId: user.id }\n    })\n    return `Triggered progress sync for ${email}`\n  },\n}\n```\n\n## Escalation Path\n\n1. **Tier 1**: Use playbook actions (90% of cases)\n2. **Tier 2**: Manual DB investigation (9% of cases)\n3. **Tier 3**: Engineering escalation (1% of cases)\n\n## Files to Create\n- `docs/support/AUTH_CUTOVER_PLAYBOOK.md`\n- `apps/egghead/src/lib/support/actions.ts`\n- Update Front plugin with new actions\n\n## Acceptance Criteria\n- [ ] Playbook covers all common scenarios\n- [ ] Support team trained on playbook (walkthrough session)\n- [ ] Front plugin actions work in test environment\n- [ ] Escalation path documented with contact info\n- [ ] Metrics: track resolution time by scenario type","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:26.155584-08:00","updated_at":"2025-12-11T12:01:14.551026-08:00","dependencies":[{"issue_id":"migrate-egghead-04y.5","depends_on_id":"migrate-egghead-04y","type":"parent-child","created_at":"2025-12-11T09:53:26.15594-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-04y.6","title":"Build auth status dashboard (monitor login success rate)","description":"Build real-time dashboard to monitor auth health during cutover.\n\n## Context\n\nDuring cutover, we need visibility into auth success/failure rates to catch issues immediately.\n\n## Dashboard Requirements\n\n### Key Metrics (Real-time)\n1. **Login Success Rate** - % of login attempts that succeed (target: \u003e99%)\n2. **OAuth Re-link Rate** - % of OAuth users successfully re-linked\n3. **Password Reset Requests** - Spike indicates problems\n4. **Support Ticket Volume** - Auth-related tickets\n\n### Data Sources\n\n```typescript\n// Inngest events to track\nconst authEvents = [\n  'auth/login.success',\n  'auth/login.failure',\n  'auth/oauth.relink.success',\n  'auth/oauth.relink.failure',\n  'auth/password.reset.requested',\n  'auth/password.set.success',\n]\n```\n\n### Implementation\n\n#### 1. Event Logging (Inngest)\n```typescript\n// middleware/auth-telemetry.ts\nexport async function logAuthEvent(\n  event: 'login' | 'oauth_relink' | 'password_reset',\n  status: 'success' | 'failure',\n  metadata: Record\u003cstring, any\u003e\n) {\n  await inngest.send({\n    name: `auth/${event}.${status}`,\n    data: {\n      timestamp: Date.now(),\n      ...metadata,\n    }\n  })\n  \n  // Also increment Redis counter for real-time\n  await redis.incr(`auth:${event}:${status}:${getHourBucket()}`)\n}\n```\n\n#### 2. Dashboard API\n```typescript\n// app/api/admin/auth-metrics/route.ts\nexport async function GET() {\n  const hour = getHourBucket()\n  \n  const [\n    loginSuccess,\n    loginFailure,\n    oauthRelinkSuccess,\n    oauthRelinkFailure,\n    passwordResets,\n  ] = await Promise.all([\n    redis.get(`auth:login:success:${hour}`),\n    redis.get(`auth:login:failure:${hour}`),\n    redis.get(`auth:oauth_relink:success:${hour}`),\n    redis.get(`auth:oauth_relink:failure:${hour}`),\n    redis.get(`auth:password_reset:requested:${hour}`),\n  ])\n  \n  const loginTotal = (loginSuccess || 0) + (loginFailure || 0)\n  const successRate = loginTotal \u003e 0 \n    ? ((loginSuccess || 0) / loginTotal * 100).toFixed(1)\n    : '100'\n  \n  return Response.json({\n    loginSuccessRate: `${successRate}%`,\n    loginAttempts: loginTotal,\n    oauthRelinks: {\n      success: oauthRelinkSuccess || 0,\n      failure: oauthRelinkFailure || 0,\n    },\n    passwordResets: passwordResets || 0,\n    timestamp: new Date().toISOString(),\n  })\n}\n```\n\n#### 3. Dashboard UI\n```tsx\n// app/admin/auth-dashboard/page.tsx\nexport default function AuthDashboard() {\n  const { data, isLoading } = useSWR('/api/admin/auth-metrics', fetcher, {\n    refreshInterval: 5000, // Poll every 5s\n  })\n  \n  return (\n    \u003cdiv className=\"grid grid-cols-4 gap-4\"\u003e\n      \u003cMetricCard\n        title=\"Login Success Rate\"\n        value={data?.loginSuccessRate}\n        target=\"99%\"\n        status={parseFloat(data?.loginSuccessRate) \u003e= 99 ? 'good' : 'bad'}\n      /\u003e\n      \u003cMetricCard\n        title=\"Login Attempts (1h)\"\n        value={data?.loginAttempts}\n      /\u003e\n      \u003cMetricCard\n        title=\"OAuth Re-links\"\n        value={`${data?.oauthRelinks.success} / ${data?.oauthRelinks.success + data?.oauthRelinks.failure}`}\n      /\u003e\n      \u003cMetricCard\n        title=\"Password Resets (1h)\"\n        value={data?.passwordResets}\n        status={data?.passwordResets \u003e 50 ? 'warning' : 'good'}\n      /\u003e\n      \n      {/* Time series chart */}\n      \u003cdiv className=\"col-span-4\"\u003e\n        \u003cAuthMetricsChart /\u003e\n      \u003c/div\u003e\n      \n      {/* Recent failures table */}\n      \u003cdiv className=\"col-span-4\"\u003e\n        \u003cRecentAuthFailures /\u003e\n      \u003c/div\u003e\n    \u003c/div\u003e\n  )\n}\n```\n\n#### 4. Alerting\n```typescript\n// inngest/functions/auth/monitor-auth-health.ts\nexport const monitorAuthHealth = inngest.createFunction(\n  { id: 'monitor-auth-health' },\n  { cron: '* * * * *' }, // Every minute during cutover\n  async ({ step }) =\u003e {\n    const metrics = await step.run('get-metrics', getAuthMetrics)\n    \n    // Alert if success rate drops below 95%\n    if (metrics.loginSuccessRate \u003c 95) {\n      await step.run('alert-low-success-rate', () =\u003e\n        sendSlackAlert({\n          channel: '#egghead-migration',\n          text: `üö® Auth success rate dropped to ${metrics.loginSuccessRate}%`,\n          color: 'danger',\n        })\n      )\n    }\n    \n    // Alert if password resets spike\n    if (metrics.passwordResetsPerHour \u003e 100) {\n      await step.run('alert-password-spike', () =\u003e\n        sendSlackAlert({\n          channel: '#egghead-migration',\n          text: `‚ö†Ô∏è Password reset spike: ${metrics.passwordResetsPerHour}/hour`,\n          color: 'warning',\n        })\n      )\n    }\n  }\n)\n```\n\n## Files to Create\n- `apps/egghead/src/app/admin/auth-dashboard/page.tsx`\n- `apps/egghead/src/app/api/admin/auth-metrics/route.ts`\n- `apps/egghead/src/components/admin/auth-metrics-chart.tsx`\n- `apps/egghead/src/inngest/functions/auth/monitor-auth-health.ts`\n- `apps/egghead/src/lib/auth/telemetry.ts`\n\n## Acceptance Criteria\n- [ ] Dashboard updates in real-time (5s refresh)\n- [ ] Success rate calculated correctly\n- [ ] Slack alerts fire when thresholds breached\n- [ ] Historical data retained for 7 days\n- [ ] Dashboard accessible only to admins\n- [ ] Mobile-friendly for on-call monitoring","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T09:53:26.18637-08:00","updated_at":"2025-12-11T12:01:35.128068-08:00","dependencies":[{"issue_id":"migrate-egghead-04y.6","depends_on_id":"migrate-egghead-04y","type":"parent-child","created_at":"2025-12-11T09:53:26.1867-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-04y.7","title":"Test cutover with 100 real users (beta group)","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T09:53:26.215844-08:00","updated_at":"2025-12-11T09:53:26.215844-08:00","dependencies":[{"issue_id":"migrate-egghead-04y.7","depends_on_id":"migrate-egghead-04y","type":"parent-child","created_at":"2025-12-11T09:53:26.216166-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-0ii","title":"Enrich Migration Beads - Full Stack Enrichment","description":"Enrich all empty/thin migration beads with detailed descriptions, acceptance criteria, file paths, and create supporting documentation (runbooks, ADRs). 7 parallel workstreams covering Phase 1-6 beads plus documentation.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T11:20:53.087525-08:00","updated_at":"2025-12-11T11:25:54.210442-08:00","closed_at":"2025-12-11T11:25:54.210442-08:00"}
{"id":"migrate-egghead-0ii.1","title":"Create koh subtasks (Phase 1: Data Migration)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T11:20:53.12592-08:00","updated_at":"2025-12-11T11:23:50.580578-08:00","closed_at":"2025-12-11T11:23:50.580578-08:00","dependencies":[{"issue_id":"migrate-egghead-0ii.1","depends_on_id":"migrate-egghead-0ii","type":"parent-child","created_at":"2025-12-11T11:20:53.126299-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-0ii.2","title":"Create qk0 subtasks (Phase 4: External Integrations)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T11:20:53.161543-08:00","updated_at":"2025-12-11T11:23:00.571459-08:00","closed_at":"2025-12-11T11:23:00.571459-08:00","dependencies":[{"issue_id":"migrate-egghead-0ii.2","depends_on_id":"migrate-egghead-0ii","type":"parent-child","created_at":"2025-12-11T11:20:53.161903-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-0ii.3","title":"Enrich r52 subtasks (Phase 5: UI Components)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T11:20:53.198204-08:00","updated_at":"2025-12-11T11:23:57.528352-08:00","closed_at":"2025-12-11T11:23:57.528352-08:00","dependencies":[{"issue_id":"migrate-egghead-0ii.3","depends_on_id":"migrate-egghead-0ii","type":"parent-child","created_at":"2025-12-11T11:20:53.198778-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-0ii.4","title":"Enrich axl subtasks (Phase 6: Cutover)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T11:20:53.235313-08:00","updated_at":"2025-12-11T11:25:21.783401-08:00","closed_at":"2025-12-11T11:25:21.783401-08:00","dependencies":[{"issue_id":"migrate-egghead-0ii.4","depends_on_id":"migrate-egghead-0ii","type":"parent-child","created_at":"2025-12-11T11:20:53.23571-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-0ii.5","title":"Enrich dxh subtasks (Team Features)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T11:20:53.273226-08:00","updated_at":"2025-12-11T11:22:40.331477-08:00","closed_at":"2025-12-11T11:22:40.331477-08:00","dependencies":[{"issue_id":"migrate-egghead-0ii.5","depends_on_id":"migrate-egghead-0ii","type":"parent-child","created_at":"2025-12-11T11:20:53.273638-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-0ii.6","title":"Create runbooks (dual-write, cutover, rollback)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T11:20:53.314045-08:00","updated_at":"2025-12-11T11:24:25.330418-08:00","closed_at":"2025-12-11T11:24:25.330418-08:00","dependencies":[{"issue_id":"migrate-egghead-0ii.6","depends_on_id":"migrate-egghead-0ii","type":"parent-child","created_at":"2025-12-11T11:20:53.31444-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-0ii.7","title":"Create ADRs (idempotency, email, video player)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T11:20:53.348908-08:00","updated_at":"2025-12-11T11:25:00.583478-08:00","closed_at":"2025-12-11T11:25:00.583478-08:00","dependencies":[{"issue_id":"migrate-egghead-0ii.7","depends_on_id":"migrate-egghead-0ii","type":"parent-child","created_at":"2025-12-11T11:20:53.349533-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-15v","title":"[HUMAN] Approve Webhook Handler Design","description":"**HARD STOP - Agent must not proceed past this point without human approval**\n\n## Gate: Before Phase 2 (Webhook Handlers)\n\n### What Needs Review\n1. Webhook handler architecture design\n2. Event processing flow (Inngest functions)\n3. Idempotency strategy\n4. Error handling and retry logic\n5. Dual-write coordination with Rails\n\n### Artifacts to Present\n- [ ] Webhook handler design doc\n- [ ] Inngest function signatures\n- [ ] Event schema definitions\n- [ ] Rollback strategy\n\n### Approval Criteria\n- Design handles all 12 critical Stripe events\n- Idempotency keys prevent duplicate processing\n- Failure modes are documented\n- Rollback path is clear\n\n### How to Proceed\nAgent presents design ‚Üí Human reviews ‚Üí Human marks this bead closed with approval note ‚Üí Agent continues to implementation","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:53:42.470126-08:00","updated_at":"2025-12-11T10:53:42.470126-08:00"}
{"id":"migrate-egghead-15y","title":"Migration Infrastructure \u0026 POC Validation","description":"Set up migration infrastructure (deps, logging, progress tracking), run POC scripts against dev database, and verify UI routes work with migrated content.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-13T08:49:12.483289-08:00","updated_at":"2025-12-13T08:49:12.483289-08:00"}
{"id":"migrate-egghead-15y.1","title":"Install migration dependencies","description":"Install required dependencies for migration scripts:\n\n```bash\ncd investigation\npnpm add @paralleldrive/cuid2 @portabletext/to-markdown\n```\n\nThese are needed for:\n- `@paralleldrive/cuid2` - Generate proper CUIDs for ContentResource IDs\n- `@portabletext/to-markdown` - Convert Sanity portable text to markdown\n\nVerify package.json is updated and deps install correctly.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-13T08:49:12.523663-08:00","updated_at":"2025-12-13T08:52:24.186215-08:00","closed_at":"2025-12-13T08:52:24.186215-08:00","dependencies":[{"issue_id":"migrate-egghead-15y.1","depends_on_id":"migrate-egghead-15y","type":"parent-child","created_at":"2025-12-13T08:49:12.524011-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-15y.2","title":"Add migration logging and progress utilities","description":"Created migration-utils.ts with all required functions:\n‚úì Progress tracking (console output with percentage)\n‚úì Logging (start/complete/error)\n‚úì ID generation (cuid2 wrapper)\n‚úì Portable text conversion (type-safe with fallback)\n‚úì Idempotency helpers (legacy ID field mapping)\n\nAll functions tested and working. Note: portableTextToMarkdown has a TODO for @portabletext/to-markdown integration (currently uses basic text extraction).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T08:49:12.566451-08:00","updated_at":"2025-12-13T08:52:25.376901-08:00","closed_at":"2025-12-13T08:52:25.376901-08:00","dependencies":[{"issue_id":"migrate-egghead-15y.2","depends_on_id":"migrate-egghead-15y","type":"parent-child","created_at":"2025-12-13T08:49:12.566798-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-15y.3","title":"Run POC modern course migration","description":"Execute the modern course POC migration script against dev database.\n\n**Script**: `investigation/poc-migrate-modern-course.ts`\n**Course**: Claude Code Essentials (17 lessons)\n**Source**: Sanity + Rails\n\n**Steps**:\n1. Ensure dev database connection works (NEW_DATABASE_URL)\n2. Run script with DRY_RUN=false\n3. Verify records created in egghead_ContentResource table\n4. Check course‚Üílesson‚Üívideo linking\n\n**Verification queries**:\n```sql\nSELECT COUNT(*) FROM egghead_ContentResource WHERE type='course' AND JSON_EXTRACT(fields, '$.slug') LIKE 'claude-code%';\nSELECT COUNT(*) FROM egghead_ContentResource WHERE type='lesson' AND JSON_EXTRACT(fields, '$.legacySanityId') IS NOT NULL;\n```","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T08:49:12.608286-08:00","updated_at":"2025-12-13T08:58:30.423838-08:00","closed_at":"2025-12-13T08:58:30.423838-08:00","dependencies":[{"issue_id":"migrate-egghead-15y.3","depends_on_id":"migrate-egghead-15y","type":"parent-child","created_at":"2025-12-13T08:49:12.608618-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-15y.4","title":"Run POC legacy course migration","description":"Execute the legacy course POC migration script against dev database.\n\n**Script**: `investigation/poc-migrate-legacy-course.ts`\n**Course**: Fix Common Git Mistakes (20 lessons)\n**Source**: Rails only (no Sanity)\n\n**Steps**:\n1. Ensure dev database connection works (NEW_DATABASE_URL)\n2. Run script with DRY_RUN=false\n3. Verify records created in egghead_ContentResource table\n4. Check course‚Üílesson‚Üívideo linking\n\n**Verification queries**:\n```sql\nSELECT COUNT(*) FROM egghead_ContentResource WHERE type='course' AND JSON_EXTRACT(fields, '$.slug') LIKE 'fix-common-git%';\nSELECT COUNT(*) FROM egghead_ContentResource WHERE type='lesson' AND JSON_EXTRACT(fields, '$.legacyRailsId') IS NOT NULL;\n```","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T08:49:12.649359-08:00","updated_at":"2025-12-13T08:58:31.671999-08:00","closed_at":"2025-12-13T08:58:31.671999-08:00","dependencies":[{"issue_id":"migrate-egghead-15y.4","depends_on_id":"migrate-egghead-15y","type":"parent-child","created_at":"2025-12-13T08:49:12.64973-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-15y.5","title":"Verify UI routes render migrated content","description":"Verify the UI routes render migrated content correctly.\n\n**Routes to test**:\n- `/courses/claude-code-essentials~jc0n6` - Modern course\n- `/courses/fix-common-git-mistakes` - Legacy course\n- `/lessons/[any-migrated-lesson-slug]` - Individual lessons\n\n**Verification checklist**:\n- [ ] Course page loads without errors\n- [ ] Course title and description display\n- [ ] Lesson list shows with correct ordering\n- [ ] Lesson links work (/lessons/[slug])\n- [ ] Lesson page loads without errors\n- [ ] Video player renders (Mux HLS)\n- [ ] Lesson metadata displays (title, description)\n\n**Method**: Use browser automation or manual testing against dev server at https://joel-x42.coursebuilder.dev","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T08:49:12.692494-08:00","updated_at":"2025-12-13T09:02:59.020409-08:00","closed_at":"2025-12-13T09:02:59.020409-08:00","dependencies":[{"issue_id":"migrate-egghead-15y.5","depends_on_id":"migrate-egghead-15y","type":"parent-child","created_at":"2025-12-13T08:49:12.692804-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1p8","title":"Customer.io Event Replay Strategy","description":"**CRITICAL GAP**: No plan for replaying historical events to Customer.io post-migration.\n\n## Problem\n\nCustomer.io tracks user behavior for email campaigns:\n- Subscription events (created, cancelled, renewed)\n- Content engagement (lessons watched, courses completed)\n- User attributes (plan type, join date, etc.)\n\nAfter migration, Customer.io will have stale data unless we replay events.\n\n## Scope\n\nWhat needs syncing:\n1. **User attributes** - email, name, plan, join date\n2. **Subscription state** - active/cancelled/expired\n3. **Recent activity** - last 30 days of engagement\n\nWhat we DON'T need:\n- Historical events older than 30 days (Customer.io has them)\n- Real-time events (new system handles these)\n\n## Solution\n\n### 1. Bulk User Attribute Sync\n\n```typescript\n// inngest/functions/customerio/sync-all-users.ts\nexport const syncAllUsersToCustomerIo = inngest.createFunction(\n  { id: 'sync-all-users-customerio', concurrency: 10 },\n  { event: 'customerio/sync.all-users' },\n  async ({ step }) =\u003e {\n    const users = await step.run('get-users', () =\u003e\n      db.query.users.findMany({\n        with: { subscriptions: true, organizations: true }\n      })\n    )\n    \n    for (const batch of chunk(users, 100)) {\n      await step.run(`batch-${batch[0].id}`, async () =\u003e {\n        for (const user of batch) {\n          await customerio.identify(user.id, {\n            email: user.email,\n            name: user.name,\n            created_at: Math.floor(user.createdAt.getTime() / 1000),\n            plan: user.subscriptions[0]?.planName || 'free',\n            subscription_status: user.subscriptions[0]?.status || 'none',\n            organization_id: user.organizations[0]?.id,\n          })\n        }\n      })\n      \n      // Rate limit: 100 identifies per second\n      await step.sleep('rate-limit', '1s')\n    }\n  }\n)\n```\n\n### 2. Subscription Event Replay\n\n```typescript\n// Replay subscription events from last 30 days\nexport const replaySubscriptionEvents = inngest.createFunction(\n  { id: 'replay-subscription-events' },\n  { event: 'customerio/replay.subscriptions' },\n  async ({ step }) =\u003e {\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)\n    \n    const events = await step.run('get-events', () =\u003e\n      db.query.subscriptions.findMany({\n        where: gte(subscriptions.updatedAt, thirtyDaysAgo),\n        with: { user: true }\n      })\n    )\n    \n    for (const sub of events) {\n      await step.run(`event-${sub.id}`, () =\u003e\n        customerio.track(sub.userId, {\n          name: `subscription_${sub.status}`,\n          data: {\n            subscription_id: sub.id,\n            plan: sub.planName,\n            amount: sub.price,\n            timestamp: Math.floor(sub.updatedAt.getTime() / 1000),\n          }\n        })\n      )\n    }\n  }\n)\n```\n\n### 3. Engagement Event Replay\n\n```typescript\n// Replay lesson completions from last 30 days\nexport const replayEngagementEvents = inngest.createFunction(\n  { id: 'replay-engagement-events' },\n  { event: 'customerio/replay.engagement' },\n  async ({ step }) =\u003e {\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)\n    \n    // Lesson completions\n    const completions = await step.run('get-completions', () =\u003e\n      db.query.lessonProgress.findMany({\n        where: and(\n          isNotNull(lessonProgress.completedAt),\n          gte(lessonProgress.completedAt, thirtyDaysAgo)\n        ),\n        with: { lesson: true }\n      })\n    )\n    \n    for (const batch of chunk(completions, 100)) {\n      await step.run(`batch-${batch[0].id}`, async () =\u003e {\n        for (const completion of batch) {\n          await customerio.track(completion.userId, {\n            name: 'lesson_completed',\n            data: {\n              lesson_id: completion.lessonId,\n              lesson_title: completion.lesson.title,\n              timestamp: Math.floor(completion.completedAt.getTime() / 1000),\n            }\n          })\n        }\n      })\n    }\n  }\n)\n```\n\n## Cutover Runbook Addition\n\n```markdown\n### T+1 hour: Customer.io Sync\n1. Trigger user attribute sync: `inngest.send({ name: 'customerio/sync.all-users' })`\n2. Monitor Inngest dashboard for completion\n3. Trigger subscription replay: `inngest.send({ name: 'customerio/replay.subscriptions' })`\n4. Trigger engagement replay: `inngest.send({ name: 'customerio/replay.engagement' })`\n5. Verify in Customer.io: Check user profiles have updated attributes\n```\n\n## Files to Create\n- `apps/egghead/src/inngest/functions/customerio/sync-all-users.ts`\n- `apps/egghead/src/inngest/functions/customerio/replay-subscriptions.ts`\n- `apps/egghead/src/inngest/functions/customerio/replay-engagement.ts`\n- `apps/egghead/src/lib/customerio/client.ts`\n- Update `reports/CUTOVER-RUNBOOK.md`\n\n## Acceptance Criteria\n- [ ] All users synced to Customer.io with correct attributes\n- [ ] Subscription events from last 30 days replayed\n- [ ] Engagement events from last 30 days replayed\n- [ ] Rate limiting prevents API throttling\n- [ ] Verification: spot-check 10 users in Customer.io dashboard","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T12:04:24.441294-08:00","updated_at":"2025-12-12T09:26:03.836523-08:00","closed_at":"2025-12-12T09:26:03.836523-08:00"}
{"id":"migrate-egghead-1rx","title":"Migration Support Automation System","description":"Build a multi-tenant AI-powered support platform. egghead migration is the first tenant, but architecture supports all Skill Recordings properties (Total TypeScript, Pro Tailwind, etc.) and beyond.\n\n## Multi-Tenant Architecture\n\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ                    SUPPORT PLATFORM (Multi-Tenant)              ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ  Tenant Config                                                   ‚îÇ\n‚îÇ  ‚îú‚îÄ egghead     { frontInbox, stripeAccount, db, branding }    ‚îÇ\n‚îÇ  ‚îú‚îÄ totaltypescript  { ... }                                    ‚îÇ\n‚îÇ  ‚îú‚îÄ protailwind      { ... }                                    ‚îÇ\n‚îÇ  ‚îî‚îÄ [future]         { ... }                                    ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ  Shared Infrastructure                                           ‚îÇ\n‚îÇ  ‚îú‚îÄ Upstash Redis    (namespaced by tenant)                     ‚îÇ\n‚îÇ  ‚îú‚îÄ Upstash Vector   (namespaced by tenant)                     ‚îÇ\n‚îÇ  ‚îú‚îÄ Inngest          (tenant in event metadata)                 ‚îÇ\n‚îÇ  ‚îî‚îÄ Front Plugin     (routes by inbox ‚Üí tenant)                 ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ  Tenant-Specific                                                 ‚îÇ\n‚îÇ  ‚îú‚îÄ Diagnostic queries (different schemas per app)              ‚îÇ\n‚îÇ  ‚îú‚îÄ Auto-resolvers (tenant-specific actions)                    ‚îÇ\n‚îÇ  ‚îú‚îÄ Response templates (branding, tone)                         ‚îÇ\n‚îÇ  ‚îî‚îÄ Vector indexes (tenant's docs, tickets, code)               ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## Tenant Configuration\n\n```typescript\ninterface TenantConfig {\n  id: string                    // 'egghead' | 'totaltypescript' | ...\n  name: string                  // Display name\n  \n  // Front integration\n  front: {\n    inboxIds: string[]          // Which Front inboxes route here\n    webhookSecret: string\n  }\n  \n  // Database (for diagnostics)\n  database: {\n    type: 'planetscale' | 'postgres'\n    connectionString: string\n    schema: TenantSchema        // Tenant-specific query adapters\n  }\n  \n  // Stripe (for billing issues)\n  stripe: {\n    accountId: string\n    secretKey: string\n  }\n  \n  // Branding\n  branding: {\n    name: string\n    supportEmail: string\n    signatureTemplate: string\n  }\n  \n  // Feature flags\n  features: {\n    autoResolve: boolean\n    proactiveMonitor: boolean\n    ragEnabled: boolean\n  }\n}\n```\n\n## Key Design Principles\n\n1. **Namespace everything** - Redis keys, vector namespaces, Inngest events all prefixed with tenant\n2. **Tenant from context** - Front inbox ‚Üí tenant lookup at webhook entry point\n3. **Shared infra, isolated data** - One Redis/Vector instance, tenant-scoped keys\n4. **Pluggable diagnostics** - Each tenant implements `DiagnosticAdapter` interface\n5. **Tenant-specific resolvers** - Core resolver logic shared, actions tenant-specific\n\n## Success Metrics (per tenant)\n- Auto-resolve rate \u003e 60%\n- Time to first response \u003c 5 min\n- Resolution accuracy \u003e 90% (measured by re-open rate)","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:58:46.697139-08:00","updated_at":"2025-12-11T10:03:15.444102-08:00"}
{"id":"migrate-egghead-1rx.1","title":"Build Front webhook receiver (Inngest function)","description":"Build Front webhook receiver that triggers Inngest functions.\n\nFront webhook events to handle:\n- `inbound` - New message received (classify and route)\n- `outbound` - Reply sent (track resolution)\n- `conversation_assigned` - Assigned to teammate\n- `conversation_unassigned` - Back in queue\n- `tag_added` - Manual categorization\n\nWebhook endpoint: POST /api/webhooks/front\n\nFlow:\n1. Receive webhook from Front\n2. Verify signature (FRONT_WEBHOOK_SECRET)\n3. Extract conversation ID, sender email, message body\n4. Send to Inngest: `support/conversation.received`\n5. Inngest function picks up and starts classification\n\n```typescript\n// Inngest event schema\n{\n  name: 'support/conversation.received',\n  data: {\n    conversationId: string,\n    email: string,\n    subject: string,\n    body: string,\n    inboxId: string,\n    isNewConversation: boolean,\n  }\n}\n```","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:58:46.733845-08:00","updated_at":"2025-12-11T09:58:57.21168-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.1","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T09:58:46.734189-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.10","title":"Build escalation flow with full diagnostic context for humans","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T09:58:47.02927-08:00","updated_at":"2025-12-11T09:58:47.02927-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.10","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T09:58:47.02963-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.11","title":"Set up Upstash Redis for conversation state + resolution cache","description":"Set up Upstash Redis as the state layer for multi-tenant support infrastructure.\n\n## Multi-Tenant Key Structure\n\nAll keys namespaced by tenant ID:\n\n```typescript\n// Conversation state (TTL: 24h)\n`{tenant}:conv:${conversationId}` ‚Üí {\n  tenantId: string\n  userId: string\n  classification: Classification\n  diagnostic: UserDiagnostic\n  messages: Message[]\n  resolutionAttempts: ResolutionAttempt[]\n  status: 'open' | 'pending' | 'resolved' | 'escalated'\n}\n\n// User session cache (TTL: 1h)\n`{tenant}:user:${email}` ‚Üí UserDiagnostic\n\n// Resolution cache - what worked (TTL: 30d)\n`{tenant}:resolution:${issueType}:${specificIssue}` ‚Üí {\n  successCount: number\n  failureCount: number\n  lastSuccess: Date\n  template: string\n  actions: Action[]\n}\n\n// Pattern counters (TTL: 1h, sliding window)\n`{tenant}:pattern:${issueType}:${hour}` ‚Üí count\n\n// Rate limiting (per tenant)\n`{tenant}:ratelimit:${email}` ‚Üí count\n\n// Tenant config cache (TTL: 5min)\n`tenant:config:${tenantId}` ‚Üí TenantConfig\n```\n\n## Typed Client\n\n```typescript\n// lib/support/redis.ts\nimport { Redis } from '@upstash/redis'\n\nconst redis = new Redis({\n  url: process.env.UPSTASH_REDIS_REST_URL,\n  token: process.env.UPSTASH_REDIS_REST_TOKEN,\n})\n\n// Tenant-scoped helpers\nexport function tenantRedis(tenantId: string) {\n  return {\n    async getConversation(convId: string) {\n      return redis.get\u003cConversation\u003e(`${tenantId}:conv:${convId}`)\n    },\n    async setConversation(convId: string, conv: Conversation) {\n      return redis.set(`${tenantId}:conv:${convId}`, conv, { ex: 86400 })\n    },\n    async getUserCache(email: string) {\n      return redis.get\u003cUserDiagnostic\u003e(`${tenantId}:user:${email}`)\n    },\n    // ... etc\n  }\n}\n```\n\n## Implementation\n\n1. Create Upstash Redis instance\n2. Add UPSTASH_REDIS_REST_URL and UPSTASH_REDIS_REST_TOKEN to env\n3. Create `lib/support/redis.ts` with tenant-scoped client\n4. Create tenant config loader with caching\n5. Add TTL management utilities","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:02:06.934623-08:00","updated_at":"2025-12-11T10:03:25.54171-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.11","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T10:02:06.935024-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.12","title":"Set up Upstash Vector for semantic search (docs, tickets, code)","description":"Set up Upstash Vector as the multi-tenant semantic search layer.\n\n## Multi-Tenant Index Strategy\n\nOption A: **Namespaces per tenant** (recommended)\n- Single Upstash Vector index\n- Use namespace parameter: `egghead`, `totaltypescript`, etc.\n- Pros: Simple, cost-effective, easy tenant isolation\n- Cons: Can't have different dimensions per tenant (all use same embedding model)\n\n```typescript\n// Query with namespace\nconst results = await index.query({\n  vector: embedding,\n  topK: 5,\n  namespace: tenantId,  // 'egghead' | 'totaltypescript' | ...\n  filter: { type: 'faq' }\n})\n```\n\n## Index Structure (per namespace)\n\n```typescript\n// Namespace: {tenant}/support-docs\n{\n  id: 'doc-{slug}',\n  vector: float[1536],  // OpenAI text-embedding-3-small\n  metadata: {\n    tenantId: string,\n    type: 'faq' | 'guide' | 'troubleshooting',\n    title: string,\n    content: string,\n    url: string,\n    lastUpdated: string\n  }\n}\n\n// Namespace: {tenant}/past-tickets\n{\n  id: 'ticket-{id}',\n  vector: float[1536],\n  metadata: {\n    tenantId: string,\n    issueType: string,\n    resolution: string,\n    wasSuccessful: boolean,\n    responseTemplate: string,\n    createdAt: string\n  }\n}\n```\n\n## Typed Client\n\n```typescript\n// lib/support/vector.ts\nimport { Index } from '@upstash/vector'\n\nconst index = new Index({\n  url: process.env.UPSTASH_VECTOR_REST_URL,\n  token: process.env.UPSTASH_VECTOR_REST_TOKEN,\n})\n\nexport function tenantVector(tenantId: string) {\n  return {\n    async searchDocs(embedding: number[], topK = 3) {\n      return index.query({\n        vector: embedding,\n        topK,\n        namespace: `${tenantId}/support-docs`,\n        includeMetadata: true,\n      })\n    },\n    async searchTickets(embedding: number[], filter?: object, topK = 3) {\n      return index.query({\n        vector: embedding,\n        topK,\n        namespace: `${tenantId}/past-tickets`,\n        filter,\n        includeMetadata: true,\n      })\n    },\n    async upsertDoc(id: string, embedding: number[], metadata: DocMetadata) {\n      return index.upsert({\n        id,\n        vector: embedding,\n        metadata: { ...metadata, tenantId },\n        namespace: `${tenantId}/support-docs`,\n      })\n    },\n    // ... etc\n  }\n}\n```\n\n## Implementation\n\n1. Create Upstash Vector index (1536 dimensions for OpenAI)\n2. Add UPSTASH_VECTOR_REST_URL and UPSTASH_VECTOR_REST_TOKEN\n3. Create `lib/support/vector.ts` with tenant-namespaced client\n4. Create namespace management utilities\n5. Add tenant isolation tests","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:02:12.845266-08:00","updated_at":"2025-12-11T10:03:35.591982-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.12","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T10:02:12.84569-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.13","title":"Build embedding pipeline for support docs + past tickets","description":"Build the embedding pipeline that populates the vector DB.\n\n## Sources to Index\n\n1. **Support Docs** (one-time + on change)\n   - FAQ pages from egghead\n   - Help center articles\n   - Common troubleshooting guides\n   \n2. **Past Tickets** (batch + incremental)\n   - Export from Front (last 6 months)\n   - Extract: issue, resolution, success/failure\n   - Incremental: webhook on ticket close\n   \n3. **Codebase** (optional, on-demand)\n   - Key files: auth, subscriptions, entitlements\n   - Chunk by function/component\n   - Re-index on deploy\n\n## Inngest Functions\n\n```typescript\n// One-time batch indexing\ninngest.createFunction(\n  { id: 'index-support-docs' },\n  { event: 'support/index.docs' },\n  async ({ step }) =\u003e {\n    const docs = await step.run('fetch-docs', fetchAllDocs)\n    for (const doc of docs) {\n      await step.run(`embed-${doc.id}`, () =\u003e embedAndUpsert(doc))\n    }\n  }\n)\n\n// Incremental on ticket close\ninngest.createFunction(\n  { id: 'index-resolved-ticket' },\n  { event: 'support/ticket.resolved' },\n  async ({ event, step }) =\u003e {\n    const embedding = await step.run('embed', () =\u003e \n      embed(event.data.issue + ' ' + event.data.resolution)\n    )\n    await step.run('upsert', () =\u003e \n      vectorUpsert('past-tickets', { ... })\n    )\n  }\n)\n```\n\n## Chunking Strategy\n\n- Docs: Split by section (h2/h3 headers)\n- Tickets: Full ticket as single chunk\n- Code: Function/component boundaries","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:02:21.811817-08:00","updated_at":"2025-12-11T10:02:21.811817-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.13","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T10:02:21.812283-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.14","title":"Build RAG retrieval layer (query vector DB before AI response)","description":"Build the RAG retrieval layer that enriches AI responses with relevant context.\n\n## Flow\n\n```\nUser Message\n    ‚Üì\nEmbed Query (OpenAI ada-002)\n    ‚Üì\nParallel Vector Search:\n‚îú‚îÄ support-docs (top 3)\n‚îú‚îÄ past-tickets (top 3, filter: wasSuccessful=true)\n‚îî‚îÄ codebase (top 2, if technical)\n    ‚Üì\nContext Assembly\n    ‚Üì\nLLM with enriched context\n    ‚Üì\nResponse\n```\n\n## Implementation\n\n```typescript\ninterface RAGContext {\n  relevantDocs: { title: string; content: string; url: string }[]\n  similarTickets: { issue: string; resolution: string; template: string }[]\n  codeContext?: { file: string; snippet: string }[]\n}\n\nasync function retrieveContext(\n  query: string,\n  classification: Classification\n): Promise\u003cRAGContext\u003e {\n  const embedding = await embed(query)\n  \n  const [docs, tickets, code] = await Promise.all([\n    vectorQuery('support-docs', embedding, { topK: 3 }),\n    vectorQuery('past-tickets', embedding, { \n      topK: 3, \n      filter: { wasSuccessful: true, issueType: classification.category }\n    }),\n    classification.isTechnical \n      ? vectorQuery('codebase', embedding, { topK: 2 })\n      : null\n  ])\n  \n  return { relevantDocs: docs, similarTickets: tickets, codeContext: code }\n}\n\n// Use in classifier/resolver\nconst context = await retrieveContext(message, classification)\nconst response = await openai.chat.completions.create({\n  messages: [\n    { role: 'system', content: buildSystemPrompt(context) },\n    { role: 'user', content: message }\n  ]\n})\n```\n\n## System Prompt Template\n\n```\nYou are an egghead.io support agent. Use the following context to help the user:\n\n## Relevant Documentation\n{docs}\n\n## Similar Resolved Tickets\n{tickets}\n\n## User Diagnostic\n{diagnostic}\n\nRespond helpfully and concisely. If you can resolve the issue, do so. If not, explain what you need.\n```","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:02:31.388956-08:00","updated_at":"2025-12-11T10:02:31.388956-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.14","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T10:02:31.389331-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.15","title":"Build resolution memory (track what worked, surface for similar issues)","description":"Build the resolution memory system that learns from outcomes.\n\n## Data Model\n\n```typescript\ninterface Resolution {\n  id: string\n  issueType: Category\n  specificIssue: string  // e.g., \"password_reset\", \"missing_entitlement\"\n  \n  // What we did\n  actions: Action[]\n  responseTemplate: string\n  \n  // Outcome tracking\n  attempts: number\n  successes: number\n  failures: number\n  successRate: number\n  \n  // Timing\n  avgResolutionTime: number\n  lastUsed: Date\n  \n  // Feedback\n  userRatings: number[]\n  reopenRate: number\n}\n\ninterface ResolutionAttempt {\n  resolutionId: string\n  conversationId: string\n  timestamp: Date\n  outcome: 'success' | 'failure' | 'pending'\n  userFeedback?: 'positive' | 'negative'\n  reopened: boolean\n}\n```\n\n## Learning Loop\n\n```typescript\n// On ticket close\ninngest.createFunction(\n  { id: 'learn-from-resolution' },\n  { event: 'support/ticket.closed' },\n  async ({ event, step }) =\u003e {\n    const { conversationId, wasReopened, userFeedback } = event.data\n    \n    // Get what we tried\n    const conv = await redis.get(`conv:${conversationId}`)\n    const attempts = conv.resolutionAttempts\n    \n    // Update resolution stats\n    for (const attempt of attempts) {\n      await step.run(`update-${attempt.resolutionId}`, async () =\u003e {\n        const resolution = await getResolution(attempt.resolutionId)\n        \n        if (wasReopened) {\n          resolution.failures++\n          resolution.reopenRate = recalculate(...)\n        } else {\n          resolution.successes++\n        }\n        \n        resolution.successRate = resolution.successes / resolution.attempts\n        await saveResolution(resolution)\n        \n        // Re-embed if success rate changed significantly\n        if (shouldReindex(resolution)) {\n          await inngest.send({ name: 'support/resolution.reindex', data: resolution })\n        }\n      })\n    }\n  }\n)\n```\n\n## Surfacing Best Resolutions\n\n```typescript\nasync function getBestResolution(\n  issueType: Category,\n  specificIssue: string\n): Promise\u003cResolution | null\u003e {\n  // Check cache first\n  const cached = await redis.get(`resolution:${issueType}:${specificIssue}`)\n  if (cached \u0026\u0026 cached.successRate \u003e 0.8) return cached\n  \n  // Query vector DB for similar issues\n  const similar = await vectorQuery('past-tickets', embed(specificIssue), {\n    filter: { issueType, wasSuccessful: true },\n    topK: 5\n  })\n  \n  // Return highest success rate\n  return similar.sort((a, b) =\u003e b.successRate - a.successRate)[0]\n}\n```","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:02:41.826336-08:00","updated_at":"2025-12-11T10:02:41.826336-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.15","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T10:02:41.826737-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.16","title":"Build pattern detector (aggregate issues ‚Üí systemic alerts)","description":"Build pattern detection to catch systemic issues before they become crises.\n\n## Detection Rules\n\n```typescript\ninterface PatternRule {\n  id: string\n  name: string\n  condition: {\n    issueType: Category\n    specificIssue?: string\n    threshold: number      // Count to trigger\n    window: number         // Time window in minutes\n  }\n  action: {\n    alert: 'slack' | 'pagerduty'\n    channel: string\n    severity: 'info' | 'warning' | 'critical'\n    autoAction?: string    // Optional auto-remediation\n  }\n}\n\nconst rules: PatternRule[] = [\n  {\n    id: 'auth-spike',\n    name: 'Authentication Error Spike',\n    condition: { issueType: 'AUTH', threshold: 10, window: 60 },\n    action: { alert: 'slack', channel: '#support-alerts', severity: 'critical' }\n  },\n  {\n    id: 'access-spike',\n    name: 'Access Denied Spike',\n    condition: { issueType: 'ACCESS', threshold: 5, window: 30 },\n    action: { alert: 'slack', channel: '#support-alerts', severity: 'warning' }\n  },\n  {\n    id: 'video-playback',\n    name: 'Video Playback Issues',\n    condition: { issueType: 'CONTENT', specificIssue: 'video_wont_play', threshold: 3, window: 15 },\n    action: { alert: 'slack', channel: '#engineering', severity: 'critical' }\n  }\n]\n```\n\n## Implementation\n\n```typescript\n// Increment counter on every ticket\nasync function trackPattern(classification: Classification) {\n  const hour = new Date().toISOString().slice(0, 13)  // 2024-01-15T14\n  const key = `pattern:${classification.category}:${hour}`\n  \n  const count = await redis.incr(key)\n  await redis.expire(key, 3600)  // 1 hour TTL\n  \n  // Check rules\n  for (const rule of rules) {\n    if (rule.condition.issueType !== classification.category) continue\n    \n    const windowCount = await getWindowCount(\n      classification.category,\n      rule.condition.window\n    )\n    \n    if (windowCount \u003e= rule.condition.threshold) {\n      await triggerAlert(rule, windowCount)\n    }\n  }\n}\n\n// Sliding window count\nasync function getWindowCount(issueType: Category, windowMinutes: number): Promise\u003cnumber\u003e {\n  const now = new Date()\n  const keys = []\n  \n  for (let i = 0; i \u003c Math.ceil(windowMinutes / 60); i++) {\n    const hour = new Date(now.getTime() - i * 60 * 60 * 1000)\n      .toISOString().slice(0, 13)\n    keys.push(`pattern:${issueType}:${hour}`)\n  }\n  \n  const counts = await redis.mget(keys)\n  return counts.reduce((sum, c) =\u003e sum + (parseInt(c) || 0), 0)\n}\n\n// Alert with context\nasync function triggerAlert(rule: PatternRule, count: number) {\n  // Dedupe: don't alert twice in 15 min\n  const alertKey = `alert:${rule.id}`\n  if (await redis.get(alertKey)) return\n  await redis.set(alertKey, '1', { ex: 900 })\n  \n  // Get recent examples\n  const recentTickets = await getRecentTickets(rule.condition.issueType, 5)\n  \n  await slack.send(rule.action.channel, {\n    text: `üö® ${rule.name}: ${count} issues in ${rule.condition.window} min`,\n    blocks: [\n      { type: 'section', text: { type: 'mrkdwn', text: `*${rule.name}*\\n${count} issues detected` }},\n      { type: 'section', text: { type: 'mrkdwn', text: `*Recent examples:*\\n${recentTickets.map(t =\u003e `‚Ä¢ ${t.subject}`).join('\\n')}` }}\n    ]\n  })\n}\n```","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:02:55.636787-08:00","updated_at":"2025-12-11T10:02:55.636787-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.16","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T10:02:55.637178-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.17","title":"Build tenant configuration system (registry, routing, feature flags)","description":"Build the multi-tenant configuration system that routes requests and manages tenant-specific settings.\n\n## Tenant Registry\n\n```typescript\n// lib/support/tenants/config.ts\ninterface TenantConfig {\n  id: string                    // 'egghead' | 'totaltypescript' | ...\n  name: string                  // Display name\n  \n  // Front integration\n  front: {\n    inboxIds: string[]          // Which Front inboxes route here\n    webhookSecret: string       // Per-tenant webhook verification\n  }\n  \n  // Database (for diagnostics)\n  database: {\n    provider: 'planetscale' | 'neon' | 'supabase'\n    connectionUrl: string       // From env: DATABASE_URL_{TENANT}\n  }\n  \n  // Stripe (for billing issues)\n  stripe: {\n    accountId: string           // Connect account or platform\n    secretKeyEnvVar: string     // STRIPE_SECRET_KEY_{TENANT}\n  }\n  \n  // Branding\n  branding: {\n    displayName: string         // \"egghead.io\" | \"Total TypeScript\"\n    supportEmail: string        // support@egghead.io\n    signatureTemplate: string   // \"Cheers,\\negghead Support\"\n    tone: 'casual' | 'professional' | 'friendly'\n  }\n  \n  // Feature flags\n  features: {\n    autoResolve: boolean        // Can AI auto-resolve without human?\n    proactiveMonitor: boolean   // Run background health checks?\n    ragEnabled: boolean         // Use vector search for context?\n    maxAutoResolvePerHour: number\n  }\n  \n  // Issue categories (can be customized per tenant)\n  categories: Category[]\n}\n\n// Initial tenants\nconst tenants: TenantConfig[] = [\n  {\n    id: 'egghead',\n    name: 'egghead.io',\n    front: {\n      inboxIds: ['inb_xxx'],  // From Front\n      webhookSecret: process.env.FRONT_WEBHOOK_SECRET_EGGHEAD!,\n    },\n    database: {\n      provider: 'planetscale',\n      connectionUrl: process.env.DATABASE_URL_EGGHEAD!,\n    },\n    stripe: {\n      accountId: 'acct_xxx',\n      secretKeyEnvVar: 'STRIPE_SECRET_KEY_EGGHEAD',\n    },\n    branding: {\n      displayName: 'egghead.io',\n      supportEmail: 'support@egghead.io',\n      signatureTemplate: 'Cheers,\\negghead Support',\n      tone: 'casual',\n    },\n    features: {\n      autoResolve: true,\n      proactiveMonitor: true,\n      ragEnabled: true,\n      maxAutoResolvePerHour: 50,\n    },\n    categories: ['AUTH', 'ACCESS', 'PROGRESS', 'CONTENT', 'BILLING', 'TEAM'],\n  },\n  // Add more tenants as needed\n]\n```\n\n## Routing: Inbox ‚Üí Tenant\n\n```typescript\n// lib/support/tenants/routing.ts\nimport { redis } from '../redis'\n\n// Cache inbox ‚Üí tenant mapping\nconst inboxToTenant = new Map\u003cstring, string\u003e()\n\nexport async function getTenantFromInbox(inboxId: string): Promise\u003cTenantConfig\u003e {\n  // Check memory cache\n  let tenantId = inboxToTenant.get(inboxId)\n  \n  if (!tenantId) {\n    // Check Redis cache\n    tenantId = await redis.get(`inbox:${inboxId}:tenant`)\n    \n    if (!tenantId) {\n      // Lookup from config\n      const tenant = tenants.find(t =\u003e t.front.inboxIds.includes(inboxId))\n      if (!tenant) throw new Error(`Unknown inbox: ${inboxId}`)\n      tenantId = tenant.id\n      \n      // Cache it\n      await redis.set(`inbox:${inboxId}:tenant`, tenantId, { ex: 3600 })\n    }\n    \n    inboxToTenant.set(inboxId, tenantId)\n  }\n  \n  return getTenant(tenantId)\n}\n\nexport function getTenant(tenantId: string): TenantConfig {\n  const tenant = tenants.find(t =\u003e t.id === tenantId)\n  if (!tenant) throw new Error(`Unknown tenant: ${tenantId}`)\n  return tenant\n}\n```\n\n## Tenant Context in Inngest Events\n\n```typescript\n// All support events include tenant\ninterface SupportEvent {\n  name: `support/${string}`\n  data: {\n    tenantId: string\n    // ... event-specific data\n  }\n}\n\n// Example\nawait inngest.send({\n  name: 'support/conversation.received',\n  data: {\n    tenantId: 'egghead',\n    conversationId: 'cnv_xxx',\n    email: 'user@example.com',\n    // ...\n  }\n})\n```\n\n## Implementation\n\n1. Create `lib/support/tenants/` directory structure\n2. Define TenantConfig type with Zod validation\n3. Create tenant registry with initial egghead config\n4. Build inbox ‚Üí tenant routing with caching\n5. Create getTenant/getTenantFromInbox helpers\n6. Add tenant validation middleware for Inngest functions\n7. Document env vars needed per tenant","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:04:12.476644-08:00","updated_at":"2025-12-11T10:04:12.476644-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.17","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T10:04:12.477063-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.2","title":"Build AI issue classifier (auth/access/progress/content/billing/team)","description":"Build AI issue classifier using structured output.\n\nCategories:\n- AUTH: Login issues, password reset, OAuth, \"can't sign in\"\n- ACCESS: Pro access lost, entitlements, \"can't watch\", paywall\n- PROGRESS: Course progress missing, completion status, certificates\n- CONTENT: Video won't play, lesson missing, 404 errors\n- BILLING: Refund request, double charge, invoice, subscription\n- TEAM: Team access, seats, invites, member management\n- OTHER: Escalate to human\n\nImplementation:\n```typescript\nconst classifyIssue = inngest.createFunction(\n  { id: 'classify-support-issue' },\n  { event: 'support/conversation.received' },\n  async ({ event, step }) =\u003e {\n    const classification = await step.run('classify', async () =\u003e {\n      return openai.chat.completions.create({\n        model: 'gpt-4o',\n        messages: [{\n          role: 'system',\n          content: `Classify this support request into one category:\n            AUTH, ACCESS, PROGRESS, CONTENT, BILLING, TEAM, OTHER\n            \n            Also extract:\n            - urgency (low/medium/high/critical)\n            - sentiment (frustrated/neutral/positive)\n            - specific_issue (e.g., \"password_reset\", \"refund_request\")\n            - can_auto_resolve (boolean)`\n        }, {\n          role: 'user',\n          content: `Subject: ${event.data.subject}\\n\\n${event.data.body}`\n        }],\n        response_format: { type: 'json_schema', ... }\n      })\n    })\n    \n    // Route to appropriate resolver\n    await step.sendEvent('route', {\n      name: `support/issue.${classification.category.toLowerCase()}`,\n      data: { ...event.data, classification }\n    })\n  }\n)\n```","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:58:46.769268-08:00","updated_at":"2025-12-11T09:59:04.571343-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.2","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T09:58:46.769616-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.3","title":"Build diagnostic engine - gather all user context automatically","description":"Build diagnostic engine with pluggable tenant adapters.\n\n## Multi-Tenant Diagnostic Architecture\n\nEach tenant has different database schemas, so diagnostics are pluggable:\n\n```typescript\n// Core interface - all tenants implement this\ninterface DiagnosticAdapter {\n  tenantId: string\n  \n  // Required methods\n  getUserByEmail(email: string): Promise\u003cTenantUser | null\u003e\n  getEntitlements(userId: string): Promise\u003cEntitlement[]\u003e\n  getSubscription(userId: string): Promise\u003cSubscription | null\u003e\n  getProgress(userId: string): Promise\u003cProgressSummary\u003e\n  getRecentErrors(userId: string): Promise\u003cErrorLog[]\u003e\n  \n  // Optional tenant-specific\n  getMigrationStatus?(userId: string): Promise\u003cMigrationStatus\u003e  // egghead only\n  getTeamMembership?(userId: string): Promise\u003cTeamMembership\u003e    // if teams supported\n}\n\n// Normalized output - same shape regardless of tenant\ninterface UserDiagnostic {\n  tenantId: string\n  \n  user: {\n    id: string\n    email: string\n    name: string\n    createdAt: Date\n    lastLoginAt: Date\n    authProviders: string[]\n  }\n  \n  entitlements: {\n    type: string\n    source: 'subscription' | 'purchase' | 'gift' | 'team' | 'manual'\n    expiresAt: Date | null\n    isActive: boolean\n  }[]\n  \n  subscription: {\n    status: string\n    provider: 'stripe'\n    customerId: string\n    subscriptionId: string\n    currentPeriodEnd: Date\n    cancelAtPeriodEnd: boolean\n  } | null\n  \n  progress: {\n    itemsStarted: number\n    itemsCompleted: number\n    lastActivityAt: Date\n  }\n  \n  recentErrors: {\n    type: string\n    message: string\n    timestamp: Date\n  }[]\n  \n  // Tenant-specific extensions\n  extensions: Record\u003cstring, unknown\u003e\n}\n```\n\n## Tenant Adapters\n\n```typescript\n// lib/support/adapters/egghead.ts\nexport class EggheadDiagnosticAdapter implements DiagnosticAdapter {\n  tenantId = 'egghead'\n  \n  private db: PlanetScaleConnection\n  \n  async getUserByEmail(email: string) {\n    return this.db.query.users.findFirst({\n      where: eq(users.email, email)\n    })\n  }\n  \n  async getMigrationStatus(userId: string) {\n    // egghead-specific: check Rails migration status\n    return {\n      railsUserId: user.railsUserId,\n      migratedAt: user.migratedAt,\n      progressMigrated: user.progressMigrated,\n      hasDataDiscrepancy: await this.checkDiscrepancy(userId)\n    }\n  }\n  \n  // ... implement all methods\n}\n\n// lib/support/adapters/totaltypescript.ts\nexport class TotalTypeScriptDiagnosticAdapter implements DiagnosticAdapter {\n  tenantId = 'totaltypescript'\n  // Different schema, same interface\n}\n\n// Registry\nconst adapters: Record\u003cstring, DiagnosticAdapter\u003e = {\n  egghead: new EggheadDiagnosticAdapter(),\n  totaltypescript: new TotalTypeScriptDiagnosticAdapter(),\n}\n\nexport function getDiagnosticAdapter(tenantId: string): DiagnosticAdapter {\n  const adapter = adapters[tenantId]\n  if (!adapter) throw new Error(`Unknown tenant: ${tenantId}`)\n  return adapter\n}\n```\n\n## Usage in Support Flow\n\n```typescript\n// In classifier/resolver\nconst tenant = await getTenantFromInbox(inboxId)\nconst adapter = getDiagnosticAdapter(tenant.id)\nconst diagnostic = await adapter.getUserByEmail(senderEmail)\n\n// Diagnostic is normalized - resolvers don't care which tenant\nconst context = buildContext(diagnostic)\n```","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:58:46.802487-08:00","updated_at":"2025-12-11T10:03:49.942801-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.3","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T09:58:46.802822-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.4","title":"Build auto-resolver: AUTH issues (password reset, OAuth re-link)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:58:46.836826-08:00","updated_at":"2025-12-11T09:58:46.836826-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.4","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T09:58:46.837177-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.5","title":"Build auto-resolver: ACCESS issues (entitlement check, manual grant)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:58:46.870373-08:00","updated_at":"2025-12-11T09:58:46.870373-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.5","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T09:58:46.870723-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.6","title":"Build auto-resolver: PROGRESS issues (re-sync from Rails)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:58:46.902737-08:00","updated_at":"2025-12-11T09:58:46.902737-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.6","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T09:58:46.903074-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.7","title":"Build canned response generator with dynamic data injection","description":"Build canned response generator with dynamic data injection.\n\nTemplates for each issue type with placeholders:\n\n```typescript\nconst templates = {\n  auth_password_reset: {\n    subject: 'Password Reset Link Sent',\n    body: `Hi {{firstName}},\n\nI've sent a password reset link to {{email}}. Please check your inbox (and spam folder) - it should arrive within a few minutes.\n\nClick the link to set a new password and you'll be back in action.\n\nIf you don't receive it within 10 minutes, let me know and I'll look into it further.\n\nCheers,\negghead Support`\n  },\n  \n  access_restored: {\n    subject: 'Your Pro Access Has Been Restored',\n    body: `Hi {{firstName}},\n\nGood news - I've restored your Pro access. You should now be able to watch all lessons without any issues.\n\n**What happened:** {{diagnosisSummary}}\n\n**What I did:** {{actionTaken}}\n\nYour access is now active until {{accessExpiresAt}}.\n\nLet me know if you run into any other issues!\n\nCheers,\negghead Support`\n  },\n  \n  progress_resynced: {\n    subject: 'Your Course Progress Has Been Restored',\n    body: `Hi {{firstName}},\n\nI've re-synced your course progress from our records. Here's what was restored:\n\n- **Courses completed:** {{coursesCompleted}}\n- **Lessons completed:** {{lessonsCompleted}}\n- **Last activity:** {{lastActivityAt}}\n\nEverything should be back to normal now. If anything looks off, just reply to this email.\n\nCheers,\negghead Support`\n  },\n  \n  // ... more templates\n}\n\n// Injection function\nfunction generateResponse(template: string, diagnostic: UserDiagnostic, action: ActionResult) {\n  return template\n    .replace('{{firstName}}', diagnostic.user.name?.split(' ')[0] || 'there')\n    .replace('{{email}}', diagnostic.user.email)\n    .replace('{{diagnosisSummary}}', action.diagnosis)\n    .replace('{{actionTaken}}', action.summary)\n    // ... etc\n}\n```","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:58:46.936024-08:00","updated_at":"2025-12-11T09:59:19.772625-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.7","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T09:58:46.936356-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.8","title":"Add push-button actions to Front plugin (fix auth, grant access, resync)","description":"Add push-button actions to Front plugin for support agents.\n\nNew component: MigrationActions.tsx\n\nActions available:\n1. **Fix Auth** - One click to:\n   - Send password reset email\n   - Re-link OAuth providers\n   - Clear stale sessions\n\n2. **Grant Access** - One click to:\n   - Create manual entitlement (24h, 7d, 30d, permanent)\n   - With reason field for audit trail\n\n3. **Resync Progress** - One click to:\n   - Pull progress from Rails backup\n   - Merge with Coursebuilder data\n   - Show diff before applying\n\n4. **Resync Subscription** - One click to:\n   - Fetch latest from Stripe\n   - Update local records\n   - Recalculate entitlements\n\n5. **View Full Diagnostic** - Expandable panel showing:\n   - Migration status\n   - All entitlements\n   - Subscription details\n   - Recent errors\n   - Data discrepancies\n\n6. **Generate Response** - AI-powered:\n   - Based on diagnostic + conversation\n   - Editable before sending\n   - Tracks what was auto-generated\n\n```tsx\n\u003cMigrationActions \n  email={userEmail}\n  onAction={(action, result) =\u003e {\n    // Log action for audit\n    // Update conversation tags\n    // Optionally auto-send response\n  }}\n/\u003e\n```","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:58:46.969677-08:00","updated_at":"2025-12-11T09:59:26.559654-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.8","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T09:58:46.970033-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-1rx.9","title":"Build proactive monitor: detect users with broken state post-migration","description":"Build proactive monitor that detects broken user states BEFORE they contact support.\n\nRuns as Inngest cron (every hour during migration, daily after):\n\n```typescript\nconst proactiveMonitor = inngest.createFunction(\n  { id: 'proactive-support-monitor' },\n  { cron: '0 * * * *' }, // Every hour\n  async ({ step }) =\u003e {\n    // 1. Find users with subscription but no entitlement\n    const missingEntitlements = await step.run('check-entitlements', () =\u003e\n      db.query(`\n        SELECT u.* FROM users u\n        JOIN subscriptions s ON s.user_id = u.id\n        WHERE s.status = 'active'\n        AND NOT EXISTS (\n          SELECT 1 FROM entitlements e \n          WHERE e.user_id = u.id AND e.deleted_at IS NULL\n        )\n      `)\n    )\n    \n    // 2. Find users who logged in but hit access errors\n    const accessErrors = await step.run('check-access-errors', () =\u003e\n      getRecentErrors({ type: 'ACCESS_DENIED', since: '1 hour ago' })\n    )\n    \n    // 3. Find users with progress in Rails but not in CB\n    const missingProgress = await step.run('check-progress', () =\u003e\n      db.query(`\n        SELECT u.* FROM users u\n        WHERE u.rails_user_id IS NOT NULL\n        AND u.progress_migrated = false\n        AND u.last_login_at \u003e NOW() - INTERVAL '24 hours'\n      `)\n    )\n    \n    // 4. Auto-fix what we can\n    for (const user of missingEntitlements) {\n      await step.run(`fix-entitlement-${user.id}`, () =\u003e\n        createEntitlementFromSubscription(user)\n      )\n      await step.run(`notify-${user.id}`, () =\u003e\n        sendEmail(user, 'proactive_access_fixed')\n      )\n    }\n    \n    // 5. Alert on things we can't auto-fix\n    if (accessErrors.length \u003e 10) {\n      await step.run('alert-spike', () =\u003e\n        slack.send('#support-alerts', `‚ö†Ô∏è Access error spike: ${accessErrors.length} in last hour`)\n      )\n    }\n  }\n)\n```\n\nThis catches issues before users even notice them.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T09:58:46.999495-08:00","updated_at":"2025-12-11T09:59:34.922628-08:00","dependencies":[{"issue_id":"migrate-egghead-1rx.9","depends_on_id":"migrate-egghead-1rx","type":"parent-child","created_at":"2025-12-11T09:58:46.999824-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-2gb","title":"Migrate Front.com support plugin to Coursebuilder APIs","description":"The skill-front-integration submodule contains a Front.com plugin for support operations. Currently it calls Rails GraphQL/REST APIs. After migration, these need to point to Coursebuilder.\n\nCurrent capabilities (see skill-front-integration/src/trpc/router/egghead.ts):\n- getUserByEmail - lookup user by email\n- transferEmail - change user email\n- refundPurchase - process refunds via Rails API\n- transferPurchase - transfer purchase to another user\n- createCoupon - generate discount coupons\n\nPost-migration requirements:\n1. Update API endpoints from app.egghead.io to Coursebuilder\n2. Replace GraphQL calls with tRPC or REST\n3. Update Stripe account IDs in front-inboxes.json\n4. Test all support workflows end-to-end\n\nThis is P2 because support can use Stripe dashboard directly during transition.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T09:56:42.909587-08:00","updated_at":"2025-12-11T09:56:42.909587-08:00"}
{"id":"migrate-egghead-30z","title":"Complete Video Migration: All egghead videos on Mux","description":"**Goal**: Every egghead lesson serves video from Mux. No CloudFront, no Wistia fallbacks.\n\n## Current State (Dec 12, 2025)\n- **SQLite migrated (ID ‚â§ 10388)**: 6,764 on Mux, but Rails doesn't know\n- **Gap lessons (ID 10389-10684)**: 152 need upload, then Rails backfill\n- **Coursebuilder (ID 10685+)**: 391 already on Mux\n- **Rails `current_video_hls_url`**: Mix of CloudFront, Mux, and null\n\n## End State\n1. All videos have `mux_asset_id` (SQLite) or `muxPlaybackId` (Coursebuilder)\n2. All Rails lessons have `current_video_hls_url` pointing to Mux\n3. egghead-next serves ALL videos from Mux\n4. CloudFront can be deprecated (cost savings)\n\n## Dependencies\n- Mux API credentials\n- Rails DATABASE_URL (write access for backfill)\n- NAS access for any missing source files","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-12T08:05:42.274488-08:00","updated_at":"2025-12-12T08:05:42.274488-08:00"}
{"id":"migrate-egghead-30z.1","title":"Execute gap lesson upload to Mux (152 videos)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T08:05:42.313288-08:00","updated_at":"2025-12-12T08:13:33.972459-08:00","closed_at":"2025-12-12T08:13:33.972459-08:00","dependencies":[{"issue_id":"migrate-egghead-30z.1","depends_on_id":"migrate-egghead-30z","type":"parent-child","created_at":"2025-12-12T08:05:42.313608-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-30z.2","title":"Backfill Rails with Mux URLs for gap lessons","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T08:05:42.350393-08:00","updated_at":"2025-12-12T08:28:33.401978-08:00","closed_at":"2025-12-12T08:28:33.401978-08:00","dependencies":[{"issue_id":"migrate-egghead-30z.2","depends_on_id":"migrate-egghead-30z","type":"parent-child","created_at":"2025-12-12T08:05:42.350814-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-30z.3","title":"Backfill Rails with Mux URLs for SQLite-migrated lessons (ID ‚â§ 10388)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T08:05:42.38161-08:00","updated_at":"2025-12-12T08:05:42.38161-08:00","dependencies":[{"issue_id":"migrate-egghead-30z.3","depends_on_id":"migrate-egghead-30z","type":"parent-child","created_at":"2025-12-12T08:05:42.381912-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-30z.4","title":"Audit lessons with missing videos (193 in SQLite)","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T08:05:42.414727-08:00","updated_at":"2025-12-12T08:05:42.414727-08:00","dependencies":[{"issue_id":"migrate-egghead-30z.4","depends_on_id":"migrate-egghead-30z","type":"parent-child","created_at":"2025-12-12T08:05:42.415072-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-30z.5","title":"Verify all published lessons have Mux URLs in Rails","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T08:05:42.448036-08:00","updated_at":"2025-12-12T08:05:42.448036-08:00","dependencies":[{"issue_id":"migrate-egghead-30z.5","depends_on_id":"migrate-egghead-30z","type":"parent-child","created_at":"2025-12-12T08:05:42.448378-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-30z.6","title":"Update egghead-next to remove CloudFront fallback logic","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T08:05:42.485854-08:00","updated_at":"2025-12-12T08:05:42.485854-08:00","dependencies":[{"issue_id":"migrate-egghead-30z.6","depends_on_id":"migrate-egghead-30z","type":"parent-child","created_at":"2025-12-12T08:05:42.486165-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-30z.7","title":"Document video URL resolution for Coursebuilder migration","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T08:05:42.518933-08:00","updated_at":"2025-12-12T08:05:42.518933-08:00","dependencies":[{"issue_id":"migrate-egghead-30z.7","depends_on_id":"migrate-egghead-30z","type":"parent-child","created_at":"2025-12-12T08:05:42.519286-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-341","title":"Data Integrity \u0026 Safety Infrastructure","description":"Critical infrastructure for safe migration: CDC mechanism, idempotency layer, reconciliation jobs, and drift detection. Must be complete BEFORE dual-write phase begins.\n\nKey decisions:\n- CDC: Application-level dual-write with idempotency keys + reconciliation (Option C)\n- Redis Streams via Upstash for event log\n- Daily reconciliation with Slack alerts on drift","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:52:49.843078-08:00","updated_at":"2025-12-12T09:26:03.761539-08:00","closed_at":"2025-12-12T09:26:03.761539-08:00"}
{"id":"migrate-egghead-341.1","title":"Add stripe_event_id column to all mutation tables","description":"## Context\nAdd `stripe_event_id` column to all Stripe-related mutation tables in Coursebuilder to enable webhook idempotency. Prevents duplicate processing when Stripe retries webhooks.\n\n## Files to Reference\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/commerce.ts` - Main commerce tables\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/entitlements.ts` - Entitlements table\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/migrations/` - Migration examples\n\n## Tables to Update\n1. `purchases` - Created/updated on payment_intent.succeeded\n2. `subscriptions` - Created/updated on customer.subscription.*\n3. `entitlements` - Created/updated when granting access\n\n## Column Specification\n```typescript\nstripeEventId: varchar('stripe_event_id', { length: 191 }).index()\n```\n- varchar(191) for MySQL utf8mb4 compatibility\n- Indexed for fast deduplication lookups\n- Nullable (existing rows won't have values)\n\n## Acceptance Criteria\n- [ ] All Stripe-mutating tables have `stripe_event_id` column\n- [ ] Drizzle schema files updated\n- [ ] Migration file generated and tested\n- [ ] `pnpm db:push` succeeds\n\n## Dependencies\nNone - must complete before migrate-egghead-341.2","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:52:49.875116-08:00","updated_at":"2025-12-11T10:59:46.545774-08:00","dependencies":[{"issue_id":"migrate-egghead-341.1","depends_on_id":"migrate-egghead-341","type":"parent-child","created_at":"2025-12-11T09:52:49.875474-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-341.2","title":"Implement webhook deduplication check in process-stripe-webhook.ts","description":"## Context\nImplement webhook event deduplication in Coursebuilder's Stripe webhook processor. Stripe retries failed webhooks up to 3 days - we must handle the same event multiple times gracefully.\n\n## Files to Reference\n- `course-builder/apps/*/inngest/functions/stripe/process-stripe-webhook.ts` - Main webhook processor\n- `egghead-rails/app/services/stripe/webhook_event_processor.rb` - Rails reference\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/commerce.ts` - Tables with stripe_event_id\n\n## Implementation Pattern\n```typescript\nexport const processStripeWebhook = inngest.createFunction(\n  { id: 'stripe-webhook-processor' },\n  { event: 'stripe/webhook.received' },\n  async ({ event, step }) =\u003e {\n    const stripeEvent = event.data\n    const eventId = stripeEvent.id // evt_xxx\n\n    // Early return for duplicate events\n    const isDuplicate = await step.run('check-duplicate', async () =\u003e {\n      return await checkEventProcessed(eventId, stripeEvent.type)\n    })\n\n    if (isDuplicate) {\n      console.log(`Skipping duplicate event: ${eventId}`)\n      return { status: 'skipped', reason: 'duplicate' }\n    }\n\n    // Process event and store event_id in mutations\n    await step.run('process-event', async () =\u003e {\n      return await processEventWithId(stripeEvent)\n    })\n  }\n)\n```\n\n## Event Types to Handle\n- `payment_intent.succeeded`\n- `customer.subscription.created/updated/deleted`\n- `invoice.payment_succeeded/failed`\n- `charge.refunded`\n\n## Acceptance Criteria\n- [ ] Deduplication check runs before any webhook processing\n- [ ] Duplicate events return early without mutations\n- [ ] All database mutations include stripe_event_id\n- [ ] Manual test: Send same webhook twice, verify only one mutation\n- [ ] No race conditions with concurrent webhooks\n\n## Dependencies\n**MUST COMPLETE FIRST:** migrate-egghead-341.1 (stripe_event_id columns)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:52:49.907979-08:00","updated_at":"2025-12-11T10:59:51.114673-08:00","dependencies":[{"issue_id":"migrate-egghead-341.2","depends_on_id":"migrate-egghead-341","type":"parent-child","created_at":"2025-12-11T09:52:49.908305-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-341.3","title":"Add idempotency key generation for outbound Stripe API calls","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:52:49.939876-08:00","updated_at":"2025-12-11T09:52:49.939876-08:00","dependencies":[{"issue_id":"migrate-egghead-341.3","depends_on_id":"migrate-egghead-341","type":"parent-child","created_at":"2025-12-11T09:52:49.940202-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-341.4","title":"Build daily reconciliation Inngest cron (PG vs PlanetScale checksums)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:52:49.97211-08:00","updated_at":"2025-12-11T09:52:49.97211-08:00","dependencies":[{"issue_id":"migrate-egghead-341.4","depends_on_id":"migrate-egghead-341","type":"parent-child","created_at":"2025-12-11T09:52:49.972452-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-341.5","title":"Build drift detection alerts (Slack notification on divergence)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:52:50.004197-08:00","updated_at":"2025-12-11T09:52:50.004197-08:00","dependencies":[{"issue_id":"migrate-egghead-341.5","depends_on_id":"migrate-egghead-341","type":"parent-child","created_at":"2025-12-11T09:52:50.004512-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-341.6","title":"Set up Redis Streams event log for migration events","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T09:52:50.03716-08:00","updated_at":"2025-12-11T09:52:50.03716-08:00","dependencies":[{"issue_id":"migrate-egghead-341.6","depends_on_id":"migrate-egghead-341","type":"parent-child","created_at":"2025-12-11T09:52:50.037515-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-341.7","title":"Build rollback test: verify can flip back to Rails/Sidekiq","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T09:52:50.071531-08:00","updated_at":"2025-12-11T09:52:50.071531-08:00","dependencies":[{"issue_id":"migrate-egghead-341.7","depends_on_id":"migrate-egghead-341","type":"parent-child","created_at":"2025-12-11T09:52:50.071885-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-34t","title":"SEO Safety - Zero 404s Migration","description":"Protect organic traffic during migration. No 404s allowed. Staged rollout with monitoring.\n\nKey URLs to preserve:\n- /lessons/[slug] (5,132 lessons)\n- /courses/[slug] (420 courses)\n- /q/[...params] (massive sitemap from topic combinations)\n- /i/[slug] -\u003e /instructors/[slug] (134 instructors)\n\nMonitoring: Google Search Console, 404 alerts, sitemap diff","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:53:13.879743-08:00","updated_at":"2025-12-11T09:53:13.879743-08:00"}
{"id":"migrate-egghead-34t.1","title":"Generate pre-migration sitemap snapshot (all URLs)","description":"## Context\nBefore migrating from egghead-next to Coursebuilder, capture a complete snapshot of all live URLs to ensure zero 404s post-migration. egghead.io has ~420 courses, ~5,132 lessons, and ~800k topic combination URLs that drive significant organic traffic.\n\n## Files to Reference\n- `egghead-next/next-sitemap.js` - Main sitemap config\n- `egghead-next/tags-sitemap.js` - Topic combination URL generator\n- `download-egghead/egghead_videos.db` - SQLite DB with course/lesson slugs\n\n## Implementation\n1. Fetch all sitemap files from egghead.io:\n   - `sitemap.xml` (index)\n   - `sitemap-0.xml` through `sitemap-N.xml`\n   - `tags-sitemap-0.xml` through `tags-sitemap-15.xml` (~800k topic URLs)\n2. Parse and normalize URLs (strip domain, dedupe)\n3. Group by route pattern: `/courses/[slug]`, `/lessons/[slug]`, `/q/[tags]`, etc.\n4. Cross-reference with SQLite DB for discrepancies\n\n## Output Format\nSave to `reports/sitemap-snapshot-pre-migration.json`:\n```json\n{\n  \"generated_at\": \"2025-12-11T00:00:00Z\",\n  \"total_urls\": 850000,\n  \"urls_by_pattern\": {\n    \"/courses/[slug]\": { \"count\": 420, \"urls\": [...] },\n    \"/lessons/[slug]\": { \"count\": 5132, \"urls\": [...] },\n    \"/q/[tags]\": { \"count\": 800000, \"sample_urls\": [...] }\n  }\n}\n```\n\n## Acceptance Criteria\n- [ ] JSON snapshot with 850k+ URLs cataloged\n- [ ] URLs grouped by pattern\n- [ ] Cross-reference with SQLite shows \u003c1% discrepancies\n- [ ] Topic combination URLs extracted (most critical for SEO)\n\n## Dependencies\nNone - first step in SEO safety epic","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:13.917896-08:00","updated_at":"2025-12-11T11:00:01.716464-08:00","dependencies":[{"issue_id":"migrate-egghead-34t.1","depends_on_id":"migrate-egghead-34t","type":"parent-child","created_at":"2025-12-11T09:53:13.918251-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-34t.2","title":"Build sitemap diff tool (compare pre/post migration)","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:13.950193-08:00","updated_at":"2025-12-11T09:53:13.950193-08:00","dependencies":[{"issue_id":"migrate-egghead-34t.2","depends_on_id":"migrate-egghead-34t","type":"parent-child","created_at":"2025-12-11T09:53:13.95053-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-34t.3","title":"Set up Google Search Console monitoring alerts","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:13.981926-08:00","updated_at":"2025-12-11T09:53:13.981926-08:00","dependencies":[{"issue_id":"migrate-egghead-34t.3","depends_on_id":"migrate-egghead-34t","type":"parent-child","created_at":"2025-12-11T09:53:13.982248-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-34t.4","title":"Build 404 monitoring with Slack alerts (immediate notification)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:14.014244-08:00","updated_at":"2025-12-11T09:53:14.014244-08:00","dependencies":[{"issue_id":"migrate-egghead-34t.4","depends_on_id":"migrate-egghead-34t","type":"parent-child","created_at":"2025-12-11T09:53:14.014578-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-34t.5","title":"Implement staged rollout: lessons first (test 100 URLs)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:14.047078-08:00","updated_at":"2025-12-11T09:53:14.047078-08:00","dependencies":[{"issue_id":"migrate-egghead-34t.5","depends_on_id":"migrate-egghead-34t","type":"parent-child","created_at":"2025-12-11T09:53:14.047402-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-34t.6","title":"Implement staged rollout: courses second (test 50 URLs)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:14.078939-08:00","updated_at":"2025-12-11T09:53:14.078939-08:00","dependencies":[{"issue_id":"migrate-egghead-34t.6","depends_on_id":"migrate-egghead-34t","type":"parent-child","created_at":"2025-12-11T09:53:14.079292-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-34t.7","title":"Implement staged rollout: search pages last (/q/[[...all]])","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T09:53:14.110959-08:00","updated_at":"2025-12-11T09:53:14.110959-08:00","dependencies":[{"issue_id":"migrate-egghead-34t.7","depends_on_id":"migrate-egghead-34t","type":"parent-child","created_at":"2025-12-11T09:53:14.111352-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-34t.8","title":"Build comprehensive redirect map in next.config.ts","description":"## Context\nImplement 301/308 redirects in Coursebuilder's `next.config.mjs` to preserve all legacy egghead-next URLs. Must handle 850k+ URLs via pattern matching (not individual redirects).\n\n## Files to Reference\n- `egghead-next/next.config.mjs` - Existing redirect patterns (lines 101-420)\n- `reports/sitemap-snapshot-pre-migration.json` - URLs to redirect\n- `course-builder/apps/egghead/next.config.mjs` - Target redirect config\n\n## Redirect Groups to Port\nFrom egghead-next (100+ existing rules):\n- `teamRoutes` (lines 356-392) - Team features ‚Üí Rails\n- `rssRoutes` (lines 394-420) - RSS feeds ‚Üí Rails\n- `contentCrudRoutes` (lines 333-354) - Content management ‚Üí Rails\n- `apiRoutes` (lines 320-331) - API endpoints ‚Üí Rails\n- `legacyRoutes` (lines 212-298) - Old URLs ‚Üí various\n- `searchRoutes` (lines 203-210) - Search variants ‚Üí /q\n- `instructorRoutes` (lines 184-201) - Instructor pages\n\n## Key Patterns\n```typescript\n// Topic combinations (800k URLs via wildcard)\n{ source: '/q/:tags*', destination: '/search?tags=:tags*', permanent: true }\n\n// Instructor pages\n{ source: '/instructors/:instructor', destination: '/search?instructor=:instructor', permanent: true }\n\n// Rails admin catch-all\n{ source: '/admin/:path*', destination: 'https://app.egghead.io/admin/:path*', statusCode: 308 }\n```\n\n## Validation Script\nCreate `scripts/validate-redirects.ts` to test all URLs from snapshot are covered.\n\n## Acceptance Criteria\n- [ ] All 100+ existing egghead-next redirects ported\n- [ ] Topic combination URLs handled via wildcard\n- [ ] Validation script passes 100%\n- [ ] No redirect chains \u003e2 hops\n- [ ] Status codes correct (301 for content, 308 for API)\n\n## Dependencies\n- Task 34t.1 complete (need URL snapshot)\n- Task 34t.2 complete (need diff results)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:14.144386-08:00","updated_at":"2025-12-11T11:00:12.532562-08:00","dependencies":[{"issue_id":"migrate-egghead-34t.8","depends_on_id":"migrate-egghead-34t","type":"parent-child","created_at":"2025-12-11T09:53:14.144736-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-39p","title":"Kill egghead-rails and egghead-next","description":"Migrate egghead.io (699K users, 420 courses, 3M progress records) from Rails + Next.js to Coursebuilder (PlanetScale/Inngest). Kill both legacy systems.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T08:38:53.030569-08:00","updated_at":"2025-12-12T09:26:03.860939-08:00","closed_at":"2025-12-12T09:26:03.860939-08:00"}
{"id":"migrate-egghead-39p.1","title":"Schema design: Map Rails models to Coursebuilder","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T08:38:53.063791-08:00","updated_at":"2025-12-11T08:55:23.680972-08:00","closed_at":"2025-12-11T08:55:23.680972-08:00","dependencies":[{"issue_id":"migrate-egghead-39p.1","depends_on_id":"migrate-egghead-39p","type":"parent-child","created_at":"2025-12-11T08:38:53.064183-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-39p.10","title":"DNS + traffic cutover runbook","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T08:38:53.357717-08:00","updated_at":"2025-12-11T08:38:53.357717-08:00","dependencies":[{"issue_id":"migrate-egghead-39p.10","depends_on_id":"migrate-egghead-39p","type":"parent-child","created_at":"2025-12-11T08:38:53.358065-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-39p.2","title":"User/Account migration pipeline (699K users, 94K accounts)","description":"Migrate 699K users and 94K accounts from Rails PostgreSQL to Coursebuilder PlanetScale.\n\n## Overview\n\nThis is the **foundation** - everything else depends on users existing in Coursebuilder.\n\n## Source Data (Rails PostgreSQL)\n\n### Users Table (699K records)\n```sql\nusers {\n  id: serial (PK)\n  email: string (unique, NOT NULL)\n  first_name: string\n  last_name: string\n  avatar_url: string\n  provider: string ('github', 'SAML', null)\n  uid: string (OAuth provider ID)\n  encrypted_password: string\n  authentication_token: string (unique)\n  is_banned: boolean\n  can_contact: boolean\n  kvstore: jsonb (flexible metadata)\n  created_at: timestamp\n  updated_at: timestamp\n  -- Devise fields (sign_in tracking, password reset, etc.)\n}\n```\n\n### Accounts Table (94K records)\n```sql\naccounts {\n  id: serial (PK)\n  name: string\n  slug: string\n  guid: string\n  stripe_customer_id: string (unique)\n  team_invite_id: uuid\n  created_at: timestamp\n}\n```\n\n### Account Users (membership join)\n```sql\naccount_users {\n  id: serial (PK)\n  account_id: bigint (FK)\n  user_id: bigint (FK)\n  created_at: timestamp\n}\n```\n\n## Target Schema (Coursebuilder PlanetScale)\n\n### User Table\n```typescript\n{\n  id: varchar(255) PK,           // Generate new CUID\n  email: varchar(255) UNIQUE,\n  name: varchar(255),            // Combine first_name + last_name\n  role: varchar(191) DEFAULT 'user',\n  image: varchar(255),           // avatar_url\n  fields: json,                  // Store legacy data\n  emailVerified: timestamp,\n  createdAt: timestamp,\n}\n```\n\n### Organization Table (replaces accounts)\n```typescript\n{\n  id: varchar(255) PK,\n  name: varchar(255),\n  fields: json,                  // slug, legacyGuid, etc.\n  image: varchar(255),\n  createdAt: timestamp,\n}\n```\n\n### OrganizationMembership (replaces account_users)\n```typescript\n{\n  id: varchar(255) PK,\n  organizationId: varchar(191) FK,\n  userId: varchar(255) FK,\n  role: varchar(191),            // 'owner', 'member'\n  invitedById: varchar(255),\n  fields: json,\n  createdAt: timestamp,\n}\n```\n\n### MerchantCustomer (Stripe customer link)\n```typescript\n{\n  id: varchar(191) PK,\n  organizationId: varchar(191) FK,\n  userId: varchar(191),\n  merchantAccountId: varchar(191),\n  identifier: varchar(191),      // stripe_customer_id (cus_xxx)\n  status: int,\n  createdAt: timestamp,\n}\n```\n\n## Field Mapping\n\n### User ‚Üí User\n| Rails | Coursebuilder | Notes |\n|-------|---------------|-------|\n| `id` | `fields.legacyId` | Preserve for lookups |\n| `email` | `email` | Direct copy |\n| `first_name + last_name` | `name` | Concatenate |\n| `avatar_url` | `image` | Direct copy |\n| `provider` | `fields.oauthProvider` | For re-linking |\n| `uid` | `fields.oauthUid` | For re-linking |\n| `is_banned` | `fields.isBanned` | Preserve |\n| `can_contact` | `fields.canContact` | Preserve |\n| `kvstore` | `fields.legacy` | Preserve all |\n| `created_at` | `createdAt` | Direct copy |\n\n### Account ‚Üí Organization\n| Rails | Coursebuilder | Notes |\n|-------|---------------|-------|\n| `id` | `fields.legacyId` | Preserve |\n| `name` | `name` | Direct copy |\n| `slug` | `fields.slug` | Preserve |\n| `guid` | `fields.legacyGuid` | Preserve |\n| `stripe_customer_id` | ‚Üí MerchantCustomer | Separate table |\n| `team_invite_id` | `fields.teamInviteId` | Preserve |\n\n## Migration Pipeline (Inngest)\n\n### Phase 1: Users (parallelizable)\n```typescript\n// inngest/functions/migration/migrate-users.ts\nexport const migrateUsers = inngest.createFunction(\n  { id: 'migrate-users', concurrency: 10 },\n  { event: 'migration/users.start' },\n  async ({ step }) =\u003e {\n    // Batch process in chunks of 1000\n    const totalUsers = await step.run('count-users', () =\u003e \n      railsDb.query('SELECT COUNT(*) FROM users')\n    )\n    \n    const batches = Math.ceil(totalUsers / 1000)\n    \n    for (let i = 0; i \u003c batches; i++) {\n      await step.run(`batch-${i}`, async () =\u003e {\n        const users = await railsDb.query(`\n          SELECT * FROM users \n          ORDER BY id \n          LIMIT 1000 OFFSET ${i * 1000}\n        `)\n        \n        const transformed = users.map(transformUser)\n        await cbDb.insert(usersTable).values(transformed)\n      })\n    }\n  }\n)\n```\n\n### Phase 2: Organizations (depends on users)\n```typescript\nexport const migrateOrganizations = inngest.createFunction(\n  { id: 'migrate-organizations' },\n  { event: 'migration/organizations.start' },\n  async ({ step }) =\u003e {\n    // Similar batch pattern\n    // Also creates MerchantCustomer records for stripe_customer_id\n  }\n)\n```\n\n### Phase 3: Memberships (depends on both)\n```typescript\nexport const migrateMemberships = inngest.createFunction(\n  { id: 'migrate-memberships' },\n  { event: 'migration/memberships.start' },\n  async ({ step }) =\u003e {\n    // Join account_users with ID mapping tables\n    // Determine owner vs member role\n  }\n)\n```\n\n## ID Mapping Strategy\n\nCreate temporary mapping tables in Coursebuilder:\n```sql\nCREATE TABLE _migration_user_map (\n  rails_id INT PRIMARY KEY,\n  cb_id VARCHAR(255) NOT NULL,\n  INDEX idx_cb_id (cb_id)\n);\n\nCREATE TABLE _migration_org_map (\n  rails_id INT PRIMARY KEY,\n  cb_id VARCHAR(255) NOT NULL,\n  INDEX idx_cb_id (cb_id)\n);\n```\n\n## Validation Queries\n\nAfter migration, verify:\n```sql\n-- User count matches\nSELECT COUNT(*) FROM User;  -- Should be ~699K\n\n-- Organization count matches  \nSELECT COUNT(*) FROM Organization;  -- Should be ~94K\n\n-- All emails unique\nSELECT email, COUNT(*) FROM User GROUP BY email HAVING COUNT(*) \u003e 1;\n\n-- All Stripe customers linked\nSELECT COUNT(*) FROM MerchantCustomer WHERE identifier LIKE 'cus_%';\n```\n\n## Files to Create/Modify\n\n### New Files\n- `apps/egghead/src/inngest/functions/migration/migrate-users.ts`\n- `apps/egghead/src/inngest/functions/migration/migrate-organizations.ts`\n- `apps/egghead/src/inngest/functions/migration/migrate-memberships.ts`\n- `apps/egghead/src/lib/migration/transforms.ts` (user/org transforms)\n- `apps/egghead/src/lib/migration/rails-db.ts` (read-only Rails connection)\n\n### Reference Files\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/auth/users.ts`\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/org/organizations.ts`\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/commerce/merchant-customer.ts`\n- `egghead-rails/db/schema.rb` (lines 1744-1792 for users)\n\n## Acceptance Criteria\n\n- [ ] All 699K users migrated with email preserved\n- [ ] All 94K accounts migrated as Organizations\n- [ ] All account_users migrated as OrganizationMemberships\n- [ ] All stripe_customer_id values in MerchantCustomer table\n- [ ] Legacy IDs preserved in `fields.legacyId` for all records\n- [ ] OAuth provider/uid preserved for re-linking\n- [ ] ID mapping tables populated for downstream migrations\n- [ ] No duplicate emails in target\n- [ ] Migration is idempotent (can re-run safely)\n\n## Dependencies\n\n- **Blocks**: All other migration tasks (subscriptions, progress, content)\n- **Blocked by**: CDC triggers (migrate-egghead-5qr) - for ongoing sync during migration window\n\n## Estimated Effort\n\n- Transform logic: 2-3 hours\n- Inngest functions: 2-3 hours  \n- Testing with sample data: 2 hours\n- Full migration run: 1-2 hours (699K users @ 1000/batch)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T08:38:53.095563-08:00","updated_at":"2025-12-11T11:08:28.822601-08:00","dependencies":[{"issue_id":"migrate-egghead-39p.2","depends_on_id":"migrate-egghead-39p","type":"parent-child","created_at":"2025-12-11T08:38:53.095887-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-39p.3","title":"Subscription data migration (3,335 active)","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T08:38:53.124845-08:00","updated_at":"2025-12-11T08:38:53.124845-08:00","dependencies":[{"issue_id":"migrate-egghead-39p.3","depends_on_id":"migrate-egghead-39p","type":"parent-child","created_at":"2025-12-11T08:38:53.125173-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-39p.4","title":"Progress data migration (3M records)","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T08:38:53.155437-08:00","updated_at":"2025-12-11T08:38:53.155437-08:00","dependencies":[{"issue_id":"migrate-egghead-39p.4","depends_on_id":"migrate-egghead-39p","type":"parent-child","created_at":"2025-12-11T08:38:53.155764-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-39p.5","title":"Content migration: Courses, lessons, videos (97.5% on Mux)","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T08:38:53.189742-08:00","updated_at":"2025-12-11T08:38:53.189742-08:00","dependencies":[{"issue_id":"migrate-egghead-39p.5","depends_on_id":"migrate-egghead-39p","type":"parent-child","created_at":"2025-12-11T08:38:53.190094-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-39p.6","title":"Stripe webhook handlers (Inngest)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T08:38:53.223268-08:00","updated_at":"2025-12-11T08:38:53.223268-08:00","dependencies":[{"issue_id":"migrate-egghead-39p.6","depends_on_id":"migrate-egghead-39p","type":"parent-child","created_at":"2025-12-11T08:38:53.223594-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-39p.7","title":"Video player + lesson view + search","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T08:38:53.256974-08:00","updated_at":"2025-12-11T08:38:53.256974-08:00","dependencies":[{"issue_id":"migrate-egghead-39p.7","depends_on_id":"migrate-egghead-39p","type":"parent-child","created_at":"2025-12-11T08:38:53.257321-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-39p.8","title":"User profiles + instructor pages","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T08:38:53.290161-08:00","updated_at":"2025-12-11T08:38:53.290161-08:00","dependencies":[{"issue_id":"migrate-egghead-39p.8","depends_on_id":"migrate-egghead-39p","type":"parent-child","created_at":"2025-12-11T08:38:53.290471-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-39p.9","title":"Auth cutover: NextAuth + OAuth migration","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T08:38:53.324795-08:00","updated_at":"2025-12-11T08:38:53.324795-08:00","dependencies":[{"issue_id":"migrate-egghead-39p.9","depends_on_id":"migrate-egghead-39p","type":"parent-child","created_at":"2025-12-11T08:38:53.325148-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-51p","title":"Gift Subscription Migration","description":"Migrate gift subscription system from Rails to Coursebuilder.\n\n## Context\n- 86K total gifts (since 2014)\n- Only 7 currently active (providing access)\n- ~70K unclaimed codes (mostly bulk 1-month from Apr 2023)\n- No balance/credit complexity - just time-boxed access\n\n## Rails Implementation\n- `Gift` model with `claimed_at`, `duration_months`, `expires_at`\n- `Gift::Claim` creates `AccountSubscription` with placeholder Stripe IDs\n- `Gift::Expiration` marks subscription `unpaid` on expiry\n- `GiftExpirationWorker` cron job for expiration checks\n- 2 emails: `expiration_reminder`, `expired_gift_notification`\n\n## Key Constraints (from Rails)\n- Cannot apply to team accounts\n- Cannot apply if user has active subscription\n- Optional email lock (`lock_to_email`)\n- Uses placeholder Stripe IDs (not real Stripe objects)\n\n## Migration Tasks\n1. Identify gift subscriptions (`stripe_subscription_id LIKE 'gift_%'` or join to gifts table)\n2. Migrate 7 active as time-limited purchases/entitlements in Coursebuilder\n3. Migrate valid unclaimed codes as redeemable coupons (100% off, X months)\n4. Port `GiftExpirationWorker` to Inngest scheduled job\n5. Port 2 gift emails to Customer.io\n\n## Coursebuilder Model\nGifts ‚Üí Purchases with:\n- `expiresAt` timestamp\n- Entitlement type: `pro_access`\n- Duration from original gift\n\n## Files to Reference\n- `egghead-rails/app/models/gift.rb`\n- `egghead-rails/app/models/gift/claim.rb`\n- `egghead-rails/app/models/gift/expiration.rb`\n- `egghead-rails/app/workers/gift_expiration_worker.rb`\n- `egghead-rails/app/mailers/gift_mailer.rb`","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:49:27.994641-08:00","updated_at":"2025-12-11T10:49:27.994641-08:00"}
{"id":"migrate-egghead-5bk","title":"Phase 2: Webhook Handlers + Integration Tests","description":"Implement the STUB Inngest handlers for Stripe subscription events. Currently all 3 subscription handlers have TODO comments and no DB updates. This phase makes them production-ready with full E2E Stripe flow testing. Gate: All handlers implemented, unit tests pass, E2E checkout/cancel flows work.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:29:07.749203-08:00","updated_at":"2025-12-12T09:25:57.175602-08:00","closed_at":"2025-12-12T09:25:57.175602-08:00"}
{"id":"migrate-egghead-5bk.1","title":"Implement subscription.created Inngest handler (replace TODO stub)","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:07.780766-08:00","updated_at":"2025-12-11T09:29:07.780766-08:00","dependencies":[{"issue_id":"migrate-egghead-5bk.1","depends_on_id":"migrate-egghead-5bk","type":"parent-child","created_at":"2025-12-11T09:29:07.781066-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5bk.2","title":"Implement subscription.updated Inngest handler (replace TODO stub)","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:07.814372-08:00","updated_at":"2025-12-11T09:29:07.814372-08:00","dependencies":[{"issue_id":"migrate-egghead-5bk.2","depends_on_id":"migrate-egghead-5bk","type":"parent-child","created_at":"2025-12-11T09:29:07.814704-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5bk.3","title":"Create subscription.deleted Inngest handler (currently MISSING)","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:07.848801-08:00","updated_at":"2025-12-11T09:29:07.848801-08:00","dependencies":[{"issue_id":"migrate-egghead-5bk.3","depends_on_id":"migrate-egghead-5bk","type":"parent-child","created_at":"2025-12-11T09:29:07.849128-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5bk.4","title":"Implement invoice.payment_succeeded handler with 1-min delay","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:07.882369-08:00","updated_at":"2025-12-11T09:29:07.882369-08:00","dependencies":[{"issue_id":"migrate-egghead-5bk.4","depends_on_id":"migrate-egghead-5bk","type":"parent-child","created_at":"2025-12-11T09:29:07.882705-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5bk.5","title":"Unit tests for all Inngest subscription handlers","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:07.915123-08:00","updated_at":"2025-12-11T09:29:07.915123-08:00","dependencies":[{"issue_id":"migrate-egghead-5bk.5","depends_on_id":"migrate-egghead-5bk","type":"parent-child","created_at":"2025-12-11T09:29:07.915465-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5bk.6","title":"E2E: Test Stripe checkout flow ‚Üí entitlement granted","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:07.948062-08:00","updated_at":"2025-12-11T09:29:07.948062-08:00","dependencies":[{"issue_id":"migrate-egghead-5bk.6","depends_on_id":"migrate-egghead-5bk","type":"parent-child","created_at":"2025-12-11T09:29:07.948409-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5bk.7","title":"E2E: Test subscription cancel ‚Üí access revoked","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:07.980259-08:00","updated_at":"2025-12-11T09:29:07.980259-08:00","dependencies":[{"issue_id":"migrate-egghead-5bk.7","depends_on_id":"migrate-egghead-5bk","type":"parent-child","created_at":"2025-12-11T09:29:07.980597-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5bk.8","title":"[HUMAN] Review webhook handlers + approve for shadow mode","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:08.012692-08:00","updated_at":"2025-12-11T09:29:08.012692-08:00","dependencies":[{"issue_id":"migrate-egghead-5bk.8","depends_on_id":"migrate-egghead-5bk","type":"parent-child","created_at":"2025-12-11T09:29:08.013008-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5qr","title":"CDC via PostgreSQL Triggers","description":"Implement Change Data Capture using PostgreSQL database triggers (no Rails app changes).\n\n## Chosen Approach: Option A - CDC Table + Polling\n\n**Why this approach:**\n- Simplest, most debuggable\n- No infrastructure overhead (no Debezium, no persistent connections)\n- Visible queue - if something breaks, you can see it\n- Coursebuilder Inngest job polls every 30s\n\n## Implementation\n\n### 1. CDC Events Table (add to Rails PostgreSQL)\n```sql\nCREATE TABLE cdc_events (\n  id SERIAL PRIMARY KEY,\n  table_name VARCHAR(255) NOT NULL,\n  operation VARCHAR(10) NOT NULL, -- INSERT/UPDATE/DELETE\n  record_id BIGINT NOT NULL,\n  old_data JSONB,\n  new_data JSONB,\n  processed_at TIMESTAMP,\n  created_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE INDEX idx_cdc_events_unprocessed ON cdc_events (created_at) WHERE processed_at IS NULL;\n```\n\n### 2. Trigger Function\n```sql\nCREATE OR REPLACE FUNCTION cdc_capture() RETURNS TRIGGER AS $$\nBEGIN\n  INSERT INTO cdc_events (table_name, operation, record_id, old_data, new_data)\n  VALUES (\n    TG_TABLE_NAME,\n    TG_OP,\n    COALESCE(NEW.id, OLD.id),\n    CASE WHEN TG_OP = 'DELETE' THEN row_to_json(OLD) ELSE NULL END,\n    CASE WHEN TG_OP != 'DELETE' THEN row_to_json(NEW) ELSE NULL END\n  );\n  RETURN COALESCE(NEW, OLD);\nEND;\n$$ LANGUAGE plpgsql;\n```\n\n### 3. Attach to Tables (priority order)\n```sql\n-- Subscriptions (most critical)\nCREATE TRIGGER cdc_account_subscriptions\n  AFTER INSERT OR UPDATE OR DELETE ON account_subscriptions\n  FOR EACH ROW EXECUTE FUNCTION cdc_capture();\n\n-- Accounts\nCREATE TRIGGER cdc_accounts\n  AFTER INSERT OR UPDATE OR DELETE ON accounts\n  FOR EACH ROW EXECUTE FUNCTION cdc_capture();\n\n-- Users\nCREATE TRIGGER cdc_users\n  AFTER INSERT OR UPDATE OR DELETE ON users\n  FOR EACH ROW EXECUTE FUNCTION cdc_capture();\n\n-- Account memberships\nCREATE TRIGGER cdc_account_users\n  AFTER INSERT OR UPDATE OR DELETE ON account_users\n  FOR EACH ROW EXECUTE FUNCTION cdc_capture();\n\n-- Gifts\nCREATE TRIGGER cdc_gifts\n  AFTER INSERT OR UPDATE OR DELETE ON gifts\n  FOR EACH ROW EXECUTE FUNCTION cdc_capture();\n```\n\n### 4. Coursebuilder Consumer (Inngest)\n```typescript\n// inngest/functions/cdc-processor.ts\nexport const processCdcEvents = inngest.createFunction(\n  { id: \"process-cdc-events\" },\n  { cron: \"*/30 * * * * *\" }, // Every 30 seconds\n  async ({ step }) =\u003e {\n    const events = await step.run(\"fetch-events\", async () =\u003e {\n      return railsDb.query(`\n        SELECT * FROM cdc_events \n        WHERE processed_at IS NULL \n        ORDER BY created_at \n        LIMIT 100\n      `);\n    });\n\n    for (const event of events) {\n      await step.run(`process-${event.id}`, async () =\u003e {\n        await syncToCoursebuilder(event);\n        await railsDb.query(\n          `UPDATE cdc_events SET processed_at = NOW() WHERE id = $1`,\n          [event.id]\n        );\n      });\n    }\n  }\n);\n```\n\n## Tables to Track\n1. `account_subscriptions` - subscription state changes (CRITICAL)\n2. `accounts` - account updates\n3. `users` - user profile changes\n4. `account_users` - membership changes\n5. `gifts` - gift claims/expirations\n\n## Considerations\n- **Idempotency**: Process by record_id, check if already synced\n- **Ordering**: Process in created_at order per table\n- **Cleanup**: Cron job to purge processed events older than 7 days\n- **Monitoring**: Alert if unprocessed events \u003e 1000\n\n## Files to Reference\n- `course-builder/packages/core/src/inngest/` - Inngest patterns\n- `egghead-rails/db/schema.rb` - Rails schema\n\n## Dependencies\n- Must complete before `migrate-egghead-koh.1` (user migration)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:49:42.257544-08:00","updated_at":"2025-12-11T10:54:15.595558-08:00"}
{"id":"migrate-egghead-5vc","title":"Document Rails Stripe Webhook System for Next.js Migration","description":"Comprehensive analysis and documentation of egghead-rails Stripe webhook implementation including controller flow, event model, multi-tenancy, error handling, and all event types to inform migration to egghead-next","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T07:23:52.709294-08:00","updated_at":"2025-12-11T07:35:44.448943-08:00","closed_at":"2025-12-11T07:35:44.448943-08:00"}
{"id":"migrate-egghead-5vc.1","title":"Analyze StripeEventsController webhook flow and routing","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T07:23:52.746443-08:00","updated_at":"2025-12-11T07:32:21.645154-08:00","closed_at":"2025-12-11T07:32:21.645154-08:00","dependencies":[{"issue_id":"migrate-egghead-5vc.1","depends_on_id":"migrate-egghead-5vc","type":"parent-child","created_at":"2025-12-11T07:23:52.74676-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5vc.2","title":"Analyze StripeWebhookEvent model and persistence layer","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T07:23:52.782941-08:00","updated_at":"2025-12-11T07:32:22.898081-08:00","closed_at":"2025-12-11T07:32:22.898081-08:00","dependencies":[{"issue_id":"migrate-egghead-5vc.2","depends_on_id":"migrate-egghead-5vc","type":"parent-child","created_at":"2025-12-11T07:23:52.783247-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5vc.3","title":"Catalog all webhook event handlers and their business logic","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T07:23:52.819166-08:00","updated_at":"2025-12-11T07:32:23.805155-08:00","closed_at":"2025-12-11T07:32:23.805155-08:00","dependencies":[{"issue_id":"migrate-egghead-5vc.3","depends_on_id":"migrate-egghead-5vc","type":"parent-child","created_at":"2025-12-11T07:23:52.819483-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5vc.4","title":"Analyze multi-tenant architecture and site tenant handling","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T07:23:52.857684-08:00","updated_at":"2025-12-11T07:32:25.013428-08:00","closed_at":"2025-12-11T07:32:25.013428-08:00","dependencies":[{"issue_id":"migrate-egghead-5vc.4","depends_on_id":"migrate-egghead-5vc","type":"parent-child","created_at":"2025-12-11T07:23:52.858007-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5vc.5","title":"Map background job dependencies and async processing","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T07:23:52.894853-08:00","updated_at":"2025-12-11T07:32:25.944296-08:00","closed_at":"2025-12-11T07:32:25.944296-08:00","dependencies":[{"issue_id":"migrate-egghead-5vc.5","depends_on_id":"migrate-egghead-5vc","type":"parent-child","created_at":"2025-12-11T07:23:52.895149-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-5vc.6","title":"Synthesize findings into migration documentation","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T07:23:52.933118-08:00","updated_at":"2025-12-11T07:35:43.59652-08:00","closed_at":"2025-12-11T07:35:43.59652-08:00","dependencies":[{"issue_id":"migrate-egghead-5vc.6","depends_on_id":"migrate-egghead-5vc","type":"parent-child","created_at":"2025-12-11T07:23:52.933477-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv","title":"Phase 0: Pre-Migration Safety + E2E Infrastructure","description":"**Migration Control Plane** - The infrastructure that orchestrates everything else.\n\n## What This Phase Builds\n- **Upstash Redis** - State store, event log, pub/sub, vector DB for codebase\n- **Inngest Orchestrator** - Phase sequencing, task spawning, human checkpoints\n- **Slack Bot** - Real-time notifications, approval buttons, escalation\n- **Dashboard** - Live migration status, metrics, E2E results\n- **Playwright Infrastructure** - E2E test framework with intelligent scheduling\n- **Phase Contracts** - Explicit input/output requirements per phase\n\n## Architecture\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ                 MIGRATION CONTROL PLANE                      ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ  Upstash Redis ‚óÑ‚îÄ‚îÄ‚ñ∫ Inngest ‚óÑ‚îÄ‚îÄ‚ñ∫ Slack Bot                  ‚îÇ\n‚îÇ       ‚îÇ                ‚îÇ              ‚îÇ                      ‚îÇ\n‚îÇ       ‚ñº                ‚ñº              ‚ñº                      ‚îÇ\n‚îÇ  [State + Events + Vector DB] [Orchestration] [Human Loop]  ‚îÇ\n‚îÇ                        ‚îÇ                                     ‚îÇ\n‚îÇ                        ‚ñº                                     ‚îÇ\n‚îÇ              Agent Swarm (Sonnet 4)                         ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## Gate Criteria\n- [ ] Redis connected, vector DB indexed\n- [ ] Inngest orchestrator deployed\n- [ ] Slack bot responding\n- [ ] Dashboard showing live state\n- [ ] Baseline E2E tests passing\n- [ ] Phase contracts defined for all 6 phases\n- [ ] **[HUMAN]** Joel approves control plane before Phase 1","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:28:42.08579-08:00","updated_at":"2025-12-12T09:25:57.120107-08:00","closed_at":"2025-12-12T09:25:57.120107-08:00"}
{"id":"migrate-egghead-6pv.1","title":"Set up Playwright E2E test infrastructure","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:42.119182-08:00","updated_at":"2025-12-11T09:38:16.90941-08:00","closed_at":"2025-12-11T09:38:16.90941-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.1","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:28:42.119511-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.10","title":"Vector DB indexing - index all 3 codebases","description":"Use Upstash Vector to index the full codebases for agent context:\n- egghead-rails (Ruby, ~50K LOC)\n- egghead-next (TypeScript, ~100K LOC)  \n- course-builder (TypeScript, ~200K LOC)\n- Create embeddings for all source files\n- Build semantic search API for agents to query\n- Test retrieval quality with sample queries","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:38:30.43257-08:00","updated_at":"2025-12-11T09:38:30.43257-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.10","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:38:30.432972-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.11","title":"Inngest orchestrator functions - phase sequencing, task spawning","description":"Build the Inngest orchestration layer:\n- migrationOrchestrator function (phase sequencing)\n- taskExecutor function (agent task execution)\n- Human checkpoint wait/approval flow\n- E2E validation triggers\n- Retry logic with exponential backoff\n- Event emission for all state transitions\n- Integration with Redis state store","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:38:32.935738-08:00","updated_at":"2025-12-11T09:38:32.935738-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.11","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:38:32.936111-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.12","title":"Slack bot - #egghead-migration channel, approval buttons","description":"Build Slack integration for human-in-the-loop:\n- Create #egghead-migration channel\n- Build Slack bot with Block Kit UI\n- Phase start/complete notifications\n- Human checkpoint approval buttons (Approve/Reject)\n- Task failure alerts with error context\n- E2E failure notifications\n- Link to dashboard in all messages\n- Inngest function to handle Slack events","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:38:36.028934-08:00","updated_at":"2025-12-11T09:38:36.028934-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.12","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:38:36.029327-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.13","title":"Dashboard - live migration status, metrics, E2E results","description":"Build real-time migration dashboard:\n- Phase progress visualization (7 phases)\n- Task status per phase (pending/in_progress/completed/failed)\n- Metrics display (users migrated, subs, progress records)\n- E2E test results with failure details\n- Event log timeline\n- Human checkpoint status\n- Redis-backed real-time updates\nLocation TBD: standalone app or part of egghead Coursebuilder app","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:38:39.221168-08:00","updated_at":"2025-12-11T09:38:39.221168-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.13","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:38:39.221486-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.14","title":"Playwright infrastructure - E2E framework with intelligent scheduling","description":"Set up Playwright E2E testing infrastructure:\n- playwright.config.ts for egghead Coursebuilder app\n- Test fixtures and helpers\n- Auth flow testing (login, logout, session)\n- Content rendering tests (courses, lessons)\n- Subscription/entitlement tests\n- Intelligent scheduling (not after every task, batch at phase boundaries)\n- CI integration for automated runs\n- Screenshot/video capture on failure","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:38:42.362007-08:00","updated_at":"2025-12-11T09:38:42.362007-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.14","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:38:42.362377-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.15","title":"Phase contracts - define input/output for all 6 phases","description":"Define explicit contracts for each migration phase:\n- Phase 1: Data Migration (users, orgs, subs, content, progress)\n- Phase 2: Webhook Handlers (Stripe Inngest functions)\n- Phase 3: Cron Jobs (17 Sidekiq ‚Üí Inngest)\n- Phase 4: External Integrations (Customer.io, mailers)\n- Phase 5: UI Components + E2E Click Matrix\n- Phase 6: Cutover + Final Validation\n\nEach contract includes:\n- Required inputs (files, data, previous phase completion)\n- Validators (DB connections, file existence)\n- Output artifacts (files, reports)\n- Metrics to capture\n- E2E tests that must pass\n- Human checkpoint criteria (if any)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:38:47.381551-08:00","updated_at":"2025-12-11T09:38:47.381551-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.15","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:38:47.381935-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.16","title":"Baseline E2E tests - validate current egghead.io state","description":"Create baseline E2E tests against current production:\n- Homepage loads correctly\n- Course pages render (sample 5 courses)\n- Lesson pages render with video player\n- Search works\n- Auth flow (if testable)\n- Instructor pages load\n- Tag/topic pages load\nThese establish the \"before\" state for comparison after migration.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:38:50.51997-08:00","updated_at":"2025-12-11T09:38:50.51997-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.16","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:38:50.520329-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.17","title":"[HUMAN] Approve Migration Control Plane before Phase 1","description":"Human gate before starting data migration:\n- [ ] Redis connected and state schema working\n- [ ] Vector DB indexed with all 3 codebases\n- [ ] Inngest orchestrator deployed and tested\n- [ ] Slack bot responding in #egghead-migration\n- [ ] Dashboard showing live state\n- [ ] Baseline E2E tests passing\n- [ ] Phase contracts reviewed and approved\n- [ ] Joel signs off on control plane architecture","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T09:38:52.8783-08:00","updated_at":"2025-12-11T09:38:52.8783-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.17","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:38:52.878653-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.2","title":"Create E2E click-test matrix document","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:42.154291-08:00","updated_at":"2025-12-11T09:38:17.472045-08:00","closed_at":"2025-12-11T09:38:17.472045-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.2","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:28:42.154625-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.3","title":"Build baseline E2E tests for current state","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T09:28:42.185782-08:00","updated_at":"2025-12-11T09:38:17.984763-08:00","closed_at":"2025-12-11T09:38:17.984763-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.3","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:28:42.186126-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.4","title":"Design CDC mechanism (ADR)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T09:28:42.217548-08:00","updated_at":"2025-12-11T09:38:18.570713-08:00","closed_at":"2025-12-11T09:38:18.570713-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.4","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:28:42.217874-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.5","title":"Build idempotency layer for migrations","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:42.248996-08:00","updated_at":"2025-12-11T09:38:19.019968-08:00","closed_at":"2025-12-11T09:38:19.019968-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.5","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:28:42.249305-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.6","title":"Build reconciliation job infrastructure","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:42.28041-08:00","updated_at":"2025-12-11T09:38:19.444461-08:00","closed_at":"2025-12-11T09:38:19.444461-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.6","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:28:42.280739-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.7","title":"Document and test rollback procedures","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:42.313269-08:00","updated_at":"2025-12-11T09:38:20.067897-08:00","closed_at":"2025-12-11T09:38:20.067897-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.7","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:28:42.313601-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.8","title":"[HUMAN] Review and approve pre-migration safety plan","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:42.349229-08:00","updated_at":"2025-12-11T09:38:20.536458-08:00","closed_at":"2025-12-11T09:38:20.536458-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.8","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:28:42.349565-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6pv.9","title":"Upstash Redis setup - state store, event log, pub/sub","description":"Set up Upstash Redis for the Migration Control Plane:\n- Create Upstash Redis instance\n- Configure state store schema (MigrationState interface)\n- Set up Redis Streams for event log (migration:events)\n- Configure pub/sub channels for real-time notifications\n- Create helper functions for state queries and updates\n- Test connection from local dev and Vercel","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:38:27.672978-08:00","updated_at":"2025-12-11T09:38:27.672978-08:00","dependencies":[{"issue_id":"migrate-egghead-6pv.9","depends_on_id":"migrate-egghead-6pv","type":"parent-child","created_at":"2025-12-11T09:38:27.673359-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6y2","title":"Testing Infrastructure: Full Pyramid Coverage","description":"**NO CODE SHIPS WITHOUT TESTS. PERIOD.**\n\nEvery single piece of this migration gets the full testing pyramid - but we're pragmatic about it.\n\n```\n                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n                    ‚îÇ   E2E/UI    ‚îÇ  ‚Üê Playwright: real browser, real flows\n                    ‚îÇ  (few, slow)‚îÇ\n                   ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ\n                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n                  ‚îÇ  Integration    ‚îÇ  ‚Üê REAL services: Stripe test mode, real DB, real Redis\n                  ‚îÇ  (some, medium) ‚îÇ     NO MOCKS for external services\n                 ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ\n                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n                ‚îÇ      Unit Tests       ‚îÇ  ‚Üê Pure functions, transforms, validators\n                ‚îÇ    (many, fast)       ‚îÇ     Mock only internal boundaries\n                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## Philosophy: Real \u003e Mock\n\n**Stripe mocks are garbage.** They don't behave like real Stripe. Use:\n- **Stripe Test Mode** for integration tests (real API, test data)\n- **Stripe CLI** for webhook forwarding in E2E\n- **Stripe Test Clocks** for time-based scenarios (renewals, trials)\n\n**Mock only what you own.** Don't mock:\n- Stripe API ‚Üí use test mode\n- Database ‚Üí use real MySQL (Testcontainers or PlanetScale branch)\n- Redis ‚Üí use real Redis (Testcontainers or Upstash)\n- Inngest ‚Üí use dev server\n\n**Do mock:**\n- Your own service boundaries (when testing a single unit)\n- OpenAI (expensive, rate-limited) ‚Üí mock with deterministic responses\n- Front API (no test mode) ‚Üí mock the HTTP layer\n\n## CI Strategy: Fast Feedback, Real Tests\n\n```\nPush to branch:\n‚îú‚îÄ Lint + Typecheck (30s)           ‚Üê Instant feedback\n‚îú‚îÄ Unit tests (1-2min)              ‚Üê Fast, parallel\n‚îî‚îÄ Integration tests (3-5min)       ‚Üê Real DB, real Stripe test mode\n\nPR to main:\n‚îú‚îÄ All above +\n‚îú‚îÄ E2E critical paths (5-10min)     ‚Üê Playwright\n‚îî‚îÄ Coverage check                   ‚Üê 80% gate\n\nMerge to main:\n‚îú‚îÄ Full E2E suite                   ‚Üê All browsers\n‚îî‚îÄ Deploy to preview                ‚Üê Vercel preview URL\n```\n\n## What We're NOT Doing\n\n- ‚ùå stripe-mock (unreliable, doesn't match real behavior)\n- ‚ùå Mocking database queries (use real DB)\n- ‚ùå Mocking Redis (use real Redis)\n- ‚ùå Running full E2E on every push (too slow)\n- ‚ùå 100% coverage targets (diminishing returns)\n- ‚ùå Flaky test tolerance (fix or delete)\n\n## Coverage Requirements\n\n| Layer | Target | Notes |\n|-------|--------|-------|\n| Unit | 80%+ lines | Pure functions, transforms |\n| Integration | Critical paths | Auth, payments, subscriptions |\n| E2E | Happy paths + key errors | Login, checkout, video playback |\n\n## Test Data Strategy\n\n- **Stripe**: Real test mode with cleanup after each test\n- **Database**: PlanetScale branch databases OR Testcontainers\n- **Fixtures**: Deterministic data for unit tests\n- **Factories**: faker-based for integration tests\n- **Seeds**: Known state for E2E","status":"open","priority":0,"issue_type":"epic","created_at":"2025-12-11T10:04:56.340337-08:00","updated_at":"2025-12-11T10:07:39.791469-08:00"}
{"id":"migrate-egghead-6y2.1","title":"Set up Vitest + testing infrastructure","description":"Set up the core testing infrastructure that everything else builds on.\n\n## Vitest Configuration\n\n```typescript\n// vitest.config.ts\nimport { defineConfig } from 'vitest/config'\nimport react from '@vitejs/plugin-react'\nimport tsconfigPaths from 'vite-tsconfig-paths'\n\nexport default defineConfig({\n  plugins: [react(), tsconfigPaths()],\n  test: {\n    // Test environments\n    environment: 'node',\n    environmentMatchGlobs: [\n      ['**/*.dom.test.{ts,tsx}', 'jsdom'],\n      ['**/*.component.test.{ts,tsx}', 'jsdom'],\n    ],\n    \n    // Coverage\n    coverage: {\n      provider: 'v8',\n      reporter: ['text', 'json', 'html'],\n      exclude: [\n        'node_modules/',\n        '**/*.test.ts',\n        '**/__mocks__/',\n        '**/__fixtures__/',\n      ],\n      thresholds: {\n        statements: 80,\n        branches: 80,\n        functions: 80,\n        lines: 80,\n      },\n    },\n    \n    // Test organization\n    include: [\n      '**/*.test.ts',\n      '**/*.test.tsx',\n    ],\n    \n    // Separate test pools\n    poolOptions: {\n      threads: {\n        singleThread: true, // For DB tests\n      },\n    },\n    \n    // Setup files\n    setupFiles: [\n      './test/setup.ts',\n    ],\n    \n    // Global test utilities\n    globals: true,\n  },\n})\n```\n\n## Directory Structure\n\n```\ntest/\n‚îú‚îÄ‚îÄ setup.ts                 # Global setup (env, mocks)\n‚îú‚îÄ‚îÄ utils/\n‚îÇ   ‚îú‚îÄ‚îÄ db.ts               # Test DB helpers\n‚îÇ   ‚îú‚îÄ‚îÄ redis.ts            # Test Redis helpers\n‚îÇ   ‚îú‚îÄ‚îÄ stripe.ts           # Stripe mock helpers\n‚îÇ   ‚îú‚îÄ‚îÄ inngest.ts          # Inngest test helpers\n‚îÇ   ‚îî‚îÄ‚îÄ factories/          # Data factories\n‚îÇ       ‚îú‚îÄ‚îÄ user.ts\n‚îÇ       ‚îú‚îÄ‚îÄ subscription.ts\n‚îÇ       ‚îî‚îÄ‚îÄ ...\n‚îú‚îÄ‚îÄ fixtures/\n‚îÇ   ‚îú‚îÄ‚îÄ users.json\n‚îÇ   ‚îú‚îÄ‚îÄ stripe-events/\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ checkout.completed.json\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ subscription.created.json\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îî‚îÄ‚îÄ integration/\n    ‚îú‚îÄ‚îÄ setup.ts            # Testcontainers setup\n    ‚îî‚îÄ‚îÄ globalSetup.ts      # Start containers once\n```\n\n## Package.json Scripts\n\n```json\n{\n  \"scripts\": {\n    \"test\": \"vitest\",\n    \"test:unit\": \"vitest --project unit\",\n    \"test:integration\": \"vitest --project integration\",\n    \"test:e2e\": \"playwright test\",\n    \"test:coverage\": \"vitest --coverage\",\n    \"test:ci\": \"vitest --run --coverage\"\n  }\n}\n```\n\n## Test Naming Convention\n\n```\n*.test.ts          - Unit tests\n*.integration.ts   - Integration tests (real DB/Redis)\n*.e2e.ts          - E2E tests (Playwright)\n*.component.ts    - React component tests\n```\n\n## Implementation\n\n1. Install deps: vitest, @vitest/coverage-v8, @testing-library/react\n2. Create vitest.config.ts with workspaces\n3. Create test/setup.ts with global mocks\n4. Create test/utils/ helpers\n5. Create initial factories\n6. Add CI workflow for tests\n7. Add pre-commit hook for affected tests","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:05:19.35957-08:00","updated_at":"2025-12-11T10:05:19.35957-08:00","dependencies":[{"issue_id":"migrate-egghead-6y2.1","depends_on_id":"migrate-egghead-6y2","type":"parent-child","created_at":"2025-12-11T10:05:19.359988-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6y2.2","title":"Set up Testcontainers for integration tests (MySQL, Redis)","description":"Set up Testcontainers for real database/Redis integration tests.\n\n## Why Testcontainers\n\n- Real MySQL (not SQLite pretending to be MySQL)\n- Real Redis (not in-memory mock)\n- Isolated per test run\n- Same behavior as production\n- Works in CI\n\n## Setup\n\n```typescript\n// test/integration/setup.ts\nimport { MySqlContainer, StartedMySqlContainer } from '@testcontainers/mysql'\nimport { RedisContainer, StartedRedisContainer } from '@testcontainers/redis'\nimport { drizzle } from 'drizzle-orm/mysql2'\nimport mysql from 'mysql2/promise'\nimport { Redis } from '@upstash/redis'\n\nlet mysqlContainer: StartedMySqlContainer\nlet redisContainer: StartedRedisContainer\n\nexport async function setupTestContainers() {\n  // Start MySQL\n  mysqlContainer = await new MySqlContainer('mysql:8.0')\n    .withDatabase('test')\n    .withUsername('test')\n    .withUserPassword('test')\n    .start()\n  \n  // Start Redis\n  redisContainer = await new RedisContainer('redis:7')\n    .start()\n  \n  // Set env vars for tests\n  process.env.DATABASE_URL = mysqlContainer.getConnectionUri()\n  process.env.UPSTASH_REDIS_REST_URL = `http://${redisContainer.getHost()}:${redisContainer.getPort()}`\n  \n  // Run migrations\n  const connection = await mysql.createConnection(mysqlContainer.getConnectionUri())\n  const db = drizzle(connection)\n  await migrate(db, { migrationsFolder: './drizzle' })\n  \n  return { mysqlContainer, redisContainer }\n}\n\nexport async function teardownTestContainers() {\n  await mysqlContainer?.stop()\n  await redisContainer?.stop()\n}\n\n// Per-test cleanup\nexport async function resetDatabase(db: DrizzleDB) {\n  // Truncate all tables in correct order (FK constraints)\n  await db.execute(sql`SET FOREIGN_KEY_CHECKS = 0`)\n  for (const table of ['purchases', 'subscriptions', 'users', ...]) {\n    await db.execute(sql`TRUNCATE TABLE ${sql.identifier(table)}`)\n  }\n  await db.execute(sql`SET FOREIGN_KEY_CHECKS = 1`)\n}\n```\n\n## Global Setup (run once)\n\n```typescript\n// test/integration/globalSetup.ts\nimport { setupTestContainers, teardownTestContainers } from './setup'\n\nexport async function setup() {\n  const containers = await setupTestContainers()\n  return () =\u003e teardownTestContainers()\n}\n```\n\n## Vitest Config for Integration\n\n```typescript\n// vitest.config.integration.ts\nexport default defineConfig({\n  test: {\n    include: ['**/*.integration.ts'],\n    globalSetup: './test/integration/globalSetup.ts',\n    setupFiles: ['./test/integration/setup.ts'],\n    pool: 'forks',  // Isolated processes\n    poolOptions: {\n      forks: {\n        singleFork: true,  // Share containers\n      },\n    },\n    testTimeout: 30000,  // Containers can be slow\n  },\n})\n```\n\n## Usage in Tests\n\n```typescript\n// src/lib/subscriptions.integration.ts\nimport { describe, it, expect, beforeEach } from 'vitest'\nimport { getTestDb, resetDatabase } from '@/test/integration/setup'\nimport { createSubscription } from './subscriptions'\n\ndescribe('Subscriptions (integration)', () =\u003e {\n  const db = getTestDb()\n  \n  beforeEach(async () =\u003e {\n    await resetDatabase(db)\n  })\n  \n  it('creates subscription with correct entitlements', async () =\u003e {\n    // This hits REAL MySQL\n    const sub = await createSubscription({\n      userId: 'user_123',\n      stripeSubscriptionId: 'sub_xxx',\n      priceId: 'price_pro_monthly',\n    })\n    \n    expect(sub.status).toBe('active')\n    \n    // Verify DB state\n    const entitlements = await db.query.entitlements.findMany({\n      where: eq(entitlements.userId, 'user_123')\n    })\n    expect(entitlements).toHaveLength(1)\n    expect(entitlements[0].type).toBe('pro')\n  })\n})\n```\n\n## CI Configuration\n\n```yaml\n# .github/workflows/test.yml\nintegration:\n  runs-on: ubuntu-latest\n  services:\n    # Testcontainers handles this, but we need Docker\n    docker:\n      image: docker:dind\n  steps:\n    - uses: actions/checkout@v4\n    - uses: actions/setup-node@v4\n    - run: pnpm install\n    - run: pnpm test:integration\n```","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:05:38.591731-08:00","updated_at":"2025-12-11T10:05:38.591731-08:00","dependencies":[{"issue_id":"migrate-egghead-6y2.2","depends_on_id":"migrate-egghead-6y2","type":"parent-child","created_at":"2025-12-11T10:05:38.592146-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6y2.3","title":"Set up Playwright for E2E tests","description":"Set up Playwright for full E2E browser testing.\n\n## Playwright Configuration\n\n```typescript\n// playwright.config.ts\nimport { defineConfig, devices } from '@playwright/test'\n\nexport default defineConfig({\n  testDir: './e2e',\n  fullyParallel: true,\n  forbidOnly: !!process.env.CI,\n  retries: process.env.CI ? 2 : 0,\n  workers: process.env.CI ? 1 : undefined,\n  reporter: [\n    ['html'],\n    ['json', { outputFile: 'test-results/results.json' }],\n    process.env.CI ? ['github'] : ['list'],\n  ],\n  \n  use: {\n    baseURL: 'http://localhost:3000',\n    trace: 'on-first-retry',\n    screenshot: 'only-on-failure',\n    video: 'on-first-retry',\n  },\n  \n  projects: [\n    // Auth setup - runs first\n    { name: 'setup', testMatch: /.*\\.setup\\.ts/ },\n    \n    {\n      name: 'chromium',\n      use: { ...devices['Desktop Chrome'] },\n      dependencies: ['setup'],\n    },\n    {\n      name: 'firefox',\n      use: { ...devices['Desktop Firefox'] },\n      dependencies: ['setup'],\n    },\n    {\n      name: 'mobile',\n      use: { ...devices['iPhone 13'] },\n      dependencies: ['setup'],\n    },\n  ],\n  \n  // Start dev server for tests\n  webServer: {\n    command: 'pnpm dev',\n    url: 'http://localhost:3000',\n    reuseExistingServer: !process.env.CI,\n    timeout: 120000,\n  },\n})\n```\n\n## Directory Structure\n\n```\ne2e/\n‚îú‚îÄ‚îÄ auth.setup.ts           # Create auth state\n‚îú‚îÄ‚îÄ fixtures/\n‚îÇ   ‚îú‚îÄ‚îÄ test-user.ts        # Test user factory\n‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îú‚îÄ‚îÄ pages/                  # Page Object Models\n‚îÇ   ‚îú‚îÄ‚îÄ login.page.ts\n‚îÇ   ‚îú‚îÄ‚îÄ lesson.page.ts\n‚îÇ   ‚îú‚îÄ‚îÄ checkout.page.ts\n‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îú‚îÄ‚îÄ auth/\n‚îÇ   ‚îú‚îÄ‚îÄ login.e2e.ts\n‚îÇ   ‚îú‚îÄ‚îÄ oauth.e2e.ts\n‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îú‚îÄ‚îÄ subscriptions/\n‚îÇ   ‚îú‚îÄ‚îÄ checkout.e2e.ts\n‚îÇ   ‚îú‚îÄ‚îÄ cancel.e2e.ts\n‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îú‚îÄ‚îÄ content/\n‚îÇ   ‚îú‚îÄ‚îÄ lesson-playback.e2e.ts\n‚îÇ   ‚îú‚îÄ‚îÄ course-progress.e2e.ts\n‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îî‚îÄ‚îÄ support/\n    ‚îú‚îÄ‚îÄ ticket-flow.e2e.ts\n    ‚îî‚îÄ‚îÄ ...\n```\n\n## Page Object Model Example\n\n```typescript\n// e2e/pages/lesson.page.ts\nimport { Page, Locator } from '@playwright/test'\n\nexport class LessonPage {\n  readonly page: Page\n  readonly videoPlayer: Locator\n  readonly completeButton: Locator\n  readonly nextLessonButton: Locator\n  readonly progressBar: Locator\n  \n  constructor(page: Page) {\n    this.page = page\n    this.videoPlayer = page.locator('[data-testid=\"video-player\"]')\n    this.completeButton = page.locator('[data-testid=\"complete-lesson\"]')\n    this.nextLessonButton = page.locator('[data-testid=\"next-lesson\"]')\n    this.progressBar = page.locator('[data-testid=\"progress-bar\"]')\n  }\n  \n  async goto(slug: string) {\n    await this.page.goto(`/lessons/${slug}`)\n  }\n  \n  async waitForVideoReady() {\n    await this.videoPlayer.waitFor({ state: 'visible' })\n    await this.page.waitForFunction(() =\u003e {\n      const video = document.querySelector('video')\n      return video \u0026\u0026 video.readyState \u003e= 3\n    })\n  }\n  \n  async markComplete() {\n    await this.completeButton.click()\n    await this.page.waitForResponse(resp =\u003e \n      resp.url().includes('/api/progress') \u0026\u0026 resp.status() === 200\n    )\n  }\n  \n  async getProgress(): Promise\u003cnumber\u003e {\n    const width = await this.progressBar.evaluate(el =\u003e \n      getComputedStyle(el).getPropertyValue('--progress')\n    )\n    return parseFloat(width)\n  }\n}\n```\n\n## Auth Setup (reusable auth state)\n\n```typescript\n// e2e/auth.setup.ts\nimport { test as setup, expect } from '@playwright/test'\n\nconst authFile = 'e2e/.auth/user.json'\n\nsetup('authenticate', async ({ page }) =\u003e {\n  // Login as test user\n  await page.goto('/login')\n  await page.fill('[name=\"email\"]', process.env.TEST_USER_EMAIL!)\n  await page.fill('[name=\"password\"]', process.env.TEST_USER_PASSWORD!)\n  await page.click('[type=\"submit\"]')\n  \n  // Wait for auth to complete\n  await page.waitForURL('/dashboard')\n  \n  // Save auth state\n  await page.context().storageState({ path: authFile })\n})\n```\n\n## Example E2E Test\n\n```typescript\n// e2e/content/lesson-playback.e2e.ts\nimport { test, expect } from '@playwright/test'\nimport { LessonPage } from '../pages/lesson.page'\n\ntest.describe('Lesson Playback', () =\u003e {\n  test('pro user can watch full lesson and mark complete', async ({ page }) =\u003e {\n    const lessonPage = new LessonPage(page)\n    \n    await lessonPage.goto('intro-to-typescript')\n    await lessonPage.waitForVideoReady()\n    \n    // Video should be playable (not gated)\n    await expect(lessonPage.videoPlayer).toBeVisible()\n    await expect(page.locator('[data-testid=\"paywall\"]')).not.toBeVisible()\n    \n    // Mark complete\n    await lessonPage.markComplete()\n    \n    // Progress should update\n    const progress = await lessonPage.getProgress()\n    expect(progress).toBeGreaterThan(0)\n  })\n  \n  test('free user sees paywall after preview', async ({ browser }) =\u003e {\n    // Use fresh context (no auth)\n    const context = await browser.newContext()\n    const page = await context.newPage()\n    const lessonPage = new LessonPage(page)\n    \n    await lessonPage.goto('advanced-patterns')\n    \n    // Should see paywall\n    await expect(page.locator('[data-testid=\"paywall\"]')).toBeVisible()\n    await expect(lessonPage.completeButton).not.toBeVisible()\n  })\n})\n```\n\n## CI Integration\n\n```yaml\ne2e:\n  runs-on: ubuntu-latest\n  steps:\n    - uses: actions/checkout@v4\n    - uses: actions/setup-node@v4\n    - run: pnpm install\n    - run: pnpm exec playwright install --with-deps\n    - run: pnpm test:e2e\n    - uses: actions/upload-artifact@v4\n      if: failure()\n      with:\n        name: playwright-report\n        path: playwright-report/\n```","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:05:51.848159-08:00","updated_at":"2025-12-11T10:05:51.848159-08:00","dependencies":[{"issue_id":"migrate-egghead-6y2.3","depends_on_id":"migrate-egghead-6y2","type":"parent-child","created_at":"2025-12-11T10:05:51.84856-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6y2.4","title":"Set up Stripe testing infrastructure (stripe-mock + CLI)","description":"Set up Stripe testing using REAL Stripe test mode - no mocks.\n\n## Why No stripe-mock\n\nstripe-mock is fundamentally broken:\n- Doesn't validate request bodies properly\n- Doesn't maintain state between calls\n- Webhook signatures don't match real behavior\n- Edge cases behave differently than production\n- False confidence - tests pass but prod breaks\n\n## Real Stripe Test Mode Strategy\n\n### 1. Test Mode API (Integration Tests)\n\n```typescript\n// test/utils/stripe.ts\nimport Stripe from 'stripe'\n\n// Real Stripe, test mode\nexport const stripe = new Stripe(process.env.STRIPE_SECRET_KEY_TEST!, {\n  apiVersion: '2024-11-20.acacia',\n})\n\n// Create isolated test data\nexport async function createTestCustomer(email?: string) {\n  return stripe.customers.create({\n    email: email ?? `test-${Date.now()}@example.com`,\n    metadata: { \n      test: 'true',\n      createdBy: 'integration-test',\n      createdAt: new Date().toISOString(),\n    },\n  })\n}\n\n// Cleanup after tests\nexport async function cleanupTestCustomer(customerId: string) {\n  try {\n    // Cancel any subscriptions first\n    const subs = await stripe.subscriptions.list({ customer: customerId })\n    for (const sub of subs.data) {\n      await stripe.subscriptions.cancel(sub.id)\n    }\n    // Delete customer\n    await stripe.customers.del(customerId)\n  } catch (e) {\n    // Already deleted, fine\n  }\n}\n```\n\n### 2. Test Clocks (Time-Based Scenarios)\n\n```typescript\n// For testing renewals, trials, cancellations\nexport async function createTestClockCustomer() {\n  const testClock = await stripe.testHelpers.testClocks.create({\n    frozen_time: Math.floor(Date.now() / 1000),\n    name: `test-clock-${Date.now()}`,\n  })\n  \n  const customer = await stripe.customers.create({\n    email: `clock-test-${Date.now()}@example.com`,\n    test_clock: testClock.id,\n    metadata: { test: 'true' },\n  })\n  \n  return { testClock, customer }\n}\n\n// Advance time to trigger renewal\nexport async function advanceTestClock(testClockId: string, seconds: number) {\n  const clock = await stripe.testHelpers.testClocks.retrieve(testClockId)\n  await stripe.testHelpers.testClocks.advance(testClockId, {\n    frozen_time: clock.frozen_time + seconds,\n  })\n  \n  // Wait for Stripe to process\n  await new Promise(resolve =\u003e setTimeout(resolve, 2000))\n}\n```\n\n### 3. Webhook Testing with Stripe CLI\n\n```typescript\n// e2e/utils/stripe-webhooks.ts\nimport { spawn, ChildProcess } from 'child_process'\n\nlet stripeProcess: ChildProcess | null = null\n\nexport async function startStripeWebhooks(port = 3000) {\n  return new Promise\u003cstring\u003e((resolve, reject) =\u003e {\n    stripeProcess = spawn('stripe', [\n      'listen',\n      '--forward-to', `localhost:${port}/api/webhooks/stripe`,\n      '--skip-verify',  // For local dev\n    ])\n    \n    stripeProcess.stdout?.on('data', (data) =\u003e {\n      const output = data.toString()\n      // Extract webhook signing secret\n      const match = output.match(/whsec_[a-zA-Z0-9]+/)\n      if (match) {\n        process.env.STRIPE_WEBHOOK_SECRET = match[0]\n        resolve(match[0])\n      }\n    })\n    \n    stripeProcess.stderr?.on('data', (data) =\u003e {\n      console.error('Stripe CLI:', data.toString())\n    })\n    \n    setTimeout(() =\u003e reject(new Error('Stripe CLI timeout')), 10000)\n  })\n}\n\nexport function stopStripeWebhooks() {\n  stripeProcess?.kill()\n  stripeProcess = null\n}\n```\n\n### 4. Integration Test Example\n\n```typescript\n// src/inngest/stripe/subscription-lifecycle.integration.ts\nimport { describe, it, expect, beforeEach, afterEach } from 'vitest'\nimport { stripe, createTestCustomer, cleanupTestCustomer } from '@/test/utils/stripe'\nimport { getTestDb, resetDatabase } from '@/test/integration/setup'\n\ndescribe('Subscription Lifecycle (real Stripe)', () =\u003e {\n  const db = getTestDb()\n  let testCustomerId: string\n  \n  beforeEach(async () =\u003e {\n    await resetDatabase(db)\n    const customer = await createTestCustomer()\n    testCustomerId = customer.id\n    \n    // Create user linked to Stripe customer\n    await db.insert(users).values({\n      id: 'user_test',\n      email: customer.email!,\n      stripeCustomerId: customer.id,\n    })\n  })\n  \n  afterEach(async () =\u003e {\n    await cleanupTestCustomer(testCustomerId)\n  })\n  \n  it('creates subscription and entitlements on checkout', async () =\u003e {\n    // Create real subscription in Stripe\n    const subscription = await stripe.subscriptions.create({\n      customer: testCustomerId,\n      items: [{ price: process.env.STRIPE_PRICE_PRO_MONTHLY! }],\n      payment_behavior: 'default_incomplete',\n      payment_settings: { save_default_payment_method: 'on_subscription' },\n      expand: ['latest_invoice.payment_intent'],\n    })\n    \n    // Simulate successful payment (test mode auto-succeeds with test cards)\n    const invoice = subscription.latest_invoice as Stripe.Invoice\n    const paymentIntent = invoice.payment_intent as Stripe.PaymentIntent\n    \n    await stripe.paymentIntents.confirm(paymentIntent.id, {\n      payment_method: 'pm_card_visa',  // Test card\n    })\n    \n    // Wait for webhook to process (real webhook via Stripe CLI or poll)\n    await waitForCondition(async () =\u003e {\n      const sub = await db.query.subscriptions.findFirst({\n        where: eq(subscriptions.stripeSubscriptionId, subscription.id),\n      })\n      return sub?.status === 'active'\n    }, { timeout: 10000 })\n    \n    // Verify DB state\n    const dbSub = await db.query.subscriptions.findFirst({\n      where: eq(subscriptions.stripeSubscriptionId, subscription.id),\n    })\n    expect(dbSub).toBeDefined()\n    expect(dbSub!.status).toBe('active')\n    \n    const entitlements = await db.query.entitlements.findMany({\n      where: eq(entitlements.userId, 'user_test'),\n    })\n    expect(entitlements).toHaveLength(1)\n    expect(entitlements[0].type).toBe('pro')\n  })\n})\n```\n\n## CI Configuration\n\n```yaml\nintegration:\n  env:\n    STRIPE_SECRET_KEY_TEST: ${{ secrets.STRIPE_SECRET_KEY_TEST }}\n    STRIPE_PRICE_PRO_MONTHLY: ${{ secrets.STRIPE_PRICE_PRO_MONTHLY }}\n  steps:\n    - run: pnpm test:integration\n    # No stripe-mock needed - we hit real Stripe test mode\n```\n\n## Test Isolation\n\nEach test creates its own Stripe customer and cleans up after. No shared state between tests. Tests can run in parallel safely.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:06:13.546127-08:00","updated_at":"2025-12-11T10:08:30.366551-08:00","dependencies":[{"issue_id":"migrate-egghead-6y2.4","depends_on_id":"migrate-egghead-6y2","type":"parent-child","created_at":"2025-12-11T10:06:13.546549-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6y2.5","title":"Set up Inngest testing (@inngest/test)","description":"Set up Inngest function testing at all levels.\n\n## @inngest/test Package\n\n```typescript\n// test/utils/inngest.ts\nimport { createStepTools } from '@inngest/test'\nimport { inngest } from '@/inngest/client'\n\nexport function createTestContext() {\n  const stepTools = createStepTools()\n  \n  return {\n    ...stepTools,\n    inngest,\n  }\n}\n```\n\n## Unit Testing Inngest Functions\n\n```typescript\n// src/inngest/support/classify-issue.test.ts\nimport { describe, it, expect, vi } from 'vitest'\nimport { classifyIssue } from './classify-issue'\nimport { createTestContext } from '@/test/utils/inngest'\n\ndescribe('classifyIssue', () =\u003e {\n  it('classifies auth issues correctly', async () =\u003e {\n    const { runStep, getStepOutput } = createTestContext()\n    \n    const event = {\n      name: 'support/conversation.received',\n      data: {\n        tenantId: 'egghead',\n        conversationId: 'conv_123',\n        email: 'user@example.com',\n        subject: 'Cannot log in',\n        body: 'I keep getting an error when trying to sign in with GitHub',\n      },\n    }\n    \n    // Mock the OpenAI call\n    vi.mock('@/lib/openai', () =\u003e ({\n      classifyWithAI: vi.fn().mockResolvedValue({\n        category: 'AUTH',\n        specificIssue: 'oauth_github',\n        urgency: 'medium',\n        canAutoResolve: true,\n      }),\n    }))\n    \n    await runStep(classifyIssue, event, 'classify')\n    \n    const classification = getStepOutput('classify')\n    expect(classification.category).toBe('AUTH')\n    expect(classification.specificIssue).toBe('oauth_github')\n  })\n  \n  it('routes to correct resolver after classification', async () =\u003e {\n    const { runFunction, getSentEvents } = createTestContext()\n    \n    const event = {\n      name: 'support/conversation.received',\n      data: {\n        tenantId: 'egghead',\n        conversationId: 'conv_123',\n        email: 'user@example.com',\n        subject: 'Lost my progress',\n        body: 'All my completed lessons are gone',\n      },\n    }\n    \n    await runFunction(classifyIssue, event)\n    \n    const sentEvents = getSentEvents()\n    expect(sentEvents).toContainEqual(\n      expect.objectContaining({\n        name: 'support/issue.progress',\n        data: expect.objectContaining({\n          tenantId: 'egghead',\n          conversationId: 'conv_123',\n        }),\n      })\n    )\n  })\n})\n```\n\n## Testing Step Functions\n\n```typescript\n// src/inngest/migration/migrate-user.test.ts\nimport { describe, it, expect } from 'vitest'\nimport { migrateUser } from './migrate-user'\nimport { createTestContext } from '@/test/utils/inngest'\n\ndescribe('migrateUser', () =\u003e {\n  it('executes steps in correct order', async () =\u003e {\n    const { runFunction, getStepOrder } = createTestContext()\n    \n    const event = {\n      name: 'migration/user.migrate',\n      data: { railsUserId: 123 },\n    }\n    \n    await runFunction(migrateUser, event)\n    \n    const stepOrder = getStepOrder()\n    expect(stepOrder).toEqual([\n      'fetch-rails-user',\n      'transform-user',\n      'create-cb-user',\n      'migrate-entitlements',\n      'migrate-progress',\n      'verify-migration',\n    ])\n  })\n  \n  it('handles step failure with retry', async () =\u003e {\n    const { runFunction, failStep, getRetryCount } = createTestContext()\n    \n    // Fail the first attempt\n    failStep('create-cb-user', new Error('DB connection failed'))\n    \n    const event = {\n      name: 'migration/user.migrate',\n      data: { railsUserId: 123 },\n    }\n    \n    await runFunction(migrateUser, event)\n    \n    expect(getRetryCount('create-cb-user')).toBe(1)\n  })\n})\n```\n\n## Integration Testing with Inngest Dev Server\n\n```typescript\n// src/inngest/support/full-flow.integration.ts\nimport { describe, it, expect, beforeAll, afterAll } from 'vitest'\nimport { Inngest } from 'inngest'\nimport { serve } from 'inngest/next'\n\ndescribe('Support Flow (integration)', () =\u003e {\n  let inngestDevServer: any\n  \n  beforeAll(async () =\u003e {\n    // Start Inngest dev server\n    inngestDevServer = await startInngestDev()\n  })\n  \n  afterAll(async () =\u003e {\n    await inngestDevServer.stop()\n  })\n  \n  it('full flow: webhook ‚Üí classify ‚Üí resolve ‚Üí reply', async () =\u003e {\n    // Send event\n    await inngest.send({\n      name: 'support/conversation.received',\n      data: {\n        tenantId: 'egghead',\n        conversationId: 'conv_test_123',\n        email: 'test@example.com',\n        subject: 'Password reset',\n        body: 'I forgot my password',\n      },\n    })\n    \n    // Wait for function chain to complete\n    await waitForInngestRun('classify-support-issue', 'conv_test_123')\n    await waitForInngestRun('resolve-auth-issue', 'conv_test_123')\n    \n    // Verify final state\n    const conversation = await redis.get('egghead:conv:conv_test_123')\n    expect(conversation.status).toBe('resolved')\n    expect(conversation.resolutionAttempts).toHaveLength(1)\n  })\n})\n```\n\n## Mocking External Services in Inngest\n\n```typescript\n// test/utils/inngest-mocks.ts\nimport { vi } from 'vitest'\n\nexport function mockInngestDependencies() {\n  // Mock OpenAI\n  vi.mock('@/lib/openai', () =\u003e ({\n    embed: vi.fn().mockResolvedValue(new Array(1536).fill(0)),\n    classify: vi.fn().mockResolvedValue({ category: 'AUTH' }),\n  }))\n  \n  // Mock Front API\n  vi.mock('@/lib/front', () =\u003e ({\n    sendReply: vi.fn().mockResolvedValue({ id: 'msg_123' }),\n    addTag: vi.fn().mockResolvedValue({}),\n  }))\n  \n  // Mock Stripe\n  vi.mock('@/lib/stripe', () =\u003e ({\n    getSubscription: vi.fn().mockResolvedValue({ status: 'active' }),\n  }))\n}\n```","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:06:35.41479-08:00","updated_at":"2025-12-11T10:06:35.41479-08:00","dependencies":[{"issue_id":"migrate-egghead-6y2.5","depends_on_id":"migrate-egghead-6y2","type":"parent-child","created_at":"2025-12-11T10:06:35.415349-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6y2.6","title":"Create test data factories and fixtures","description":"Create reusable test data factories and fixtures.\n\n## Factory Pattern with @faker-js/faker\n\n```typescript\n// test/factories/user.ts\nimport { faker } from '@faker-js/faker'\nimport { User } from '@/db/schema'\n\ninterface UserOverrides extends Partial\u003cUser\u003e {}\n\nexport function createUser(overrides: UserOverrides = {}): User {\n  return {\n    id: faker.string.uuid(),\n    email: faker.internet.email(),\n    name: faker.person.fullName(),\n    image: faker.image.avatar(),\n    emailVerified: faker.date.past(),\n    createdAt: faker.date.past(),\n    updatedAt: new Date(),\n    ...overrides,\n  }\n}\n\n// Specific user types\nexport function createProUser(overrides: UserOverrides = {}): User {\n  return createUser({\n    ...overrides,\n  })\n}\n\nexport function createTeamAdmin(overrides: UserOverrides = {}): User {\n  return createUser({\n    role: 'admin',\n    ...overrides,\n  })\n}\n```\n\n```typescript\n// test/factories/subscription.ts\nimport { faker } from '@faker-js/faker'\nimport { Subscription } from '@/db/schema'\n\nexport function createSubscription(overrides: Partial\u003cSubscription\u003e = {}): Subscription {\n  const now = new Date()\n  const periodEnd = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000)\n  \n  return {\n    id: faker.string.uuid(),\n    stripeSubscriptionId: `sub_${faker.string.alphanumeric(24)}`,\n    stripeCustomerId: `cus_${faker.string.alphanumeric(24)}`,\n    status: 'active',\n    priceId: 'price_pro_monthly',\n    currentPeriodStart: now,\n    currentPeriodEnd: periodEnd,\n    cancelAtPeriodEnd: false,\n    createdAt: now,\n    updatedAt: now,\n    ...overrides,\n  }\n}\n\nexport function createCanceledSubscription(overrides: Partial\u003cSubscription\u003e = {}) {\n  return createSubscription({\n    status: 'canceled',\n    cancelAtPeriodEnd: true,\n    ...overrides,\n  })\n}\n\nexport function createPastDueSubscription(overrides: Partial\u003cSubscription\u003e = {}) {\n  return createSubscription({\n    status: 'past_due',\n    ...overrides,\n  })\n}\n```\n\n## Fixture Files (Static Test Data)\n\n```typescript\n// test/fixtures/stripe-events/checkout.session.completed.json\n{\n  \"id\": \"evt_test_checkout_completed\",\n  \"type\": \"checkout.session.completed\",\n  \"data\": {\n    \"object\": {\n      \"id\": \"cs_test_xxx\",\n      \"customer\": \"cus_test_xxx\",\n      \"subscription\": \"sub_test_xxx\",\n      \"mode\": \"subscription\",\n      \"payment_status\": \"paid\",\n      \"metadata\": {\n        \"userId\": \"user_123\"\n      }\n    }\n  }\n}\n```\n\n```typescript\n// test/fixtures/index.ts\nimport checkoutCompleted from './stripe-events/checkout.session.completed.json'\nimport subscriptionCreated from './stripe-events/customer.subscription.created.json'\n// ... more\n\nexport const stripeFixtures = {\n  checkoutCompleted,\n  subscriptionCreated,\n  // ...\n}\n\n// Load fixture with type safety\nexport function loadStripeFixture\u003cT extends keyof typeof stripeFixtures\u003e(\n  name: T\n): typeof stripeFixtures[T] {\n  return stripeFixtures[name]\n}\n```\n\n## Database Seeders\n\n```typescript\n// test/seeds/index.ts\nimport { DrizzleDB } from '@/db'\nimport { createUser, createProUser } from '../factories/user'\nimport { createSubscription } from '../factories/subscription'\n\nexport async function seedTestUsers(db: DrizzleDB) {\n  const users = [\n    createUser({ id: 'free_user', email: 'free@test.com' }),\n    createProUser({ id: 'pro_user', email: 'pro@test.com' }),\n    createUser({ id: 'team_admin', email: 'admin@test.com' }),\n  ]\n  \n  await db.insert(usersTable).values(users)\n  return users\n}\n\nexport async function seedTestSubscriptions(db: DrizzleDB) {\n  const subscriptions = [\n    createSubscription({ userId: 'pro_user' }),\n  ]\n  \n  await db.insert(subscriptionsTable).values(subscriptions)\n  return subscriptions\n}\n\nexport async function seedFullTestData(db: DrizzleDB) {\n  const users = await seedTestUsers(db)\n  const subscriptions = await seedTestSubscriptions(db)\n  // ... more\n  \n  return { users, subscriptions }\n}\n```\n\n## Factory Sequences (for unique values)\n\n```typescript\n// test/factories/sequences.ts\nlet userSequence = 0\nlet subscriptionSequence = 0\n\nexport function nextUserId() {\n  return `user_${++userSequence}`\n}\n\nexport function nextSubscriptionId() {\n  return `sub_${++subscriptionSequence}`\n}\n\nexport function resetSequences() {\n  userSequence = 0\n  subscriptionSequence = 0\n}\n```\n\n## Builder Pattern for Complex Objects\n\n```typescript\n// test/factories/builders/user-with-subscription.ts\nexport class TestUserBuilder {\n  private user: Partial\u003cUser\u003e = {}\n  private subscription: Partial\u003cSubscription\u003e | null = null\n  private entitlements: Partial\u003cEntitlement\u003e[] = []\n  \n  withEmail(email: string) {\n    this.user.email = email\n    return this\n  }\n  \n  withProSubscription() {\n    this.subscription = createSubscription()\n    this.entitlements.push({ type: 'pro', source: 'subscription' })\n    return this\n  }\n  \n  withTeamAccess(orgId: string) {\n    this.entitlements.push({ type: 'pro', source: 'team', organizationId: orgId })\n    return this\n  }\n  \n  async build(db: DrizzleDB) {\n    const user = createUser(this.user)\n    await db.insert(usersTable).values(user)\n    \n    if (this.subscription) {\n      await db.insert(subscriptionsTable).values({\n        ...this.subscription,\n        userId: user.id,\n      })\n    }\n    \n    for (const entitlement of this.entitlements) {\n      await db.insert(entitlementsTable).values({\n        ...createEntitlement(entitlement),\n        userId: user.id,\n      })\n    }\n    \n    return user\n  }\n}\n\n// Usage\nconst user = await new TestUserBuilder()\n  .withEmail('test@example.com')\n  .withProSubscription()\n  .build(db)\n```","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:06:55.87349-08:00","updated_at":"2025-12-11T10:06:55.87349-08:00","dependencies":[{"issue_id":"migrate-egghead-6y2.6","depends_on_id":"migrate-egghead-6y2","type":"parent-child","created_at":"2025-12-11T10:06:55.87391-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-6y2.7","title":"Add CI pipeline with test gates","description":"Set up CI/CD pipeline that's fast, reliable, and doesn't slow us down.\n\n## Philosophy: Fast Feedback, Real Tests\n\nCI should catch real bugs without being a bottleneck. Every minute of CI time is a minute of developer waiting.\n\n## Pipeline Architecture\n\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ                         PUSH TO BRANCH                          ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ  Parallel (total ~3min):                                        ‚îÇ\n‚îÇ  ‚îú‚îÄ Lint + Typecheck (30s)                                      ‚îÇ\n‚îÇ  ‚îú‚îÄ Unit tests (1-2min)                                         ‚îÇ\n‚îÇ  ‚îî‚îÄ Integration tests (2-3min)  ‚Üê Real DB, real Stripe          ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n                              ‚îÇ\n                              ‚ñº\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ                         PR TO MAIN                              ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ  Above + (runs after unit/integration pass):                    ‚îÇ\n‚îÇ  ‚îú‚îÄ E2E critical paths (5min)  ‚Üê Chromium only                  ‚îÇ\n‚îÇ  ‚îî‚îÄ Coverage check (80% gate)                                   ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n                              ‚îÇ\n                              ‚ñº\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ                        MERGE TO MAIN                            ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ  ‚îú‚îÄ Full E2E (all browsers)                                     ‚îÇ\n‚îÇ  ‚îú‚îÄ Deploy to Vercel preview                                    ‚îÇ\n‚îÇ  ‚îî‚îÄ Smoke tests against preview                                 ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## GitHub Actions Workflow\n\n```yaml\n# .github/workflows/ci.yml\nname: CI\n\non:\n  push:\n    branches: ['**']\n  pull_request:\n    branches: [main]\n\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true\n\njobs:\n  # ============================================\n  # FAST CHECKS - Run on every push\n  # ============================================\n  \n  lint-and-types:\n    runs-on: ubuntu-latest\n    timeout-minutes: 5\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: 'pnpm'\n      - run: pnpm install --frozen-lockfile\n      - run: pnpm lint\n      - run: pnpm typecheck\n\n  unit:\n    runs-on: ubuntu-latest\n    timeout-minutes: 5\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: 'pnpm'\n      - run: pnpm install --frozen-lockfile\n      - run: pnpm test:unit --coverage\n      - uses: actions/upload-artifact@v4\n        with:\n          name: coverage\n          path: coverage/\n\n  integration:\n    runs-on: ubuntu-latest\n    timeout-minutes: 10\n    services:\n      mysql:\n        image: mysql:8.0\n        env:\n          MYSQL_ROOT_PASSWORD: test\n          MYSQL_DATABASE: test\n        ports:\n          - 3306:3306\n        options: \u003e-\n          --health-cmd=\"mysqladmin ping\"\n          --health-interval=10s\n          --health-timeout=5s\n          --health-retries=3\n      redis:\n        image: redis:7\n        ports:\n          - 6379:6379\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: 'pnpm'\n      - run: pnpm install --frozen-lockfile\n      - run: pnpm db:migrate\n        env:\n          DATABASE_URL: mysql://root:test@localhost:3306/test\n      - run: pnpm test:integration\n        env:\n          DATABASE_URL: mysql://root:test@localhost:3306/test\n          REDIS_URL: redis://localhost:6379\n          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY_TEST }}\n\n  # ============================================\n  # PR CHECKS - Only on PRs to main\n  # ============================================\n  \n  e2e:\n    if: github.event_name == 'pull_request'\n    needs: [lint-and-types, unit]  # Don't waste time if basics fail\n    runs-on: ubuntu-latest\n    timeout-minutes: 15\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: 'pnpm'\n      - run: pnpm install --frozen-lockfile\n      - run: pnpm exec playwright install chromium --with-deps\n      - run: pnpm build\n      - run: pnpm test:e2e --project=chromium\n        env:\n          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}\n      - uses: actions/upload-artifact@v4\n        if: failure()\n        with:\n          name: playwright-report\n          path: playwright-report/\n          retention-days: 7\n\n  coverage-gate:\n    if: github.event_name == 'pull_request'\n    needs: [unit]\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/download-artifact@v4\n        with:\n          name: coverage\n      - name: Check coverage threshold\n        run: |\n          COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json)\n          echo \"Coverage: $COVERAGE%\"\n          if (( $(echo \"$COVERAGE \u003c 80\" | bc -l) )); then\n            echo \"::error::Coverage $COVERAGE% is below 80% threshold\"\n            exit 1\n          fi\n\n  # ============================================\n  # MERGE CHECKS - Only on main\n  # ============================================\n  \n  e2e-full:\n    if: github.ref == 'refs/heads/main'\n    needs: [lint-and-types, unit, integration]\n    runs-on: ubuntu-latest\n    timeout-minutes: 20\n    strategy:\n      matrix:\n        browser: [chromium, firefox, webkit]\n    steps:\n      - uses: actions/checkout@v4\n      - uses: pnpm/action-setup@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: 'pnpm'\n      - run: pnpm install --frozen-lockfile\n      - run: pnpm exec playwright install ${{ matrix.browser }} --with-deps\n      - run: pnpm build\n      - run: pnpm test:e2e --project=${{ matrix.browser }}\n```\n\n## Speed Optimizations\n\n### 1. Aggressive Caching\n\n```yaml\n- uses: actions/cache@v4\n  with:\n    path: |\n      ~/.pnpm-store\n      node_modules/.cache\n      .next/cache\n    key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}\n    restore-keys: |\n      ${{ runner.os }}-pnpm-\n```\n\n### 2. Parallel Everything\n\n```yaml\n# Run lint, unit, integration in parallel\n# E2E waits for fast checks to pass first\n```\n\n### 3. Skip Unchanged\n\n```yaml\n# Only run tests for changed packages in monorepo\n- uses: dorny/paths-filter@v2\n  id: changes\n  with:\n    filters: |\n      app:\n        - 'apps/egghead/**'\n      packages:\n        - 'packages/**'\n\n- run: pnpm test:unit\n  if: steps.changes.outputs.app == 'true'\n```\n\n### 4. Fail Fast\n\n```yaml\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true  # Kill old runs when new push comes\n```\n\n## Branch Protection\n\n```yaml\n# Required status checks before merge\nrequired_status_checks:\n  strict: true\n  contexts:\n    - lint-and-types\n    - unit\n    - integration\n    - e2e\n    - coverage-gate\n```\n\n## Notifications\n\n```yaml\nnotify:\n  if: failure() \u0026\u0026 github.ref == 'refs/heads/main'\n  needs: [e2e-full]\n  runs-on: ubuntu-latest\n  steps:\n    - uses: slackapi/slack-github-action@v1\n      with:\n        payload: |\n          {\n            \"text\": \"üî¥ Main branch CI failed\",\n            \"blocks\": [{\n              \"type\": \"section\",\n              \"text\": {\n                \"type\": \"mrkdwn\",\n                \"text\": \"*CI Failed on main*\\n\u003c${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run\u003e\"\n              }\n            }]\n          }\n      env:\n        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}\n```\n\n## Local Pre-commit (Optional)\n\n```bash\n# .husky/pre-commit\n#!/bin/sh\n# Only run affected tests - fast feedback\npnpm vitest --changed HEAD~1 --run\n```\n\n## What We're NOT Doing\n\n- ‚ùå Running all tests on every push (too slow)\n- ‚ùå Multiple browser E2E on PRs (chromium only, full suite on main)\n- ‚ùå Blocking on flaky tests (fix or delete immediately)\n- ‚ùå Complex matrix builds (keep it simple)\n- ‚ùå Separate staging deploys (Vercel previews are enough)","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:07:16.088201-08:00","updated_at":"2025-12-11T10:09:01.464733-08:00","dependencies":[{"issue_id":"migrate-egghead-6y2.7","depends_on_id":"migrate-egghead-6y2","type":"parent-child","created_at":"2025-12-11T10:07:16.088614-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-8cj","title":"Beads Restructure: Align with README Phases","description":"Export, analyze, and rebuild beads tracking to match README migration phases exactly. Includes holistic analysis, boy scouting, and clean new structure.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-12T09:11:26.410917-08:00","updated_at":"2025-12-12T16:02:32.087142-08:00","closed_at":"2025-12-12T16:02:32.087142-08:00"}
{"id":"migrate-egghead-8cj.1","title":"Export all beads to BEADS_ARCHIVE.md","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T09:11:26.445108-08:00","updated_at":"2025-12-12T09:21:14.580108-08:00","closed_at":"2025-12-12T09:21:14.580108-08:00","dependencies":[{"issue_id":"migrate-egghead-8cj.1","depends_on_id":"migrate-egghead-8cj","type":"parent-child","created_at":"2025-12-12T09:11:26.445403-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-8cj.2","title":"Holistic analysis and boy scouting report","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T09:11:26.475818-08:00","updated_at":"2025-12-12T09:23:33.299586-08:00","closed_at":"2025-12-12T09:23:33.299586-08:00","dependencies":[{"issue_id":"migrate-egghead-8cj.2","depends_on_id":"migrate-egghead-8cj","type":"parent-child","created_at":"2025-12-12T09:11:26.476112-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-8cj.3","title":"Archive old beads and create new phase-aligned structure","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T09:11:26.507583-08:00","updated_at":"2025-12-12T09:26:10.513585-08:00","closed_at":"2025-12-12T09:26:10.513585-08:00","dependencies":[{"issue_id":"migrate-egghead-8cj.3","depends_on_id":"migrate-egghead-8cj","type":"parent-child","created_at":"2025-12-12T09:11:26.507889-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-8cj.4","title":"Update README and AGENTS.md with current status","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T09:11:26.537314-08:00","updated_at":"2025-12-12T16:02:32.059648-08:00","closed_at":"2025-12-12T16:02:32.059648-08:00","dependencies":[{"issue_id":"migrate-egghead-8cj.4","depends_on_id":"migrate-egghead-8cj","type":"parent-child","created_at":"2025-12-12T09:11:26.537654-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-8dl","title":"Simplified Instructor Revenue Share","description":"Replace complex Plutus-based revenue share system with simple calculation.\n\n## Context\n- Current MRR: ~$20K (down from $270K peak)\n- Rails system: Full double-entry accounting with Plutus gem\n- Reality: Overkill for current scale\n\n## Current Rails System (KILL)\n- `InstructorRevenueSplit` - date-ranged percentage splits\n- `RevenueShareQuery` - 170-line SQL monster\n- `InstructorTransaction` - Plutus ledger operations\n- `Plutus::Entry` - double-entry accounting\n- `RevenueShareRun` - monthly calculation runs\n- Co-instructor splits, advances, rollups, checks\n\n## New Coursebuilder System (BUILD)\n\n### Simple Formula\n```\ninstructor_payout = (instructor_watch_minutes / total_watch_minutes) √ó revenue_pool √ó instructor_percentage\n```\n\n### Schema\n```sql\n-- Instructor percentage (simple)\ninstructor_revenue_config {\n  instructorId: string\n  percentage: decimal  -- e.g., 0.50 for 50%\n  effectiveFrom: date\n}\n\n-- Monthly payout record\ninstructor_payouts {\n  id: string\n  instructorId: string\n  month: date\n  watchMinutes: int\n  totalWatchMinutes: int\n  revenuePool: decimal\n  percentage: decimal\n  payoutAmount: decimal\n  status: enum('calculated', 'approved', 'paid')\n  paidAt: timestamp\n  stripeTransferId: string\n}\n```\n\n### Calculation (Inngest monthly job)\n1. Query total watch time per instructor for month\n2. Query total Stripe revenue for month (minus fees)\n3. Calculate each instructor's share\n4. Create payout records\n5. [HUMAN] Approve payouts\n6. Execute Stripe transfers\n\n### What We're NOT Porting\n- Plutus double-entry accounting\n- Advances and advance payback\n- Sellable-specific royalties\n- Complex date-ranged splits\n- Co-instructor auto-splitting (handle manually or fixed splits)\n\n### Migration\n1. Export current instructor percentages from `instructor_revenue_splits`\n2. Create simple `instructor_revenue_config` records\n3. Historical data stays in Rails (read-only archive)\n\n## Files to Reference\n- `egghead-rails/app/models/instructor_revenue_split.rb`\n- `egghead-rails/app/queries/revenue_share_query.rb`\n- `egghead-rails/app/models/instructor_transaction.rb`\n- `egghead-rails/app/models/instructor.rb` (get_payout methods)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:51:53.94323-08:00","updated_at":"2025-12-11T10:51:53.94323-08:00"}
{"id":"migrate-egghead-8fs","title":"Migration Control Plane TUI","description":"Build a terminal UI using OpenTUI that displays real-time migration progress via Durable Streams. Shows progress bars, error logs, and verification counts.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-13T10:36:08.278476-08:00","updated_at":"2025-12-13T10:36:08.278476-08:00"}
{"id":"migrate-egghead-8fs.1","title":"Core types and Durable Streams client","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-13T10:36:08.320696-08:00","updated_at":"2025-12-13T10:39:34.387478-08:00","closed_at":"2025-12-13T10:39:34.387478-08:00","dependencies":[{"issue_id":"migrate-egghead-8fs.1","depends_on_id":"migrate-egghead-8fs","type":"parent-child","created_at":"2025-12-13T10:36:08.32103-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-8fs.2","title":"TUI shell and state management","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T10:36:08.361573-08:00","updated_at":"2025-12-13T10:44:37.118408-08:00","closed_at":"2025-12-13T10:44:37.118408-08:00","dependencies":[{"issue_id":"migrate-egghead-8fs.2","depends_on_id":"migrate-egghead-8fs","type":"parent-child","created_at":"2025-12-13T10:36:08.36194-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-8fs.3","title":"Progress bars component","description":"","status":"in_progress","priority":1,"issue_type":"task","created_at":"2025-12-13T10:36:08.399585-08:00","updated_at":"2025-12-13T10:44:37.403412-08:00","dependencies":[{"issue_id":"migrate-egghead-8fs.3","depends_on_id":"migrate-egghead-8fs","type":"parent-child","created_at":"2025-12-13T10:36:08.399915-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-8fs.4","title":"Error log component","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T10:36:08.437523-08:00","updated_at":"2025-12-13T10:47:51.742808-08:00","closed_at":"2025-12-13T10:47:51.742808-08:00","dependencies":[{"issue_id":"migrate-egghead-8fs.4","depends_on_id":"migrate-egghead-8fs","type":"parent-child","created_at":"2025-12-13T10:36:08.43787-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-8fs.5","title":"Update migration scripts to emit events","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T10:36:08.476632-08:00","updated_at":"2025-12-13T10:44:37.276614-08:00","closed_at":"2025-12-13T10:44:37.276614-08:00","dependencies":[{"issue_id":"migrate-egghead-8fs.5","depends_on_id":"migrate-egghead-8fs","type":"parent-child","created_at":"2025-12-13T10:36:08.476962-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-9eu","title":"Research: Content Migration to Coursebuilder ContentResource","description":"Investigate what's required to move ALL lesson and course content from Rails and Sanity to Coursebuilder ContentResource structure, achieving single-database architecture.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-12T16:21:21.550127-08:00","updated_at":"2025-12-12T16:28:06.908592-08:00","closed_at":"2025-12-12T16:28:06.908592-08:00"}
{"id":"migrate-egghead-9eu.1","title":"Analyze Rails content schema and data structure","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T16:21:21.588222-08:00","updated_at":"2025-12-12T16:25:42.901575-08:00","closed_at":"2025-12-12T16:25:42.901575-08:00","dependencies":[{"issue_id":"migrate-egghead-9eu.1","depends_on_id":"migrate-egghead-9eu","type":"parent-child","created_at":"2025-12-12T16:21:21.588545-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-9eu.2","title":"Audit Sanity CMS content types and references","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T16:21:21.623469-08:00","updated_at":"2025-12-12T16:25:44.360687-08:00","closed_at":"2025-12-12T16:25:44.360687-08:00","dependencies":[{"issue_id":"migrate-egghead-9eu.2","depends_on_id":"migrate-egghead-9eu","type":"parent-child","created_at":"2025-12-12T16:21:21.623773-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-9eu.3","title":"Map Coursebuilder ContentResource schema and capabilities","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T16:21:21.656791-08:00","updated_at":"2025-12-12T16:25:45.282818-08:00","closed_at":"2025-12-12T16:25:45.282818-08:00","dependencies":[{"issue_id":"migrate-egghead-9eu.3","depends_on_id":"migrate-egghead-9eu","type":"parent-child","created_at":"2025-12-12T16:21:21.657105-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-9eu.4","title":"Identify code changes needed for content loading","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T16:21:21.689214-08:00","updated_at":"2025-12-12T16:25:46.169524-08:00","closed_at":"2025-12-12T16:25:46.169524-08:00","dependencies":[{"issue_id":"migrate-egghead-9eu.4","depends_on_id":"migrate-egghead-9eu","type":"parent-child","created_at":"2025-12-12T16:21:21.689553-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-9eu.5","title":"Synthesize findings into migration report","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-12T16:21:21.722214-08:00","updated_at":"2025-12-12T16:28:02.811031-08:00","closed_at":"2025-12-12T16:28:02.811031-08:00","dependencies":[{"issue_id":"migrate-egghead-9eu.5","depends_on_id":"migrate-egghead-9eu","type":"parent-child","created_at":"2025-12-12T16:21:21.722521-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-9mp","title":"Docker Compose Test Infrastructure","description":"Set up Docker Compose environment simulating the egghead migration stack: PostgreSQL (Rails source), MySQL (Coursebuilder target), Sanity GraphQL mock, and SQLite for Mux video tracking. Enables testing migrations before production.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-13T09:15:12.85296-08:00","updated_at":"2025-12-13T09:24:19.079735-08:00","closed_at":"2025-12-13T09:24:19.079735-08:00"}
{"id":"migrate-egghead-9mp.1","title":"Docker Compose base + PostgreSQL (Rails source)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-13T09:15:12.897655-08:00","updated_at":"2025-12-13T09:19:58.812398-08:00","closed_at":"2025-12-13T09:19:58.812398-08:00","dependencies":[{"issue_id":"migrate-egghead-9mp.1","depends_on_id":"migrate-egghead-9mp","type":"parent-child","created_at":"2025-12-13T09:15:12.897997-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-9mp.2","title":"MySQL container (Coursebuilder target)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T09:15:12.94516-08:00","updated_at":"2025-12-13T09:20:00.01531-08:00","closed_at":"2025-12-13T09:20:00.01531-08:00","dependencies":[{"issue_id":"migrate-egghead-9mp.2","depends_on_id":"migrate-egghead-9mp","type":"parent-child","created_at":"2025-12-13T09:15:12.945499-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-9mp.3","title":"SQLite volume + Mux video data","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T09:15:12.986391-08:00","updated_at":"2025-12-13T09:20:01.347791-08:00","closed_at":"2025-12-13T09:20:01.347791-08:00","dependencies":[{"issue_id":"migrate-egghead-9mp.3","depends_on_id":"migrate-egghead-9mp","type":"parent-child","created_at":"2025-12-13T09:15:12.986717-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-9mp.4","title":"Sanity GraphQL mock server","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T09:15:13.029464-08:00","updated_at":"2025-12-13T09:20:02.603506-08:00","closed_at":"2025-12-13T09:20:02.603506-08:00","dependencies":[{"issue_id":"migrate-egghead-9mp.4","depends_on_id":"migrate-egghead-9mp","type":"parent-child","created_at":"2025-12-13T09:15:13.029838-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-9mp.5","title":"Test runner script + environment config","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T09:15:13.074332-08:00","updated_at":"2025-12-13T09:23:56.15565-08:00","closed_at":"2025-12-13T09:23:56.15565-08:00","dependencies":[{"issue_id":"migrate-egghead-9mp.5","depends_on_id":"migrate-egghead-9mp","type":"parent-child","created_at":"2025-12-13T09:15:13.074667-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-9mp.6","title":"Sample migration test","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T09:15:13.117814-08:00","updated_at":"2025-12-13T09:23:57.29971-08:00","closed_at":"2025-12-13T09:23:57.29971-08:00","dependencies":[{"issue_id":"migrate-egghead-9mp.6","depends_on_id":"migrate-egghead-9mp","type":"parent-child","created_at":"2025-12-13T09:15:13.118136-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-axl","title":"Phase 6: Cutover + Final E2E Validation","description":"Execute the cutover: dual-write webhooks, shadow mode (7+ days), flip primary, auth cutover, DNS switch. Each step has E2E validation and human checkpoints. Gate: 7 days stable post-DNS, final authorization to kill Rails. RAILS IS DEAD.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:29:58.541849-08:00","updated_at":"2025-12-12T09:25:57.276035-08:00","closed_at":"2025-12-12T09:25:57.276035-08:00"}
{"id":"migrate-egghead-axl.1","title":"Deploy dual-write webhook configuration (Rails primary, CB shadow)","description":"## Deploy Dual-Write Webhook Config\n\n**Goal**: Configure Stripe to send webhooks to BOTH Rails and Coursebuilder simultaneously, with Rails as PRIMARY and CB as SHADOW.\n\n### Steps\n1. **Stripe Dashboard Configuration**\n   - Add new webhook endpoint for Coursebuilder (egghead.io/api/stripe/webhook)\n   - Keep existing Rails endpoint active\n   - Configure identical event types on both endpoints\n   - Set Rails endpoint priority higher (will be flipped later)\n\n2. **Implement Shadow Mode Handler**\n   - File: `course-builder/apps/egghead/src/inngest/functions/stripe/dual-write.ts`\n   - Log all incoming webhook events to Redis with timestamp\n   - Process events normally (create/update subscriptions)\n   - Tag with `shadow_mode: true` in metrics\n   - Do NOT send user-facing emails during shadow mode\n\n3. **Redis Event Logger**\n   - File: `course-builder/apps/egghead/src/lib/webhook-logger.ts`\n   - Schema: `{ stripe_event_id, timestamp, endpoint, processing_result, mutations }`\n   - TTL: 7 days\n   - Index by stripe_event_id for comparison queries\n\n4. **Verification Dashboard**\n   - Simple Inngest function that queries both systems\n   - Displays: events received, processing status, divergence rate\n   - Accessible at /admin/webhook-shadow-mode\n\n### Files\n- `course-builder/apps/egghead/src/inngest/functions/stripe/dual-write.ts`\n- `course-builder/apps/egghead/src/lib/webhook-logger.ts`\n- `course-builder/apps/egghead/src/app/admin/webhook-shadow-mode/page.tsx`\n\n### Acceptance Criteria\n- [ ] Both endpoints receiving webhooks from Stripe\n- [ ] All events logged to Redis with processing results\n- [ ] Dashboard shows real-time event comparison\n- [ ] No user-facing side effects from CB shadow processing\n- [ ] Idempotency verified (duplicate events don't create double subscriptions)\n\n### Risk Mitigation\n- CB failures do NOT affect Rails (primary remains authoritative)\n- Rate limit protection on CB endpoint (prevent Stripe retry storms)\n- Alerts if CB event processing falls behind \u003e 5 minutes","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:58.573993-08:00","updated_at":"2025-12-11T11:22:17.346079-08:00","dependencies":[{"issue_id":"migrate-egghead-axl.1","depends_on_id":"migrate-egghead-axl","type":"parent-child","created_at":"2025-12-11T09:29:58.5743-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-axl.10","title":"[HUMAN] Post-cutover monitoring + KILL RAILS authorization","description":"## Post-Cutover Monitoring + KILL RAILS\n\n**Goal**: Monitor Coursebuilder stability for 7 days post-DNS cutover, then permanently shut down Rails/Heroku.\n\n### Phase 1: 7-Day Monitoring Window\n\n#### Daily Health Checks (Run at 9am ET)\n\n**1. Error Rate Analysis**\n- **Sentry Dashboard**: Review last 24 hours\n  - Total errors: Should be \u003c 100/day (baseline)\n  - New error types: Investigate any not seen in shadow mode\n  - Critical errors: Auth failures, checkout failures, video playback failures\n- **Target**: \u003c 0.1% error rate (\u003c 1 error per 1000 requests)\n- **Action if exceeded**: Triage errors, deploy fixes within 24 hours\n\n**2. User-Facing Metrics**\n- **Login Success Rate**:\n  - Target: \u003e 99.5%\n  - Check: Auth logs for failed login attempts\n  - Alert if: Drops below 99% sustained for 1 hour\n  \n- **Video Playback Success Rate**:\n  - Target: \u003e 99%\n  - Check: Mux analytics for playback failures\n  - Alert if: Spike in buffering/loading errors\n  \n- **Checkout Conversion Rate**:\n  - Target: Match Rails baseline (e.g., 8.5%)\n  - Check: Stripe dashboard for successful subscriptions\n  - Alert if: Drops \u003e 10% from baseline\n\n**3. Webhook Processing Health**\n- **Inngest Dashboard**: Review subscription webhook functions\n  - Processing time: \u003c 200ms p95 (target)\n  - Failure rate: \u003c 0.01%\n  - Backlog: Should be zero (all events processed real-time)\n- **Stripe Event Log**: Verify all events delivered and processed\n- **Compare to Rails**: Divergence should be 0% now (Rails is shadow, not processing)\n\n**4. Search Functionality**\n- **Typesense Metrics**: Query latency, index health\n  - Target: \u003c 100ms p95 query time\n  - Check: Search result relevance (spot check \"React hooks\", \"TypeScript\")\n- **User Behavior**: Clicks from search results (should match baseline)\n\n**5. Support Ticket Volume**\n- **Help Scout/Intercom**: Review tickets tagged \"login\", \"access\", \"video\"\n  - Target: \u003c 5 tickets/day related to platform issues\n  - Alert if: Spike \u003e 10 tickets/day (indicates user-facing problem)\n- **Common Issues**: Categorize and prioritize (e.g., \"can't log in\" vs \"video quality\")\n\n#### Weekly Review (End of Day 7)\n\n**Metrics Summary**:\n- Total errors over 7 days: _____\n- Average error rate: _____%\n- Login success rate: _____%\n- Video playback success rate: _____%\n- Checkout conversion vs baseline: _____%\n- Support tickets (platform-related): _____\n\n**Go/No-Go Decision for Rails Shutdown**:\n- [ ] Error rate \u003c 0.1% for 7 consecutive days\n- [ ] No critical bugs unresolved\n- [ ] Support ticket volume normal (\u003c 5/day platform issues)\n- [ ] Stakeholder approval (Joel + team)\n\n### Phase 2: Archive Rails (Day 8+)\n\n#### Pre-Shutdown Checklist\n\n**1. Data Archival**\n- **PostgreSQL Dump**: Full backup of Rails DB\n  - Command: `pg_dump -Fc egghead_production \u003e egghead_rails_final_backup.dump`\n  - Store: S3 bucket (encrypted, long-term storage)\n  - Verify: Restore to test DB, spot-check data integrity\n\n- **Critical Data Extraction** (if not already migrated):\n  - Audit logs: Export to CSV, store in S3\n  - Historical analytics: Export key metrics (traffic, revenue, engagement)\n  - User-generated content: Comments, forum posts (if applicable)\n\n**2. Dependency Audit**\n- **Third-Party Integrations**: Ensure none still pointing to Rails\n  - Stripe webhooks: Already pointing to CB (verified in axl.5)\n  - ConvertKit/Email provider: Forms/embeds pointing to CB\n  - Analytics: GA4/Segment tracking CB domain\n  - CDN: Cloudflare rules updated for CB URLs\n\n- **Internal Tools**: Check for hardcoded Rails URLs\n  - Admin scripts, dashboards, monitoring tools\n  - Update to use CB URLs or mark as deprecated\n\n**3. DNS Final Cleanup**\n- **Remove Rails DNS Records**:\n  - Delete any lingering subdomains pointing to Heroku\n  - Example: `admin.egghead.io` if it was Rails-specific\n  - Keep: DNS records for CB only\n\n- **SSL Certificates**: Let Rails/Heroku certs expire (no renewal)\n\n#### Shutdown Procedure\n\n**1. Heroku App Shutdown** (Permanent)\n- **Action**: Heroku dashboard ‚Üí Select `egghead-rails` app ‚Üí Settings ‚Üí Delete app\n- **Before deletion**:\n  - Final DB backup (see above)\n  - Export Heroku logs (last 7 days): `heroku logs --tail --app egghead-rails \u003e final_logs.txt`\n  - Screenshot Heroku config vars (for reference)\n\n- **Confirmation**: Type app name to confirm deletion\n- **Result**: App destroyed, dynos stopped, add-ons detached\n\n**2. Heroku Add-ons Cleanup**\n- **PostgreSQL**: If separate add-on, delete after backup verified\n- **Redis**: Delete (no longer needed, CB uses Upstash/Vercel KV)\n- **Other Add-ons**: Review and delete (e.g., Sendgrid, New Relic if Rails-specific)\n\n**3. Repository Archival**\n- **GitHub**: egghead-rails repo ‚Üí Settings ‚Üí Archive repository\n  - Mark as read-only (no new commits allowed)\n  - Add banner: \"This repository is archived. egghead.io now runs on Coursebuilder.\"\n  - Keep public or private based on preference (likely private)\n\n- **Tag Final State**: `git tag -a v-final-rails-shutdown -m \"Final Rails state before shutdown\"`\n- **Push Tag**: `git push origin v-final-rails-shutdown`\n\n**4. Update Documentation**\n- **README**: Add deprecation notice\n  ```markdown\n  # egghead-rails [ARCHIVED]\n\n  This repository is no longer active. egghead.io migrated to Coursebuilder in [DATE].\n\n  For current codebase, see: [link to course-builder/apps/egghead]\n  ```\n\n- **Wiki/Confluence**: Update migration timeline, mark Rails as EOL\n- **Team Onboarding Docs**: Remove Rails setup instructions\n\n#### Post-Shutdown Verification\n\n**1. Confirm Zero Traffic to Rails**\n- **Heroku Logs**: Should show \"App deleted\" or equivalent\n- **DNS**: `dig egghead.io` should never resolve to Heroku IP\n- **Sentry (if Rails had it)**: No new errors reported\n\n**2. Confirm CB Handling 100% of Traffic**\n- **Vercel Analytics**: Traffic stable, no sudden drop (would indicate DNS issue)\n- **Stripe Webhooks**: All events processed by CB only (no Rails shadow logs)\n\n**3. Cost Savings Verification**\n- **Heroku Bill**: Should drop to $0 next billing cycle (or residual add-on costs if not cleaned up)\n- **Estimated Savings**: ~$500-1000/month (Heroku dynos + add-ons)\n\n### Phase 3: Long-Term Monitoring (30+ Days)\n\n**Monthly Review** (for next 3 months):\n- Compare CB metrics to Rails historical baseline\n  - Traffic: Should match or grow\n  - Engagement: Watch time, course completions\n  - Revenue: Subscription creation rate, churn rate\n- Verify: No regressions, no \"wish we kept Rails\" moments\n- Document: Lessons learned, migration retrospective\n\n### Files\n- `reports/POST-CUTOVER-MONITORING.md` (this document in markdown)\n- `reports/MIGRATION-RETROSPECTIVE.md` (create post-shutdown for learnings)\n- `scripts/rails-archive-backup.sh` (automate DB dump, S3 upload)\n\n### Acceptance Criteria\n- [ ] 7 days post-DNS with error rate \u003c 0.1%\n- [ ] All critical metrics stable or improved vs Rails baseline\n- [ ] Support ticket volume normal (no platform-crisis spike)\n- [ ] Rails PostgreSQL fully backed up to S3\n- [ ] Heroku app deleted, costs dropped to $0\n- [ ] egghead-rails GitHub repo archived\n- [ ] Documentation updated (Rails marked as EOL)\n- [ ] Team celebrates migration completion üéâ\n\n### Rollback Plan (Even After Rails Shutdown)\n\n**If Critical Issue Found Post-Shutdown**:\n- Rails is gone, no rollback to old system possible\n- **Mitigation**: Fix-forward in CB (this is why we monitor 7 days first)\n- **Backup Plan**: Restore Rails from backup to separate Heroku app (emergency only)\n  - Cost: ~$500 for temporary Heroku app\n  - Time: ~2 hours to restore and re-point DNS\n  - Use Case: Catastrophic data loss or corruption in CB\n\n### Celebration Checklist\n- [ ] Post in #egghead-team: \"Rails is dead, long live Coursebuilder!\"\n- [ ] Team retro: What went well, what didn't, what we'd do differently\n- [ ] Document migration timeline for future reference (blog post?)\n- [ ] Archive all migration runbooks in `reports/archive/`\n- [ ] Update team wiki: \"How egghead.io runs\" (CB architecture)\n\n### Estimated Costs\n\n**7-Day Monitoring**:\n- Heroku: ~$500 (dynos + add-ons)\n- Time: ~2 hours/day monitoring = ~$2000 (assuming $100/hr)\n\n**Rails Shutdown**:\n- One-time: ~4 hours (backup, cleanup, archival) = ~$400\n- Ongoing savings: ~$500-1000/month (Heroku eliminated)\n\n**ROI**: Savings pay for monitoring/shutdown within 1-2 months","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:58.86953-08:00","updated_at":"2025-12-11T11:25:20.229479-08:00","dependencies":[{"issue_id":"migrate-egghead-axl.10","depends_on_id":"migrate-egghead-axl","type":"parent-child","created_at":"2025-12-11T09:29:58.869983-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-axl.2","title":"Build shadow traffic comparison tool","description":"## Build Shadow Traffic Comparison Tool\n\n**Goal**: Automated comparison of Rails vs Coursebuilder webhook processing results to detect divergence before cutover.\n\n### Steps\n1. **Comparison Engine**\n   - File: `course-builder/apps/egghead/src/lib/webhook-comparison.ts`\n   - Query Redis logs for same stripe_event_id\n   - Compare: subscription status, price_id, quantity, customer_id\n   - Detect: missing events, processing failures, data mismatches\n   - Score divergence: 0% = perfect match, \u003e0.1% = investigate\n\n2. **Metrics Collection**\n   - Track per event type: `customer.subscription.created`, `updated`, `deleted`\n   - Latency: Rails processing time vs CB processing time\n   - Success rate: % of events processed without error\n   - Data mutations: Did both systems produce identical DB state?\n\n3. **Divergence Detection**\n   - File: `course-builder/apps/egghead/src/inngest/functions/stripe/compare-shadow.ts`\n   - Runs every 5 minutes via Inngest cron\n   - Queries last 1 hour of events\n   - Calculates divergence rate\n   - Triggers alert if \u003e 0.1% divergence\n\n4. **Alert System**\n   - Slack webhook to #egghead-migration channel\n   - Include: event type, divergence %, sample event IDs\n   - Link to comparison dashboard for investigation\n   - Email to joel@ if divergence \u003e 1%\n\n5. **Investigation Dashboard**\n   - File: `course-builder/apps/egghead/src/app/admin/webhook-comparison/page.tsx`\n   - Shows: event timeline, divergence graph, failed event details\n   - Drill-down: View specific event processing diff (Rails vs CB)\n   - Export: CSV of divergent events for analysis\n\n### Files\n- `course-builder/apps/egghead/src/lib/webhook-comparison.ts`\n- `course-builder/apps/egghead/src/inngest/functions/stripe/compare-shadow.ts`\n- `course-builder/apps/egghead/src/app/admin/webhook-comparison/page.tsx`\n- `course-builder/apps/egghead/src/lib/alerts/slack.ts`\n\n### Acceptance Criteria\n- [ ] Dashboard shows real-time divergence rate (updated every 5 min)\n- [ ] Successful comparison of 100+ events with 0% divergence\n- [ ] Alert triggered when test divergence injected\n- [ ] Latency metrics show CB processing time \u003c Rails by at least 20%\n- [ ] Drill-down investigation works for failed events\n\n### Key Metrics\n- **Target divergence**: \u003c 0.1% over 7 days\n- **Target latency**: CB \u003c 200ms avg (Rails ~500ms)\n- **Target success rate**: \u003e 99.9%\n\n### Risk Mitigation\n- False positive alerts (tune thresholds based on 24hr baseline)\n- Redis memory usage (auto-expire logs after 7 days)\n- Comparison function performance (batch queries, not per-event)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:58.605231-08:00","updated_at":"2025-12-11T11:22:31.569421-08:00","dependencies":[{"issue_id":"migrate-egghead-axl.2","depends_on_id":"migrate-egghead-axl","type":"parent-child","created_at":"2025-12-11T09:29:58.605531-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-axl.3","title":"E2E: Run full suite against shadow mode","description":"## E2E Full Suite Against Shadow Mode\n\n**Goal**: Comprehensive end-to-end testing of Coursebuilder while Rails is still primary to verify production-readiness.\n\n### Steps\n1. **E2E Test Suite Structure**\n   - Directory: `course-builder/apps/egghead/e2e/shadow-mode/`\n   - Framework: Playwright (already in course-builder)\n   - Environment: Use Stripe test mode + test DB (isolated from shadow logs)\n   - Target URL: CB staging instance (not production yet)\n\n2. **Critical User Flows**\n   - **Checkout Flow** (`e2e/shadow-mode/checkout.spec.ts`)\n     - Guest user ‚Üí Browse course ‚Üí Add to cart ‚Üí Stripe checkout\n     - Verify: Stripe session created, webhook received, subscription created\n     - Verify: User receives access to course content\n   \n   - **Subscription Management** (`e2e/shadow-mode/subscription.spec.ts`)\n     - Login ‚Üí Account page ‚Üí View subscription\n     - Cancel subscription ‚Üí Verify webhook ‚Üí Access revoked at period_end\n     - Reactivate subscription ‚Üí Verify access restored\n   \n   - **Progress Tracking** (`e2e/shadow-mode/progress.spec.ts`)\n     - Login ‚Üí Start lesson ‚Üí Mark complete ‚Üí Verify progress saved\n     - Resume from different device (session sync)\n     - Complete course ‚Üí Verify certificate issued\n   \n   - **Search** (`e2e/shadow-mode/search.spec.ts`)\n     - Search for \"React hooks\" ‚Üí Verify Typesense results\n     - Filter by instructor, topic, skill level\n     - Click result ‚Üí Navigate to course page\n   \n   - **Auth** (`e2e/shadow-mode/auth.spec.ts`)\n     - Magic link login ‚Üí Verify email sent ‚Üí Click link ‚Üí Logged in\n     - GitHub OAuth ‚Üí Authorize ‚Üí Account created/linked\n     - Logout ‚Üí Verify session cleared\n\n3. **Data Integrity Checks**\n   - File: `e2e/shadow-mode/data-integrity.spec.ts`\n   - Verify: User record created with correct email\n   - Verify: Subscription record matches Stripe data\n   - Verify: Progress records persist across sessions\n   - Verify: No duplicate subscriptions from webhook replays\n\n4. **Performance Benchmarks**\n   - File: `e2e/shadow-mode/performance.spec.ts`\n   - Measure: Page load time (\u003c 1.5s for course pages)\n   - Measure: Video player start time (\u003c 500ms)\n   - Measure: Search query time (\u003c 200ms)\n   - Compare to Rails baseline (should be faster or equal)\n\n5. **Edge Cases**\n   - File: `e2e/shadow-mode/edge-cases.spec.ts`\n   - Duplicate webhook delivery (idempotency test)\n   - Subscription upgrade/downgrade mid-cycle\n   - User with both individual + team subscription\n   - Expired subscription grace period handling\n\n### Files\n- `course-builder/apps/egghead/e2e/shadow-mode/checkout.spec.ts`\n- `course-builder/apps/egghead/e2e/shadow-mode/subscription.spec.ts`\n- `course-builder/apps/egghead/e2e/shadow-mode/progress.spec.ts`\n- `course-builder/apps/egghead/e2e/shadow-mode/search.spec.ts`\n- `course-builder/apps/egghead/e2e/shadow-mode/auth.spec.ts`\n- `course-builder/apps/egghead/e2e/shadow-mode/data-integrity.spec.ts`\n- `course-builder/apps/egghead/e2e/shadow-mode/performance.spec.ts`\n- `course-builder/apps/egghead/e2e/shadow-mode/edge-cases.spec.ts`\n- `course-builder/apps/egghead/e2e/playwright.config.ts` (shadow mode config)\n\n### Acceptance Criteria\n- [ ] All 50+ E2E tests pass in shadow mode environment\n- [ ] Zero data integrity violations detected\n- [ ] Performance benchmarks meet or exceed Rails baseline\n- [ ] Idempotency verified (duplicate webhooks don't break state)\n- [ ] All critical user flows work without Rails as fallback\n\n### CI Integration\n- Run E2E suite on every PR to CB egghead app\n- Gate merges on E2E passing\n- Nightly full suite run against staging (includes shadow mode tests)\n\n### Risk Mitigation\n- Isolate test environment (don't pollute shadow mode logs)\n- Use Stripe test mode (no real charges)\n- Test DB reset between runs (clean slate)\n- Screenshot + video recording on failures (Playwright built-in)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:58.636924-08:00","updated_at":"2025-12-11T11:22:52.388364-08:00","dependencies":[{"issue_id":"migrate-egghead-axl.3","depends_on_id":"migrate-egghead-axl","type":"parent-child","created_at":"2025-12-11T09:29:58.637281-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-axl.4","title":"[HUMAN] Shadow mode review (7+ days, \u003c0.1% divergence)","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:58.669454-08:00","updated_at":"2025-12-11T09:29:58.669454-08:00","dependencies":[{"issue_id":"migrate-egghead-axl.4","depends_on_id":"migrate-egghead-axl","type":"parent-child","created_at":"2025-12-11T09:29:58.669763-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-axl.5","title":"Execute flip to Coursebuilder primary","description":"## Execute Flip to Coursebuilder Primary\n\n**Goal**: Switch Coursebuilder from SHADOW to PRIMARY, making it the authoritative system for webhook processing while Rails becomes read-only shadow.\n\n### Prerequisites\n- [ ] 7 days shadow mode with \u003c 0.1% divergence\n- [ ] All E2E tests passing (axl.3 complete)\n- [ ] Comparison tool shows stable metrics (axl.2 complete)\n- [ ] Stakeholder approval (Joel, team review)\n\n### Runbook Steps\n\n#### 1. Pre-Flip Verification (15 min)\n- Check divergence rate over last 24 hours (must be \u003c 0.1%)\n- Verify CB webhook endpoint response time \u003c 200ms avg\n- Verify no Inngest function failures in last 1 hour\n- Confirm DB replication lag \u003c 1 second (PlanetScale)\n- Take snapshot of current subscription counts (Rails vs CB for comparison)\n\n#### 2. Communication (5 min)\n- Post in #egghead-team: \"Starting cutover flip to Coursebuilder\"\n- Update status page: \"Maintenance window - 30 min - no user impact expected\"\n- Have rollback plan ready (see below)\n\n#### 3. Update Stripe Webhook Configuration (10 min)\n- **Action**: Stripe Dashboard ‚Üí Webhooks\n- **Change**: Increase CB endpoint priority to 1 (highest)\n- **Change**: Decrease Rails endpoint priority to 2 (shadow)\n- **Verify**: Send test event ‚Üí Check both endpoints receive it\n- **Verify**: CB processes first (check webhook logger timestamps)\n\n#### 4. Verify CB Processing (30 min observation)\n- Monitor Inngest dashboard for new subscription events\n- Check DB: New subscriptions being created in CB\n- Verify comparison tool: CB now shows as PRIMARY in logs\n- Check error rates: Should remain \u003c 0.01%\n- Test user flow: Create test subscription ‚Üí Verify access granted\n\n#### 5. Mark Rails Read-Only (Shadow Mode) (5 min)\n- **Action**: Rails webhook handler ‚Üí Add `SHADOW_MODE=true` env var\n- **Effect**: Rails processes webhooks but doesn't send emails or user-facing actions\n- **Verify**: Rails logs show \"SHADOW MODE\" prefix\n- **Keep**: Rails admin panel read-only access (for 7 days comparison)\n\n#### 6. Post-Flip Verification (1 hour monitoring)\n- Watch for spike in errors (Sentry, Inngest dashboard)\n- Verify webhook processing rate matches historical baseline\n- Check user-facing metrics: login success rate, video playback starts\n- Run spot-check E2E test: checkout flow end-to-end\n- Verify comparison tool: Divergence rate still \u003c 0.1%\n\n#### 7. Rollback Plan (If Needed)\n**Trigger Conditions**:\n- Error rate \u003e 1% sustained for 10 minutes\n- Divergence rate \u003e 5% sustained for 5 minutes\n- Critical user flow broken (checkout, login)\n\n**Rollback Steps** (5 min):\n1. Stripe Dashboard ‚Üí Flip webhook priorities back (Rails = 1, CB = 2)\n2. Remove `SHADOW_MODE=true` from Rails env\n3. Post mortem: Review logs, identify root cause\n4. Fix issue in CB, re-test in shadow mode for 24 hours before retry\n\n### Files\n- `reports/CUTOVER-RUNBOOK.md` (this document in markdown form)\n- `course-builder/apps/egghead/src/inngest/functions/stripe/webhook-handler.ts` (ensure PRIMARY mode active)\n- `egghead-rails/app/controllers/stripe_webhooks_controller.rb` (add SHADOW_MODE check)\n\n### Acceptance Criteria\n- [ ] CB is PRIMARY (processes webhooks first)\n- [ ] Rails is SHADOW (processes but read-only)\n- [ ] No errors during flip window\n- [ ] User flows unaffected (checkout, login, video playback work)\n- [ ] Comparison tool shows CB as PRIMARY in logs\n- [ ] Team notified of successful flip\n\n### Monitoring Checklist (Next 24 Hours)\n- Error rate \u003c 0.1%\n- Webhook processing latency \u003c 200ms p95\n- Login success rate \u003e 99.5%\n- Subscription creation rate matches historical avg\n- Zero reports of access issues in support channels\n\n### Documentation\n- Update team wiki: \"Coursebuilder is now PRIMARY\"\n- Update incident response playbook: CB as source of truth\n- Tag Rails repo: \"read-only-shadow-mode-YYYY-MM-DD\"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:58.703073-08:00","updated_at":"2025-12-11T11:23:16.275522-08:00","dependencies":[{"issue_id":"migrate-egghead-axl.5","depends_on_id":"migrate-egghead-axl","type":"parent-child","created_at":"2025-12-11T09:29:58.703383-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-axl.6","title":"Auth cutover + password reset campaign","description":"## Auth Cutover + Magic Link Verification\n\n**Goal**: Verify authentication works seamlessly in Coursebuilder (magic link + GitHub OAuth) without requiring password migration.\n\n### Context\n- **egghead DOES NOT use passwords** (magic link + GitHub OAuth only)\n- **No password reset campaign needed** (unlike typical migrations)\n- Users continue using same auth methods, just on CB instead of Rails\n\n### Steps\n\n#### 1. Verify Magic Link Flow (30 min)\n- **Test as guest user**:\n  - Visit egghead.io (CB) ‚Üí Click \"Sign In\"\n  - Enter email ‚Üí Receive magic link email\n  - Click link ‚Üí Redirected to site, logged in\n  - Verify: Session cookie set, user record in CB DB\n\n- **Verify email delivery**:\n  - File: `course-builder/apps/egghead/src/lib/auth/magic-link.ts`\n  - Check: Email sent via ConvertKit/Resend (whatever CB uses)\n  - Check: Link expires after 15 minutes (security)\n  - Check: Link is single-use (can't replay)\n\n- **Test edge cases**:\n  - Expired link ‚Üí Shows error, offers to resend\n  - Already logged in user clicks link ‚Üí No-op or redirect to account\n  - Invalid token ‚Üí Clear error message\n\n#### 2. Verify GitHub OAuth Flow (30 min)\n- **Test as guest user**:\n  - Visit egghead.io (CB) ‚Üí Click \"Sign in with GitHub\"\n  - OAuth authorize screen ‚Üí Approve\n  - Redirected to site, logged in\n  - Verify: GitHub profile linked to user record\n\n- **Test existing user with GitHub**:\n  - User already has GitHub linked in Rails\n  - Login via GitHub OAuth in CB\n  - Verify: Same user record matched (by email or GitHub ID)\n  - Verify: No duplicate accounts created\n\n- **Test account linking**:\n  - User created via magic link ‚Üí Later connects GitHub\n  - Verify: GitHub profile linked to existing account (not new account)\n\n#### 3. Session Management (15 min)\n- **Verify session persistence**:\n  - Login ‚Üí Close browser ‚Üí Reopen ‚Üí Still logged in (7 day session)\n  - Logout ‚Üí Verify session cleared, can't access protected routes\n\n- **Verify session security**:\n  - File: `course-builder/apps/egghead/src/lib/auth/session.ts`\n  - Check: HttpOnly cookies (prevent XSS)\n  - Check: Secure flag (HTTPS only)\n  - Check: SameSite=Lax (CSRF protection)\n\n#### 4. User Communication (No Password Reset Needed)\n- **Email to all users** (post-DNS cutover):\n  - Subject: \"egghead.io has moved to a new platform\"\n  - Body: \"You can still log in the same way - magic link or GitHub\"\n  - Include: Link to help doc if issues\n  - Tone: Low-key, no action required from users\n\n- **Help Doc**:\n  - File: `course-builder/apps/egghead/src/app/help/login/page.mdx`\n  - Title: \"How to log in to egghead\"\n  - Content: Magic link steps, GitHub OAuth steps, troubleshooting\n  - FAQ: \"Do I need a password?\" ‚Üí No, we use magic links\n\n#### 5. Migration of Existing Sessions (Handled by DNS Cutover)\n- **No session migration needed**:\n  - Rails sessions will expire naturally (7 days)\n  - Users will re-login via magic link or GitHub on CB\n  - No forced logout required\n\n- **Session invalidation strategy**:\n  - Rails read-only mode ‚Üí Sessions still work for 7 days\n  - After DNS cutover ‚Üí Rails sessions gradually expire\n  - CB sessions created on first login post-cutover\n\n### Files\n- `course-builder/apps/egghead/src/lib/auth/magic-link.ts`\n- `course-builder/apps/egghead/src/lib/auth/github-oauth.ts`\n- `course-builder/apps/egghead/src/lib/auth/session.ts`\n- `course-builder/apps/egghead/src/app/auth/signin/page.tsx`\n- `course-builder/apps/egghead/src/app/auth/callback/github/route.ts`\n- `course-builder/apps/egghead/src/app/help/login/page.mdx`\n- `course-builder/apps/egghead/emails/magic-link.tsx` (email template)\n\n### Acceptance Criteria\n- [ ] Magic link flow works end-to-end (send email ‚Üí click ‚Üí logged in)\n- [ ] GitHub OAuth flow works end-to-end (authorize ‚Üí logged in)\n- [ ] Existing users with GitHub linked can log in without issues\n- [ ] No duplicate accounts created during OAuth flow\n- [ ] Session security verified (HttpOnly, Secure, SameSite)\n- [ ] Help doc published and accessible\n- [ ] Email template tested (send to test account, verify formatting)\n\n### Testing Checklist\n- [ ] Test with fresh account (never used egghead before)\n- [ ] Test with existing account (migrated from Rails)\n- [ ] Test with existing GitHub-linked account\n- [ ] Test magic link expiration (wait 15 min)\n- [ ] Test magic link single-use (click twice)\n- [ ] Test session persistence (close browser, reopen)\n- [ ] Test logout (verify session cleared)\n\n### Risk Mitigation\n- Magic link email delivery (monitor bounce rate, spam folder)\n- GitHub OAuth config mismatch (verify callback URL in GitHub app settings)\n- Session cookie domain mismatch (ensure `.egghead.io` domain)\n- Duplicate account creation (match by email AND GitHub ID)\n\n### Monitoring Post-Cutover\n- Login success rate (should be \u003e 99.5%)\n- Magic link email open rate (track via email provider)\n- GitHub OAuth success rate (Sentry for errors)\n- Support tickets related to login (should be minimal)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:58.735979-08:00","updated_at":"2025-12-11T11:23:44.082654-08:00","dependencies":[{"issue_id":"migrate-egghead-axl.6","depends_on_id":"migrate-egghead-axl","type":"parent-child","created_at":"2025-12-11T09:29:58.736299-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-axl.7","title":"E2E: Post-flip full regression suite","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:58.769067-08:00","updated_at":"2025-12-11T09:29:58.769067-08:00","dependencies":[{"issue_id":"migrate-egghead-axl.7","depends_on_id":"migrate-egghead-axl","type":"parent-child","created_at":"2025-12-11T09:29:58.769368-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-axl.8","title":"[HUMAN] DNS cutover authorization (24h+ stable)","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:58.802579-08:00","updated_at":"2025-12-11T09:29:58.802579-08:00","dependencies":[{"issue_id":"migrate-egghead-axl.8","depends_on_id":"migrate-egghead-axl","type":"parent-child","created_at":"2025-12-11T09:29:58.802902-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-axl.9","title":"Execute DNS cutover (keep Rails read-only 7 days)","description":"## Execute DNS Cutover\n\n**Goal**: Switch egghead.io DNS from Rails (Heroku) to Coursebuilder (Vercel) while maintaining zero downtime and zero 404s.\n\n### Prerequisites\n- [ ] CB is PRIMARY for 7 days with stable metrics (axl.5 complete)\n- [ ] Auth verified working (axl.6 complete)\n- [ ] All redirects deployed (Phase 4 complete)\n- [ ] E2E tests passing against CB production URL\n- [ ] Stakeholder approval for cutover date/time\n\n### Pre-Cutover Preparation (48 hours before)\n\n#### 1. Lower DNS TTL (48h before cutover)\n- **Action**: DNS provider (Cloudflare/Route53) ‚Üí Lower TTL to 60 seconds\n- **Why**: Allows fast rollback if issues detected post-cutover\n- **Current TTL**: Likely 3600s (1 hour) - check current value\n- **New TTL**: 60s (1 minute)\n- **Wait**: 48 hours for old TTL to expire globally\n\n#### 2. Verify Vercel Configuration\n- File: `course-builder/apps/egghead/vercel.json`\n- Verify: Custom domain `egghead.io` added to Vercel project\n- Verify: SSL certificate provisioned (Vercel auto-provisions)\n- Verify: `www.egghead.io` redirects to `egghead.io` (or vice versa based on preference)\n\n#### 3. Pre-Cutover Smoke Tests\n- Test CB production URL directly (e.g., `egghead-cb.vercel.app`)\n- Verify: Homepage loads, search works, video player works\n- Verify: All critical redirects work (test `/courses/react`, `/instructors/kentcdodds`)\n- Verify: Auth works (magic link, GitHub OAuth)\n- Verify: Checkout flow works (test subscription purchase)\n\n### Cutover Window\n\n**Recommended Time**: Tuesday or Wednesday, 10am ET (low traffic, team available)\n\n#### Step 1: Final Verification (15 min before)\n- Check CB production health: Error rate \u003c 0.1%, response time \u003c 500ms\n- Check Inngest: No backlog, all functions healthy\n- Check PlanetScale: Replication lag \u003c 1s, connection pool healthy\n- Post in #egghead-team: \"DNS cutover starting in 15 minutes\"\n\n#### Step 2: Update DNS Records (5 min)\n**Action**: DNS provider ‚Üí Update A/CNAME records\n\n**Old (Rails/Heroku)**:\n```\negghead.io          CNAME   egghead-rails.herokuapp.com\nwww.egghead.io      CNAME   egghead-rails.herokuapp.com\n```\n\n**New (Coursebuilder/Vercel)**:\n```\negghead.io          CNAME   cname.vercel-dns.com\nwww.egghead.io      CNAME   cname.vercel-dns.com\n```\n\n**Verify**: DNS provider shows updated records\n**Note**: Propagation starts immediately but takes 1-60 minutes globally (due to TTL)\n\n#### Step 3: Monitor Propagation (30 min)\n- **Check DNS propagation**: Use `dig egghead.io` from multiple locations\n  - Run from local machine: `dig egghead.io +short`\n  - Use online tools: whatsmydns.net (check 10+ global locations)\n- **Target**: 80%+ of global DNS servers showing new IP within 30 min\n\n#### Step 4: Verify Traffic Shift (1 hour)\n- **Vercel Analytics**: Watch real-time traffic increase to CB\n- **Heroku Logs**: Watch traffic decrease to Rails (should taper off)\n- **Sentry**: Monitor error rate on CB (should stay \u003c 0.1%)\n- **User-facing checks**:\n  - Visit egghead.io in incognito (bypasses browser cache)\n  - Verify: CB version loads (check footer or version meta tag)\n  - Test: Login, search, video playback\n\n#### Step 5: Test Critical Flows (30 min)\n- [ ] Homepage loads without errors\n- [ ] Search returns results\n- [ ] Course page loads, video plays\n- [ ] Login via magic link works\n- [ ] Login via GitHub OAuth works\n- [ ] Checkout flow (create test subscription, verify webhook)\n- [ ] Instructor page loads (e.g., `/kent`)\n- [ ] Legacy URL redirects work (e.g., `/courses/react` ‚Üí new URL)\n\n#### Step 6: Keep Rails Read-Only (7 days)\n- **Action**: Do NOT shut down Rails/Heroku yet\n- **Why**: Fallback option if critical issue found in CB\n- **Mode**: Rails remains in shadow mode (receiving webhooks, not processing)\n- **Access**: Keep Rails admin panel accessible (for data comparison)\n- **Cost**: ~$500 Heroku for 7 days (acceptable safety net)\n\n### Rollback Plan (If Needed)\n\n**Trigger Conditions**:\n- Error rate \u003e 1% sustained for 10 minutes post-cutover\n- Critical feature broken (login, checkout, video playback)\n- Mass user reports of issues (\u003e 10 support tickets in 1 hour)\n\n**Rollback Steps** (10 min):\n1. DNS provider ‚Üí Revert A/CNAME records to Rails/Heroku\n2. Wait 5 minutes for DNS propagation (TTL is 60s)\n3. Verify traffic shifts back to Rails (Heroku logs)\n4. Post-mortem: Review CB logs, identify root cause\n5. Fix issue, re-test, schedule new cutover date\n\n### Post-Cutover Monitoring (7 Days)\n\n**Immediate (First 6 Hours)**:\n- [ ] Error rate \u003c 0.1%\n- [ ] Login success rate \u003e 99.5%\n- [ ] Video playback success rate \u003e 99%\n- [ ] Checkout flow success rate \u003e 99%\n- [ ] No 404s on redirected URLs (sample check)\n- [ ] No spike in support tickets\n\n**Daily (Next 7 Days)**:\n- [ ] Review Sentry errors (categorize, prioritize fixes)\n- [ ] Review user feedback (support tickets, social media)\n- [ ] Compare CB metrics to Rails baseline (traffic, engagement, conversion)\n- [ ] Verify Rails shadow mode showing \u003c 0.1% divergence (should be zero now)\n\n**Day 7: Kill Rails Decision**:\n- If CB stable for 7 days ‚Üí Proceed to axl.10 (shut down Rails)\n- If issues persist ‚Üí Extend monitoring, delay Rails shutdown\n\n### Files\n- `reports/DNS-CUTOVER-RUNBOOK.md` (this document in markdown)\n- `course-builder/apps/egghead/vercel.json` (domain config)\n- `course-builder/apps/egghead/public/robots.txt` (ensure production robots.txt active)\n\n### Acceptance Criteria\n- [ ] DNS points to Coursebuilder (verified via dig)\n- [ ] Homepage loads on egghead.io (not staging URL)\n- [ ] Zero 404s on legacy URLs (redirects work)\n- [ ] Auth flows work (magic link, GitHub OAuth)\n- [ ] Checkout flow works (test subscription created)\n- [ ] Video playback works\n- [ ] Error rate \u003c 0.1% sustained for 24 hours post-cutover\n- [ ] Rails still running read-only as safety net\n\n### Communication Plan\n\n**Pre-Cutover (1 day before)**:\n- Email to team: \"DNS cutover tomorrow at 10am ET, expect 30 min monitoring window\"\n- Post in #egghead-team: \"DNS cutover checklist, who's on deck for monitoring?\"\n\n**During Cutover**:\n- Post in #egghead-team: \"DNS updated, monitoring propagation\"\n- Post updates every 15 min during first hour\n\n**Post-Cutover (1 hour after)**:\n- Post in #egghead-team: \"DNS cutover complete, CB receiving traffic, metrics nominal\"\n- Email to stakeholders: \"Migration complete, monitoring for 7 days before Rails shutdown\"\n\n**If Issues**:\n- Post in #egghead-team: \"Issue detected: [description], rolling back DNS\"\n- Email to stakeholders: \"Cutover rolled back, investigating [issue], new cutover date TBD\"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:58.834774-08:00","updated_at":"2025-12-11T11:24:24.392428-08:00","dependencies":[{"issue_id":"migrate-egghead-axl.9","depends_on_id":"migrate-egghead-axl","type":"parent-child","created_at":"2025-12-11T09:29:58.835099-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-bj1","title":"Export real POC course data to Docker seeds","description":"Run the export script to populate Docker test infrastructure with real data from the 2 POC courses:\n- \"Claude Code Essentials\" (modern, Sanity-based)\n- \"Fix Common Git Mistakes\" (legacy, Rails-only)\n\nScript: `pnpm tsx scripts/export-poc-courses.ts`\n\nThis replaces the synthetic seed data with real lessons, instructors, tags, and Mux URLs (emails anonymized).\n\nIteration toward full sample export (Option 1 ‚Üí Option 3).","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-13T09:34:00.987734-08:00","updated_at":"2025-12-13T09:58:33.849951-08:00","closed_at":"2025-12-13T09:58:33.849951-08:00"}
{"id":"migrate-egghead-brp","title":"Gap Video Migration Cleanup","description":"Complete gap video migration: backfill Rails with Mux URLs for ready assets, investigate and handle errored assets. 146 gap videos uploaded to Mux, 131 ready, 15 errored.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-12T08:19:23.584351-08:00","updated_at":"2025-12-12T08:19:23.584351-08:00"}
{"id":"migrate-egghead-brp.1","title":"Investigate errored Mux assets and update SQLite","description":"Completed: Investigated 15 errored Mux assets. All 15 are published lessons. 14 have inaccessible S3 sources (403), 1 has subtitle validation error. Updated SQLite: 14 ‚Üí missing_video, 1 ‚Üí error. Created investigation report at reports/ERRORED_MUX_ASSETS_INVESTIGATION.md","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T08:19:23.62478-08:00","updated_at":"2025-12-12T08:24:19.629777-08:00","closed_at":"2025-12-12T08:24:19.629779-08:00","dependencies":[{"issue_id":"migrate-egghead-brp.1","depends_on_id":"migrate-egghead-brp","type":"parent-child","created_at":"2025-12-12T08:19:23.625118-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-brp.2","title":"Backfill Rails with Mux URLs for ready videos","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T08:19:23.663415-08:00","updated_at":"2025-12-12T08:28:31.825303-08:00","closed_at":"2025-12-12T08:28:31.825303-08:00","dependencies":[{"issue_id":"migrate-egghead-brp.2","depends_on_id":"migrate-egghead-brp","type":"parent-child","created_at":"2025-12-12T08:19:23.663765-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-brp.3","title":"Document video migration status and update reports","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T08:19:23.701915-08:00","updated_at":"2025-12-12T08:55:37.801421-08:00","closed_at":"2025-12-12T08:55:37.801421-08:00","dependencies":[{"issue_id":"migrate-egghead-brp.3","depends_on_id":"migrate-egghead-brp","type":"parent-child","created_at":"2025-12-12T08:19:23.702232-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-c7z","title":"Progress Data Backfill Monitoring","description":"**CRITICAL GAP**: 3M progress records migrating with no monitoring or alerting.\n\n## Problem\n\nProgress migration is the largest data migration:\n- 3M records from `lesson_progresses` table\n- Batch processing over several hours\n- No visibility into progress or failures\n- No alerting if migration stalls\n\n## Requirements\n\n### 1. Progress Dashboard\n\n```typescript\n// app/api/admin/migration/progress-status/route.ts\nexport async function GET() {\n  const [railsCount, cbCount, lastBatch] = await Promise.all([\n    railsDb.query('SELECT COUNT(*) FROM lesson_progresses'),\n    cbDb.query('SELECT COUNT(*) FROM LessonProgress'),\n    redis.get('migration:progress:last-batch'),\n  ])\n  \n  return Response.json({\n    source: railsCount,\n    migrated: cbCount,\n    percentage: ((cbCount / railsCount) * 100).toFixed(2),\n    lastBatchAt: lastBatch,\n    estimatedCompletion: calculateETA(railsCount, cbCount),\n  })\n}\n```\n\n### 2. Inngest Function with Checkpoints\n\n```typescript\nexport const migrateProgress = inngest.createFunction(\n  { id: 'migrate-progress', concurrency: 5 },\n  { event: 'migration/progress.start' },\n  async ({ step }) =\u003e {\n    let offset = await step.run('get-checkpoint', () =\u003e\n      redis.get('migration:progress:offset') || 0\n    )\n    \n    const batchSize = 1000\n    let processed = 0\n    \n    while (true) {\n      const batch = await step.run(`batch-${offset}`, async () =\u003e {\n        const records = await railsDb.query(`\n          SELECT * FROM lesson_progresses \n          ORDER BY id LIMIT ${batchSize} OFFSET ${offset}\n        `)\n        \n        if (records.length === 0) return null\n        \n        await cbDb.insert(lessonProgress).values(\n          records.map(transformProgress)\n        )\n        \n        // Checkpoint\n        await redis.set('migration:progress:offset', offset + batchSize)\n        await redis.set('migration:progress:last-batch', Date.now())\n        \n        return records.length\n      })\n      \n      if (!batch) break\n      \n      processed += batch\n      offset += batchSize\n      \n      // Report progress every 10 batches\n      if ((offset / batchSize) % 10 === 0) {\n        await step.run('report-progress', () =\u003e\n          inngest.send({\n            name: 'migration/progress.checkpoint',\n            data: { processed, offset, timestamp: Date.now() }\n          })\n        )\n      }\n    }\n    \n    return { totalProcessed: processed }\n  }\n)\n```\n\n### 3. Stall Detection\n\n```typescript\nexport const monitorProgressMigration = inngest.createFunction(\n  { id: 'monitor-progress-migration' },\n  { cron: '*/5 * * * *' }, // Every 5 minutes\n  async ({ step }) =\u003e {\n    const lastBatch = await step.run('check-last-batch', () =\u003e\n      redis.get('migration:progress:last-batch')\n    )\n    \n    const stalledMinutes = (Date.now() - lastBatch) / 1000 / 60\n    \n    if (stalledMinutes \u003e 10) {\n      await step.run('alert-stalled', () =\u003e\n        sendSlackAlert({\n          channel: '#egghead-migration',\n          text: `üö® Progress migration stalled! No batches in ${stalledMinutes.toFixed(0)} minutes`,\n          color: 'danger',\n        })\n      )\n    }\n    \n    // Also check for errors\n    const errorCount = await redis.get('migration:progress:errors')\n    if (errorCount \u003e 100) {\n      await step.run('alert-errors', () =\u003e\n        sendSlackAlert({\n          channel: '#egghead-migration',\n          text: `‚ö†Ô∏è Progress migration has ${errorCount} errors`,\n          color: 'warning',\n        })\n      )\n    }\n  }\n)\n```\n\n### 4. Validation Queries\n\n```typescript\n// Post-migration validation\nasync function validateProgressMigration() {\n  // Count match\n  const [railsCount, cbCount] = await Promise.all([\n    railsDb.query('SELECT COUNT(*) FROM lesson_progresses'),\n    cbDb.query('SELECT COUNT(*) FROM LessonProgress'),\n  ])\n  \n  if (railsCount !== cbCount) {\n    throw new Error(`Count mismatch: Rails=${railsCount}, CB=${cbCount}`)\n  }\n  \n  // Sample validation\n  const sample = await railsDb.query(`\n    SELECT user_id, lesson_id, completed_at \n    FROM lesson_progresses \n    ORDER BY RANDOM() LIMIT 100\n  `)\n  \n  for (const record of sample) {\n    const cbRecord = await cbDb.query.lessonProgress.findFirst({\n      where: and(\n        eq(lessonProgress.userId, mapUserId(record.user_id)),\n        eq(lessonProgress.lessonId, mapLessonId(record.lesson_id))\n      )\n    })\n    \n    if (!cbRecord) {\n      throw new Error(`Missing progress: user=${record.user_id}, lesson=${record.lesson_id}`)\n    }\n  }\n  \n  return { validated: true, sampleSize: 100 }\n}\n```\n\n## Files to Create\n- `apps/egghead/src/app/api/admin/migration/progress-status/route.ts`\n- `apps/egghead/src/app/admin/migration/progress/page.tsx`\n- `apps/egghead/src/inngest/functions/migration/migrate-progress.ts`\n- `apps/egghead/src/inngest/functions/migration/monitor-progress.ts`\n- `scripts/validate-progress-migration.ts`\n\n## Acceptance Criteria\n- [ ] Real-time dashboard shows migration progress\n- [ ] Checkpoints allow resume after failure\n- [ ] Slack alert if migration stalls \u003e10 minutes\n- [ ] Slack alert if error count \u003e100\n- [ ] Post-migration validation passes\n- [ ] ETA calculation reasonably accurate","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T12:04:04.784028-08:00","updated_at":"2025-12-11T12:04:04.784028-08:00"}
{"id":"migrate-egghead-cdg","title":"Explore Durable Streams for Swarm Mail","description":"Build a migration control plane UI with real-time sync using Durable Streams.\n\n## The Problem\n\nMigration scripts run in terminal. No visibility into:\n- Progress (how many of 5,132 lessons migrated?)\n- Errors (which records failed and why?)\n- State (can I resume from where it crashed?)\n- Verification (do counts match?)\n\n## The Solution\n\nA control plane UI that:\n1. **Tails migration events** in real-time via Durable Streams\n2. **Shows progress** - counts, percentages, ETA\n3. **Captures errors** - failed records with context\n4. **Enables resume** - checkpoint-based restart\n5. **Verifies** - Rails vs CB count reconciliation\n\n## Architecture (Reference: Swarm Mail in opencode-swarm-plugin)\n\n```\nMigration Script                    Control Plane UI\n      ‚îÇ                                    ‚îÇ\n      ‚îÇ append(event)                      ‚îÇ SSE tail\n      ‚ñº                                    ‚ñº\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ           Durable Stream                     ‚îÇ\n‚îÇ  /migrations/{run-id}                        ‚îÇ\n‚îÇ  - offset-based                              ‚îÇ\n‚îÇ  - resumable                                 ‚îÇ\n‚îÇ  - HTTP/SSE                                  ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## Event Types\n\n```typescript\ntype MigrationEvent = \n  | { type: 'start', entity: 'tags' | 'courses' | 'lessons', total: number }\n  | { type: 'progress', entity: string, current: number, total: number }\n  | { type: 'success', entity: string, legacyId: number, newId: string }\n  | { type: 'error', entity: string, legacyId: number, error: string }\n  | { type: 'complete', entity: string, migrated: number, failed: number }\n  | { type: 'checkpoint', offset: number, state: object }\n```\n\n## UI Components\n\n1. **Dashboard** - Overall migration status, phase progress\n2. **Entity View** - Per-entity (tags/courses/lessons) progress bars\n3. **Error Log** - Failed records with retry button\n4. **Verification** - Side-by-side Rails vs CB counts\n\n## Reference Implementation\n\nLook at Swarm Mail in `~/Code/joelhooks/opencode-swarm-plugin` for:\n- Durable Streams client usage\n- SSE tailing pattern\n- Checkpoint/resume logic\n\n## Files to Create\n\n- `migration/src/lib/migration-stream.ts` - Stream client wrapper\n- `migration/src/ui/` - Simple React/Next.js control panel\n- Update migration scripts to emit events\n\n## Why Durable Streams\n\n- **Resumability**: Crash? Resume from last checkpoint\n- **Real-time**: SSE tail, no polling\n- **Audit trail**: Every event persisted, replayable\n- **HTTP-native**: Works from browser, no WebSocket complexity","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-13T10:21:22.883984-08:00","updated_at":"2025-12-13T10:24:09.72784-08:00"}
{"id":"migrate-egghead-ckn","title":"Enrich Migration Task Descriptions","description":"Systematically enrich all empty/thin migration task descriptions with file pointers, implementation details, and acceptance criteria. Each task should be actionable by an AI agent without asking questions.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T11:02:23.174817-08:00","updated_at":"2025-12-11T11:06:44.916061-08:00","closed_at":"2025-12-11T11:06:44.916061-08:00"}
{"id":"migrate-egghead-ckn.1","title":"Enrich Team Features tasks (dxh.1-6)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T11:02:23.207037-08:00","updated_at":"2025-12-11T11:06:36.195177-08:00","closed_at":"2025-12-11T11:06:36.195177-08:00","dependencies":[{"issue_id":"migrate-egghead-ckn.1","depends_on_id":"migrate-egghead-ckn","type":"parent-child","created_at":"2025-12-11T11:02:23.207383-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ckn.2","title":"Enrich Cron Jobs tasks (tkd.1-2)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T11:02:23.240886-08:00","updated_at":"2025-12-11T11:06:36.9699-08:00","closed_at":"2025-12-11T11:06:36.9699-08:00","dependencies":[{"issue_id":"migrate-egghead-ckn.2","depends_on_id":"migrate-egghead-ckn","type":"parent-child","created_at":"2025-12-11T11:02:23.241261-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ckn.3","title":"Enrich Auth Cutover tasks (04y.1-2)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T11:02:23.27786-08:00","updated_at":"2025-12-11T11:06:37.674953-08:00","closed_at":"2025-12-11T11:06:37.674953-08:00","dependencies":[{"issue_id":"migrate-egghead-ckn.3","depends_on_id":"migrate-egghead-ckn","type":"parent-child","created_at":"2025-12-11T11:02:23.27824-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ckn.4","title":"Enrich Sanity Elimination tasks (mnn.1-3)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T11:02:23.312479-08:00","updated_at":"2025-12-11T11:06:38.428655-08:00","closed_at":"2025-12-11T11:06:38.428655-08:00","dependencies":[{"issue_id":"migrate-egghead-ckn.4","depends_on_id":"migrate-egghead-ckn","type":"parent-child","created_at":"2025-12-11T11:02:23.31282-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ckn.5","title":"Enrich Customer.io Integration tasks (ifz.1-2)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T11:02:23.346916-08:00","updated_at":"2025-12-11T11:06:39.105082-08:00","closed_at":"2025-12-11T11:06:39.105082-08:00","dependencies":[{"issue_id":"migrate-egghead-ckn.5","depends_on_id":"migrate-egghead-ckn","type":"parent-child","created_at":"2025-12-11T11:02:23.347252-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ckn.6","title":"Enrich Mailer Migration tasks (qk0)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T11:02:23.380651-08:00","updated_at":"2025-12-11T11:06:40.131813-08:00","closed_at":"2025-12-11T11:06:40.131813-08:00","dependencies":[{"issue_id":"migrate-egghead-ckn.6","depends_on_id":"migrate-egghead-ckn","type":"parent-child","created_at":"2025-12-11T11:02:23.380998-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-cqi","title":"Stripe Webhook Dual-Write Deduplication Strategy","description":"**CRITICAL GAP**: No strategy for preventing duplicate processing when both Rails and Coursebuilder receive webhooks during shadow mode.\n\n## Problem\n\nDuring dual-write phase, Stripe sends webhooks to BOTH:\n- Rails endpoint: `/stripe/events` (existing)\n- Coursebuilder endpoint: `/api/webhooks/stripe` (new)\n\nBoth systems will process the same event, potentially causing:\n- Duplicate entitlement grants\n- Double email sends\n- Inconsistent state\n\n## Solution Options\n\n### Option A: Event ID Deduplication (RECOMMENDED)\n\n```typescript\n// Coursebuilder: Check if Rails already processed\nasync function processStripeWebhook(event: Stripe.Event) {\n  // Check dedup table\n  const existing = await db.query.stripeEventLog.findFirst({\n    where: eq(stripeEventLog.stripeEventId, event.id)\n  })\n  \n  if (existing) {\n    console.log(`Event ${event.id} already processed by ${existing.processor}`)\n    return { status: 'duplicate', processedBy: existing.processor }\n  }\n  \n  // Claim the event\n  await db.insert(stripeEventLog).values({\n    stripeEventId: event.id,\n    eventType: event.type,\n    processor: 'coursebuilder',\n    processedAt: new Date(),\n  })\n  \n  // Process...\n}\n```\n\n### Option B: Leader Election (Complex)\n\nUse Redis lock to ensure only one system processes:\n```typescript\nconst lock = await redis.set(`stripe:${event.id}`, 'cb', { nx: true, ex: 300 })\nif (!lock) return // Other system got it\n```\n\n### Option C: Disable Rails Webhooks (Risky)\n\nTurn off Rails webhook processing during shadow mode. Risky if CB has bugs.\n\n## Recommended Approach\n\n1. **Add `stripe_event_log` table** to both Rails and CB\n2. **First processor wins** - check table before processing\n3. **Log all events** - even duplicates, for debugging\n4. **Alert on divergence** - if both try to process, something's wrong\n\n## Schema\n\n```sql\n-- Add to both Rails and Coursebuilder\nCREATE TABLE stripe_event_log (\n  id VARCHAR(191) PRIMARY KEY,\n  stripe_event_id VARCHAR(255) UNIQUE NOT NULL,\n  event_type VARCHAR(100) NOT NULL,\n  processor ENUM('rails', 'coursebuilder') NOT NULL,\n  processed_at TIMESTAMP NOT NULL,\n  payload JSON,\n  INDEX idx_stripe_event_id (stripe_event_id),\n  INDEX idx_processed_at (processed_at)\n);\n```\n\n## Implementation Steps\n\n1. Add `stripe_event_log` table to CB schema\n2. Add dedup check to `process-stripe-webhook.ts`\n3. Add same table to Rails (migration)\n4. Add dedup check to Rails `StripeEventsController`\n5. Test with duplicate webhook sends\n6. Monitor for any slip-throughs\n\n## Files to Modify\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/commerce/`\n- `apps/egghead/src/inngest/functions/stripe/process-stripe-webhook.ts`\n- `egghead-rails/db/migrate/xxx_add_stripe_event_log.rb`\n- `egghead-rails/app/controllers/stripe_events_controller.rb`\n\n## Acceptance Criteria\n- [ ] No duplicate processing in shadow mode\n- [ ] Both systems log all received events\n- [ ] Alert fires if same event processed twice\n- [ ] Graceful handling of race conditions","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T12:03:29.694663-08:00","updated_at":"2025-12-11T12:03:29.694663-08:00"}
{"id":"migrate-egghead-d4x","title":"Migration Control Plane UI","description":"Minimal admin UI for monitoring and controlling egghead content migration. Shows progress, validates counts, triggers Inngest functions.\n\nRoute: /admin/migration\nFeatures:\n- Status dashboard with Rails vs CB counts\n- Validation indicators (count matches)\n- Trigger buttons for migration Inngest functions\n- Polling for real-time updates","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-13T08:01:27.709796-08:00","updated_at":"2025-12-13T08:08:30.197339-08:00","closed_at":"2025-12-13T08:08:30.197339-08:00"}
{"id":"migrate-egghead-d4x.1","title":"Migration status data layer + API routes","description":"Create the data fetching layer for migration status:\n\n1. Create `src/lib/migration/status.ts` with functions:\n   - `getRailsCounts()` - query Rails PG for lessons, series, tags, instructors counts\n   - `getCBCounts()` - query PlanetScale for ContentResource counts by type\n   - `getMigrationStatus()` - combine both into status object\n\n2. Create `src/lib/migration/types.ts` with TypeScript types:\n   - `MigrationStatus`, `EntityCounts`, `ValidationResult`\n\n3. Create API route `src/app/api/admin/migration/status/route.ts`:\n   - GET handler returning migration status JSON\n   - Admin auth check (use existing pattern from other admin routes)\n\nUse existing `eggheadPgQuery` for Rails, Drizzle `db` for PlanetScale.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-13T08:01:27.750908-08:00","updated_at":"2025-12-13T08:06:07.182598-08:00","closed_at":"2025-12-13T08:06:07.182598-08:00","dependencies":[{"issue_id":"migrate-egghead-d4x.1","depends_on_id":"migrate-egghead-d4x","type":"parent-child","created_at":"2025-12-13T08:01:27.751275-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-d4x.2","title":"Migration trigger API + Inngest events","description":"Create API to trigger migration Inngest functions:\n\n1. Create `src/lib/migration/events.ts` with Inngest event definitions:\n   - `migration/tags.start`\n   - `migration/courses.start`\n   - `migration/lessons.start`\n\n2. Create `src/inngest/functions/migration/index.ts` as barrel export\n\n3. Create stub Inngest functions (actual logic in ntu beads later):\n   - `src/inngest/functions/migration/migrate-tags.ts`\n   - `src/inngest/functions/migration/migrate-courses.ts`\n   - `src/inngest/functions/migration/migrate-lessons.ts`\n\n4. Create API route `src/app/api/admin/migration/trigger/route.ts`:\n   - POST handler accepting { entity: 'tags' | 'courses' | 'lessons' }\n   - Sends Inngest event\n   - Admin auth check\n\n5. Register functions in `src/inngest/inngest.config.ts`","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-13T08:01:27.79025-08:00","updated_at":"2025-12-13T08:06:08.386177-08:00","closed_at":"2025-12-13T08:06:08.386177-08:00","dependencies":[{"issue_id":"migrate-egghead-d4x.2","depends_on_id":"migrate-egghead-d4x","type":"parent-child","created_at":"2025-12-13T08:01:27.790612-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-d4x.3","title":"Migration admin page UI","description":"Create the admin UI page:\n\n1. Create `src/app/(content-creator)/admin/migration/page.tsx`:\n   - Server component with admin auth check\n   - Fetch initial status server-side\n   - Render MigrationDashboard client component\n\n2. Create `src/app/(content-creator)/admin/migration/_components/migration-dashboard.tsx`:\n   - Client component with polling (useEffect + setInterval)\n   - Display counts table: Entity | Rails | CB | Status\n   - Validation indicators (checkmark/x for count matches)\n   - Trigger buttons for each entity type\n   - Loading/error states\n\n3. Use shadcn components: Card, Table, Button, Badge\n\n4. Add link to migration page in admin nav if exists\n\n**Depends on**: d4x.1 (status API), d4x.2 (trigger API)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T08:01:27.830006-08:00","updated_at":"2025-12-13T08:08:28.886772-08:00","closed_at":"2025-12-13T08:08:28.886772-08:00","dependencies":[{"issue_id":"migrate-egghead-d4x.3","depends_on_id":"migrate-egghead-d4x","type":"parent-child","created_at":"2025-12-13T08:01:27.830362-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ddl","title":"Video Migration: Gap Lessons to Mux","description":"Migrate 152 gap lessons (ID 10389-10684) from CloudFront to Mux, update egghead-next to use Mux exclusively, and update documentation with final migration status","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-12T07:22:18.935531-08:00","updated_at":"2025-12-12T07:28:33.256094-08:00","closed_at":"2025-12-12T07:28:33.256094-08:00"}
{"id":"migrate-egghead-ddl.1","title":"Create gap lessons export script for SQLite","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T07:22:18.971441-08:00","updated_at":"2025-12-12T07:28:20.610529-08:00","closed_at":"2025-12-12T07:28:20.610529-08:00","dependencies":[{"issue_id":"migrate-egghead-ddl.1","depends_on_id":"migrate-egghead-ddl","type":"parent-child","created_at":"2025-12-12T07:22:18.971798-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ddl.2","title":"Create Rails backfill script for Mux URLs","description":"Created backfill-rails-mux-urls.mjs script. Script reads mux_asset_id from SQLite, fetches playback_id from Mux API, and updates Rails lessons table with HLS URLs. Idempotent (skips already-updated lessons). Requires pg npm package installation.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T07:22:19.004538-08:00","updated_at":"2025-12-12T07:28:22.603869-08:00","closed_at":"2025-12-12T07:28:22.603869-08:00","dependencies":[{"issue_id":"migrate-egghead-ddl.2","depends_on_id":"migrate-egghead-ddl","type":"parent-child","created_at":"2025-12-12T07:22:19.004863-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ddl.3","title":"Update VIDEO_MIGRATION_STATUS.md with complete plan","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T07:22:19.035265-08:00","updated_at":"2025-12-12T07:28:22.871019-08:00","closed_at":"2025-12-12T07:28:22.871019-08:00","dependencies":[{"issue_id":"migrate-egghead-ddl.3","depends_on_id":"migrate-egghead-ddl","type":"parent-child","created_at":"2025-12-12T07:22:19.035559-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ddl.4","title":"Update README.md video migration section","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T07:22:19.065527-08:00","updated_at":"2025-12-12T07:28:12.85728-08:00","closed_at":"2025-12-12T07:28:12.85728-08:00","dependencies":[{"issue_id":"migrate-egghead-ddl.4","depends_on_id":"migrate-egghead-ddl","type":"parent-child","created_at":"2025-12-12T07:22:19.065877-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ddl.5","title":"Analyze egghead-next video player for Mux preference","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T07:22:19.095181-08:00","updated_at":"2025-12-12T07:28:24.096106-08:00","closed_at":"2025-12-12T07:28:24.096106-08:00","dependencies":[{"issue_id":"migrate-egghead-ddl.5","depends_on_id":"migrate-egghead-ddl","type":"parent-child","created_at":"2025-12-12T07:22:19.095504-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-dqg","title":"Magic Link Token Migration Strategy","description":"**CRITICAL GAP**: In-flight magic links will break during cutover.\n\n## Problem\n\nWhen we cut over from Rails to Coursebuilder:\n- User requests magic link from Rails (T-5 minutes)\n- Cutover happens (T-0)\n- User clicks link (T+2 minutes)\n- Link points to Rails endpoint, but Rails is gone OR\n- Token exists in Rails DB but not in CB\n\n## Scope\n\n```sql\n-- Rails: Active magic link tokens\nSELECT COUNT(*) FROM users \nWHERE authentication_token IS NOT NULL \nAND updated_at \u003e NOW() - INTERVAL '10 minutes';\n-- Typically: 10-50 tokens at any moment\n```\n\n## Solution Options\n\n### Option A: Token Sync (RECOMMENDED)\n\nSync active tokens to CB before cutover:\n```typescript\n// Run 1 minute before cutover\nasync function syncMagicLinkTokens() {\n  const activeTokens = await railsDb.query(`\n    SELECT id, email, authentication_token, updated_at\n    FROM users \n    WHERE authentication_token IS NOT NULL \n    AND updated_at \u003e NOW() - INTERVAL '10 minutes'\n  `)\n  \n  for (const token of activeTokens) {\n    await cbDb.insert(verificationTokens).values({\n      identifier: token.email,\n      token: token.authentication_token,\n      expires: new Date(token.updated_at.getTime() + 10 * 60 * 1000),\n    })\n  }\n  \n  return { synced: activeTokens.length }\n}\n```\n\n### Option B: Dual Endpoint (Complex)\n\nKeep Rails magic link endpoint alive for 10 minutes post-cutover:\n- Nginx routes `/api/v1/sign_in/*` to Rails for 10 min\n- Then switches to CB\n\n### Option C: Grace Period Email (User-Friendly)\n\nIf token validation fails, auto-send new magic link:\n```typescript\n// CB: Handle invalid token gracefully\nif (!validToken) {\n  // Check if this looks like a Rails token\n  if (token.startsWith('rails_')) {\n    await sendNewMagicLink(email)\n    return redirect('/check-email?reason=token-expired')\n  }\n}\n```\n\n## Recommended Approach\n\n1. **Sync tokens** 1 minute before cutover\n2. **Keep Rails endpoint** alive for 15 minutes (read-only)\n3. **Auto-resend** if token fails validation\n\n## Cutover Runbook Addition\n\n```markdown\n### T-1 minute: Sync Magic Link Tokens\n1. Run: `pnpm tsx scripts/sync-magic-tokens.ts`\n2. Verify: Check CB `VerificationToken` table has recent entries\n3. Expected: 10-50 tokens synced\n\n### T+15 minutes: Disable Rails Magic Link Endpoint\n1. Update nginx to return 410 Gone for `/api/v1/sign_in/*`\n2. Monitor for 404s on old endpoint\n```\n\n## Files to Create\n- `scripts/sync-magic-tokens.ts`\n- Update `reports/CUTOVER-RUNBOOK.md`\n\n## Acceptance Criteria\n- [ ] No user locked out due to in-flight magic link\n- [ ] Tokens synced within 1 minute of cutover\n- [ ] Graceful error message if token expired\n- [ ] Auto-resend option for failed tokens","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T12:03:44.991225-08:00","updated_at":"2025-12-11T12:04:51.335943-08:00","closed_at":"2025-12-11T12:04:51.335943-08:00"}
{"id":"migrate-egghead-dwa","title":"[HUMAN] Approve Auth Cutover Plan","description":"**HARD STOP - Agent must not proceed past this point without human approval**\n\n## Gate: Before Phase 6 (Cutover)\n\n### What Needs Review\n1. OAuth re-linking strategy (GitHub, Google, etc.)\n2. Session migration approach\n3. Password reset flow for email-only users\n4. Rollback plan if auth breaks\n5. Communication to users\n\n### Artifacts to Present\n- [ ] Auth cutover runbook (step-by-step)\n- [ ] OAuth provider configuration\n- [ ] User communication templates\n- [ ] Rollback procedure\n- [ ] Success metrics (login success rate)\n\n### Approval Criteria\n- No user gets locked out\n- OAuth re-linking is seamless\n- Rollback can happen in \u003c 5 minutes\n- Support team is briefed\n\n### How to Proceed\nAgent presents plan ‚Üí Human reviews ‚Üí Human marks this bead closed with approval note ‚Üí Agent executes cutover","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:53:55.799688-08:00","updated_at":"2025-12-11T10:53:55.799688-08:00"}
{"id":"migrate-egghead-dxh","title":"Team Features (Not Deferred)","description":"Team features are NOT deferred. 266 teams with 1,619 seats represent significant revenue.\n\nMinimum viable team features:\n- Team dashboard (read members, see seats)\n- Invite flow (send invite, accept invite)\n- Seat management (add/remove members)\n- Team billing (view invoices, manage subscription)\n\nDefer to post-launch:\n- Ownership transfer\n- SAML SSO (~15 enterprise accounts)","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:54:04.964051-08:00","updated_at":"2025-12-11T09:54:04.964051-08:00"}
{"id":"migrate-egghead-dxh.1","title":"Build team dashboard page (view members, seats used)","description":"## Context\n\nBuild a team dashboard page where team owners/admins can view their organization's members and seat usage. This replaces the Rails team management UI that shows member list, seat allocation, and invite status.\n\n**Current Rails behavior**:\n- Shows total_seats (sum of subscription quantities)\n- Shows active_member_count (members with :account_member role)\n- Displays team name, owner email\n- Lists all members with ability to remove (via account.remove_user)\n\n**Coursebuilder target**:\n- Organization-based (not Account)\n- OrganizationMembership records for members\n- Subscription.fields.quantity for seat count\n- Role-based access (only owner/admin can view)\n\n## Files to Reference\n\n**Rails implementation**:\n- `egghead-rails/app/models/account.rb` (lines 67-79: seat logic, members method)\n- `egghead-rails/app/controllers/api/v1/team_members_controller.rb` (remove member endpoint)\n- `egghead-rails/app/graphql/types/account_type.rb` (GraphQL team data)\n\n**Coursebuilder schemas**:\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/org/organizations.ts`\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/org/organization-memberships.ts`\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/commerce/subscription.ts`\n\n**Similar patterns in Coursebuilder**:\n- Look for existing dashboard/admin pages in `course-builder/apps/*/src/app/(app)/` directories\n- Check for existing org member queries\n\n## Implementation Details\n\n1. **Create route**: `/team/[organizationId]` or `/team/dashboard`\n2. **Auth check**: Verify current user is owner or admin of org\n3. **Data queries**:\n   - Fetch Organization by ID\n   - Fetch all OrganizationMemberships for this org (with user data)\n   - Fetch active Subscription(s) to get total seats from fields.quantity\n4. **Display components**:\n   - Team name/image header\n   - Seat usage indicator: \"3 of 5 seats used\"\n   - Member list table: name, email, role, joined date, remove button\n   - Empty state: \"No members yet. Invite someone!\"\n5. **Use shadcn/ui components**:\n   - Card for dashboard layout\n   - Table for member list\n   - Badge for seat count\n   - Button for remove action\n   - Alert for no seats available warning\n\n## Acceptance Criteria\n\n- [ ] Page loads for org owner/admin\n- [ ] Shows correct seat count from Subscription.fields.quantity\n- [ ] Shows correct member count from OrganizationMembership records\n- [ ] Displays all members with name, email, role\n- [ ] Remove button triggers removal flow (modal confirmation)\n- [ ] Non-owners/admins get 403 or redirect\n- [ ] Handles orgs with no active subscription gracefully\n- [ ] Handles orgs with unlimited seats (quantity: -1 or null)\n- [ ] Responsive design (mobile + desktop)\n\n## Dependencies\n\n- **MUST BE DONE FIRST**: migrate-egghead-dxh.6 (team data migration - need real org/membership data)\n- **BLOCKS**: migrate-egghead-dxh.2 (invite flow - dashboard will link to invite page)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:54:04.998004-08:00","updated_at":"2025-12-11T11:03:55.263882-08:00","dependencies":[{"issue_id":"migrate-egghead-dxh.1","depends_on_id":"migrate-egghead-dxh","type":"parent-child","created_at":"2025-12-11T09:54:04.998423-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-dxh.2","title":"Build team invite flow (send invite email)","description":"## Context\n\nBuild the team invite flow where team owners/admins can send invite emails to new members. This replaces the Rails team_invite_id token system with a more robust token-based invite system in Coursebuilder.\n\n**Current Rails behavior**:\n- Account has `team_invite_id` UUID column (one permanent token per account)\n- Invite URL: `/api/v1/team_invite/:token`\n- Email sent with invite link (no dedicated invite table, just the token)\n- No expiration, no tracking of who was invited when\n- Token is reusable (same link for all invites)\n\n**Coursebuilder upgrade**:\n- Create proper InviteToken table (or use OrganizationMembership with pending status)\n- One-time use tokens with expiration\n- Track who sent invite (invitedById field exists in OrganizationMembership)\n- Email via Inngest/Resend\n\n## Files to Reference\n\n**Rails implementation**:\n- `egghead-rails/app/controllers/api/v1/accounts_controller.rb` (lines 14-17: view_team_invite endpoint)\n- `egghead-rails/db/schema.rb` (line 74: team_invite_id column)\n- `egghead-rails/spec/controllers/api/v1/accounts_controller_spec.rb` (lines 64-94: invite specs)\n\n**Coursebuilder schemas**:\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/org/organization-memberships.ts` (has invitedById field)\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/auth/verification-tokens.ts` (token pattern reference)\n\n**Email patterns**:\n- Search Coursebuilder for Resend/email send patterns\n- Look for Inngest event handlers in `packages/core/src/inngest/`\n\n## Implementation Details\n\n1. **Create invite form on team dashboard**:\n   - Input: email address\n   - Select: role (member, admin)\n   - Button: \"Send Invite\"\n   - Validation: email format, check if already a member\n\n2. **API endpoint**: `POST /api/team/[organizationId]/invite`\n   - Auth: verify sender is owner/admin\n   - Check available seats: `if (usedSeats \u003e= totalSeats) throw new Error(\"No seats\")`\n   - Generate token: `crypto.randomUUID()` or use nanoid\n   - Create pending OrganizationMembership OR separate InviteToken table:\n     ```typescript\n     {\n       id: generateId(),\n       organizationId: org.id,\n       email: inviteEmail,  // store email before user exists\n       role: selectedRole,\n       invitedById: currentUser.id,\n       status: 'pending',   // or use a separate invites table\n       token: generatedToken,\n       expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days\n     }\n     ```\n\n3. **Send email via Inngest**:\n   - Trigger: `inngest.send('team/invite.sent', { email, token, orgName })`\n   - Handler: Send email with link to `/team/accept/:token`\n   - Email content: \"You've been invited to join [Team Name] on egghead. Accept invite: [link]\"\n   - Template: Use Resend React Email or plain HTML\n\n4. **UI feedback**:\n   - Success: \"Invite sent to [email]\"\n   - Error: \"No seats available\" or \"Already a member\"\n   - Show pending invites list on dashboard (optional nice-to-have)\n\n## Acceptance Criteria\n\n- [ ] Form validates email and role\n- [ ] Checks seat availability before sending\n- [ ] Creates invite record with token and expiration\n- [ ] Sends email via Inngest (verify email received in test)\n- [ ] Email contains correct org name and accept link\n- [ ] Shows success/error messages\n- [ ] Prevents duplicate invites to same email\n- [ ] Only owners/admins can send invites\n- [ ] Handles org with no subscription (reject invite)\n\n## Dependencies\n\n- **MUST BE DONE FIRST**: migrate-egghead-dxh.1 (dashboard - invite form lives there)\n- **BLOCKS**: migrate-egghead-dxh.3 (acceptance flow - need invites to accept)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:54:05.029783-08:00","updated_at":"2025-12-11T11:04:15.888977-08:00","dependencies":[{"issue_id":"migrate-egghead-dxh.2","depends_on_id":"migrate-egghead-dxh","type":"parent-child","created_at":"2025-12-11T09:54:05.030132-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-dxh.3","title":"Build invite acceptance flow (token-based)","description":"## Context\n\nBuild the invite acceptance flow where invited users click the email link and get added to the team. This replaces the Rails `accept_team_invite` endpoint with proper token validation and user creation.\n\n**Current Rails behavior**:\n- Endpoint: `POST /api/v1/team_invite/:token`\n- Finds account by team_invite_id\n- Calls `account.add_member(current_user)` (adds AccountUser + :account_member role)\n- Checks seats with `has_available_seats?`\n- Raises `Account::NoAvailableSeats` if full\n- Requires authentication (user must already exist and be logged in)\n\n**Coursebuilder improvement**:\n- Token-based with expiration\n- Handle invite for non-existent users (create account first)\n- Create OrganizationMembership record\n- Grant Entitlement for pro access\n- One-time use token (mark as used)\n\n## Files to Reference\n\n**Rails implementation**:\n- `egghead-rails/app/controllers/api/v1/accounts_controller.rb` (lines 20-29: accept_team_invite)\n- `egghead-rails/app/models/account.rb` (lines 105-116: add_member method)\n- `egghead-rails/spec/controllers/api/v1/accounts_controller_spec.rb` (lines 101-180: acceptance specs)\n\n**Coursebuilder schemas**:\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/org/organization-memberships.ts`\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/entitlements/entitlement.ts`\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/auth/users.ts`\n\n**Similar patterns**:\n- Look for magic link or token validation patterns in Coursebuilder auth\n- Check for existing user creation flows\n\n## Implementation Details\n\n1. **Route**: `/team/accept/:token` (public, no auth required)\n\n2. **Token validation**:\n   - Query invite by token\n   - Check `expiresAt \u003e new Date()` (reject if expired)\n   - Check `status !== 'accepted'` (prevent reuse)\n   - Check org still has available seats\n\n3. **User handling** (two paths):\n   - **A. User logged in**: Use current user\n   - **B. User not logged in**: \n     - Show form: \"Enter your name and create password\"\n     - Create user account with invite email\n     - Auto-login after creation\n\n4. **Add member to org**:\n   ```typescript\n   // Update invite status\n   await db.update(invites)\n     .set({ status: 'accepted', acceptedAt: new Date() })\n     .where(eq(invites.token, token))\n   \n   // Create membership\n   await db.insert(organizationMemberships).values({\n     id: generateId(),\n     organizationId: invite.organizationId,\n     userId: user.id,\n     role: invite.role,\n     invitedById: invite.invitedById,\n   })\n   \n   // Create entitlement\n   await db.insert(entitlements).values({\n     id: generateId(),\n     entitlementType: 'pro',\n     userId: user.id,\n     organizationId: invite.organizationId,\n     sourceType: 'SUBSCRIPTION',\n     sourceId: subscription.id,\n   })\n   ```\n\n5. **Redirect**:\n   - Success: Redirect to `/team/[orgId]` dashboard\n   - Error states:\n     - Expired: \"This invite has expired. Contact the team owner.\"\n     - No seats: \"This team is full. Contact [owner email].\"\n     - Already used: \"This invite has already been accepted.\"\n     - Invalid token: \"Invalid invite link.\"\n\n6. **Email notification**:\n   - Send email to org owner: \"[Name] accepted your invite to [Team]\"\n\n## Acceptance Criteria\n\n- [ ] Token validation works (expires after 7 days)\n- [ ] Prevents token reuse (one-time only)\n- [ ] Checks seat availability\n- [ ] Creates user if not exists (signup flow)\n- [ ] Uses existing user if logged in\n- [ ] Creates OrganizationMembership record\n- [ ] Creates Entitlement for pro access\n- [ ] Shows clear error messages for all failure modes\n- [ ] Redirects to team dashboard on success\n- [ ] Sends confirmation email to owner\n- [ ] Handles expired/invalid tokens gracefully\n- [ ] Works on mobile (form is responsive)\n\n## Dependencies\n\n- **MUST BE DONE FIRST**: migrate-egghead-dxh.2 (invite flow - need invites to accept)\n- **BLOCKS**: None (can test manually before migration)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:54:05.062114-08:00","updated_at":"2025-12-11T11:04:35.952479-08:00","dependencies":[{"issue_id":"migrate-egghead-dxh.3","depends_on_id":"migrate-egghead-dxh","type":"parent-child","created_at":"2025-12-11T09:54:05.062465-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-dxh.4","title":"Build seat management (add/remove team members)","description":"## Description\nBuild seat management functionality for team admins.\n\n## Features\n1. **View seats**: Show total seats, used seats, available seats\n2. **Add member**: Invite user by email, assign seat\n3. **Remove member**: Remove user, free up seat\n4. **Swap seat**: Remove one user, add another (atomic)\n5. **Admin without seat**: Admins can manage team without taking a seat\n\n## Routes\n- `/team/members` - List members, manage seats\n- `/team/invite` - Invite new member\n\n## Components\n- `MemberList` - Table of members with role, seat status, actions\n- `InviteForm` - Email input, role selector\n- `SeatCounter` - Visual display of seat usage\n\n## API\n- `POST /api/team/invite` - Send invite, reserve seat\n- `DELETE /api/team/members/:id` - Remove member, free seat\n- `PATCH /api/team/members/:id` - Update role, seat status\n\n## Files\n- `course-builder/apps/egghead/src/app/team/members/page.tsx`\n- `course-builder/apps/egghead/src/app/api/team/`\n- `course-builder/apps/egghead/src/components/team/`\n\n## Data Model\n```\nOrganizationMembership\n‚îú‚îÄ‚îÄ userId\n‚îú‚îÄ‚îÄ role: 'owner' | 'admin' | 'billing_admin' | 'member'\n‚îî‚îÄ‚îÄ fields: { isSeatHolder: boolean }\n\nOrganization\n‚îî‚îÄ‚îÄ fields: { seatCount: number }\n```\n\n## Acceptance Criteria\n- [ ] Admins can view seat usage\n- [ ] Admins can invite members (email sent)\n- [ ] Admins can remove members (seat freed)\n- [ ] Admins can swap seats (atomic operation)\n- [ ] Admins without seats can still manage team\n- [ ] Seat count enforced (can't exceed purchased seats)","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:54:05.094677-08:00","updated_at":"2025-12-11T11:22:34.441736-08:00","dependencies":[{"issue_id":"migrate-egghead-dxh.4","depends_on_id":"migrate-egghead-dxh","type":"parent-child","created_at":"2025-12-11T09:54:05.095005-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-dxh.5","title":"Build team billing page (invoices, manage subscription)","description":"## Description\nBuild billing management for team billing admins.\n\n## Features\n1. **View plan**: Show current plan, seat count, price\n2. **View invoices**: List past invoices with download links\n3. **Update seats**: Add/remove seats (Stripe subscription update)\n4. **Update payment**: Link to Stripe customer portal\n5. **Cancel subscription**: Cancel with confirmation\n\n## Routes\n- `/team/billing` - Billing dashboard\n- `/team/billing/invoices` - Invoice history\n\n## Components\n- `PlanSummary` - Current plan, seats, next billing date\n- `InvoiceList` - Table of invoices with PDF download\n- `SeatAdjuster` - +/- seats with price preview\n- `CancelConfirmation` - Modal with cancellation flow\n\n## API\n- `GET /api/team/billing` - Get billing info\n- `GET /api/team/invoices` - List invoices\n- `PATCH /api/team/subscription` - Update seat count\n- `DELETE /api/team/subscription` - Cancel subscription\n\n## Stripe Integration\n- Use Stripe Customer Portal for payment method updates\n- Use Stripe API for seat quantity updates\n- Use Stripe API for invoice retrieval\n\n## Files\n- `course-builder/apps/egghead/src/app/team/billing/page.tsx`\n- `course-builder/apps/egghead/src/app/api/team/billing/`\n- `course-builder/apps/egghead/src/components/team/billing/`\n\n## Data Model\n```\nSubscription\n‚îú‚îÄ‚îÄ organizationId\n‚îú‚îÄ‚îÄ fields: { quantity: number } (seats)\n‚îî‚îÄ‚îÄ status\n\nOrganization\n‚îú‚îÄ‚îÄ stripe_customer_id\n‚îî‚îÄ‚îÄ fields: { seatCount: number }\n```\n\n## Acceptance Criteria\n- [ ] Billing admins can view current plan\n- [ ] Billing admins can view/download invoices\n- [ ] Billing admins can add/remove seats\n- [ ] Billing admins can update payment method (via Stripe portal)\n- [ ] Billing admins can cancel subscription\n- [ ] Non-billing-admins cannot access billing page","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:54:05.127039-08:00","updated_at":"2025-12-11T11:22:38.717245-08:00","dependencies":[{"issue_id":"migrate-egghead-dxh.5","depends_on_id":"migrate-egghead-dxh","type":"parent-child","created_at":"2025-12-11T09:54:05.127372-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-dxh.6","title":"Migrate team data from Rails (266 teams, account_users)","description":"## Context\n\nMigrate the 266 team accounts from Rails to Coursebuilder as Organizations with OrganizationMemberships. This is the data foundation for the team features UI.\n\n**Data to migrate**:\n- **266 team accounts** (accounts where quantity \u003e= 2)\n- **account_users** (many-to-many: accounts ‚Üî users)\n- **Roles**: Rails uses `:account_owner` and `:account_member` roles on User\n- **Team invite tokens**: `team_invite_id` UUID per account\n\n**Target structure**:\n- Organization (one per team account)\n- OrganizationMembership (one per account_user)\n- Preserve owner/member roles\n- Migrate or regenerate invite tokens (decision needed)\n\n## Files to Reference\n\n**Rails schema**:\n- `egghead-rails/app/models/account.rb` (team logic, roles, seats)\n- `egghead-rails/app/models/account_user.rb` (simple join table)\n- `egghead-rails/db/schema.rb` (accounts table, account_users table)\n\n**Coursebuilder schemas**:\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/org/organizations.ts`\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/org/organization-memberships.ts`\n\n**Migration scripts to create**:\n- New file: `investigation/src/migrations/teams.ts` (or similar)\n- Use Effect-TS patterns from existing migration scripts\n\n**Reference existing migration**:\n- `reports/COURSEBUILDER_SCHEMA_ANALYSIS.md` (lines 320-345: field mappings)\n\n## Implementation Details\n\n### 1. Extract Rails team data\n\nQuery Rails DB for team accounts:\n```sql\n-- Accounts with 2+ seats (teams)\nSELECT \n  a.id, a.name, a.slug, a.guid, a.stripe_customer_id, a.team_invite_id,\n  a.created_at\nFROM accounts a\nJOIN account_subscriptions asub ON asub.account_id = a.id\nWHERE asub.quantity \u003e= 2 AND asub.status = 'active'\nLIMIT 266;\n\n-- Get all account_users for these teams\nSELECT \n  au.account_id, au.user_id, au.created_at\nFROM account_users au\nWHERE au.account_id IN (SELECT id FROM accounts WHERE ...);\n\n-- Get owner and member roles\nSELECT \n  u.id, r.name, r.resource_id\nFROM users u\nJOIN users_roles ur ON ur.user_id = u.id\nJOIN roles r ON r.id = ur.role_id\nWHERE r.name IN ('account_owner', 'account_member')\n  AND r.resource_type = 'Account';\n```\n\n### 2. Create Organizations\n\nFor each team account:\n```typescript\nconst org = await db.insert(organizations).values({\n  id: generateId(),\n  name: account.name,\n  image: null, // no image in Rails\n  fields: {\n    slug: account.slug,\n    legacyAccountId: account.id,\n    legacyGuid: account.guid,\n    legacyInviteToken: account.team_invite_id, // preserve for reference\n  },\n  createdAt: account.created_at,\n})\n```\n\n### 3. Create OrganizationMemberships\n\nFor each account_user:\n```typescript\n// Determine role from Rails roles\nconst isOwner = hasRole(user, 'account_owner', account)\nconst role = isOwner ? 'admin' : 'user'\n\nawait db.insert(organizationMemberships).values({\n  id: generateId(),\n  organizationId: orgIdMap[account.id],\n  userId: userIdMap[account_user.user_id],\n  role: role,\n  invitedById: ownerUserId, // owner invited everyone (or null for owner)\n  fields: {\n    legacyAccountUserId: account_user.id,\n  },\n  createdAt: account_user.created_at,\n})\n```\n\n### 4. Create MerchantCustomers\n\nLink Stripe customers to orgs:\n```typescript\nawait db.insert(merchantCustomers).values({\n  id: generateId(),\n  organizationId: orgId,\n  userId: ownerId, // team owner's userId\n  merchantAccountId: merchantAccountId, // egghead's Stripe account\n  identifier: account.stripe_customer_id,\n  status: 1, // active\n  createdAt: account.created_at,\n})\n```\n\n### 5. Validation checks\n\nAfter migration:\n- [ ] Count: 266 Organizations created\n- [ ] All account_users migrated to OrganizationMemberships\n- [ ] Each org has exactly 1 owner (role='admin')\n- [ ] Member counts match Rails: `OrganizationMembership.count === account_users.count`\n- [ ] All orgs linked to MerchantCustomer (Stripe)\n- [ ] No orphaned memberships (all users exist)\n\n### 6. Rollback plan\n\n```typescript\n// Delete in reverse order\nawait db.delete(organizationMemberships)\n  .where(like(fields, '%legacyAccountUserId%'))\n\nawait db.delete(merchantCustomers)\n  .where(inArray(organizationId, teamOrgIds))\n\nawait db.delete(organizations)\n  .where(like(fields, '%legacyAccountId%'))\n```\n\n## Acceptance Criteria\n\n- [ ] All 266 team accounts migrated to Organizations\n- [ ] Organization names and legacy IDs preserved in fields\n- [ ] All account_users migrated to OrganizationMemberships\n- [ ] Owner/member roles correctly mapped (owner ‚Üí admin, member ‚Üí user)\n- [ ] MerchantCustomer records created for Stripe linkage\n- [ ] invitedById populated (owner for members, null for owner)\n- [ ] Validation query confirms counts match\n- [ ] No data loss (all Rails IDs preserved in fields.legacy*)\n- [ ] Script is idempotent (can run multiple times safely)\n- [ ] Rollback script tested in dev environment\n\n## Dependencies\n\n- **MUST BE DONE FIRST**: migrate-egghead-39p.2 (user migration - need users to exist)\n- **BLOCKS**: migrate-egghead-dxh.1, dxh.2, dxh.3 (UI needs org data)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:54:05.159934-08:00","updated_at":"2025-12-11T11:05:04.254457-08:00","dependencies":[{"issue_id":"migrate-egghead-dxh.6","depends_on_id":"migrate-egghead-dxh","type":"parent-child","created_at":"2025-12-11T09:54:05.160265-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-esr","title":"[HUMAN] Approve Customer.io + Email Strategy","description":"**HARD STOP - Agent must not proceed past this point without human approval**\n\n## Gate: Before Phase 4 (External Integrations)\n\n### What Needs Review\n1. Customer.io integration architecture\n2. Email template migration plan\n3. Event taxonomy (what triggers what)\n4. Transactional vs marketing email split\n\n### Artifacts to Present\n- [ ] Customer.io event catalog\n- [ ] Email template inventory (17 mailers from Rails)\n- [ ] Trigger mapping (Rails mailer ‚Üí Customer.io event)\n- [ ] Migration sequence\n\n### Approval Criteria\n- All critical transactional emails covered\n- Event naming is consistent\n- No email gaps during cutover\n- Unsubscribe/preferences handled\n\n### How to Proceed\nAgent presents strategy ‚Üí Human reviews ‚Üí Human marks this bead closed with approval note ‚Üí Agent continues to implementation","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:53:46.773949-08:00","updated_at":"2025-12-11T10:53:46.773949-08:00"}
{"id":"migrate-egghead-f3k","title":"Full sanitized production data export","description":"Option 3: Complete production data export with:\n- All published content (lessons, courses, tags)\n- Anonymized users (fake emails, preserved structure)\n- Real Mux playback IDs (not sensitive)\n- SQLite video tracker data\n- Sanity content for modern courses\n\nCreates a \"production-like\" test environment for full migration validation.\n\nDepends on: generalized export script working.","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-13T09:34:07.847726-08:00","updated_at":"2025-12-13T09:34:07.847726-08:00"}
{"id":"migrate-egghead-h14","title":"Migration gap analysis and README enhancement","description":"Find holes in the egghead migration plan, leverage pdf-brain knowledge, create bulletproof step-by-step README","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:02:03.607541-08:00","updated_at":"2025-12-11T09:06:06.22885-08:00","closed_at":"2025-12-11T09:06:06.22885-08:00"}
{"id":"migrate-egghead-h14.1","title":"Search pdf-brain for data migration patterns","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T09:02:03.641222-08:00","updated_at":"2025-12-11T09:04:34.081748-08:00","closed_at":"2025-12-11T09:04:34.081748-08:00","dependencies":[{"issue_id":"migrate-egghead-h14.1","depends_on_id":"migrate-egghead-h14","type":"parent-child","created_at":"2025-12-11T09:02:03.641579-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-h14.2","title":"Analyze egghead-rails for undocumented dependencies","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T09:02:03.676076-08:00","updated_at":"2025-12-11T09:04:36.001741-08:00","closed_at":"2025-12-11T09:04:36.001741-08:00","dependencies":[{"issue_id":"migrate-egghead-h14.2","depends_on_id":"migrate-egghead-h14","type":"parent-child","created_at":"2025-12-11T09:02:03.676417-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-h14.3","title":"Analyze egghead-next for undocumented features","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T09:02:03.710342-08:00","updated_at":"2025-12-11T09:04:37.20502-08:00","closed_at":"2025-12-11T09:04:37.20502-08:00","dependencies":[{"issue_id":"migrate-egghead-h14.3","depends_on_id":"migrate-egghead-h14","type":"parent-child","created_at":"2025-12-11T09:02:03.71072-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-h14.4","title":"Audit Coursebuilder readiness gaps","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T09:02:03.744146-08:00","updated_at":"2025-12-11T09:04:38.716505-08:00","closed_at":"2025-12-11T09:04:38.716505-08:00","dependencies":[{"issue_id":"migrate-egghead-h14.4","depends_on_id":"migrate-egghead-h14","type":"parent-child","created_at":"2025-12-11T09:02:03.74447-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-h14.5","title":"Synthesize findings and update README","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:02:03.776718-08:00","updated_at":"2025-12-11T09:05:58.73749-08:00","closed_at":"2025-12-11T09:05:58.73749-08:00","dependencies":[{"issue_id":"migrate-egghead-h14.5","depends_on_id":"migrate-egghead-h14","type":"parent-child","created_at":"2025-12-11T09:02:03.777066-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ifz","title":"Customer.io Integration","description":"Port Customer.io integration from Rails to Coursebuilder. Follow the pattern from ai-hero's email-list-provider.ts using the existing ConvertKit provider as template.\n\nEvents to track:\n- subscribed (new subscription)\n- billed (renewal payment)\n- subscription removed (cancellation)\n\nUser attributes to sync:\n- is_pro (boolean)\n- Plan_Interval (month/year)\n- subscription_status","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:53:35.891099-08:00","updated_at":"2025-12-12T09:26:03.813082-08:00","closed_at":"2025-12-12T09:26:03.813082-08:00"}
{"id":"migrate-egghead-ifz.1","title":"Create CustomerioProvider following ConvertKit pattern","description":"## Context\n\nCustomer.io is egghead's transactional email and user tracking platform. Legacy Rails uses Customer.io for:\n- User identification (email, name, plan, timezone, instructor/pro status)\n- Event tracking (purchases, course progress, engagement)\n- User suppression (opt-outs, marketing restrictions)\n\nThis task creates a CustomerioProvider following the established ConvertKit pattern in Coursebuilder Core.\n\n## Why Customer.io (not ConvertKit)\n\n- **ConvertKit**: Newsletter/marketing emails, lead magnets\n- **Customer.io**: Transactional emails triggered by user actions (purchase confirmations, progress notifications, team invites)\n- Both coexist: ConvertKit for marketing, Customer.io for transactional\n\n## Files to Reference\n\n**ConvertKit provider pattern (PRIMARY REFERENCE):**\n- `course-builder/packages/core/src/providers/convertkit.ts` - Full provider implementation\n- `course-builder/packages/core/src/providers/index.ts` - EmailListConfig interface (lines 18-41)\n\n**Rails Customer.io integration (EVENTS/PATTERNS):**\n- `egghead-rails/app/models/customer_io.rb` - Wrapper methods\n- `egghead-rails/app/workers/cio_sync_user_worker.rb` - User identification pattern\n- `egghead-rails/app/workers/track_analytics_worker.rb` - Event tracking pattern\n\n**Inngest integration examples:**\n- `course-builder/apps/egghead/src/inngest/functions/user-created.ts` - Where Customer.io calls will be triggered\n\n## Implementation Details\n\n### 1. Create Provider File\nCreate `course-builder/packages/core/src/providers/customerio.ts`\n\n### 2. Provider Interface (adapt EmailListConfig)\n```typescript\nexport interface CustomerioConfig extends Omit\u003cEmailListConfig, 'subscribeToList'\u003e {\n  id: 'customerio'\n  name: 'Customer.io'\n  type: 'email-list'\n  apiKey: string          // Site ID\n  apiSecret: string       // API Key\n  trackingApiKey: string  // Tracking API Key\n  \n  // Core methods\n  identify(params: IdentifyParams): Promise\u003cvoid\u003e\n  track(params: TrackParams): Promise\u003cvoid\u003e\n  suppress(subscriberId: string): Promise\u003cvoid\u003e\n  \n  // Optional compatibility with EmailListConfig\n  getSubscriber?(subscriberId: string): Promise\u003cSubscriber | null\u003e\n  getSubscriberByEmail?(email: string): Promise\u003cSubscriber | null\u003e\n}\n\ninterface IdentifyParams {\n  id: string          // contact.guid\n  email: string\n  created_at: number  // Unix timestamp\n  first_name?: string\n  plan?: string\n  instructor?: boolean\n  pro?: boolean\n  timezone?: string\n}\n\ninterface TrackParams {\n  id: string          // contact.guid\n  event: string       // e.g., 'course_completed'\n  properties: Record\u003cstring, any\u003e\n}\n```\n\n### 3. Customer.io SDK Integration\nInstall: `customerio-node` (check npm for official SDK)\n\nAPI endpoints:\n- Identify: `PUT /api/v1/customers/{id}` (Track API)\n- Track: `POST /api/v1/customers/{id}/events` (Track API)\n- Suppress: `POST /api/v1/customers/{id}/suppress` (App API)\n\n### 4. Event Patterns from Rails\nKey events to support:\n- User lifecycle: `user_created`, `user_updated`\n- Purchases: `purchase_complete`, `subscription_started`\n- Content: `course_completed`, `lesson_completed`\n- Teams: `team_invite_sent`, `team_seat_claimed`\n\n### 5. Export Provider\nUpdate `course-builder/packages/core/src/providers/index.ts`:\n```typescript\nexport { default as CustomerioProvider } from './customerio'\n```\n\n## Acceptance Criteria\n\n- [ ] `CustomerioProvider` function created with EmailListConfig-compatible interface\n- [ ] Core methods: `identify()`, `track()`, `suppress()` implemented\n- [ ] Zod schemas for IdentifyParams and TrackParams\n- [ ] Environment variables: `CUSTOMERIO_SITE_ID`, `CUSTOMERIO_API_KEY`, `CUSTOMERIO_TRACKING_API_KEY`\n- [ ] Error handling with try/catch and logging\n- [ ] TypeScript types exported\n- [ ] Provider exported from `providers/index.ts`\n- [ ] Optional: Mock provider for dev/test (like ConvertKit's pattern)\n\n## Dependencies\n\n**MUST BE DONE FIRST:**\n- None (standalone provider creation)\n\n**BLOCKS:**\n- migrate-egghead-ifz.2 (SDK installation in egghead app)\n\n## References\n\n- Customer.io Track API docs: https://customer.io/docs/api/track/\n- Customer.io App API docs: https://customer.io/docs/api/app/\n- ConvertKit provider: Lines 13-136 show full pattern","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:35.924794-08:00","updated_at":"2025-12-11T11:04:31.314208-08:00","dependencies":[{"issue_id":"migrate-egghead-ifz.1","depends_on_id":"migrate-egghead-ifz","type":"parent-child","created_at":"2025-12-11T09:53:35.925162-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ifz.2","title":"Add Customer.io SDK to egghead app","description":"## Context\n\nThis task integrates the CustomerioProvider (from ifz.1) into the egghead Coursebuilder app and wires it to Inngest functions for transactional email triggers.\n\nCustomer.io will handle:\n- User identification on signup/login\n- Event tracking for purchases, completions, team actions\n- Transactional emails (purchase receipts, progress notifications, team invites)\n\n## Files to Modify\n\n**App configuration:**\n- `course-builder/apps/egghead/src/env.mjs` - Add Customer.io env vars\n- `course-builder/apps/egghead/package.json` - Add `customerio-node` dependency\n\n**Inngest functions (wire up Customer.io calls):**\n- `course-builder/apps/egghead/src/inngest/functions/user-created.ts` - Add identify() call\n- `course-builder/apps/egghead/src/inngest/functions/post-event-purchase.ts` - Add track() for purchases\n\n**New files:**\n- `course-builder/apps/egghead/src/lib/customerio.ts` - App-specific Customer.io utilities/config\n\n## Implementation Details\n\n### 1. Install Customer.io SDK\n```bash\ncd course-builder/apps/egghead\npnpm add customerio-node\n```\n\nUpdate `package.json` dependencies to include Customer.io SDK.\n\n### 2. Environment Variables\nAdd to `course-builder/apps/egghead/src/env.mjs`:\n```typescript\nexport const env = createEnv({\n  server: {\n    // ... existing\n    CUSTOMERIO_SITE_ID: z.string().min(1),\n    CUSTOMERIO_API_KEY: z.string().min(1),\n    CUSTOMERIO_TRACKING_API_KEY: z.string().min(1),\n  }\n})\n```\n\nAdd to `.env.local`:\n```\nCUSTOMERIO_SITE_ID=your_site_id\nCUSTOMERIO_API_KEY=your_api_key\nCUSTOMERIO_TRACKING_API_KEY=your_tracking_key\n```\n\n### 3. Create Customer.io Service\nCreate `course-builder/apps/egghead/src/lib/customerio.ts`:\n```typescript\nimport { CustomerioProvider } from '@coursebuilder/core/providers'\nimport { env } from '@/env.mjs'\n\nexport const customerio = CustomerioProvider({\n  apiKey: env.CUSTOMERIO_SITE_ID,\n  apiSecret: env.CUSTOMERIO_API_KEY,\n  trackingApiKey: env.CUSTOMERIO_TRACKING_API_KEY,\n})\n\n// Helper: Identify user (call on signup, login, profile updates)\nexport async function identifyUser(user: {\n  id: string\n  email: string\n  name?: string\n  createdAt: Date\n  // ... other fields\n}) {\n  await customerio.identify({\n    id: user.id,\n    email: user.email,\n    created_at: Math.floor(user.createdAt.getTime() / 1000),\n    first_name: user.name?.split(' ')[0],\n    // Add: plan, instructor, pro, timezone when available\n  })\n}\n\n// Helper: Track event\nexport async function trackEvent(userId: string, event: string, properties?: Record\u003cstring, any\u003e) {\n  await customerio.track({\n    id: userId,\n    event,\n    properties: properties || {},\n  })\n}\n```\n\n### 4. Wire to Inngest Functions\n\n**User Created (already exists):**\n`course-builder/apps/egghead/src/inngest/functions/user-created.ts`\n```typescript\nimport { identifyUser } from '@/lib/customerio'\n\nexport const userCreated = inngest.createFunction(\n  // ... existing config\n  async ({ event, step }) =\u003e {\n    // ... existing user role/preference logic\n    \n    await step.run('identify user in Customer.io', async () =\u003e {\n      await identifyUser({\n        id: event.user.id,\n        email: event.user.email,\n        name: event.user.name,\n        createdAt: new Date(event.user.createdAt),\n      })\n    })\n    \n    // ... existing email send\n  }\n)\n```\n\n**Purchase Event:**\n`course-builder/apps/egghead/src/inngest/functions/post-event-purchase.ts`\n```typescript\nimport { trackEvent } from '@/lib/customerio'\n\n// Add tracking step\nawait step.run('track purchase in Customer.io', async () =\u003e {\n  await trackEvent(purchase.userId, 'purchase_complete', {\n    product_id: purchase.productId,\n    amount: purchase.amount,\n    currency: purchase.currency,\n  })\n})\n```\n\n### 5. Key Events to Track (from Rails patterns)\n\nUser lifecycle:\n- `user_created` - On signup (user-created.ts)\n- `user_updated` - On profile/email changes\n\nPurchases:\n- `purchase_complete` - After Stripe charge succeeds (post-event-purchase.ts)\n- `subscription_started` - First subscription activation\n- `subscription_cancelled` - User cancels\n\nContent:\n- `course_completed` - User finishes all lessons\n- `lesson_completed` - Individual lesson completion\n\nTeams:\n- `team_invite_sent` - Seat owner invites member\n- `team_seat_claimed` - Member accepts invite\n\n### 6. Suppression Handling\nFor users who opt out of emails:\n```typescript\n// When user opts out or restricts marketing\nawait customerio.suppress(user.id)\n```\n\nCheck `communicationPreferences` table before sending.\n\n## Acceptance Criteria\n\n- [ ] `customerio-node` installed in egghead app\n- [ ] Environment variables configured in `env.mjs`\n- [ ] `lib/customerio.ts` service created with helpers\n- [ ] `user-created.ts` calls `identifyUser()` in step\n- [ ] `post-event-purchase.ts` calls `trackEvent()` for purchases\n- [ ] TypeScript compiles without errors\n- [ ] Dev server starts without Customer.io errors (even with dummy keys)\n- [ ] Optional: Test identify/track with Customer.io test workspace\n\n## Dependencies\n\n**MUST BE DONE FIRST:**\n- migrate-egghead-ifz.1 (CustomerioProvider must exist)\n\n**BLOCKS:**\n- Future tasks: Transactional email templates, team invite tracking\n\n## Testing Strategy\n\n1. **Local dev** (mock keys):\n   - Use NullProvider pattern or catch errors gracefully\n   - Log calls instead of hitting API\n\n2. **Staging** (real keys):\n   - Create Customer.io test workspace\n   - Verify identify() creates user profile\n   - Verify track() events appear in Customer.io debugger\n\n3. **Integration points**:\n   - Signup flow ‚Üí user profile created\n   - Purchase flow ‚Üí event tracked\n   - Check Customer.io debugger for events\n\n## References\n\n- Existing Inngest function: `user-created.ts` lines 27-40 (communication preferences pattern)\n- Rails identify pattern: `cio_sync_user_worker.rb` lines 28-43\n- Rails track pattern: `track_analytics_worker.rb` lines 29-39","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:35.962133-08:00","updated_at":"2025-12-11T11:04:59.264049-08:00","dependencies":[{"issue_id":"migrate-egghead-ifz.2","depends_on_id":"migrate-egghead-ifz","type":"parent-child","created_at":"2025-12-11T09:53:35.962572-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ifz.3","title":"Implement event tracking: subscribed","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:35.996946-08:00","updated_at":"2025-12-11T09:53:35.996946-08:00","dependencies":[{"issue_id":"migrate-egghead-ifz.3","depends_on_id":"migrate-egghead-ifz","type":"parent-child","created_at":"2025-12-11T09:53:35.99732-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ifz.4","title":"Implement event tracking: billed","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:36.036228-08:00","updated_at":"2025-12-11T09:53:36.036228-08:00","dependencies":[{"issue_id":"migrate-egghead-ifz.4","depends_on_id":"migrate-egghead-ifz","type":"parent-child","created_at":"2025-12-11T09:53:36.036624-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ifz.5","title":"Implement event tracking: subscription removed","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:36.071917-08:00","updated_at":"2025-12-11T09:53:36.071917-08:00","dependencies":[{"issue_id":"migrate-egghead-ifz.5","depends_on_id":"migrate-egghead-ifz","type":"parent-child","created_at":"2025-12-11T09:53:36.072303-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ifz.6","title":"Implement user attribute sync (is_pro, Plan_Interval)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:36.106746-08:00","updated_at":"2025-12-11T09:53:36.106746-08:00","dependencies":[{"issue_id":"migrate-egghead-ifz.6","depends_on_id":"migrate-egghead-ifz","type":"parent-child","created_at":"2025-12-11T09:53:36.107139-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-j9b","title":"POC: Content Migration Proof of Concept","description":"Proof of concept: Migrate a small set of courses/lessons to validate the full migration pipeline before scaling.\n\n## Data Source Reality (CRITICAL LORE)\n\n**Two eras of content:**\n\n| Era | Courses | Lessons | Source of Truth | Notes |\n|-----|---------|---------|-----------------|-------|\n| **Legacy (pre-2024)** | ~390 | ~4,600 | Rails PostgreSQL | Never touched Sanity |\n| **Modern (2024+)** | ~30 | ~530 | Sanity CMS | Created via Coursebuilder workflow |\n\n**Sanity counts (as of Dec 2025):**\n- 38 courses total (30 with railsCourseId link)\n- 524 lessons total (425 with railsLessonId link)\n- Modern courses have rich metadata: collaborators, softwareLibraries, resources\n\n**Rails counts:**\n- 420 courses (series table)\n- 5,132 lessons\n- ALL video URLs (hls_url, mux_playback_id)\n- ALL instructor relationships\n- ALL tag relationships\n\n**Migration strategy:**\n1. Modern content (Sanity): Sanity is source, Rails backfills video URLs\n2. Legacy content (Rails-only): Rails is source, no Sanity data exists\n\n## POC Scope\n\nMigrate 2 courses (1 modern, 1 legacy) with their lessons:\n- **Modern**: \"Claude Code Essentials\" (17 lessons, Sanity source)\n- **Legacy**: Pick a popular Rails-only course (~10-20 lessons)\n\n## Success Criteria\n\n- [ ] Slugs preserved EXACTLY (URLs work)\n- [ ] Videos play (Mux HLS streaming)\n- [ ] Metadata displays correctly\n- [ ] Course‚Üílesson relationships work\n- [ ] Can distinguish modern vs legacy in the data","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-13T08:26:39.502396-08:00","updated_at":"2025-12-13T08:26:39.502396-08:00"}
{"id":"migrate-egghead-j9b.1","title":"Document data source mapping","description":"Create comprehensive documentation of where content data lives.\n\n## Document Structure\n\n```markdown\n# Content Data Sources\n\n## Two Eras of Content\n\n### Legacy Era (pre-2024): ~390 courses, ~4,600 lessons\n- **Source**: Rails PostgreSQL only\n- **No Sanity documents exist**\n- Tables: lessons, series, tracklists, instructors, tags, taggings\n\n### Modern Era (2024+): ~30 courses, ~530 lessons  \n- **Source**: Sanity CMS (created via Coursebuilder)\n- **Rails has**: video URLs, railsLessonId/railsCourseId links\n- Sanity has: rich descriptions, collaborators, softwareLibraries\n\n## Field Mapping by Source\n\n### From Rails (ALL content)\n- slug (SACRED - preserve exactly)\n- title, summary, description\n- duration, state, visibility_state, free_access\n- instructor_id ‚Üí instructor relationship\n- series_id ‚Üí course relationship\n- current_video_hls_url ‚Üí muxPlaybackId\n- tags via taggings table\n\n### From Sanity (Modern content only)\n- description (richer, markdown)\n- collaborators[] (instructor + guests)\n- softwareLibraries[] (versioned deps)\n- resources[] (lesson ordering)\n- thumbnailUrl, iconUrl\n\n### From SQLite (Video migration tracker)\n- mux_asset_id\n- mux_playback_id\n- For lessons not yet in Rails mux columns\n\n## Migration Decision Tree\n\nif (sanity document exists) {\n  source = Sanity\n  backfill video URLs from Rails\n} else {\n  source = Rails\n  no Sanity data to merge\n}\n```\n\n**Output**: `reports/CONTENT_DATA_SOURCES.md`","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-13T08:26:39.5417-08:00","updated_at":"2025-12-13T08:35:35.995185-08:00","closed_at":"2025-12-13T08:35:35.995185-08:00","dependencies":[{"issue_id":"migrate-egghead-j9b.1","depends_on_id":"migrate-egghead-j9b","type":"parent-child","created_at":"2025-12-13T08:26:39.542041-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-j9b.2","title":"Build /lessons/[slug] route","description":"Create lesson viewing route in Coursebuilder.\n\n**Route**: `/lessons/[slug]` - MUST match legacy URL exactly\n\n**Data fetching** (`src/lib/lessons.ts`):\n```typescript\nasync function getLesson(slug: string) {\n  // Query ContentResource where type='lesson' AND fields.slug = slug\n  // Join to videoResource via ContentResourceResource\n  // Return lesson with muxPlaybackId for video\n}\n```\n\n**Page component** (`src/app/(content)/lessons/[slug]/page.tsx`):\n- Server component\n- Fetch lesson by slug\n- Render video player (Mux HLS)\n- Display metadata: title, description, duration, instructor, tags\n- Show course context if lesson belongs to course\n- Basic/ugly styling OK - functionality first\n\n**Video player**:\n- HLS URL: `https://stream.mux.com/{muxPlaybackId}.m3u8`\n- Use existing Mux player component or simple video tag\n- Poster image from fields.thumbnail\n\n**No auth check for POC** - all lessons viewable (add entitlements later)","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-13T08:26:39.581657-08:00","updated_at":"2025-12-13T08:35:37.625638-08:00","closed_at":"2025-12-13T08:35:37.625638-08:00","dependencies":[{"issue_id":"migrate-egghead-j9b.2","depends_on_id":"migrate-egghead-j9b","type":"parent-child","created_at":"2025-12-13T08:26:39.582003-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-j9b.3","title":"Build /courses/[slug] route","description":"Create course viewing route in Coursebuilder.\n\n**Route**: `/courses/[slug]` - MUST match legacy URL exactly\n\n**Data fetching** (`src/lib/courses.ts`):\n```typescript\nasync function getCourse(slug: string) {\n  // Query ContentResource where type='course' AND fields.slug = slug\n  // Get lessons via ContentResourceResource (ordered by position)\n  // Return course with lesson list\n}\n```\n\n**Page component** (`src/app/(content)/courses/[slug]/page.tsx`):\n- Server component\n- Fetch course by slug\n- Display: title, description, image, instructor\n- Lesson list with:\n  - Lesson number\n  - Title (links to /lessons/[slug])\n  - Duration\n- Basic/ugly styling OK - functionality first\n\n**No progress tracking for POC** - add later","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-13T08:26:39.620069-08:00","updated_at":"2025-12-13T08:35:38.945678-08:00","closed_at":"2025-12-13T08:35:38.945678-08:00","dependencies":[{"issue_id":"migrate-egghead-j9b.3","depends_on_id":"migrate-egghead-j9b","type":"parent-child","created_at":"2025-12-13T08:26:39.620394-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-j9b.4","title":"POC migration script for modern course","description":"Migrate \"Claude Code Essentials\" course (modern, Sanity source).\n\n**Course**: claude-code-essentials~jc0n6 (17 lessons)\n**Source**: Sanity is primary, Rails backfills video URLs\n\n**Script steps**:\n1. Fetch course from Sanity (title, slug, description, collaborators, resources)\n2. Fetch lessons from Sanity (ordered via resources[])\n3. For each lesson:\n   - Get railsLessonId from Sanity\n   - Query Rails for video URL (current_video_hls_url) or SQLite for mux_playback_id\n   - Create ContentResource type='lesson' with merged fields\n   - Create videoResource with muxPlaybackId\n   - Link lesson‚Üívideo via ContentResourceResource\n4. Create ContentResource type='course'\n5. Link course‚Üílessons via ContentResourceResource (preserve order)\n\n**Verify**:\n- [ ] All 17 lessons created with correct slugs\n- [ ] All videos have muxPlaybackId\n- [ ] Course‚Üílesson ordering matches Sanity\n- [ ] Can view at /courses/claude-code-essentials~jc0n6\n\n**Output**: `investigation/poc-migrate-modern-course.ts`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T08:26:39.65942-08:00","updated_at":"2025-12-13T08:43:33.04927-08:00","closed_at":"2025-12-13T08:43:33.04927-08:00","dependencies":[{"issue_id":"migrate-egghead-j9b.4","depends_on_id":"migrate-egghead-j9b","type":"parent-child","created_at":"2025-12-13T08:26:39.65977-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-j9b.5","title":"POC migration script for legacy course","description":"Migrate a legacy Rails-only course (no Sanity document).\n\n**Course**: TBD - pick a popular course with 10-20 lessons that has NO Sanity document\n- Query Rails for courses NOT in Sanity\n- Pick one with good video coverage (mux URLs exist)\n\n**Script steps**:\n1. Fetch course from Rails (series table): title, slug, description, instructor_id\n2. Fetch lessons from Rails via tracklists (ordered)\n3. For each lesson:\n   - Get all fields from Rails (no Sanity to merge)\n   - Query SQLite or Rails for mux_playback_id\n   - Create ContentResource type='lesson'\n   - Create videoResource with muxPlaybackId\n   - Link lesson‚Üívideo\n4. Create ContentResource type='course'\n5. Link course‚Üílessons (preserve tracklist order)\n\n**Verify**:\n- [ ] All lessons created with correct slugs\n- [ ] All videos have muxPlaybackId\n- [ ] Course‚Üílesson ordering matches Rails tracklist\n- [ ] Can view at /courses/[slug]\n\n**Output**: `investigation/poc-migrate-legacy-course.ts`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T08:26:39.701492-08:00","updated_at":"2025-12-13T08:43:35.005691-08:00","closed_at":"2025-12-13T08:43:35.005691-08:00","dependencies":[{"issue_id":"migrate-egghead-j9b.5","depends_on_id":"migrate-egghead-j9b","type":"parent-child","created_at":"2025-12-13T08:26:39.701812-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-j9b.6","title":"Validate POC and document learnings","description":"Validate POC results and document learnings for full migration.\n\n**Validation checklist**:\n- [ ] Modern course displays correctly at /courses/claude-code-essentials~jc0n6\n- [ ] Legacy course displays correctly at /courses/[slug]\n- [ ] All lesson slugs work (no 404s)\n- [ ] All videos play (Mux HLS streaming)\n- [ ] Metadata is complete (no missing fields)\n- [ ] Course‚Üílesson navigation works\n\n**Document learnings**:\n1. What field mappings worked?\n2. What was missing or broken?\n3. What edge cases did we hit?\n4. How should we handle modern vs legacy differently?\n5. What needs to change in ntu.2-6 beads?\n\n**Update main migration beads**:\n- Revise ntu.3 (courses) with learnings\n- Revise ntu.4 (lessons) with learnings\n- Revise ntu.5 (relationships) with learnings\n- Add any missing beads discovered\n\n**Output**: `reports/POC_LEARNINGS.md`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T08:26:39.740748-08:00","updated_at":"2025-12-13T08:47:13.034465-08:00","closed_at":"2025-12-13T08:47:13.034465-08:00","dependencies":[{"issue_id":"migrate-egghead-j9b.6","depends_on_id":"migrate-egghead-j9b","type":"parent-child","created_at":"2025-12-13T08:26:39.741119-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-kjq","title":"Generalize export script for N random courses","description":"Extend export-poc-courses.ts to support:\n- `--courses=N` flag for random sample\n- `--all` flag for full export\n- Anonymization of all PII\n- SQLite video data export\n- Sanity content export (for modern courses)\n\nPath to Option 3 (full sanitized schema dump).","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-13T09:34:04.506265-08:00","updated_at":"2025-12-13T09:34:04.506265-08:00"}
{"id":"migrate-egghead-koh","title":"Phase 1: Data Migration Scripts + Validation","description":"## Phase 1: Data Migration (Rails PostgreSQL ‚Üí Coursebuilder PlanetScale)\n\nMigrate all production data from egghead-rails PostgreSQL to course-builder PlanetScale database. This is the foundation for killing the Rails app.\n\n### Scope\n- **699K users** ‚Üí User table\n- **94K accounts** ‚Üí Organization table with MerchantCustomer links\n- **3,335 active subscriptions** ‚Üí Subscription + MerchantSubscription + Entitlement\n- **3M progress records** ‚Üí ResourceProgress (simplified, completion-based)\n- **420 courses + 5,132 lessons** ‚Üí ContentResource with hierarchy\n\n### Migration Strategy\n1. Build migration scripts using Effect-TS for type safety and transaction control\n2. Use read-only queries against Rails PostgreSQL (`eggheadPgQuery` in apps/egghead/src/db/eggheadPostgres.ts)\n3. Write to Coursebuilder PlanetScale via Drizzle ORM\n4. Run reconciliation queries to validate data integrity\n5. Require human approval before production execution\n\n### Prerequisites\n- Rails PostgreSQL connection established (‚úì existing in apps/egghead)\n- Coursebuilder schema reviewed (‚úì COURSEBUILDER_SCHEMA_ANALYSIS.md)\n- Inngest functions for batch processing (‚úì pattern exists in migrate-tips-to-posts.ts)\n\n### Success Criteria\n- All 7 subtasks completed\n- Reconciliation shows \u003c 0.1% discrepancy\n- Joel approves migration plan\n- Zero data loss, all relationships preserved","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:28:54.927552-08:00","updated_at":"2025-12-12T09:25:57.147913-08:00","closed_at":"2025-12-12T09:25:57.147913-08:00"}
{"id":"migrate-egghead-koh.1","title":"User migration script (699K users) with dry-run","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:54.960872-08:00","updated_at":"2025-12-11T11:59:58.526735-08:00","closed_at":"2025-12-11T11:59:58.526735-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.1","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T09:28:54.96124-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.10","title":"[HUMAN] Validate data migration with reconciliation + E2E green","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:55.237502-08:00","updated_at":"2025-12-11T09:28:55.237502-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.10","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T09:28:55.237842-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.11","title":"User Migration (699K users)","description":"## Objective\nMigrate 699K users from Rails `users` table to Coursebuilder `User` table with OAuth providers and authentication setup.\n\n## Source ‚Üí Target Mapping\n\n### Rails Schema (egghead-rails)\n```sql\n-- Table: users\n- id (primary key)\n- email (unique)\n- name\n- created_at, updated_at\n- contact_name, full_name, bio_short\n- opted_out_at (for email preferences)\n- timezone, gdpr_at\n```\n\n### Coursebuilder Schema\n```typescript\n// packages/adapter-drizzle/src/lib/mysql/schemas/auth-schema.ts\nUser {\n  id, email, name, emailVerified, image\n  role (enum: user, admin)\n  fields (JSON for custom data)\n  createdAt, updatedAt\n}\n\nAccount {\n  userId, type, provider (GitHub, email)\n  providerAccountId, access_token, etc.\n}\n```\n\n## Implementation Files\n\n### Migration Script\n**Path**: `investigation/src/migrations/01-users.ts`\n\n```typescript\nimport { Effect, Schedule } from \"effect\"\nimport { eggheadPgQuery } from \"../db/eggheadPostgres\"\nimport { db } from \"course-builder/apps/egghead/src/db\"\nimport { users, accounts } from \"course-builder/packages/adapter-drizzle/src/lib/mysql/schemas\"\n\n// Batch: 1000 users at a time\n// Handle: email normalization, role mapping, OAuth providers\n```\n\n### Inngest Function\n**Path**: `course-builder/apps/egghead/src/inngest/functions/migrate-users.ts`\n\nPattern: Follow `migrate-tips-to-posts.ts` for batch processing with checkpointing.\n\n## Logic \u0026 Edge Cases\n\n1. **Email Normalization**: Lowercase, trim whitespace\n2. **Role Mapping**: \n   - Rails admin users ‚Üí role='admin'\n   - Default ‚Üí role='user'\n3. **OAuth Providers**:\n   - Query Rails `users` for GitHub OAuth tokens\n   - Create `Account` records with provider='github'\n4. **Magic Link Setup**:\n   - Create `Account` records with provider='email' for all users\n   - No password migration (Rails uses Devise, CB uses NextAuth magic links)\n5. **Custom Fields**:\n   - Store `contact_name`, `full_name`, `bio_short` in `User.fields` JSON\n   - Store `timezone`, `opted_out_at`, `gdpr_at` in `User.fields`\n6. **Deduplication**:\n   - Check for existing users by email before insert\n   - Update if exists, insert if new\n\n## Acceptance Criteria\n\n- [ ] All 699K users migrated with matching email addresses\n- [ ] Admin users have role='admin'\n- [ ] GitHub OAuth users have Account records with provider='github'\n- [ ] All users have Account records with provider='email' for magic link auth\n- [ ] Custom fields preserved in User.fields JSON\n- [ ] Can log in via magic link (test with 10 sample users)\n- [ ] Reconciliation query shows 0 missing users\n\n## Validation Query\n```sql\n-- Rails count\nSELECT COUNT(*) FROM users;\n\n-- Coursebuilder count\nSELECT COUNT(*) FROM User;\n\n-- Should match exactly\n```","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-11T11:21:46.048985-08:00","updated_at":"2025-12-11T11:21:46.048985-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.11","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T11:21:46.049358-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.12","title":"Organization Migration (94K accounts)","description":"## Objective\nMigrate 94K accounts from Rails `accounts` table to Coursebuilder `Organization` table with Stripe customer linkage via `MerchantCustomer`.\n\n## Source ‚Üí Target Mapping\n\n### Rails Schema\n```sql\n-- Table: accounts\n- id (primary key)\n- name\n- slug (unique)\n- stripe_customer_id (link to Stripe)\n- owner_id (foreign key to users)\n- created_at, updated_at\n```\n\n### Coursebuilder Schema\n```typescript\n// Organization table\nOrganization {\n  id, name, slug, createdAt, updatedAt\n}\n\n// MerchantCustomer table (Stripe linkage)\nMerchantCustomer {\n  id, userId, organizationId\n  merchantAccountId (Stripe account ID)\n  identifier (stripe_customer_id)\n  status, createdAt\n}\n```\n\n## Implementation Files\n\n### Migration Script\n**Path**: `investigation/src/migrations/02-organizations.ts`\n\n```typescript\nimport { Effect } from \"effect\"\nimport { eggheadPgQuery } from \"../db/eggheadPostgres\"\nimport { db } from \"course-builder/apps/egghead/src/db\"\nimport { organizations, merchantCustomers } from \"course-builder/packages/adapter-drizzle\"\n\n// Batch: 500 orgs at a time\n// Handle: slug uniqueness, Stripe customer creation\n```\n\n### Inngest Function\n**Path**: `course-builder/apps/egghead/src/inngest/functions/migrate-organizations.ts`\n\n## Logic \u0026 Edge Cases\n\n1. **Slug Handling**:\n   - Rails slugs must be preserved (SEO, URLs)\n   - Check for slug conflicts before insert\n   - If conflict, append `-2`, `-3`, etc.\n\n2. **Owner Mapping**:\n   - Rails `owner_id` ‚Üí Coursebuilder user via email lookup\n   - Create `OrganizationMember` record with role='owner'\n\n3. **Stripe Customer Linkage**:\n   - Rails `stripe_customer_id` ‚Üí `MerchantCustomer.identifier`\n   - Set `merchantAccountId` to egghead's Stripe account ID\n   - Status: 'active' (all existing customers are active)\n\n4. **MerchantAccount Lookup**:\n   - Query `MerchantAccount` table for egghead's Stripe account\n   - Use that ID for all `MerchantCustomer` records\n\n5. **Orphaned Accounts**:\n   - If `owner_id` is NULL or user doesn't exist, log warning\n   - Still create org, but no owner member\n\n6. **Personal vs Team Accounts**:\n   - Rails doesn't distinguish, but CB has `createdById`\n   - Set `createdById` to owner's user ID\n\n## Acceptance Criteria\n\n- [ ] All 94K organizations migrated\n- [ ] Slugs preserved exactly (critical for URLs)\n- [ ] Stripe customer IDs linked via MerchantCustomer\n- [ ] Owners have OrganizationMember records with role='owner'\n- [ ] No slug conflicts (or conflicts resolved with suffix)\n- [ ] Reconciliation shows 0 missing organizations\n- [ ] Test: Load org by slug, verify Stripe customer ID matches Rails\n\n## Validation Queries\n```sql\n-- Rails count\nSELECT COUNT(*) FROM accounts;\n\n-- CB count\nSELECT COUNT(*) FROM Organization;\n\n-- Stripe linkage check\nSELECT COUNT(*) FROM MerchantCustomer \nWHERE identifier IN (SELECT stripe_customer_id FROM accounts WHERE stripe_customer_id IS NOT NULL);\n```\n\n## Dependencies\n- **koh.1 (User Migration)** must complete first for owner lookups","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-11T11:22:01.669308-08:00","updated_at":"2025-12-11T11:22:01.669308-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.12","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T11:22:01.66972-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.13","title":"Subscription Migration (3,335 active)","description":"## Objective\nMigrate 3,335 active subscriptions from Rails `account_subscriptions` to Coursebuilder `Subscription` + `MerchantSubscription` + `Entitlement` for pro access.\n\n## Source ‚Üí Target Mapping\n\n### Rails Schema\n```sql\n-- Table: account_subscriptions\n- id\n- account_id (foreign key to accounts)\n- stripe_subscription_id\n- status (active, canceled, past_due, etc.)\n- quantity\n- interval (month, year)\n- current_period_start, current_period_end\n- cancel_at_period_end\n- created_at, updated_at\n```\n\n### Coursebuilder Schema\n```typescript\n// Subscription (logical subscription)\nSubscription {\n  id, userId, organizationId\n  status, interval, intervalCount\n  currentPeriodStart, currentPeriodEnd\n  cancelAtPeriodEnd\n  createdAt, updatedAt\n}\n\n// MerchantSubscription (Stripe linkage)\nMerchantSubscription {\n  id, subscriptionId, merchantCustomerId\n  merchantAccountId\n  identifier (stripe_subscription_id)\n  status, createdAt\n}\n\n// Entitlement (grants access)\nEntitlement {\n  id, userId, organizationId\n  productId (egghead_pro)\n  status, expiresAt\n}\n```\n\n## Implementation Files\n\n### Migration Script\n**Path**: `investigation/src/migrations/03-subscriptions.ts`\n\n### Inngest Function\n**Path**: `course-builder/apps/egghead/src/inngest/functions/migrate-subscriptions.ts`\n\n## Logic \u0026 Edge Cases\n\n1. **Account ‚Üí Organization Mapping**:\n   - Rails `account_id` ‚Üí CB `organizationId` via slug/ID lookup\n   - If account not found, skip subscription (log error)\n\n2. **User Mapping**:\n   - Get organization owner ‚Üí set as `userId` on Subscription\n   - If no owner, use account creator\n\n3. **Status Mapping**:\n   - Rails `active` ‚Üí CB `active`\n   - Rails `canceled` ‚Üí CB `canceled`\n   - Rails `past_due` ‚Üí CB `past_due`\n   - Only migrate `active`, `past_due`, `trialing` (skip `canceled`)\n\n4. **Quantity Handling**:\n   - Rails has `quantity` (seat count)\n   - CB subscription model: store in `Subscription.fields` JSON\n   - Create `quantity` entitlements for the org\n\n5. **MerchantCustomer Lookup**:\n   - Query `MerchantCustomer` by organizationId\n   - Use that ID for `merchantCustomerId` in `MerchantSubscription`\n\n6. **Product Mapping**:\n   - All egghead subscriptions grant \"egghead_pro\" product\n   - Query/create `Product` record with identifier='egghead_pro'\n   - Use that ID for `Entitlement.productId`\n\n7. **Expiration**:\n   - Set `Entitlement.expiresAt` to `current_period_end`\n   - For active subs, this auto-renews via webhook\n\n8. **Interval Mapping**:\n   - Rails `interval='month'` ‚Üí CB `interval='month'`, `intervalCount=1`\n   - Rails `interval='year'` ‚Üí CB `interval='year'`, `intervalCount=1`\n\n## Acceptance Criteria\n\n- [ ] All 3,335 active subscriptions migrated\n- [ ] Stripe subscription IDs linked via MerchantSubscription\n- [ ] Each subscription has corresponding Entitlement with productId='egghead_pro'\n- [ ] Status, quantity, interval, periods preserved\n- [ ] Entitlements expire at current_period_end\n- [ ] Test: User with active sub can access pro content\n- [ ] Reconciliation shows 0 missing active subs\n\n## Validation Queries\n```sql\n-- Rails active subs\nSELECT COUNT(*) FROM account_subscriptions \nWHERE status IN ('active', 'past_due', 'trialing');\n\n-- CB active subs\nSELECT COUNT(*) FROM Subscription \nWHERE status IN ('active', 'past_due', 'trialing');\n\n-- Entitlement check\nSELECT COUNT(*) FROM Entitlement WHERE productId = 'egghead_pro';\n```\n\n## Dependencies\n- **koh.1 (User Migration)** for userId lookup\n- **koh.2 (Organization Migration)** for organizationId and MerchantCustomer lookup","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-11T11:22:18.219106-08:00","updated_at":"2025-12-11T11:22:18.219106-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.13","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T11:22:18.219545-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.14","title":"Progress Migration (3M records)","description":"## Objective\nMigrate 3M progress records from Rails `lesson_views` + `series_progresses` to Coursebuilder `ResourceProgress`. **SIMPLIFY**: Don't migrate video segments, only completion status.\n\n## Source ‚Üí Target Mapping\n\n### Rails Schema\n```sql\n-- Table: lesson_views\n- id\n- user_id\n- lesson_id\n- collection_id (series)\n- completed_at\n- last_viewed_at\n- progress_segments (JSON array of watched segments - SKIP THIS)\n- created_at, updated_at\n\n-- Table: series_progresses  \n- id\n- user_id\n- series_id\n- completed_at\n- created_at, updated_at\n```\n\n### Coursebuilder Schema\n```typescript\n// ResourceProgress\nResourceProgress {\n  userId, resourceId\n  completedAt, updatedAt\n  fields (JSON for custom data)\n}\n```\n\n## Implementation Files\n\n### Migration Script\n**Path**: `investigation/src/migrations/04-progress.ts`\n\n### Inngest Function\n**Path**: `course-builder/apps/egghead/src/inngest/functions/migrate-progress.ts`\n\n## Logic \u0026 Edge Cases\n\n1. **Lesson Progress**:\n   - Rails `lesson_views` ‚Üí CB `ResourceProgress`\n   - Map `lesson_id` ‚Üí `resourceId` (ContentResource slug/ID lookup)\n   - If `completed_at` IS NOT NULL ‚Üí set `completedAt`\n   - If `completed_at` IS NULL but `last_viewed_at` exists ‚Üí set `updatedAt` (started but not completed)\n\n2. **Course Progress**:\n   - Rails `series_progresses` ‚Üí CB `ResourceProgress`\n   - Map `series_id` ‚Üí `resourceId` (ContentResource slug/ID lookup)\n   - Only migrate if `completed_at` IS NOT NULL\n\n3. **SKIP Video Segments**:\n   - Rails stores `progress_segments` JSON (timestamps of watched parts)\n   - **DO NOT MIGRATE** - adds complexity, not critical for user experience\n   - Simplified model: lesson is either started, completed, or not started\n\n4. **User Lookup**:\n   - Rails `user_id` ‚Üí CB `userId` via ID mapping\n   - If user not found, skip progress record (log warning)\n\n5. **Content Lookup**:\n   - Rails `lesson_id` / `series_id` ‚Üí CB `resourceId`\n   - Query `ContentResource` by slug or external ID\n   - If content not found, skip progress (log warning)\n\n6. **Deduplication**:\n   - Primary key: (userId, resourceId)\n   - If duplicate, keep record with latest `completedAt` or `last_viewed_at`\n\n7. **Batch Size**:\n   - 3M records is large - batch 5000 at a time\n   - Use Inngest sleep for rate limiting\n\n8. **Partial Progress**:\n   - Store `last_viewed_at` in `ResourceProgress.fields` JSON\n   - This preserves \"continue watching\" UX without segments\n\n## Acceptance Criteria\n\n- [ ] All lesson progress migrated (completed + partial)\n- [ ] All course progress migrated (completed only)\n- [ ] No video segments migrated (simplified model)\n- [ ] Users see completed lessons as completed\n- [ ] Users see partial lessons as in-progress (updatedAt set)\n- [ ] Reconciliation shows \u003c 1% discrepancy (allow for missing content)\n- [ ] Test: Load user profile, verify completed courses show correctly\n\n## Validation Queries\n```sql\n-- Rails lesson progress\nSELECT COUNT(*) FROM lesson_views;\n\n-- Rails completed lessons\nSELECT COUNT(*) FROM lesson_views WHERE completed_at IS NOT NULL;\n\n-- CB lesson progress\nSELECT COUNT(*) FROM ResourceProgress \nWHERE resourceId IN (SELECT id FROM ContentResource WHERE type='lesson');\n\n-- CB completed lessons\nSELECT COUNT(*) FROM ResourceProgress \nWHERE resourceId IN (SELECT id FROM ContentResource WHERE type='lesson')\nAND completedAt IS NOT NULL;\n```\n\n## Performance Considerations\n- 3M records = ~600 batches of 5000\n- Est. runtime: 2-3 hours with Inngest\n- Use `updatedAt` index for efficient queries\n\n## Dependencies\n- **koh.1 (User Migration)** for userId lookup\n- **koh.5 (Content Migration)** for resourceId lookup","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T11:22:35.584762-08:00","updated_at":"2025-12-11T11:22:35.584762-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.14","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T11:22:35.585178-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.15","title":"Content Migration (420 courses, 5,132 lessons)","description":"## Objective\nMigrate 420 courses and 5,132 lessons from Rails `series` + `lessons` tables to Coursebuilder `ContentResource` with hierarchy preserved via `ContentResourceResource`.\n\n## Source ‚Üí Target Mapping\n\n### Rails Schema\n```sql\n-- Table: series (courses/workshops)\n- id\n- slug (unique, critical for URLs)\n- title, description\n- state (published, draft, retired)\n- instructor_id (foreign key to instructors)\n- created_at, updated_at\n- square_cover_url, path (URL path)\n\n-- Table: lessons\n- id  \n- slug (unique)\n- title, summary, description\n- state (published, retired)\n- instructor_id\n- mux_asset_id (video on Mux)\n- mux_playback_id\n- created_at, updated_at\n- path, http_url\n\n-- Table: series_lessons (join table)\n- series_id, lesson_id\n- position (order within course)\n```\n\n### Coursebuilder Schema\n```typescript\n// ContentResource (unified content table)\nContentResource {\n  id, type (course, lesson, tutorial, etc.)\n  createdById (instructor)\n  fields (JSON: {\n    slug, title, description, body,\n    state, visibility,\n    muxPlaybackId, muxAssetId,\n    coverImage\n  })\n  createdAt, updatedAt\n}\n\n// ContentResourceResource (hierarchy)\nContentResourceResource {\n  resourceId (course)\n  resourceOfId (lesson)\n  position\n  createdAt, updatedAt\n}\n```\n\n## Implementation Files\n\n### Migration Script\n**Path**: `investigation/src/migrations/05-content.ts`\n\n### Inngest Function  \n**Path**: `course-builder/apps/egghead/src/inngest/functions/migrate-content.ts`\n\n### SQLite Reference\n**Path**: `download-egghead/egghead_videos.db` (already has courses/lessons with Mux IDs)\n\n## Logic \u0026 Edge Cases\n\n1. **Course Migration**:\n   - Rails `series` ‚Üí CB `ContentResource` with `type='course'`\n   - Map slug ‚Üí `fields.slug`\n   - Map title ‚Üí `fields.title`\n   - Map description ‚Üí `fields.description`\n   - Map state ‚Üí `fields.state` (published, draft, retired)\n   - Map `square_cover_url` ‚Üí `fields.coverImage`\n\n2. **Lesson Migration**:\n   - Rails `lessons` ‚Üí CB `ContentResource` with `type='lesson'`\n   - Map `mux_asset_id` ‚Üí `fields.muxAssetId`\n   - Map `mux_playback_id` ‚Üí `fields.muxPlaybackId`\n   - Map slug, title, summary, state same as courses\n\n3. **Instructor Mapping**:\n   - Rails `instructor_id` ‚Üí CB `createdById` (User ID)\n   - Query Rails `instructors` table for email\n   - Lookup CB `User` by email\n   - If not found, create placeholder user (log warning)\n\n4. **Hierarchy (Course ‚Üí Lesson)**:\n   - Rails `series_lessons` ‚Üí CB `ContentResourceResource`\n   - Map `series_id` ‚Üí `resourceId` (course)\n   - Map `lesson_id` ‚Üí `resourceOfId` (lesson)\n   - Map `position` ‚Üí `position` (preserve lesson order)\n\n5. **Slug Uniqueness**:\n   - Rails enforces unique slugs per table\n   - CB has global slug uniqueness for SEO\n   - Check for conflicts, append `-lesson` or `-course` suffix if needed\n\n6. **State/Visibility**:\n   - Rails `state='published'` ‚Üí CB `state='published'`, `visibility='public'`\n   - Rails `state='draft'` ‚Üí CB `state='draft'`, `visibility='unlisted'`\n   - Rails `state='retired'` ‚Üí CB `state='archived'`, `visibility='unlisted'`\n\n7. **Mux Asset Validation**:\n   - 97.5% of videos already on Mux (per MIGRATION_DATA_REPORT.md)\n   - For lessons with NULL `mux_asset_id`, check SQLite DB\n   - If still NULL, mark as needing manual upload (create separate bead)\n\n8. **Path Preservation**:\n   - Rails `path` field (e.g., `/courses/react-hooks`) must map to slug\n   - Store original path in `fields.legacyPath` for redirect mapping\n\n## Acceptance Criteria\n\n- [ ] All 420 courses migrated with slugs preserved\n- [ ] All 5,132 lessons migrated with Mux asset IDs\n- [ ] Hierarchy preserved (ContentResourceResource joins match series_lessons)\n- [ ] Lesson order within courses preserved (position field)\n- [ ] Instructors mapped to users via email lookup\n- [ ] State/visibility correctly set\n- [ ] Test: Load course page, verify lessons appear in correct order\n- [ ] Test: Play lesson video, verify Mux playback works\n- [ ] Reconciliation shows 0 missing courses/lessons\n\n## Validation Queries\n```sql\n-- Rails counts\nSELECT COUNT(*) FROM series;\nSELECT COUNT(*) FROM lessons;\nSELECT COUNT(*) FROM series_lessons;\n\n-- CB counts\nSELECT COUNT(*) FROM ContentResource WHERE type='course';\nSELECT COUNT(*) FROM ContentResource WHERE type='lesson';\nSELECT COUNT(*) FROM ContentResourceResource;\n\n-- Mux asset check\nSELECT COUNT(*) FROM ContentResource \nWHERE type='lesson' AND JSON_EXTRACT(fields, '$.muxAssetId') IS NOT NULL;\n```\n\n## Dependencies\n- **koh.1 (User Migration)** for instructor (createdById) lookup","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-11T11:22:58.09721-08:00","updated_at":"2025-12-11T11:22:58.09721-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.15","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T11:22:58.097591-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.16","title":"Validation \u0026 Reconciliation","description":"## Objective\nBuild reconciliation queries comparing Rails PostgreSQL vs Coursebuilder PlanetScale to verify data integrity after migration. Alert on any discrepancy \u003e 0.1%.\n\n## Reconciliation Categories\n\n### 1. User Reconciliation\n**Queries**:\n```sql\n-- Rails\nSELECT COUNT(*) as rail_users FROM users;\n\n-- Coursebuilder  \nSELECT COUNT(*) as cb_users FROM User;\n\n-- Email spot check (10 random)\nSELECT email FROM users ORDER BY RANDOM() LIMIT 10;\n-- Verify each exists in CB User table\n```\n\n**Checks**:\n- Total count matches exactly\n- Random sample email lookup (10 users)\n- Admin users have role='admin'\n- OAuth accounts exist for GitHub users\n\n### 2. Organization Reconciliation\n**Queries**:\n```sql\n-- Rails\nSELECT COUNT(*) FROM accounts;\nSELECT slug FROM accounts WHERE stripe_customer_id IS NOT NULL LIMIT 10;\n\n-- Coursebuilder\nSELECT COUNT(*) FROM Organization;\nSELECT slug FROM Organization o\nJOIN MerchantCustomer mc ON mc.organizationId = o.id\nLIMIT 10;\n```\n\n**Checks**:\n- Total count matches exactly\n- Slugs preserved (critical - SEO impact)\n- Stripe customer linkage (MerchantCustomer exists)\n- Owners have OrganizationMember records\n\n### 3. Subscription Reconciliation\n**Queries**:\n```sql\n-- Rails active subs\nSELECT COUNT(*) FROM account_subscriptions \nWHERE status IN ('active', 'past_due', 'trialing');\n\n-- CB active subs\nSELECT COUNT(*) FROM Subscription\nWHERE status IN ('active', 'past_due', 'trialing');\n\n-- Entitlement check\nSELECT COUNT(*) FROM Entitlement \nWHERE productId = (SELECT id FROM Product WHERE identifier='egghead_pro');\n```\n\n**Checks**:\n- Active subscription count matches\n- Each subscription has MerchantSubscription (Stripe link)\n- Each subscription has Entitlement record\n- Current period dates match Rails\n- Quantity preserved (for team subs)\n\n### 4. Progress Reconciliation\n**Queries**:\n```sql\n-- Rails completed lessons\nSELECT COUNT(*) FROM lesson_views WHERE completed_at IS NOT NULL;\n\n-- CB completed lessons\nSELECT COUNT(*) FROM ResourceProgress\nWHERE resourceId IN (SELECT id FROM ContentResource WHERE type='lesson')\nAND completedAt IS NOT NULL;\n\n-- User spot check (user with most progress)\nSELECT user_id, COUNT(*) FROM lesson_views \nWHERE completed_at IS NOT NULL \nGROUP BY user_id \nORDER BY COUNT(*) DESC \nLIMIT 1;\n-- Verify CB has same count for that user\n```\n\n**Checks**:\n- Completed lesson count within 1% (allow for missing content)\n- Partial progress count within 5% (acceptable loss)\n- User spot check (high-progress user)\n\n### 5. Content Reconciliation\n**Queries**:\n```sql\n-- Rails\nSELECT COUNT(*) FROM series;\nSELECT COUNT(*) FROM lessons;\nSELECT COUNT(*) FROM series_lessons;\n\n-- Coursebuilder\nSELECT COUNT(*) FROM ContentResource WHERE type='course';\nSELECT COUNT(*) FROM ContentResource WHERE type='lesson';\nSELECT COUNT(*) FROM ContentResourceResource;\n\n-- Slug preservation check\nSELECT slug FROM series ORDER BY RANDOM() LIMIT 20;\n-- Verify each exists in CB ContentResource\n```\n\n**Checks**:\n- Course count matches exactly\n- Lesson count matches exactly\n- Hierarchy (ContentResourceResource) count matches series_lessons\n- Slugs preserved (random sample)\n- Mux asset IDs present (97%+ should have assets)\n\n## Implementation Files\n\n### Reconciliation Script\n**Path**: `investigation/src/reconciliation/validate-migration.ts`\n\n```typescript\nimport { Effect } from \"effect\"\nimport { eggheadPgQuery } from \"../db/eggheadPostgres\"\nimport { db } from \"course-builder/apps/egghead/src/db\"\n\nexport const reconcile = Effect.gen(function* (_) {\n  const results = {\n    users: yield* _(reconcileUsers),\n    organizations: yield* _(reconcileOrganizations),\n    subscriptions: yield* _(reconcileSubscriptions),\n    progress: yield* _(reconcileProgress),\n    content: yield* _(reconcileContent),\n  }\n  \n  return yield* _(generateReport(results))\n})\n```\n\n### Report Format\n**Path**: `reports/MIGRATION_RECONCILIATION.md`\n\nGenerate markdown report:\n```markdown\n# Migration Reconciliation Report\nGenerated: 2025-12-11\n\n## Summary\n- ‚úÖ Users: 699,000 (100% match)\n- ‚úÖ Organizations: 94,000 (100% match)\n- ‚ö†Ô∏è  Subscriptions: 3,334 / 3,335 (99.97% - 1 missing)\n- ‚úÖ Progress: 2,987,123 / 3,000,000 (99.57% - acceptable)\n- ‚úÖ Content: 5,552 / 5,552 (100% match)\n\n## Detailed Findings\n[Per-category breakdowns]\n\n## Action Items\n- Investigate missing subscription (ID: 12345)\n```\n\n## Acceptance Criteria\n\n- [ ] Reconciliation script runs successfully\n- [ ] All counts within 0.1% tolerance (except progress: 1% allowed)\n- [ ] Report generated with pass/fail for each category\n- [ ] Spot checks pass (random sample lookups)\n- [ ] Any discrepancies logged with Rails IDs for investigation\n- [ ] Report reviewed and approved by Joel\n\n## Alert Thresholds\n\n| Category      | Tolerance | Action                  |\n|---------------|-----------|-------------------------|\n| Users         | 0%        | BLOCK migration         |\n| Organizations | 0%        | BLOCK migration         |\n| Subscriptions | 0.1%      | BLOCK migration         |\n| Progress      | 1%        | Log warnings, allow     |\n| Content       | 0%        | BLOCK migration         |\n\n## Dependencies\n- **ALL** other koh subtasks must complete before reconciliation","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T11:23:23.562126-08:00","updated_at":"2025-12-11T11:23:23.562126-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.16","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T11:23:23.562549-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.17","title":"[HUMAN] Approve Migration Before Execution","description":"## Objective\nPresent migration plan to Joel with dry-run results and get explicit written approval before executing on production data.\n\n## Approval Checklist\n\n### 1. Migration Plan Review\nPresent to Joel:\n- [ ] All 6 migration scripts reviewed (users, orgs, subs, progress, content, validation)\n- [ ] Batch sizes and runtime estimates\n- [ ] Rollback strategy (if needed)\n- [ ] Point of no return identified (after which rollback is complex)\n\n### 2. Dry-Run Results\nRun all migrations against **staging/test environment** first:\n- [ ] User migration: Show 100 sample users migrated correctly\n- [ ] Organization migration: Show 50 sample orgs with Stripe linkage\n- [ ] Subscription migration: Show 20 sample active subs with entitlements\n- [ ] Progress migration: Show user with 100+ completed lessons preserved\n- [ ] Content migration: Show course with 30 lessons, hierarchy intact\n- [ ] Reconciliation: Show validation report with 100% match\n\n### 3. Risk Assessment\nDocument and present:\n- [ ] **Data loss risk**: What could go wrong?\n- [ ] **Downtime risk**: How long will migration take?\n- [ ] **Rollback complexity**: Can we undo this?\n- [ ] **User impact**: Will users notice anything?\n- [ ] **SEO impact**: Are slugs/URLs preserved?\n\n### 4. Go/No-Go Decision\nJoel must provide written approval with:\n- [ ] \"I approve production migration\" (exact phrase)\n- [ ] Acknowledgment of risks reviewed\n- [ ] Preferred execution time (e.g., \"Run Saturday 2am EST\")\n- [ ] Communication plan (notify users? status page?)\n\n## Presentation Format\n\n### Dry-Run Summary Document\n**Path**: `reports/MIGRATION_DRY_RUN_RESULTS.md`\n\n```markdown\n# Migration Dry-Run Results\n\n## Executive Summary\n- Environment: Staging DB (copy of production)\n- Execution time: 2 hours 34 minutes\n- Success rate: 99.97%\n- Issues found: 3 (documented below)\n\n## Per-Category Results\n\n### Users (699K records)\n- Migrated: 699,000 / 699,000 (100%)\n- Runtime: 23 minutes\n- Issues: None\n- Sample: [show 10 users with email, role, OAuth status]\n\n### Organizations (94K records)\n- Migrated: 94,000 / 94,000 (100%)\n- Runtime: 18 minutes\n- Issues: 2 slug conflicts (resolved with suffix)\n- Sample: [show 10 orgs with slug, Stripe customer ID]\n\n[... continue for all categories ...]\n\n## Reconciliation Report\n[Paste validation results]\n\n## Issues \u0026 Resolutions\n1. Issue: 2 slug conflicts\n   - Resolution: Appended `-org` suffix\n   - Impact: Low (only 2 of 94K)\n\n## Risks \u0026 Mitigation\n[Detail risk assessment]\n\n## Recommendation\n‚úÖ READY for production migration\n```\n\n### Approval Email Template\nTo: joel@egghead.io\nSubject: egghead ‚Üí Coursebuilder Migration - Approval Required\n\nJoel,\n\nThe data migration scripts are complete and tested. See attached dry-run results.\n\n**Summary**:\n- 699K users, 94K orgs, 3.3K subs, 3M progress, 5.5K content\n- Dry-run: 99.97% success rate on staging\n- Runtime: ~3 hours\n- Zero expected downtime (read-only migration)\n\n**Risks**:\n- [Detail key risks from assessment]\n\n**Go/No-Go Decision Needed**:\nPlease reply with \"I approve production migration\" and your preferred execution time.\n\nFull report: reports/MIGRATION_DRY_RUN_RESULTS.md\n\n## Acceptance Criteria\n\n- [ ] Dry-run executed on staging environment\n- [ ] Dry-run results documented in MIGRATION_DRY_RUN_RESULTS.md\n- [ ] Risk assessment completed\n- [ ] Joel receives presentation (email + doc)\n- [ ] **Joel provides written approval** (\"I approve production migration\")\n- [ ] Execution time agreed upon\n- [ ] This bead marked BLOCKED until approval received\n\n## Blocking Behavior\nThis bead should be marked as BLOCKED until Joel provides explicit approval. No production migration code should run without this gate passing.\n\n## Dependencies\n- **ALL** other koh subtasks (koh.1 through koh.6) must be complete\n- Dry-run environment must be available","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-11T11:23:49.270252-08:00","updated_at":"2025-12-11T11:23:49.270252-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.17","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T11:23:49.270644-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.2","title":"Organization migration script (94K accounts)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:54.993648-08:00","updated_at":"2025-12-11T11:59:59.089178-08:00","closed_at":"2025-12-11T11:59:59.089178-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.2","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T09:28:54.993973-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.3","title":"OrganizationMembership + MerchantCustomer migration","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:55.026168-08:00","updated_at":"2025-12-11T11:59:59.708281-08:00","closed_at":"2025-12-11T11:59:59.708281-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.3","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T09:28:55.026514-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.4","title":"Subscription + MerchantSubscription migration (3,335 active)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:55.057157-08:00","updated_at":"2025-12-11T12:00:00.248417-08:00","closed_at":"2025-12-11T12:00:00.248417-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.4","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T09:28:55.057469-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.5","title":"Entitlement migration script (pro access grants)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:55.086039-08:00","updated_at":"2025-12-11T12:00:00.882822-08:00","closed_at":"2025-12-11T12:00:00.882822-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.5","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T09:28:55.086339-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.6","title":"Content migration (420 courses, 5,132 lessons, 627 tags)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:55.115195-08:00","updated_at":"2025-12-11T12:00:01.493426-08:00","closed_at":"2025-12-11T12:00:01.493426-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.6","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T09:28:55.115503-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.7","title":"Instructor migration (134 instructors)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T09:28:55.143737-08:00","updated_at":"2025-12-11T12:00:02.022664-08:00","closed_at":"2025-12-11T12:00:02.022664-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.7","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T09:28:55.144036-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.8","title":"Progress migration (3M records, batch processing)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T09:28:55.174106-08:00","updated_at":"2025-12-11T12:00:02.541847-08:00","closed_at":"2025-12-11T12:00:02.541847-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.8","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T09:28:55.174434-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-koh.9","title":"E2E: Verify migrated user auth + content renders + entitlements gate","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:28:55.205751-08:00","updated_at":"2025-12-11T09:28:55.205751-08:00","dependencies":[{"issue_id":"migrate-egghead-koh.9","depends_on_id":"migrate-egghead-koh","type":"parent-child","created_at":"2025-12-11T09:28:55.206065-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-mnn","title":"Sanity Elimination - Single Database Migration","description":"Eliminate Sanity CMS dependency. All content moves to PlanetScale ContentResource tables. egghead becomes a SINGLE DATABASE application.\n\nCurrent state: ~100 Sanity references in egghead app (lessons, courses, collaborators, software libraries)\nTarget state: All content in ContentResource with fields JSON\n\nNote: 193 missing videos will redirect to /gone page (deprecated content)","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:53:02.492794-08:00","updated_at":"2025-12-11T09:53:02.492794-08:00"}
{"id":"migrate-egghead-mnn.1","title":"Audit all Sanity content types and map to ContentResource fields","description":"## Context\n\nAudit all Sanity content types to understand what fields exist and map them to Coursebuilder's ContentResource schema. This is the foundation for eliminating the Sanity dependency - we need to understand what data lives in Sanity before we can migrate it.\n\n**Why**: Sanity is a third dependency we're eliminating (Rails + egghead-next ‚Üí Coursebuilder). All content currently in Sanity must move to Coursebuilder's flexible ContentResource.fields JSON structure.\n\n**Current State**: \n- Sanity has 3 primary content types for migration: `lesson`, `course`, `section` (plus `videoResource` which is embedded)\n- Coursebuilder has ContentResource with flexible `fields: json` that can store arbitrary structured data\n- We have 420 courses and 5,132 lessons to migrate\n\n## Files to Reference\n\n**Sanity Schemas** (source of truth for current structure):\n- `egghead-next/studio/schemas/documents/lesson.ts` - Lesson schema with railsLessonId, resources array, collaborators, etc.\n- `egghead-next/studio/schemas/documents/course.ts` - Course schema with sections, resources, images, metadata\n- `egghead-next/studio/schemas/documents/section.ts` - Section schema (grouping lessons within courses)\n- `egghead-next/studio/schemas/documents/videoResource.ts` - Video metadata (muxAsset, transcript, duration)\n- `egghead-next/studio/schemas/documents/collaborator.tsx` - Instructor/contributor metadata\n- `egghead-next/studio/schemas/objects/muxAsset.js` - Mux video asset structure\n\n**Coursebuilder Target Schema**:\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/content/content-resource.ts` - Target ContentResource schema\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/content/content-contributions.ts` - For collaborators mapping\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/content/content-resource-resource.ts` - For course‚Üílesson relationships\n\n**Reference Documents**:\n- `reports/COURSEBUILDER_SCHEMA_ANALYSIS.md` - Overall schema mapping guide\n\n## Implementation Details\n\n### Phase 1: Document Sanity Field Inventory\n\nCreate a comprehensive mapping document with these sections:\n\n1. **Lesson Fields Audit**\n   - Core fields: title, slug, description, status, accessLevel\n   - Rails linkage: railsLessonId, eggheadRailsLessonId, eggheadRailsCreatedAt\n   - Video: resources array (videoResource references), thumbnailUrl, iconUrl, codeUrl\n   - Metadata: softwareLibraries, collaborators, repoUrl\n   - Dates: publishedAt, displayedUpdatedAt\n\n2. **Course Fields Audit**\n   - Core fields: title, slug, path, description, summary, byline\n   - Structure: resources array (sections + lessons), related courses\n   - Visual: image, images array, imageIllustrator\n   - Metadata: softwareLibraries, collaborators, durationInMinutes\n   - Rails linkage: railsCourseId, sharedId\n   - Status: productionProcessState, accessLevel, searchIndexingState\n   - Dates: publishedAt, updatedAt\n\n3. **Section Fields Audit**\n   - Core: title, slug\n   - Structure: resources array (lesson references)\n\n4. **VideoResource Fields Audit** (embedded in lessons)\n   - Mux: muxAsset object (playbackId, assetId)\n   - Legacy: mediaUrls (dashUrl, hlsUrl), originalVideoUrl\n   - Transcript: transcript object (text, srt), transcriptUrl, subtitlesUrl\n   - Metadata: filename, duration\n\n5. **Collaborator Fields Audit**\n   - Identity: person reference, role, title, department\n   - Rails linkage: externalId, eggheadInstructorId\n\n### Phase 2: Create ContentResource Field Mapping\n\nFor each Sanity type, map fields to ContentResource structure:\n\n```typescript\nContentResource {\n  id: string                    // Generate new or use railsId mapping\n  type: 'lesson' | 'course' | 'section'\n  createdById: string          // Map from collaborators\n  fields: {\n    // Map ALL Sanity fields here\n    title: string\n    slug: string\n    description: string\n    // ... etc\n    \n    // Sanity-specific fields to preserve\n    sanityId?: string          // Original _id from Sanity\n    railsLessonId?: number     // Preserve Rails linkage\n    railsCourseId?: number\n    \n    // Nested structures\n    muxAsset?: { playbackId, assetId }\n    transcript?: { text, srt }\n    softwareLibraries?: Array\u003c{name, version}\u003e\n  }\n}\n```\n\n### Phase 3: Identify Relationships to ContentResourceResource\n\nMap these Sanity relationships:\n- `course.resources[]` ‚Üí ContentResourceResource (course‚Üísection, course‚Üílesson)\n- `section.resources[]` ‚Üí ContentResourceResource (section‚Üílesson)\n- `lesson.resources[]` ‚Üí Store in fields.videoResources (not separate CR records)\n\n### Phase 4: Identify Contributions Mapping\n\nMap `collaborators[]` to ContentContribution:\n- Extract role from Sanity collaborator.role\n- Map to ContributionType (instructor, illustrator, etc.)\n- Link to User via eggheadInstructorId\n\n## Acceptance Criteria\n\n- [ ] Complete field inventory document created with ALL Sanity fields catalogued\n- [ ] Field mapping matrix: Sanity field ‚Üí ContentResource.fields location\n- [ ] Relationship mapping documented: which arrays become ContentResourceResource\n- [ ] Collaborator‚ÜíContentContribution mapping defined\n- [ ] Edge cases documented (null values, missing fields, legacy data)\n- [ ] Sample ContentResource JSON examples for lesson, course, section\n- [ ] Verification: No Sanity fields lost in mapping (document what's intentionally dropped)\n\n## Dependencies\n\n**Blockers**: None - this is pure research/documentation\n\n**Blocks**: \n- migrate-egghead-mnn.2 (lesson migration script needs this mapping)\n- migrate-egghead-mnn.3 (course migration script needs this mapping)\n\n## Output Artifacts\n\nCreate: `reports/SANITY_CONTENT_MAPPING.md` with:\n1. Complete field inventory tables\n2. ContentResource.fields JSON schemas for each type\n3. Relationship mapping diagrams\n4. Sample data transformations\n5. Edge case documentation","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:02.524059-08:00","updated_at":"2025-12-11T11:04:24.421445-08:00","dependencies":[{"issue_id":"migrate-egghead-mnn.1","depends_on_id":"migrate-egghead-mnn","type":"parent-child","created_at":"2025-12-11T09:53:02.524419-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-mnn.2","title":"Build ContentResource migration script for Sanity lessons","description":"## Context\n\nBuild a migration script that extracts ALL lessons from Sanity and transforms them into Coursebuilder ContentResource records. This is the first actual migration script for Sanity elimination.\n\n**Why**: We have 5,132 lessons in Sanity that must move to Coursebuilder. Each lesson has rich metadata (video, transcript, collaborators, software libraries) that must be preserved.\n\n**Current State**:\n- Sanity client exists at `egghead-next/src/utils/sanity-client.ts`\n- Lesson schema documented in audit (migrate-egghead-mnn.1)\n- Coursebuilder ContentResource schema supports flexible JSON fields\n- 97.5% of videos already on Mux (from download-egghead migration)\n\n## Files to Reference\n\n**Source (Sanity)**:\n- `egghead-next/src/utils/sanity-client.ts` - Sanity query client\n- `egghead-next/studio/schemas/documents/lesson.ts` - Source schema\n- `egghead-next/studio/schemas/documents/videoResource.ts` - Embedded video data\n- Existing Sanity queries for reference (grep for `sanityClient` usage)\n\n**Target (Coursebuilder)**:\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/content/content-resource.ts` - Target schema\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/content/content-contributions.ts` - For collaborators\n- Coursebuilder DB connection patterns (find in course-builder apps)\n\n**Mapping Document**:\n- `reports/SANITY_CONTENT_MAPPING.md` - Created by migrate-egghead-mnn.1\n\n**Reference Implementation**:\n- `download-egghead/` scripts - Similar ETL pattern for lessons/courses\n\n## Implementation Details\n\n### Script Structure\n\nCreate: `investigation/src/sanity-migration/migrate-lessons.ts`\n\n```typescript\nimport { sanityClient } from 'egghead-next/src/utils/sanity-client'\nimport { db } from 'course-builder' // Coursebuilder DB connection\n\nasync function migrateLessons() {\n  // 1. Fetch ALL lessons from Sanity\n  // 2. Transform to ContentResource format\n  // 3. Insert to Coursebuilder DB\n  // 4. Handle collaborators ‚Üí ContentContribution\n}\n```\n\n### Phase 1: Sanity Query\n\nFetch all lessons with expanded references:\n\n```groq\n*[_type == 'lesson'] {\n  _id,\n  _createdAt,\n  _updatedAt,\n  title,\n  slug,\n  railsLessonId,\n  description,\n  repoUrl,\n  status,\n  accessLevel,\n  thumbnailUrl,\n  iconUrl,\n  codeUrl,\n  displayedUpdatedAt,\n  publishedAt,\n  eggheadRailsCreatedAt,\n  eggheadRailsLessonId,\n  \n  resources[]-\u003e {\n    _type,\n    muxAsset,\n    transcript,\n    duration,\n    filename\n  },\n  \n  softwareLibraries,\n  \n  collaborators[]-\u003e {\n    _id,\n    role,\n    title,\n    eggheadInstructorId,\n    person-\u003e {\n      _id,\n      name,\n      email\n    }\n  }\n}\n```\n\n### Phase 2: Transform to ContentResource\n\n```typescript\ninterface LessonContentResource {\n  id: string                    // Use railsLessonId or generate\n  type: 'lesson'\n  createdById: string          // Map from first instructor collaborator\n  fields: {\n    // Core egghead fields\n    title: string\n    slug: { current: string }\n    description?: string\n    repoUrl?: string\n    \n    // Status/access\n    status: 'published' | 'archived' | 'needs-review' | 'approved'\n    accessLevel: 'free' | 'pro'\n    \n    // Visual assets\n    thumbnailUrl?: string\n    iconUrl?: string\n    codeUrl?: string\n    \n    // Dates\n    publishedAt?: string\n    displayedUpdatedAt?: string\n    eggheadRailsCreatedAt?: string\n    \n    // Video resources (EMBEDDED, not separate CR)\n    videoResources?: Array\u003c{\n      muxAsset?: { playbackId: string, assetId: string }\n      transcript?: { text: string, srt: string }\n      duration?: number\n      filename?: string\n    }\u003e\n    \n    // Software dependencies\n    softwareLibraries?: Array\u003c{\n      name: string\n      version?: string\n      // ... other fields from versioned-software-library\n    }\u003e\n    \n    // Sanity provenance\n    sanityId: string           // Original _id\n    railsLessonId?: number     // Rails linkage\n    eggheadRailsLessonId?: number\n  }\n  createdAt: Date              // Use eggheadRailsCreatedAt or _createdAt\n  updatedAt: Date              // Use _updatedAt\n}\n```\n\n### Phase 3: Handle Collaborators\n\nFor each lesson's collaborators array:\n\n```typescript\nasync function migrateCollaborators(\n  lessonId: string,\n  collaborators: SanityCollaborator[]\n) {\n  for (const collab of collaborators) {\n    // 1. Find or create User by eggheadInstructorId or email\n    const user = await findOrCreateUser(collab.person)\n    \n    // 2. Find or create ContributionType for role\n    const contributionType = await findOrCreateContributionType(collab.role)\n    \n    // 3. Create ContentContribution\n    await db.insert(ContentContribution).values({\n      id: generateId(),\n      userId: user.id,\n      contentId: lessonId,\n      contributionTypeId: contributionType.id,\n      active: true\n    })\n  }\n}\n```\n\n### Phase 4: Batch Processing\n\nProcess in batches for memory efficiency:\n\n```typescript\nconst BATCH_SIZE = 100\n\nasync function processBatch(lessons: SanityLesson[]) {\n  const contentResources = lessons.map(transformLesson)\n  \n  // Insert ContentResources\n  await db.insert(ContentResource).values(contentResources)\n  \n  // Insert Collaborators\n  for (const lesson of lessons) {\n    await migrateCollaborators(lesson._id, lesson.collaborators)\n  }\n  \n  // Log progress\n  console.log(`Migrated ${lessons.length} lessons`)\n}\n```\n\n### Phase 5: Validation\n\nAfter migration:\n\n```typescript\nasync function validateMigration() {\n  // 1. Count lessons in Sanity vs Coursebuilder\n  const sanityCount = await sanityClient.fetch(`count(*[_type == 'lesson'])`)\n  const cbCount = await db.select({ count: sql`count(*)` })\n    .from(ContentResource)\n    .where(eq(ContentResource.type, 'lesson'))\n  \n  // 2. Sample random lessons and compare fields\n  // 3. Verify all railsLessonId mappings present\n  // 4. Verify collaborators migrated\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Script successfully queries all lessons from Sanity (5,132 expected)\n- [ ] All lesson fields mapped to ContentResource.fields (per mapping doc)\n- [ ] videoResource data embedded in fields.videoResources (not separate CR records)\n- [ ] softwareLibraries array preserved\n- [ ] Collaborators migrated to ContentContribution table\n- [ ] railsLessonId preserved for cross-referencing\n- [ ] sanityId stored for provenance tracking\n- [ ] Dates preserved (publishedAt, createdAt, updatedAt)\n- [ ] Validation: Sanity lesson count === Coursebuilder lesson count\n- [ ] Validation: Sample 10 random lessons, verify field accuracy\n- [ ] Error handling: Log failures, continue processing\n- [ ] Dry-run mode available (preview transformations without insert)\n- [ ] Script documented with usage instructions\n\n## Dependencies\n\n**Blockers**:\n- migrate-egghead-mnn.1 MUST be complete (need field mapping)\n- Coursebuilder DB connection established (may need to add to investigation/)\n\n**Blocks**:\n- migrate-egghead-mnn.3 (course migration will reference lessons)\n- migrate-egghead-ckn.5 (testing content pages requires migrated data)\n\n## Edge Cases to Handle\n\n1. **Missing collaborators**: Lessons with no collaborators (assign to system user?)\n2. **Missing video resources**: Lessons without video (valid for text lessons)\n3. **Duplicate railsLessonIds**: Should be unique but verify\n4. **Invalid slugs**: Empty or malformed slugs\n5. **Collaborator user not found**: Create stub user or skip contribution?\n6. **Mux asset not found**: Video not yet migrated to Mux\n7. **Null/undefined fields**: Ensure graceful handling\n\n## Output Artifacts\n\n1. Migration script: `investigation/src/sanity-migration/migrate-lessons.ts`\n2. Validation report: Log file with counts, errors, warnings\n3. Documentation: README explaining how to run script\n4. Sample output: JSON examples of transformed records","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:02.557175-08:00","updated_at":"2025-12-11T11:05:01.628122-08:00","dependencies":[{"issue_id":"migrate-egghead-mnn.2","depends_on_id":"migrate-egghead-mnn","type":"parent-child","created_at":"2025-12-11T09:53:02.557499-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-mnn.3","title":"Build ContentResource migration script for Sanity courses","description":"## Context\n\nBuild a migration script that extracts ALL courses (and sections) from Sanity and transforms them into Coursebuilder ContentResource records with proper hierarchical relationships. This completes the Sanity content migration.\n\n**Why**: We have 420 courses in Sanity, each with complex structure (sections, lessons, images, collaborators, related content). Courses are the primary navigation structure users interact with.\n\n**Current State**:\n- Sanity has `course` and `section` document types\n- Courses contain arrays of sections/lessons via `resources[]`\n- Sections contain arrays of lessons via `resources[]`\n- Coursebuilder uses ContentResourceResource join table for hierarchies\n- Lessons already migrated (migrate-egghead-mnn.2)\n\n## Files to Reference\n\n**Source (Sanity)**:\n- `egghead-next/src/utils/sanity-client.ts` - Sanity query client\n- `egghead-next/studio/schemas/documents/course.ts` - Course schema with resources, images, metadata\n- `egghead-next/studio/schemas/documents/section.ts` - Section schema (grouping within courses)\n- `egghead-next/studio/schemas/documents/collaborator.tsx` - Instructors/illustrators\n\n**Target (Coursebuilder)**:\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/content/content-resource.ts` - Target schema\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/content/content-resource-resource.ts` - For course‚Üísection‚Üílesson hierarchy\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/content/content-contributions.ts` - For collaborators\n\n**Mapping Document**:\n- `reports/SANITY_CONTENT_MAPPING.md` - Created by migrate-egghead-mnn.1\n\n**Reference Implementation**:\n- `investigation/src/sanity-migration/migrate-lessons.ts` - Lesson migration pattern (from mnn.2)\n- `download-egghead/populate-courses-sql.mjs` - Similar course ETL\n\n## Implementation Details\n\n### Script Structure\n\nCreate: `investigation/src/sanity-migration/migrate-courses.ts`\n\n```typescript\nimport { sanityClient } from 'egghead-next/src/utils/sanity-client'\nimport { db } from 'course-builder' // Coursebuilder DB connection\n\nasync function migrateCourses() {\n  // 1. Fetch ALL courses from Sanity\n  // 2. Transform to ContentResource format (type='course')\n  // 3. Insert courses to Coursebuilder\n  // 4. For each course, migrate sections\n  // 5. Create ContentResourceResource links (course‚Üísection‚Üílesson)\n  // 6. Handle collaborators ‚Üí ContentContribution\n}\n```\n\n### Phase 1: Sanity Query for Courses\n\nFetch all courses with full nesting:\n\n```groq\n*[_type == 'course'] {\n  _id,\n  _createdAt,\n  _updatedAt,\n  title,\n  slug,\n  path,\n  sharedId,\n  description,\n  summary,\n  byline,\n  publishedAt,\n  updatedAt,\n  image,\n  images,\n  accessLevel,\n  searchIndexingState,\n  railsCourseId,\n  durationInMinutes,\n  productionProcessState,\n  \n  softwareLibraries,\n  \n  resources[]-\u003e {\n    _type,\n    _id,\n    title,\n    slug,\n    \n    // If section, expand its lessons\n    resources[]-\u003e {\n      _id,\n      _type\n    }\n  },\n  \n  collaborators[]-\u003e {\n    _id,\n    role,\n    title,\n    eggheadInstructorId,\n    person-\u003e {\n      _id,\n      name,\n      email\n    }\n  },\n  \n  imageIllustrator-\u003e {\n    _id,\n    person-\u003e { name, email }\n  },\n  \n  related[]-\u003e {\n    _id,\n    _type\n  }\n}\n```\n\n### Phase 2: Transform Courses to ContentResource\n\n```typescript\ninterface CourseContentResource {\n  id: string                    // Use railsCourseId or generate\n  type: 'course'\n  createdById: string          // Map from first instructor\n  fields: {\n    // Core fields\n    title: string\n    slug: { current: string }\n    path?: string              // egghead.io path\n    sharedId: string           // Unique Sanity ID\n    description?: string\n    summary?: string\n    byline?: string\n    \n    // Status/access\n    accessLevel: 'free' | 'pro'\n    searchIndexingState: 'hidden' | 'indexed'\n    productionProcessState: string  // Preserve Sanity state\n    \n    // Visual assets\n    image?: string\n    images?: Array\u003c{ url: string, alt?: string }\u003e\n    \n    // Metadata\n    durationInMinutes?: number\n    softwareLibraries?: Array\u003c{\n      name: string\n      version?: string\n    }\u003e\n    \n    // Dates\n    publishedAt?: string\n    updatedAt?: string\n    \n    // Provenance\n    sanityId: string           // Original _id\n    railsCourseId?: number\n  }\n  createdAt: Date\n  updatedAt: Date\n}\n```\n\n### Phase 3: Transform Sections to ContentResource\n\nSections are ALSO ContentResource records:\n\n```typescript\ninterface SectionContentResource {\n  id: string                    // Generate from sanity _id\n  type: 'section'\n  createdById: string          // Inherit from course creator\n  fields: {\n    title: string\n    slug: { current: string }\n    \n    // Provenance\n    sanityId: string\n  }\n  createdAt: Date\n  updatedAt: Date\n}\n```\n\n### Phase 4: Build ContentResourceResource Hierarchy\n\nThis is the critical part - establishing the course‚Üísection‚Üílesson tree:\n\n```typescript\nasync function buildCourseHierarchy(\n  course: SanityCourse,\n  courseId: string\n) {\n  let position = 0\n  \n  for (const resource of course.resources) {\n    if (resource._type === 'section') {\n      // 1. Create Section ContentResource\n      const section = await createSectionContentResource(resource)\n      \n      // 2. Link course ‚Üí section\n      await db.insert(ContentResourceResource).values({\n        resourceOfId: courseId,    // Parent course\n        resourceId: section.id,    // Child section\n        position: position++,\n        fields: {}\n      })\n      \n      // 3. Link section ‚Üí lessons\n      let lessonPosition = 0\n      for (const lesson of resource.resources) {\n        await db.insert(ContentResourceResource).values({\n          resourceOfId: section.id,      // Parent section\n          resourceId: lesson._id,        // Child lesson (from mnn.2)\n          position: lessonPosition++,\n          fields: {}\n        })\n      }\n    } else if (resource._type === 'lesson') {\n      // Direct course ‚Üí lesson (no section wrapper)\n      await db.insert(ContentResourceResource).values({\n        resourceOfId: courseId,\n        resourceId: resource._id,\n        position: position++,\n        fields: {}\n      })\n    }\n  }\n}\n```\n\n### Phase 5: Handle Course Collaborators\n\nSimilar to lessons, but distinguish role types:\n\n```typescript\nasync function migrateCourseCollaborators(\n  courseId: string,\n  collaborators: SanityCollaborator[],\n  imageIllustrator?: SanityCollaborator\n) {\n  // Instructors/authors\n  for (const collab of collaborators) {\n    await createContentContribution(\n      courseId, \n      collab, \n      collab.role // 'instructor', 'author', etc.\n    )\n  }\n  \n  // Image illustrator (special role)\n  if (imageIllustrator) {\n    await createContentContribution(\n      courseId,\n      imageIllustrator,\n      'illustrator'\n    )\n  }\n}\n```\n\n### Phase 6: Handle Related Courses\n\nStore in fields.related as array of IDs:\n\n```typescript\nfields: {\n  // ... other fields\n  related: course.related.map(r =\u003e r._id)\n}\n```\n\n### Phase 7: Batch Processing with Transaction\n\n```typescript\nconst BATCH_SIZE = 50  // Smaller batch due to nested operations\n\nasync function processCourses(courses: SanityCourse[]) {\n  for (const course of courses) {\n    await db.transaction(async (tx) =\u003e {\n      // 1. Insert course ContentResource\n      const courseId = await insertCourse(tx, course)\n      \n      // 2. Create sections and hierarchy\n      await buildCourseHierarchy(tx, course, courseId)\n      \n      // 3. Migrate collaborators\n      await migrateCourseCollaborators(tx, courseId, course.collaborators, course.imageIllustrator)\n    })\n    \n    console.log(`Migrated: ${course.title}`)\n  }\n}\n```\n\n### Phase 8: Validation\n\n```typescript\nasync function validateCourseMigration() {\n  // 1. Count courses\n  const sanityCount = await sanityClient.fetch(`count(*[_type == 'course'])`)\n  const cbCount = await db.select({ count: sql`count(*)` })\n    .from(ContentResource)\n    .where(eq(ContentResource.type, 'course'))\n  \n  // 2. Count sections\n  const sanitySectionCount = await sanityClient.fetch(`count(*[_type == 'section'])`)\n  const cbSectionCount = await db.select({ count: sql`count(*)` })\n    .from(ContentResource)\n    .where(eq(ContentResource.type, 'section'))\n  \n  // 3. Verify hierarchy integrity\n  // - Every course has correct number of resources\n  // - Every section has correct number of lessons\n  // - All lesson IDs reference existing lessons from mnn.2\n  \n  // 4. Sample random courses and compare structure\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Script successfully queries all courses from Sanity (420 expected)\n- [ ] All course fields mapped to ContentResource.fields (per mapping doc)\n- [ ] Sections created as separate ContentResource records (type='section')\n- [ ] ContentResourceResource links created for course‚Üísection‚Üílesson hierarchy\n- [ ] Position field set correctly to preserve order\n- [ ] Collaborators migrated to ContentContribution (instructors + illustrators)\n- [ ] imageIllustrator handled separately with 'illustrator' role\n- [ ] softwareLibraries array preserved\n- [ ] related courses stored in fields.related\n- [ ] railsCourseId preserved for cross-referencing\n- [ ] sanityId stored for provenance tracking\n- [ ] Validation: Sanity course count === Coursebuilder course count\n- [ ] Validation: Sanity section count === Coursebuilder section count\n- [ ] Validation: Sample 5 random courses, verify hierarchy matches Sanity\n- [ ] Validation: All lesson IDs in hierarchy exist in ContentResource\n- [ ] Error handling: Transaction rollback on failure\n- [ ] Dry-run mode available\n- [ ] Script documented with usage instructions\n\n## Dependencies\n\n**Blockers**:\n- migrate-egghead-mnn.1 MUST be complete (need field mapping)\n- migrate-egghead-mnn.2 MUST be complete (lessons must exist to link to)\n\n**Blocks**:\n- migrate-egghead-ckn.5 (testing course pages requires courses)\n- All UI work depends on content being migrated\n\n## Edge Cases to Handle\n\n1. **Orphaned sections**: Section referenced but not found\n2. **Orphaned lessons**: Lesson ID in course.resources but not in lesson migration\n3. **Circular references**: Course in its own related[] array\n4. **Missing collaborators**: Course with no instructors (assign to system?)\n5. **Duplicate railsCourseIds**: Should be unique\n6. **Invalid hierarchy**: Section containing another section (shouldn't happen)\n7. **Mixed hierarchy**: Course with both direct lessons AND sections\n8. **Empty courses**: No resources[] (valid for draft courses)\n9. **Missing related course**: Reference to deleted/unpublished course\n\n## Output Artifacts\n\n1. Migration script: `investigation/src/sanity-migration/migrate-courses.ts`\n2. Validation report: Detailed logs with:\n   - Course/section counts\n   - Hierarchy verification results\n   - Sample data comparisons\n   - Error log\n3. Documentation: README with:\n   - How to run script\n   - Prerequisites (mnn.2 complete)\n   - Rollback procedure (if needed)\n4. Sample output: JSON examples of transformed course + section records\n5. Hierarchy diagram: Visual representation of ContentResourceResource links","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:02.590149-08:00","updated_at":"2025-12-11T11:05:44.752789-08:00","dependencies":[{"issue_id":"migrate-egghead-mnn.3","depends_on_id":"migrate-egghead-mnn","type":"parent-child","created_at":"2025-12-11T09:53:02.590464-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-mnn.4","title":"Migrate collaborators/instructors from Sanity to User table","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:02.623882-08:00","updated_at":"2025-12-11T09:53:02.623882-08:00","dependencies":[{"issue_id":"migrate-egghead-mnn.4","depends_on_id":"migrate-egghead-mnn","type":"parent-child","created_at":"2025-12-11T09:53:02.62422-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-mnn.5","title":"Remove all Sanity write client usage (100+ references)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:02.657946-08:00","updated_at":"2025-12-11T09:53:02.657946-08:00","dependencies":[{"issue_id":"migrate-egghead-mnn.5","depends_on_id":"migrate-egghead-mnn","type":"parent-child","created_at":"2025-12-11T09:53:02.658288-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-mnn.6","title":"Update Inngest functions to write to ContentResource instead of Sanity","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:02.690762-08:00","updated_at":"2025-12-11T09:53:02.690762-08:00","dependencies":[{"issue_id":"migrate-egghead-mnn.6","depends_on_id":"migrate-egghead-mnn","type":"parent-child","created_at":"2025-12-11T09:53:02.691097-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-mnn.7","title":"Build /gone page for deprecated content (193 missing videos)","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T09:53:02.726939-08:00","updated_at":"2025-12-11T09:53:02.726939-08:00","dependencies":[{"issue_id":"migrate-egghead-mnn.7","depends_on_id":"migrate-egghead-mnn","type":"parent-child","created_at":"2025-12-11T09:53:02.727271-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-mnn.8","title":"Remove Sanity dependencies from package.json","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T09:53:02.760666-08:00","updated_at":"2025-12-11T09:53:02.760666-08:00","dependencies":[{"issue_id":"migrate-egghead-mnn.8","depends_on_id":"migrate-egghead-mnn","type":"parent-child","created_at":"2025-12-11T09:53:02.761004-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-mnn.9","title":"Document Sanity touchpoints before elimination","description":"Before removing ~100 Sanity references, document the major touchpoints and data flows.\n\n**Areas to document:**\n1. Content types in Sanity (lessons, courses, collaborators, software libraries)\n2. How content is fetched (GROQ queries, client setup)\n3. Studio configuration (`egghead-next/studio/`)\n4. Image/asset handling\n5. Any webhooks or real-time subscriptions\n\n**Output:** \n- List of all Sanity schema types\n- Mapping to ContentResource equivalents\n- Migration checklist for each content type\n- Any edge cases or special handling needed\n\n**Note:** 193 missing videos will redirect to /gone page (deprecated content).","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T10:26:51.284333-08:00","updated_at":"2025-12-11T10:26:51.284333-08:00","dependencies":[{"issue_id":"migrate-egghead-mnn.9","depends_on_id":"migrate-egghead-mnn","type":"parent-child","created_at":"2025-12-11T10:26:51.284705-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu","title":"Phase 1A: Content Migration","description":"Migrate content from Rails/Sanity to Coursebuilder ContentResource. Content-first approach (before users/accounts). Captures all learnings from CONTENT_MIGRATION_RESEARCH.md.\n\nData volumes: 5,132 lessons, 420 courses, 627 tags, 134 instructors, 15K+ taggings\nStrategy: Rails (canonical) \u003e Sanity (extended) \u003e CB (target) - 3-way merge\nVideo status: 97.5% already on Mux","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-13T07:41:50.739409-08:00","updated_at":"2025-12-13T07:41:50.739409-08:00"}
{"id":"migrate-egghead-ntu.1","title":"Create ID mapping tables in PlanetScale","description":"Create temporary migration mapping tables in PlanetScale for legacy ID lookups.\n\n**SIMULATION LAYER WORKFLOW:**\n```bash\ncd migration\nbun docker:reset                    # Start Docker stack\n# Develop against Docker MySQL first\nbun scripts/create-mapping-tables.ts --target=docker\nbun test:integration                # Verify tables created\n# Then run against prod\nbun scripts/create-mapping-tables.ts --target=prod\n```\n\n**Tables to create:**\n```sql\nCREATE TABLE _migration_lesson_map (\n  rails_id INT PRIMARY KEY,\n  cb_id VARCHAR(255) NOT NULL,\n  rails_slug VARCHAR(255),\n  INDEX idx_cb_id (cb_id),\n  INDEX idx_slug (rails_slug)\n);\n\nCREATE TABLE _migration_course_map (rails_id, cb_id, rails_slug);\nCREATE TABLE _migration_instructor_map (rails_id, cb_id, rails_slug);\nCREATE TABLE _migration_tag_map (rails_id, cb_id, rails_slug);\n```\n\n**Feathers pattern**: This is a \"seam\" - a place where we can intercept and redirect lookups during migration without changing the main codebase.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-13T07:41:50.772625-08:00","updated_at":"2025-12-13T10:08:12.28144-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.1","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T07:41:50.772901-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu.10","title":"/courses/[slug] route with lesson list","description":"Create course viewing route in Coursebuilder egghead app.\n\n**Route**: `/courses/[slug]` - MUST match legacy URL structure exactly\n\n**Data source**: Coursebuilder only (no Rails, no Sanity, no 3-way merge)\n- Query ContentResource where type='course' AND fields.slug = slug\n- Get lessons via ContentResourceResource (ordered by position)\n- Get instructor via ContentContribution or fields.legacyInstructorId\n\n**Page displays** (basic/ugly OK for now):\n- Course artwork (fields.image, fields.squareCover)\n- Title, description\n- Access badge (FREE/PRO from fields.access)\n- Instructor profile\n- Tags (from ContentResourceTag)\n- Duration (sum of lesson durations)\n- Lesson count\n- Lesson list with:\n  - Lesson number\n  - Title (links to /lessons/[slug])\n  - Duration\n  - Progress indicator (if user logged in)\n\n**Auth**:\n- Course page viewable by all\n- Individual lessons may require entitlement\n\n**Files**:\n- `apps/egghead/src/app/(content)/courses/[slug]/page.tsx`\n- `apps/egghead/src/app/(content)/courses/_components/course-header.tsx`\n- `apps/egghead/src/app/(content)/courses/_components/lesson-list.tsx`\n- `apps/egghead/src/lib/courses.ts` (data fetching)","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T08:19:46.552919-08:00","updated_at":"2025-12-13T08:19:46.552919-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.10","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T08:19:46.553271-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu.11","title":"Mux subtitle/caption strategy","description":"Define and implement subtitle strategy for migrated videos.\n\n**Current state**:\n- Legacy videos have subtitles_url pointing to VTT files (Rails-hosted)\n- Mux can auto-generate captions\n- Some videos may have manually-created captions\n\n**Options**:\n1. **Mux auto-captions** - Enable on all assets, Mux generates VTT\n2. **Migrate existing VTT** - Upload legacy VTT files to Mux as text tracks\n3. **Hybrid** - Use existing where available, auto-generate for rest\n\n**Tasks**:\n- [ ] Audit current subtitle coverage (how many lessons have subtitles_url?)\n- [ ] Decide on strategy\n- [ ] If migrating VTT: script to upload to Mux via API\n- [ ] If auto-captions: enable on Mux assets\n- [ ] Update videoResource.fields to store caption track info\n- [ ] Update video player to load captions from Mux\n\n**Mux caption docs**: https://docs.mux.com/guides/add-captions-and-subtitles\n\n**NOT BLOCKING**: Migration can proceed without subtitles. This is polish.\n\n**Files**:\n- `apps/egghead/src/lib/video-resources.ts`\n- Migration script TBD","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-13T08:19:53.821099-08:00","updated_at":"2025-12-13T08:19:53.821099-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.11","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T08:19:53.821459-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu.12","title":"videoResource type and Mux integration","description":"Ensure videoResource ContentResource type is properly structured for Mux playback.\n\n**Current state**: \n- 391 videoResource records exist in CB\n- SQLite has mux_playback_id for 7,441 videos\n\n**videoResource.fields schema**:\n```typescript\n{\n  muxPlaybackId: string,     // Required for playback\n  muxAssetId: string,        // For API operations\n  duration: number,          // Seconds\n  state: 'ready' | 'processing' | 'errored',\n  transcript?: string,       // If available\n  // Legacy reference\n  legacyLessonId?: number,   // Rails lesson.id this video belongs to\n}\n```\n\n**Tasks**:\n- [ ] Verify existing videoResource records have muxPlaybackId\n- [ ] Create videoResources for migrated lessons that don't have one\n- [ ] Link lessons ‚Üí videoResources via ContentResourceResource\n- [ ] Ensure HLS URL generation works: `https://stream.mux.com/{muxPlaybackId}.m3u8`\n\n**Query to check**:\n```sql\nSELECT COUNT(*) FROM egghead_ContentResource \nWHERE type = 'videoResource' \nAND JSON_EXTRACT(fields, '$.muxPlaybackId') IS NOT NULL;\n```\n\n**Files**:\n- `apps/egghead/src/lib/video-resources.ts`\n- Migration functions in ntu.4","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-13T08:20:00.661242-08:00","updated_at":"2025-12-13T08:20:00.661242-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.12","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T08:20:00.661596-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu.13","title":"POC: Migrate 5 lessons end-to-end","description":"Proof of concept: Migrate 5 lessons from Rails/Sanity ‚Üí Coursebuilder and view them.\n\n**Goal**: See the full structure working before scaling to 5,132 lessons.\n\n**Pick 5 lessons**:\n- 2 with Sanity metadata (extended descriptions, collaborators)\n- 2 Rails-only (no Sanity doc)\n- 1 from a course (to test course‚Üílesson relationship)\n\n**Steps**:\n1. Query Rails for lesson data (title, slug, description, duration, instructor_id, series_id)\n2. Query Sanity for extended metadata (if exists)\n3. Query SQLite for mux_playback_id\n4. Create ContentResource type='lesson' with merged fields\n5. Create/link videoResource with muxPlaybackId\n6. Create ContentResourceResource linking lesson‚Üívideo\n7. View at /lessons/[slug] route\n\n**Verify**:\n- [ ] Slug preserved exactly\n- [ ] Video plays (Mux HLS)\n- [ ] Metadata displays (title, description, duration)\n- [ ] Can identify what came from Rails vs Sanity\n\n**Learn**:\n- What's the actual field mapping?\n- What's missing?\n- What breaks?\n\n**Files**:\n- `investigation/poc-migrate-lessons.ts` - one-off migration script\n- Route files from ntu.9\n\n**After POC**: Update ntu.2-6 beads with learnings before full migration.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-13T08:23:44.092961-08:00","updated_at":"2025-12-13T08:26:22.365487-08:00","closed_at":"2025-12-13T08:26:22.365489-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.13","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T08:23:44.093402-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu.2","title":"Migrate tags (627 records) ‚Üí egghead_Tag","description":"Migrate Rails tags table ‚Üí Coursebuilder Tag table.\n\n**Source**: egghead-rails `tags` table (627 records)\n**Target**: `egghead_Tag` table\n\n**Field mapping**:\n- id ‚Üí generate CUID, store rails_id in _migration_tag_map\n- name ‚Üí name\n- slug ‚Üí fields.slug\n- label ‚Üí fields.label  \n- image_url ‚Üí image\n- description ‚Üí fields.description\n\n**Implementation**: Inngest function `migrate-tags.ts`, batch size 100","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T07:41:50.804313-08:00","updated_at":"2025-12-13T10:25:12.958251-08:00","closed_at":"2025-12-13T10:25:12.958251-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.2","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T07:41:50.804619-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu.3","title":"Migrate courses (420 series) ‚Üí ContentResource type='course'","description":"Migrate Rails series table ‚Üí ContentResource type='course'.\n\n**CRITICAL: PRESERVE SLUGS EXACTLY** - No transformations. Legacy URLs must work.\n\n**Source**: egghead-rails `series` table (420 records)\n**Target**: `egghead_ContentResource` with type='course'\n\n**Field mapping to fields JSON**:\n- id ‚Üí fields.legacyId + _migration_course_map\n- title ‚Üí fields.title\n- slug ‚Üí fields.slug (PRESERVE EXACTLY - this is the URL)\n- description ‚Üí fields.description\n- state ‚Üí fields.state ('published'|'draft'|'retired')\n- access_state ‚Üí fields.access ('free'|'pro')\n- image_url ‚Üí fields.image\n- square_cover_url ‚Üí fields.squareCover\n- instructor_id ‚Üí fields.legacyInstructorId (link via ContentContribution later)\n- created_at ‚Üí createdAt\n\n**Implementation**: Inngest function `migrate-courses.ts`, batch size 50","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T07:41:50.833907-08:00","updated_at":"2025-12-13T10:25:13.743416-08:00","closed_at":"2025-12-13T10:25:13.743416-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.3","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T07:41:50.834234-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu.4","title":"Migrate lessons (5,132) ‚Üí ContentResource type='lesson'","description":"Migrate Rails lessons table ‚Üí ContentResource type='lesson'.\n\n**CRITICAL: PRESERVE SLUGS EXACTLY** - No transformations. Legacy URLs must work.\n\n**Source**: egghead-rails `lessons` table (5,132 records)\n**Target**: `egghead_ContentResource` with type='lesson'\n\n**Field mapping to fields JSON**:\n- id ‚Üí fields.legacyId + _migration_lesson_map\n- title ‚Üí fields.title\n- slug ‚Üí fields.slug (PRESERVE EXACTLY - this is the URL)\n- summary ‚Üí fields.summary\n- description ‚Üí fields.body\n- state ‚Üí fields.state\n- visibility_state ‚Üí fields.visibility\n- free_access ‚Üí fields.free\n- duration ‚Üí fields.duration\n- thumb_url ‚Üí fields.thumbnail\n- series_id ‚Üí fields.legacyCourseId (link via ContentResourceResource later)\n- instructor_id ‚Üí fields.legacyInstructorId (link via ContentContribution later)\n\n**Video linking**: \n- Query `download-egghead/egghead_videos.db` for mux_asset_id, mux_playback_id by lesson_id\n- Create ContentResourceResource linking lesson ‚Üí existing videoResource (or create new)\n- Store muxPlaybackId in videoResource.fields.muxPlaybackId\n\n**Implementation**: Inngest function `migrate-lessons.ts`, batch size 500","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T07:41:50.865093-08:00","updated_at":"2025-12-13T10:25:14.370787-08:00","closed_at":"2025-12-13T10:25:14.370787-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.4","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T07:41:50.86543-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu.5","title":"Create course‚Üílesson relationships (ContentResourceResource)","description":"Create ContentResourceResource records linking courses to lessons.\n\n**Source**: egghead-rails `tracklists` table (ordered join)\n**Target**: `egghead_ContentResourceResource`\n\n**Field mapping**:\n- series_id ‚Üí resourceOfId (lookup via _migration_course_map)\n- lesson_id ‚Üí resourceId (lookup via _migration_lesson_map)\n- position ‚Üí position (preserve ordering)\n\n**Also migrate taggings**:\n- Source: `taggings` table (polymorphic: taggable_type, taggable_id)\n- Target: `egghead_ContentResourceTag`\n- ~15,000+ records\n\n**Implementation**: Inngest function `migrate-relationships.ts`\n**Depends on**: ntu.2 (tags), ntu.3 (courses), ntu.4 (lessons)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-13T07:41:50.896778-08:00","updated_at":"2025-12-13T07:42:10.223864-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.5","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T07:41:50.897093-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu.6","title":"Merge Sanity metadata into ContentResource fields","description":"Extend ContentResource fields with Sanity marketing metadata.\n\n**3-way merge strategy**: Rails (canonical) \u003e Sanity (extended) \u003e defaults\n\n**For courses** (from Sanity `course` documents):\n- features[] ‚Üí fields.features\n- testimonials[] ‚Üí fields.testimonials\n- topics[] ‚Üí fields.topics\n- ppiUrl ‚Üí fields.ppiUrl\n\n**For lessons** (from Sanity `lesson` documents):\n- softwareLibraries[] ‚Üí fields.softwareLibraries\n- prerequisites[] ‚Üí fields.prerequisites\n- repoUrl ‚Üí fields.repoUrl\n\n**Match by slug**: Rails slug = Sanity slug\n\n**Implementation**: Inngest function `merge-sanity-metadata.ts`\n**Depends on**: ntu.3 (courses), ntu.4 (lessons)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-13T07:41:50.927249-08:00","updated_at":"2025-12-13T07:42:13.232125-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.6","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T07:41:50.927552-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu.7","title":"Validation script for content migration","description":"Create validation script to verify migration integrity.\n\n**Count verification**:\n- ContentResource type='lesson' = 5,132\n- ContentResource type='course' = 420\n- Tag count = 627\n\n**Relationship verification**:\n- All courses have lessons linked via ContentResourceResource\n- All lessons have tags linked via ContentResourceTag\n- No orphaned records\n\n**Field verification**:\n- All records have legacyId and legacySlug in fields\n- Mux playback IDs populated where available (97.5%)\n\n**Slug uniqueness check**\n\n**Implementation**: `investigation/validate-content-migration.ts`","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-13T07:41:50.956934-08:00","updated_at":"2025-12-13T07:42:16.512055-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.7","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T07:41:50.957271-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu.8","title":"[HUMAN] Review content migration before users","description":"Joel reviews content migration results before proceeding to user migration.\n\n**Checklist:**\n- [ ] All content counts match Rails source\n- [ ] Video playback works (Mux links correct)\n- [ ] Course‚Üílesson hierarchy intact\n- [ ] Tags properly associated\n- [ ] Sanity metadata merged correctly\n- [ ] Legacy slugs preserved for redirects\n\n**Verification via simulation layer:**\n```bash\ncd migration\nbun docker:reset\nbun test:integration  # Automated checks\n# Manual spot-check in browser\n```\n\n**Gate for**: Phase 1B (Users/Accounts migration)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-13T07:41:50.988234-08:00","updated_at":"2025-12-13T10:08:16.717787-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.8","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T07:41:50.988518-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-ntu.9","title":"/lessons/[slug] route with video player","description":"Create lesson viewing route in Coursebuilder egghead app.\n\n**Route**: `/lessons/[slug]` - MUST match legacy URL structure exactly\n\n**Data source**: Coursebuilder only (no Rails, no Sanity, no 3-way merge)\n- Query ContentResource where type='lesson' AND fields.slug = slug\n- Get linked videoResource via ContentResourceResource\n- Get muxPlaybackId from videoResource.fields\n\n**Video player**:\n- HLS URL: `https://stream.mux.com/{muxPlaybackId}.m3u8`\n- Poster: fields.thumbnail\n- Subtitles: TBD (see ntu.12)\n\n**Page displays** (basic/ugly OK for now):\n- Video player (Mux HLS streaming)\n- Title, description, duration\n- Instructor (from ContentContribution or fields.legacyInstructorId)\n- Tags (from ContentResourceTag)\n- Transcript (if available in fields)\n- Course context sidebar (if lesson belongs to course)\n- Code links (fields.repoUrl, fields.codeUrl)\n\n**Auth**: \n- Free lessons: viewable by all\n- Pro lessons: check entitlement (or show paywall)\n\n**Files**:\n- `apps/egghead/src/app/(content)/lessons/[slug]/page.tsx`\n- `apps/egghead/src/app/(content)/lessons/_components/lesson-player.tsx`\n- `apps/egghead/src/lib/lessons.ts` (data fetching)","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T08:19:42.094247-08:00","updated_at":"2025-12-13T08:19:42.094247-08:00","dependencies":[{"issue_id":"migrate-egghead-ntu.9","depends_on_id":"migrate-egghead-ntu","type":"parent-child","created_at":"2025-12-13T08:19:42.094629-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-0","title":"Phase 0: Minimum Viable Safety","description":"ONE E2E test, Inngest dev server, idempotency columns. Gate: Joel approves control plane.","status":"open","priority":0,"issue_type":"epic","created_at":"2025-12-12T09:23:52.982604-08:00","updated_at":"2025-12-12T09:23:52.982604-08:00"}
{"id":"migrate-egghead-phase-0.1","title":"ONE E2E test working","description":"User signs up ‚Üí gets entitlement ‚Üí can watch video. Proves the happy path.\n\n**NOW POSSIBLE WITH SIMULATION LAYER:**\n\n```bash\ncd migration\nbun docker:reset          # Start Docker stack (6 seconds)\nbun test:integration      # Verify containers healthy\n```\n\n**E2E Test Flow:**\n1. Docker MySQL has `egghead_User`, `egghead_Subscription` tables\n2. Inngest dev server handles webhooks locally\n3. Mux playback IDs available via SQLite cache\n\n**Test against Docker first, then verify against prod.**","status":"in_progress","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:12.32619-08:00","updated_at":"2025-12-13T10:04:51.346965-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-0.1","depends_on_id":"migrate-egghead-phase-0","type":"parent-child","created_at":"2025-12-12T09:24:12.326528-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-0.2","title":"Inngest dev server running","description":"Can test webhook handlers locally. Required for Phase 2 development.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T09:24:17.224244-08:00","updated_at":"2025-12-13T07:52:49.492094-08:00","closed_at":"2025-12-13T07:52:49.492094-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-0.2","depends_on_id":"migrate-egghead-phase-0","type":"parent-child","created_at":"2025-12-12T09:24:17.224587-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-0.3","title":"Add stripe_event_id columns","description":"Add idempotency columns to mutation tables for webhook deduplication.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:24:17.257757-08:00","updated_at":"2025-12-12T09:24:17.257757-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-0.3","depends_on_id":"migrate-egghead-phase-0","type":"parent-child","created_at":"2025-12-12T09:24:17.258106-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-0.4","title":"[HUMAN] Approve control plane","description":"Joel reviews Phase 0 completion and approves proceeding to Phase 1.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:17.291963-08:00","updated_at":"2025-12-12T09:24:17.291963-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-0.4","depends_on_id":"migrate-egghead-phase-0","type":"parent-child","created_at":"2025-12-12T09:24:17.292285-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-1","title":"Phase 1: Data Migration","description":"Migrate all data from Rails PostgreSQL to Coursebuilder PlanetScale: 699K users, 94K orgs, 3,335 subscriptions, 3M progress records, content, gifts, teams.","status":"open","priority":0,"issue_type":"epic","created_at":"2025-12-12T09:24:23.532403-08:00","updated_at":"2025-12-12T09:24:23.532403-08:00"}
{"id":"migrate-egghead-phase-1.1","title":"Users migration (699K)","description":"Migrate 699K users from Rails users table to Coursebuilder User table.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:33.831182-08:00","updated_at":"2025-12-12T09:24:33.831182-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-1.1","depends_on_id":"migrate-egghead-phase-1","type":"parent-child","created_at":"2025-12-12T09:24:33.831525-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-1.2","title":"Organizations migration (94K)","description":"Migrate 94K accounts to Organization + MerchantCustomer tables.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:33.863306-08:00","updated_at":"2025-12-12T09:24:33.863306-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-1.2","depends_on_id":"migrate-egghead-phase-1","type":"parent-child","created_at":"2025-12-12T09:24:33.863646-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-1.3","title":"Subscriptions migration (3,335)","description":"Migrate 3,335 active subscriptions to Subscription + MerchantSubscription + Entitlement.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:33.89614-08:00","updated_at":"2025-12-12T09:24:33.89614-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-1.3","depends_on_id":"migrate-egghead-phase-1","type":"parent-child","created_at":"2025-12-12T09:24:33.896534-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-1.4","title":"Progress migration (3M)","description":"Migrate 3M progress records with batch processing and monitoring.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:33.930871-08:00","updated_at":"2025-12-12T09:24:33.930871-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-1.4","depends_on_id":"migrate-egghead-phase-1","type":"parent-child","created_at":"2025-12-12T09:24:33.931218-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-1.5","title":"Content migration","description":"Migrate 420 courses, 5,132 lessons, 627 tags to ContentResource.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:24:33.964493-08:00","updated_at":"2025-12-12T09:24:33.964493-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-1.5","depends_on_id":"migrate-egghead-phase-1","type":"parent-child","created_at":"2025-12-12T09:24:33.964813-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-1.6","title":"Gifts migration","description":"Migrate gift subscription system (~500 active).","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T09:24:33.998526-08:00","updated_at":"2025-12-12T09:24:33.998526-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-1.6","depends_on_id":"migrate-egghead-phase-1","type":"parent-child","created_at":"2025-12-12T09:24:33.99885-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-1.7","title":"Teams migration (266)","description":"Migrate 266 teams with 1,200+ members.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:24:34.031856-08:00","updated_at":"2025-12-12T09:24:34.031856-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-1.7","depends_on_id":"migrate-egghead-phase-1","type":"parent-child","created_at":"2025-12-12T09:24:34.032213-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-1.8","title":"Validation \u0026 reconciliation","description":"Run reconciliation queries to validate \u003c0.1% discrepancy.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:34.064958-08:00","updated_at":"2025-12-12T09:24:34.064958-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-1.8","depends_on_id":"migrate-egghead-phase-1","type":"parent-child","created_at":"2025-12-12T09:24:34.065257-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-1.9","title":"[HUMAN] Approve migration","description":"Joel reviews migration results and approves proceeding to Phase 2.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:34.097324-08:00","updated_at":"2025-12-12T09:24:34.097324-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-1.9","depends_on_id":"migrate-egghead-phase-1","type":"parent-child","created_at":"2025-12-12T09:24:34.097637-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-2","title":"Phase 2: Webhook Handlers","description":"Implement Inngest handlers for Stripe subscription events. Replace Rails Sidekiq handlers.","status":"open","priority":0,"issue_type":"epic","created_at":"2025-12-12T09:24:38.933101-08:00","updated_at":"2025-12-12T09:24:38.933101-08:00"}
{"id":"migrate-egghead-phase-2.1","title":"subscription.created handler","description":"Implement Inngest handler for customer.subscription.created. Currently STUB.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:47.687632-08:00","updated_at":"2025-12-12T09:24:47.687632-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-2.1","depends_on_id":"migrate-egghead-phase-2","type":"parent-child","created_at":"2025-12-12T09:24:47.688065-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-2.2","title":"subscription.updated handler","description":"Implement Inngest handler for customer.subscription.updated with 5-sec delay. Currently STUB.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:47.722382-08:00","updated_at":"2025-12-12T09:24:47.722382-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-2.2","depends_on_id":"migrate-egghead-phase-2","type":"parent-child","created_at":"2025-12-12T09:24:47.722733-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-2.3","title":"subscription.deleted handler","description":"Create Inngest handler for customer.subscription.deleted. Currently MISSING.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:47.760305-08:00","updated_at":"2025-12-12T09:24:47.760305-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-2.3","depends_on_id":"migrate-egghead-phase-2","type":"parent-child","created_at":"2025-12-12T09:24:47.760648-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-2.4","title":"invoice.payment_succeeded handler","description":"Implement Inngest handler with 1-min delay for invoice finalization.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:24:47.798925-08:00","updated_at":"2025-12-12T09:24:47.798925-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-2.4","depends_on_id":"migrate-egghead-phase-2","type":"parent-child","created_at":"2025-12-12T09:24:47.799263-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-2.5","title":"Handler unit tests","description":"Unit tests for all Inngest subscription handlers.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:24:47.831761-08:00","updated_at":"2025-12-12T09:24:47.831761-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-2.5","depends_on_id":"migrate-egghead-phase-2","type":"parent-child","created_at":"2025-12-12T09:24:47.832097-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-2.6","title":"E2E: Checkout flow","description":"E2E test: Stripe checkout ‚Üí entitlement granted.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:47.874318-08:00","updated_at":"2025-12-12T09:24:47.874318-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-2.6","depends_on_id":"migrate-egghead-phase-2","type":"parent-child","created_at":"2025-12-12T09:24:47.874672-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-2.7","title":"E2E: Cancel flow","description":"E2E test: Subscription cancel ‚Üí access revoked.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:24:47.908215-08:00","updated_at":"2025-12-12T09:24:47.908215-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-2.7","depends_on_id":"migrate-egghead-phase-2","type":"parent-child","created_at":"2025-12-12T09:24:47.908623-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-2.8","title":"[HUMAN] Approve handlers","description":"Joel reviews webhook handlers and approves for shadow mode.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:24:47.941749-08:00","updated_at":"2025-12-12T09:24:47.941749-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-2.8","depends_on_id":"migrate-egghead-phase-2","type":"parent-child","created_at":"2025-12-12T09:24:47.942139-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-3","title":"Phase 3: Cron Jobs","description":"Port essential Sidekiq cron jobs to Inngest. Focus on site-breaking jobs only.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-12T09:24:52.754936-08:00","updated_at":"2025-12-12T09:24:52.754936-08:00"}
{"id":"migrate-egghead-phase-3.1","title":"StripeReconciler (daily)","description":"Daily Stripe reconciliation - catches webhook failures.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:01.862319-08:00","updated_at":"2025-12-12T09:25:01.862319-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-3.1","depends_on_id":"migrate-egghead-phase-3","type":"parent-child","created_at":"2025-12-12T09:25:01.862663-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-3.2","title":"GiftExpirationWorker (daily)","description":"Daily gift expiration - gifts must expire on time.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:25:01.901285-08:00","updated_at":"2025-12-12T09:25:01.901285-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-3.2","depends_on_id":"migrate-egghead-phase-3","type":"parent-child","created_at":"2025-12-12T09:25:01.904742-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-3.3","title":"RefreshSitemap (4h)","description":"4-hour sitemap refresh - SEO critical.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:25:01.939441-08:00","updated_at":"2025-12-12T09:25:01.939441-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-3.3","depends_on_id":"migrate-egghead-phase-3","type":"parent-child","created_at":"2025-12-12T09:25:01.940248-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-3.4","title":"SignInTokenCleaner (1min)","description":"1-minute magic link cleanup - prevents token pile-up.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T09:25:01.976189-08:00","updated_at":"2025-12-12T09:25:01.976189-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-3.4","depends_on_id":"migrate-egghead-phase-3","type":"parent-child","created_at":"2025-12-12T09:25:01.9767-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-3.5","title":"LessonPublishWorker (10min)","description":"10-minute scheduled content publishing.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:25:02.016576-08:00","updated_at":"2025-12-12T09:25:02.016576-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-3.5","depends_on_id":"migrate-egghead-phase-3","type":"parent-child","created_at":"2025-12-12T09:25:02.017058-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-3.6","title":"RenewalReminder (daily)","description":"Daily renewal reminder emails.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:25:02.053758-08:00","updated_at":"2025-12-12T09:25:02.053758-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-3.6","depends_on_id":"migrate-egghead-phase-3","type":"parent-child","created_at":"2025-12-12T09:25:02.054237-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-3.7","title":"Revenue share calculation (monthly)","description":"Monthly instructor revenue share calculation.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T09:25:02.090656-08:00","updated_at":"2025-12-12T09:25:02.090656-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-3.7","depends_on_id":"migrate-egghead-phase-3","type":"parent-child","created_at":"2025-12-12T09:25:02.091096-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-4","title":"Phase 4: External Integrations","description":"Customer.io integration and 17 Rails mailers to Resend.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-12T09:25:07.080764-08:00","updated_at":"2025-12-12T09:25:07.080764-08:00"}
{"id":"migrate-egghead-phase-4.1","title":"Customer.io API client","description":"Build Customer.io API client (track/identify) - MISSING from CB.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:15.859746-08:00","updated_at":"2025-12-12T09:25:15.859746-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-4.1","depends_on_id":"migrate-egghead-phase-4","type":"parent-child","created_at":"2025-12-12T09:25:15.860795-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-4.2","title":"Customer.io subscription events","description":"Inngest handlers for subscription events ‚Üí Customer.io.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:15.897899-08:00","updated_at":"2025-12-12T09:25:15.897899-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-4.2","depends_on_id":"migrate-egghead-phase-4","type":"parent-child","created_at":"2025-12-12T09:25:15.898637-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-4.3","title":"Magic link email (Resend)","description":"Migrate MagicSignInMailer to Resend - PRIMARY auth method.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:15.932844-08:00","updated_at":"2025-12-12T09:25:15.932844-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-4.3","depends_on_id":"migrate-egghead-phase-4","type":"parent-child","created_at":"2025-12-12T09:25:15.933351-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-4.4","title":"Renewal/Welcome emails","description":"Migrate RenewalMailer + WelcomeMailer to Resend.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:25:15.965857-08:00","updated_at":"2025-12-12T09:25:15.965857-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-4.4","depends_on_id":"migrate-egghead-phase-4","type":"parent-child","created_at":"2025-12-12T09:25:15.966386-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-4.5","title":"Transactional mailers (17)","description":"Migrate remaining 17 transactional mailers to Resend.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:25:15.999917-08:00","updated_at":"2025-12-12T09:25:15.999917-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-4.5","depends_on_id":"migrate-egghead-phase-4","type":"parent-child","created_at":"2025-12-12T09:25:16.000391-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-4.6","title":"E2E: Email flow","description":"E2E test: Magic link email flow end-to-end.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:25:16.038984-08:00","updated_at":"2025-12-12T09:25:16.038984-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-4.6","depends_on_id":"migrate-egghead-phase-4","type":"parent-child","created_at":"2025-12-12T09:25:16.039514-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-4.7","title":"[HUMAN] Approve email strategy","description":"Joel verifies Customer.io events + email delivery.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:16.071979-08:00","updated_at":"2025-12-12T09:25:16.071979-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-4.7","depends_on_id":"migrate-egghead-phase-4","type":"parent-child","created_at":"2025-12-12T09:25:16.072471-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-5","title":"Phase 5: UI Components","description":"Build all UI with shadcn/ui: video player (Mux), lesson/course pages, search (Typesense), pricing, subscription management.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-12T09:25:22.459585-08:00","updated_at":"2025-12-12T09:25:22.459585-08:00"}
{"id":"migrate-egghead-phase-5.1","title":"Mux video player","description":"Build Mux player component - NOT porting xstate complexity.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:32.341138-08:00","updated_at":"2025-12-12T09:25:32.341138-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-5.1","depends_on_id":"migrate-egghead-phase-5","type":"parent-child","created_at":"2025-12-12T09:25:32.341935-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-5.2","title":"Lesson view page","description":"Lesson page with player, transcript, navigation.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:32.374504-08:00","updated_at":"2025-12-12T09:25:32.374504-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-5.2","depends_on_id":"migrate-egghead-phase-5","type":"parent-child","created_at":"2025-12-12T09:25:32.374948-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-5.3","title":"Course view page","description":"Course page with lesson list, progress indicators.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:32.406736-08:00","updated_at":"2025-12-12T09:25:32.406736-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-5.3","depends_on_id":"migrate-egghead-phase-5","type":"parent-child","created_at":"2025-12-12T09:25:32.407292-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-5.4","title":"Search UI (Typesense)","description":"Typesense + InstantSearch, /q/[[...all]] route.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:25:32.44379-08:00","updated_at":"2025-12-12T09:25:32.44379-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-5.4","depends_on_id":"migrate-egghead-phase-5","type":"parent-child","created_at":"2025-12-12T09:25:32.444283-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-5.5","title":"Pricing page","description":"Pricing page with Stripe checkout integration.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:25:32.477946-08:00","updated_at":"2025-12-12T09:25:32.477946-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-5.5","depends_on_id":"migrate-egghead-phase-5","type":"parent-child","created_at":"2025-12-12T09:25:32.478396-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-5.6","title":"Subscription management","description":"Subscription management page.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-12T09:25:32.511187-08:00","updated_at":"2025-12-12T09:25:32.511187-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-5.6","depends_on_id":"migrate-egghead-phase-5","type":"parent-child","created_at":"2025-12-12T09:25:32.511978-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-5.7","title":"URL redirects","description":"Configure URL redirects in next.config - SEO critical.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:32.544669-08:00","updated_at":"2025-12-12T09:25:32.544669-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-5.7","depends_on_id":"migrate-egghead-phase-5","type":"parent-child","created_at":"2025-12-12T09:25:32.545156-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-5.8","title":"E2E: Click-test matrix","description":"Full click-test matrix for all critical user flows.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:32.577324-08:00","updated_at":"2025-12-12T09:25:32.577324-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-5.8","depends_on_id":"migrate-egghead-phase-5","type":"parent-child","created_at":"2025-12-12T09:25:32.577767-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-5.9","title":"[HUMAN] Approve UI","description":"Joel reviews UI + full E2E suite must be green.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:32.60888-08:00","updated_at":"2025-12-12T09:25:32.60888-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-5.9","depends_on_id":"migrate-egghead-phase-5","type":"parent-child","created_at":"2025-12-12T09:25:32.609339-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-6","title":"Phase 6: Cutover","description":"Execute cutover: dual-write webhooks, shadow mode (7+ days), flip primary, auth cutover, DNS switch. RAILS IS DEAD.","status":"open","priority":0,"issue_type":"epic","created_at":"2025-12-12T09:25:38.740152-08:00","updated_at":"2025-12-12T09:25:38.740152-08:00"}
{"id":"migrate-egghead-phase-6.1","title":"Deploy dual-write config","description":"Deploy dual-write webhook configuration (Rails primary, CB shadow).","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:48.975658-08:00","updated_at":"2025-12-12T09:25:48.975658-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-6.1","depends_on_id":"migrate-egghead-phase-6","type":"parent-child","created_at":"2025-12-12T09:25:48.975982-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-6.10","title":"Execute DNS cutover","description":"Execute DNS cutover (keep Rails read-only 7 days).","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:49.266484-08:00","updated_at":"2025-12-12T09:25:49.266484-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-6.10","depends_on_id":"migrate-egghead-phase-6","type":"parent-child","created_at":"2025-12-12T09:25:49.266875-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-6.11","title":"[HUMAN] Kill Rails","description":"Joel authorizes killing Rails. RAILS IS DEAD.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:49.298377-08:00","updated_at":"2025-12-12T09:25:49.298377-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-6.11","depends_on_id":"migrate-egghead-phase-6","type":"parent-child","created_at":"2025-12-12T09:25:49.298678-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-6.2","title":"Shadow traffic comparison","description":"Build shadow traffic comparison tool.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:49.008057-08:00","updated_at":"2025-12-12T09:25:49.008057-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-6.2","depends_on_id":"migrate-egghead-phase-6","type":"parent-child","created_at":"2025-12-12T09:25:49.00837-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-6.3","title":"E2E: Shadow mode","description":"Run full E2E suite against shadow mode.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:49.042192-08:00","updated_at":"2025-12-12T09:25:49.042192-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-6.3","depends_on_id":"migrate-egghead-phase-6","type":"parent-child","created_at":"2025-12-12T09:25:49.042501-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-6.4","title":"[HUMAN] Shadow mode review","description":"Joel reviews shadow mode (7+ days, \u003c0.1% divergence).","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:49.076512-08:00","updated_at":"2025-12-12T09:25:49.076512-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-6.4","depends_on_id":"migrate-egghead-phase-6","type":"parent-child","created_at":"2025-12-12T09:25:49.076822-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-6.5","title":"Flip to CB primary","description":"Execute flip to Coursebuilder primary.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:49.108088-08:00","updated_at":"2025-12-12T09:25:49.108088-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-6.5","depends_on_id":"migrate-egghead-phase-6","type":"parent-child","created_at":"2025-12-12T09:25:49.10838-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-6.6","title":"Auth cutover","description":"Auth cutover + password reset campaign.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:49.137929-08:00","updated_at":"2025-12-12T09:25:49.137929-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-6.6","depends_on_id":"migrate-egghead-phase-6","type":"parent-child","created_at":"2025-12-12T09:25:49.138193-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-6.7","title":"[HUMAN] Auth cutover approval","description":"Joel approves auth cutover plan.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:49.169308-08:00","updated_at":"2025-12-12T09:25:49.169308-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-6.7","depends_on_id":"migrate-egghead-phase-6","type":"parent-child","created_at":"2025-12-12T09:25:49.169638-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-6.8","title":"Post-flip E2E","description":"Post-flip full regression suite.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:49.202522-08:00","updated_at":"2025-12-12T09:25:49.202522-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-6.8","depends_on_id":"migrate-egghead-phase-6","type":"parent-child","created_at":"2025-12-12T09:25:49.202835-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-phase-6.9","title":"[HUMAN] DNS cutover","description":"Joel authorizes DNS cutover (24h+ stable).","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-12T09:25:49.234795-08:00","updated_at":"2025-12-12T09:25:49.234795-08:00","dependencies":[{"issue_id":"migrate-egghead-phase-6.9","depends_on_id":"migrate-egghead-phase-6","type":"parent-child","created_at":"2025-12-12T09:25:49.235115-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-pi2","title":"Sanity Content Migration Validation","description":"**CRITICAL GAP**: Migration scripts exist but no validation step to ensure content integrity.\n\n## Problem\n\nSanity content migration (mnn epic) has scripts but no validation:\n- How do we know all content migrated correctly?\n- How do we catch missing fields, broken references?\n- How do we verify rich text/portable text converted properly?\n\n## Validation Requirements\n\n### 1. Count Validation\n\n```typescript\n// scripts/validate-sanity-migration.ts\nasync function validateCounts() {\n  const sanity = createClient({ ... })\n  const db = getDb()\n  \n  const contentTypes = [\n    { sanity: 'lesson', cb: 'ContentResource', filter: \"type = 'lesson'\" },\n    { sanity: 'course', cb: 'ContentResource', filter: \"type = 'course'\" },\n    { sanity: 'instructor', cb: 'User', filter: \"role = 'instructor'\" },\n  ]\n  \n  for (const type of contentTypes) {\n    const sanityCount = await sanity.fetch(`count(*[_type == \"${type.sanity}\"])`)\n    const cbCount = await db.execute(`SELECT COUNT(*) FROM ${type.cb} WHERE ${type.filter}`)\n    \n    if (sanityCount !== cbCount) {\n      console.error(`‚ùå ${type.sanity}: Sanity=${sanityCount}, CB=${cbCount}`)\n    } else {\n      console.log(`‚úÖ ${type.sanity}: ${sanityCount} records`)\n    }\n  }\n}\n```\n\n### 2. Field Completeness\n\n```typescript\nasync function validateFields() {\n  // Check required fields are populated\n  const missingTitles = await db.query.contentResource.findMany({\n    where: and(\n      eq(contentResource.type, 'lesson'),\n      or(isNull(contentResource.title), eq(contentResource.title, ''))\n    )\n  })\n  \n  if (missingTitles.length \u003e 0) {\n    console.error(`‚ùå ${missingTitles.length} lessons missing titles`)\n  }\n  \n  // Check slugs are unique\n  const duplicateSlugs = await db.execute(`\n    SELECT slug, COUNT(*) as count \n    FROM ContentResource \n    WHERE type = 'lesson'\n    GROUP BY slug \n    HAVING count \u003e 1\n  `)\n  \n  if (duplicateSlugs.length \u003e 0) {\n    console.error(`‚ùå ${duplicateSlugs.length} duplicate slugs found`)\n  }\n}\n```\n\n### 3. Reference Integrity\n\n```typescript\nasync function validateReferences() {\n  // Check all lessons have valid instructors\n  const orphanedLessons = await db.execute(`\n    SELECT cr.id, cr.title \n    FROM ContentResource cr\n    LEFT JOIN ContentContribution cc ON cr.id = cc.contentId\n    WHERE cr.type = 'lesson' AND cc.id IS NULL\n  `)\n  \n  if (orphanedLessons.length \u003e 0) {\n    console.error(`‚ùå ${orphanedLessons.length} lessons without instructors`)\n  }\n  \n  // Check all courses have lessons\n  const emptyCourses = await db.execute(`\n    SELECT cr.id, cr.title\n    FROM ContentResource cr\n    WHERE cr.type = 'course'\n    AND NOT EXISTS (\n      SELECT 1 FROM ContentResourceResource crr \n      WHERE crr.resourceOfId = cr.id\n    )\n  `)\n  \n  if (emptyCourses.length \u003e 0) {\n    console.error(`‚ùå ${emptyCourses.length} courses without lessons`)\n  }\n}\n```\n\n### 4. Content Rendering Test\n\n```typescript\nasync function validateRendering() {\n  // Sample 100 lessons and verify they render\n  const sample = await db.query.contentResource.findMany({\n    where: eq(contentResource.type, 'lesson'),\n    limit: 100,\n    orderBy: sql`RAND()`\n  })\n  \n  for (const lesson of sample) {\n    try {\n      // Try to render the body\n      const body = lesson.fields?.body\n      if (body) {\n        // If portable text, try to convert\n        const html = portableTextToHtml(body)\n        if (!html || html.length \u003c 10) {\n          console.error(`‚ùå Lesson ${lesson.id} has empty rendered body`)\n        }\n      }\n    } catch (e) {\n      console.error(`‚ùå Lesson ${lesson.id} failed to render: ${e.message}`)\n    }\n  }\n}\n```\n\n### 5. URL Validation\n\n```typescript\nasync function validateUrls() {\n  // Ensure all legacy URLs have redirects\n  const lessons = await db.query.contentResource.findMany({\n    where: eq(contentResource.type, 'lesson'),\n    columns: { id: true, slug: true, fields: true }\n  })\n  \n  for (const lesson of lessons) {\n    const legacySlug = lesson.fields?.legacySlug\n    if (legacySlug \u0026\u0026 legacySlug !== lesson.slug) {\n      // Check redirect exists\n      const redirect = await checkRedirectExists(`/lessons/${legacySlug}`)\n      if (!redirect) {\n        console.error(`‚ùå Missing redirect for legacy slug: ${legacySlug}`)\n      }\n    }\n  }\n}\n```\n\n## Validation Report\n\n```typescript\nasync function generateValidationReport() {\n  const report = {\n    timestamp: new Date().toISOString(),\n    counts: await validateCounts(),\n    fields: await validateFields(),\n    references: await validateReferences(),\n    rendering: await validateRendering(),\n    urls: await validateUrls(),\n  }\n  \n  const passed = Object.values(report).every(r =\u003e r.errors === 0)\n  \n  await fs.writeFile(\n    `reports/sanity-validation-${Date.now()}.json`,\n    JSON.stringify(report, null, 2)\n  )\n  \n  if (!passed) {\n    await sendSlackAlert({\n      channel: '#egghead-migration',\n      text: `‚ö†Ô∏è Sanity migration validation failed. See report.`,\n      color: 'warning',\n    })\n  }\n  \n  return report\n}\n```\n\n## Files to Create\n- `scripts/validate-sanity-migration.ts`\n- `apps/egghead/src/lib/migration/sanity-validators.ts`\n- Add validation step to mnn.3 (course migration)\n\n## Acceptance Criteria\n- [ ] Count validation passes (Sanity count = CB count)\n- [ ] No missing required fields (title, slug, type)\n- [ ] No duplicate slugs\n- [ ] All lessons have instructors\n- [ ] All courses have lessons\n- [ ] Sample rendering test passes (100 lessons)\n- [ ] All legacy URLs have redirects\n- [ ] Validation report generated and stored","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T12:04:46.154736-08:00","updated_at":"2025-12-11T12:04:46.154736-08:00"}
{"id":"migrate-egghead-qk0","title":"Phase 4: External Integrations (Customer.io + Mailers)","description":"Migrate 17 Rails mailers to Coursebuilder email system.\n\n**Target Providers:**\n- **Postmark**: Transactional emails (magic link, receipts, account changes)\n- **Customer.io**: Drip campaigns and automated sequences\n\n**17 Rails Mailers Inventory:**\n\n| Mailer | Target | Priority | Notes |\n|--------|--------|----------|-------|\n| MagicSignInMailer | Postmark | P0 | Auth - critical path |\n| GiftMailer | Customer.io | P0 | Purchase flow |\n| RenewalMailer | Customer.io | P0 | Retention |\n| StripeMailer | Postmark | P0 | Payment confirmations |\n| SellablePurchasesMailer | Postmark | P1 | Purchase receipts |\n| AccountMailer | Postmark | P1 | Account notifications |\n| EmailChangeRequestMailer | Postmark | P1 | Email verification |\n| SequenceMailer | Customer.io | P1 | Onboarding flows |\n| CouponMailer | Postmark | P2 | Promo codes |\n| ReferralMailer | Customer.io | P2 | Growth loops |\n| RoyaltiesMailer | Postmark | P2 | Instructor payouts |\n| AdminMailer | Postmark | P3 | Internal notifications |\n| FeedbackMailer | Postmark | P3 | Support |\n| Instructors::ProgressMailer | Postmark | P3 | Instructor metrics |\n| CommentMailer | SKIP | - | Feature deprecation |\n| CommunityMailer | SKIP | - | Feature deprecation |\n| Devise::Mailer | SKIP | - | No password reset (magic link + OAuth) |\n\n**Key Decisions:**\n- No password reset emails (egghead uses magic link + GitHub OAuth)\n- Customer.io provider needs to be built (separate epic migrate-egghead-ifz)\n- Postmark already available in Coursebuilder\n- React Email for all templates\n- Inngest for email orchestration\n\n**Dependencies:**\n- Blocked by: migrate-egghead-ifz (Customer.io provider)\n- Requires: User/Account migration complete","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:29:31.449988-08:00","updated_at":"2025-12-12T09:25:57.227126-08:00","closed_at":"2025-12-12T09:25:57.227126-08:00"}
{"id":"migrate-egghead-qk0.1","title":"Build Customer.io API client (track/identify) - MISSING from CB","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:31.484601-08:00","updated_at":"2025-12-11T09:29:31.484601-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.1","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T09:29:31.484935-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qk0.10","title":"Create Email Templates (React Email)","description":"**Objective:** Build React Email templates for all P0/P1 Postmark transactional emails.\n\n**Templates to Build:**\n1. **P0 Templates:**\n   - `MagicSignInEmail.tsx` - Magic link authentication\n   - `StripeReceiptEmail.tsx` - Purchase confirmation\n   - `StripeRefundEmail.tsx` - Refund notification\n   - `StripeInvoiceEmail.tsx` - Invoice/receipt\n\n2. **P1 Templates:**\n   - `SellablePurchaseEmail.tsx` - Course purchase receipt\n   - `AccountUpdateEmail.tsx` - Account change notifications\n   - `EmailChangeRequestEmail.tsx` - Email verification\n\n**Requirements:**\n- Use `@react-email/components` primitives\n- Responsive design (mobile + desktop)\n- Brand consistency with egghead.io design system\n- Include unsubscribe links (where applicable)\n- Proper text fallbacks for all templates\n- Preview mode support for testing\n\n**File Structure:**\n```\ncourse-builder/packages/email-templates/emails/egghead/\n  magic-sign-in.tsx\n  stripe-receipt.tsx\n  stripe-refund.tsx\n  stripe-invoice.tsx\n  sellable-purchase.tsx\n  account-update.tsx\n  email-change-request.tsx\n```\n\n**Acceptance Criteria:**\n- [ ] All P0 templates implemented and rendering\n- [ ] All P1 templates implemented and rendering\n- [ ] Templates tested in React Email preview server\n- [ ] Mobile + desktop responsive verified\n- [ ] Text fallbacks generated correctly\n- [ ] Unsubscribe links included (where needed)\n- [ ] TypeScript types for template props defined\n- [ ] Templates match egghead.io brand guidelines\n\n**Dependencies:**\n- Requires: migrate-egghead-qk0.1 (Mailer audit - for content reference)\n\n**Estimated Effort:** 12 hours","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T11:22:16.364823-08:00","updated_at":"2025-12-11T11:22:16.364823-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.10","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T11:22:16.365209-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qk0.11","title":"Implement Inngest Email Functions","description":"**Objective:** Create Inngest functions to trigger all P0/P1 emails via Postmark and Customer.io.\n\n**Functions to Build:**\n\n1. **Postmark Functions (P0):**\n   - `send-magic-sign-in-email` - Triggered by auth flow\n   - `send-stripe-receipt-email` - Triggered by successful purchase\n   - `send-stripe-refund-email` - Triggered by refund webhook\n   - `send-stripe-invoice-email` - Triggered by invoice finalized\n\n2. **Postmark Functions (P1):**\n   - `send-sellable-purchase-email` - Triggered by course purchase\n   - `send-account-update-email` - Triggered by account changes\n   - `send-email-change-request` - Triggered by email change flow\n\n3. **Customer.io Functions (P0/P1):**\n   - `track-gift-received-event` - Track gift events\n   - `track-renewal-reminder-event` - Track renewal triggers\n   - `track-sequence-event` - Track onboarding sequence steps\n\n**Implementation Details:**\n- Use Inngest's `inngest.send()` for email dispatch\n- Postmark: Use existing CB Postmark provider\n- Customer.io: Use new provider from migrate-egghead-ifz\n- Include retry logic (3 attempts, exponential backoff)\n- Log all email sends to DB for audit trail\n- Handle template rendering errors gracefully\n\n**File Structure:**\n```\ncourse-builder/apps/egghead/src/inngest/functions/email/\n  postmark/\n    magic-sign-in.ts\n    stripe-receipts.ts\n    account-updates.ts\n  customerio/\n    gift-events.ts\n    renewal-events.ts\n    sequence-events.ts\n```\n\n**Acceptance Criteria:**\n- [ ] All P0 Postmark functions implemented\n- [ ] All P1 Postmark functions implemented\n- [ ] All P0/P1 Customer.io event tracking functions implemented\n- [ ] Retry logic tested (success + failure scenarios)\n- [ ] Email sends logged to DB with status\n- [ ] Error handling includes alerting (Sentry/logging)\n- [ ] TypeScript types for all function payloads\n- [ ] Inngest functions registered in `inngest/client.ts`\n\n**Dependencies:**\n- Requires: migrate-egghead-qk0.3 (Templates built)\n- Requires: migrate-egghead-ifz (Customer.io provider)\n\n**Estimated Effort:** 10 hours","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T11:22:26.992261-08:00","updated_at":"2025-12-11T11:22:26.992261-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.11","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T11:22:26.992613-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qk0.12","title":"Test Email Delivery","description":"**Objective:** Verify all P0/P1 email flows work correctly in staging environment.\n\n**Test Scenarios:**\n\n1. **Magic Sign In (P0):**\n   - User requests magic link\n   - Email delivers within 30 seconds\n   - Link works and authenticates user\n   - Link expires after 15 minutes\n\n2. **Stripe Receipts (P0):**\n   - Purchase triggers receipt email\n   - Receipt contains correct purchase details\n   - Links to invoice/download work\n   - Refund email triggers on refund\n\n3. **Sellable Purchase (P1):**\n   - Course purchase triggers email\n   - Email contains course access link\n   - Instructor info displayed correctly\n\n4. **Account Updates (P1):**\n   - Email change triggers verification\n   - Verification link works\n   - Account update notifications send\n\n5. **Customer.io Events (P0/P1):**\n   - Gift events tracked correctly\n   - Renewal reminders trigger on schedule\n   - Sequence steps fire in correct order\n\n**Testing Checklist:**\n- [ ] All emails render correctly (HTML + text)\n- [ ] Mobile + desktop rendering verified\n- [ ] All links in emails work (no 404s)\n- [ ] Unsubscribe links functional\n- [ ] Email delivery time \u003c 60 seconds\n- [ ] Spam score checked (use mail-tester.com)\n- [ ] Customer.io events appear in dashboard\n- [ ] Error cases handled gracefully (invalid email, etc.)\n\n**Test Environment:**\n- Staging Postmark account\n- Staging Customer.io workspace\n- Test users with known emails\n- Use Inngest dev server for function inspection\n\n**Documentation:**\n- Create test plan document: `reports/EMAIL-TEST-RESULTS.md`\n- Screenshot each email template\n- Document any bugs found + resolutions\n\n**Files:**\n- Tests: `course-builder/apps/egghead/e2e/email/`\n- Report: `reports/EMAIL-TEST-RESULTS.md`\n\n**Acceptance Criteria:**\n- [ ] All P0 emails tested and verified working\n- [ ] All P1 emails tested and verified working\n- [ ] Test results documented with screenshots\n- [ ] No critical bugs blocking launch\n- [ ] Spam scores acceptable (\u003e 8/10)\n- [ ] Customer.io events verified in dashboard\n- [ ] Test plan includes rollback procedure\n\n**Dependencies:**\n- Requires: migrate-egghead-qk0.4 (Inngest functions implemented)\n\n**Estimated Effort:** 8 hours","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T11:22:39.640995-08:00","updated_at":"2025-12-11T11:22:39.640995-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.12","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T11:22:39.6414-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qk0.13","title":"Handle Unsubscribe/Preferences","description":"**Objective:** Implement email preference management and unsubscribe handling for both Postmark and Customer.io.\n\n**Requirements:**\n\n1. **Unsubscribe Handling:**\n   - Postmark: Handle webhook for unsubscribe events\n   - Customer.io: Sync suppression lists bidirectionally\n   - Store unsubscribe status in Coursebuilder DB\n   - Respect existing Rails unsubscribe records (migrate status)\n\n2. **Suppression Lists:**\n   - Customer.io: Create suppression segments\n   - Postmark: Use suppression API for bounces/spam complaints\n   - Sync suppression status across providers\n   - Handle re-subscription requests\n\n3. **Preference Center (Optional - Can Defer):**\n   - Simple page at `/preferences/email`\n   - Allow users to opt-out of specific email categories:\n     - Marketing emails (Customer.io campaigns)\n     - Product updates\n     - Course recommendations\n   - Cannot unsubscribe from transactional (receipts, magic links)\n\n4. **Rails Migration:**\n   - Audit existing unsubscribe records in Rails DB\n   - Migrate unsubscribe status to Coursebuilder\n   - Preserve opt-out preferences from legacy system\n\n**Implementation:**\n\n**Database Schema:**\n```sql\n-- Add to User/Account schema\nemail_preferences {\n  marketing_emails: boolean (default true)\n  product_updates: boolean (default true)\n  course_recommendations: boolean (default true)\n  updated_at: timestamp\n}\n```\n\n**Inngest Functions:**\n```\ncourse-builder/apps/egghead/src/inngest/functions/email/\n  handle-postmark-unsubscribe.ts\n  sync-customerio-suppression.ts\n```\n\n**UI:**\n```\ncourse-builder/apps/egghead/src/app/preferences/\n  email/\n    page.tsx (preference center)\n    unsubscribe/\n      page.tsx (one-click unsubscribe)\n```\n\n**Acceptance Criteria:**\n- [ ] Postmark unsubscribe webhook handler implemented\n- [ ] Customer.io suppression sync working bidirectionally\n- [ ] Unsubscribe status stored in Coursebuilder DB\n- [ ] Legacy Rails unsubscribe records migrated\n- [ ] One-click unsubscribe links work in all emails\n- [ ] Suppression lists prevent sends correctly\n- [ ] Re-subscription flow tested\n- [ ] (Optional) Preference center UI implemented\n\n**Compliance Notes:**\n- CAN-SPAM Act: One-click unsubscribe required\n- GDPR: Unsubscribe must honor immediately\n- All marketing emails must include unsubscribe link\n- Transactional emails exempt from unsubscribe\n\n**Dependencies:**\n- Requires: migrate-egghead-qk0.4 (Inngest functions for webhook handling)\n\n**Estimated Effort:** 10 hours (6 hours core, 4 hours for preference center)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T11:22:53.038733-08:00","updated_at":"2025-12-11T11:22:53.038733-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.13","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T11:22:53.039171-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qk0.2","title":"Customer.io Inngest handlers for subscription events","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:31.516808-08:00","updated_at":"2025-12-11T09:29:31.516808-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.2","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T09:29:31.517136-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qk0.3","title":"Migrate MagicSignInMailer to Resend","description":"Migrate MagicSignInMailer from Rails ActionMailer to Resend.\n\n## Context\n\nMagic link sign-in is the PRIMARY auth method for egghead. This MUST work flawlessly.\n\n## Rails Implementation\n\n```ruby\n# app/mailers/magic_sign_in_mailer.rb\nclass MagicSignInMailer \u003c ApplicationMailer\n  def sign_in(user, token)\n    @user = user\n    @token = token\n    @sign_in_url = \"#{ENV['EGGHEAD_URL']}/api/v1/sign_in/#{token}\"\n    \n    mail(\n      to: @user.email,\n      subject: \"Sign in to egghead\"\n    )\n  end\nend\n```\n\n```erb\n\u003c!-- app/views/magic_sign_in_mailer/sign_in.html.erb --\u003e\n\u003cp\u003eHey \u003c%= @user.first_name || 'there' %\u003e,\u003c/p\u003e\n\u003cp\u003eClick the link below to sign in to egghead:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"\u003c%= @sign_in_url %\u003e\"\u003eSign in to egghead\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThis link expires in 10 minutes.\u003c/p\u003e\n\u003cp\u003eIf you didn't request this, you can safely ignore this email.\u003c/p\u003e\n```\n\n## Coursebuilder Implementation\n\n### 1. React Email Template\n```tsx\n// emails/magic-sign-in.tsx\nimport { Html, Head, Body, Container, Text, Button, Link } from '@react-email/components'\n\ninterface MagicSignInEmailProps {\n  firstName?: string\n  signInUrl: string\n  expiresIn: string\n}\n\nexport function MagicSignInEmail({ firstName, signInUrl, expiresIn }: MagicSignInEmailProps) {\n  return (\n    \u003cHtml\u003e\n      \u003cHead /\u003e\n      \u003cBody style={{ fontFamily: 'sans-serif', backgroundColor: '#f4f4f4' }}\u003e\n        \u003cContainer style={{ backgroundColor: '#fff', padding: '40px', borderRadius: '8px' }}\u003e\n          \u003cText style={{ fontSize: '16px' }}\u003e\n            Hey {firstName || 'there'},\n          \u003c/Text\u003e\n          \n          \u003cText style={{ fontSize: '16px' }}\u003e\n            Click the button below to sign in to egghead:\n          \u003c/Text\u003e\n          \n          \u003cButton\n            href={signInUrl}\n            style={{\n              backgroundColor: '#2563eb',\n              color: '#fff',\n              padding: '12px 24px',\n              borderRadius: '6px',\n              textDecoration: 'none',\n              display: 'inline-block',\n            }}\n          \u003e\n            Sign in to egghead\n          \u003c/Button\u003e\n          \n          \u003cText style={{ fontSize: '14px', color: '#666', marginTop: '24px' }}\u003e\n            This link expires in {expiresIn}.\n          \u003c/Text\u003e\n          \n          \u003cText style={{ fontSize: '14px', color: '#666' }}\u003e\n            If you didn't request this, you can safely ignore this email.\n          \u003c/Text\u003e\n          \n          \u003cText style={{ fontSize: '12px', color: '#999', marginTop: '32px' }}\u003e\n            Or copy and paste this URL: \u003cLink href={signInUrl}\u003e{signInUrl}\u003c/Link\u003e\n          \u003c/Text\u003e\n        \u003c/Container\u003e\n      \u003c/Body\u003e\n    \u003c/Html\u003e\n  )\n}\n```\n\n### 2. Send Function\n```typescript\n// lib/email/send-magic-link.ts\nimport { Resend } from 'resend'\nimport { MagicSignInEmail } from '@/emails/magic-sign-in'\n\nconst resend = new Resend(process.env.RESEND_API_KEY)\n\nexport async function sendMagicLinkEmail({\n  email,\n  firstName,\n  token,\n}: {\n  email: string\n  firstName?: string\n  token: string\n}) {\n  const signInUrl = `${process.env.NEXT_PUBLIC_URL}/api/auth/callback/email?token=${token}`\n  \n  const { data, error } = await resend.emails.send({\n    from: 'egghead \u003csignin@egghead.io\u003e',\n    to: email,\n    subject: 'Sign in to egghead',\n    react: MagicSignInEmail({\n      firstName,\n      signInUrl,\n      expiresIn: '10 minutes',\n    }),\n  })\n  \n  if (error) {\n    console.error('Failed to send magic link email:', error)\n    throw new Error('Failed to send email')\n  }\n  \n  return data\n}\n```\n\n### 3. NextAuth Integration\n```typescript\n// lib/auth/config.ts\nimport EmailProvider from 'next-auth/providers/email'\nimport { sendMagicLinkEmail } from '@/lib/email/send-magic-link'\n\nexport const authConfig = {\n  providers: [\n    EmailProvider({\n      server: process.env.EMAIL_SERVER, // Not used with custom sendVerificationRequest\n      from: process.env.EMAIL_FROM,\n      sendVerificationRequest: async ({ identifier: email, url, token }) =\u003e {\n        const user = await db.query.users.findFirst({\n          where: eq(users.email, email)\n        })\n        \n        await sendMagicLinkEmail({\n          email,\n          firstName: user?.name?.split(' ')[0],\n          token,\n        })\n      },\n    }),\n  ],\n}\n```\n\n## Token Handling\n\nRails uses `authentication_token` on the User model. NextAuth uses its own verification token system.\n\n```typescript\n// Coursebuilder already has VerificationToken table\n// NextAuth handles token generation and verification automatically\n```\n\n## Files to Create\n- `apps/egghead/src/emails/magic-sign-in.tsx`\n- `apps/egghead/src/lib/email/send-magic-link.ts`\n- Update `apps/egghead/src/lib/auth/config.ts`\n\n## Testing\n```bash\n# Preview email\npnpm email:dev  # Opens React Email preview\n\n# Send test email\npnpm tsx scripts/test-magic-link.ts test@example.com\n```\n\n## Acceptance Criteria\n- [ ] Email renders correctly in Gmail, Outlook, Apple Mail\n- [ ] Sign-in link works and authenticates user\n- [ ] Token expires after 10 minutes\n- [ ] Rate limiting: max 5 requests per email per hour\n- [ ] Logging: track send success/failure for debugging\n- [ ] Fallback: plain text version for email clients that don't support HTML","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:31.547158-08:00","updated_at":"2025-12-11T12:02:07.753234-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.3","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T09:29:31.547473-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qk0.4","title":"Migrate RenewalMailer + WelcomeMailer to Resend","description":"Migrate RenewalMailer and WelcomeMailer from Rails to Resend.\n\n## Context\n\nThese are critical transactional emails that affect revenue (renewal reminders) and user experience (welcome).\n\n## Rails Mailers\n\n### RenewalMailer\n```ruby\n# app/mailers/renewal_mailer.rb\nclass RenewalMailer \u003c ApplicationMailer\n  def reminder(subscription)\n    @subscription = subscription\n    @user = subscription.account.users.first\n    @renewal_date = subscription.current_period_end\n    @amount = subscription.plan.amount / 100.0\n    \n    mail(\n      to: @user.email,\n      subject: \"Your egghead subscription renews soon\"\n    )\n  end\n  \n  def failed_payment(subscription)\n    @subscription = subscription\n    @user = subscription.account.users.first\n    \n    mail(\n      to: @user.email,\n      subject: \"Action required: Update your payment method\"\n    )\n  end\nend\n```\n\n### WelcomeMailer\n```ruby\n# app/mailers/welcome_mailer.rb\nclass WelcomeMailer \u003c ApplicationMailer\n  def welcome(user)\n    @user = user\n    \n    mail(\n      to: @user.email,\n      subject: \"Welcome to egghead!\"\n    )\n  end\n  \n  def pro_welcome(user, subscription)\n    @user = user\n    @subscription = subscription\n    \n    mail(\n      to: @user.email,\n      subject: \"Welcome to egghead Pro!\"\n    )\n  end\nend\n```\n\n## Coursebuilder Implementation\n\n### 1. Renewal Reminder Email\n```tsx\n// emails/renewal-reminder.tsx\nexport function RenewalReminderEmail({\n  firstName,\n  renewalDate,\n  amount,\n  planName,\n  manageUrl,\n}: Props) {\n  return (\n    \u003cHtml\u003e\n      \u003cBody\u003e\n        \u003cContainer\u003e\n          \u003cText\u003eHey {firstName},\u003c/Text\u003e\n          \n          \u003cText\u003e\n            Your egghead {planName} subscription will automatically renew on{' '}\n            \u003cstrong\u003e{renewalDate}\u003c/strong\u003e for \u003cstrong\u003e${amount}\u003c/strong\u003e.\n          \u003c/Text\u003e\n          \n          \u003cText\u003e\n            No action needed if you want to continue learning. Your access \n            will continue uninterrupted.\n          \u003c/Text\u003e\n          \n          \u003cButton href={manageUrl}\u003e\n            Manage Subscription\n          \u003c/Button\u003e\n          \n          \u003cText style={{ fontSize: '14px', color: '#666' }}\u003e\n            Questions? Reply to this email or contact support@egghead.io\n          \u003c/Text\u003e\n        \u003c/Container\u003e\n      \u003c/Body\u003e\n    \u003c/Html\u003e\n  )\n}\n```\n\n### 2. Failed Payment Email\n```tsx\n// emails/failed-payment.tsx\nexport function FailedPaymentEmail({\n  firstName,\n  updatePaymentUrl,\n  gracePeriodEnd,\n}: Props) {\n  return (\n    \u003cHtml\u003e\n      \u003cBody\u003e\n        \u003cContainer\u003e\n          \u003cText\u003eHey {firstName},\u003c/Text\u003e\n          \n          \u003cText\u003e\n            We couldn't process your payment for egghead Pro. Your access \n            will continue until \u003cstrong\u003e{gracePeriodEnd}\u003c/strong\u003e, but we \n            need you to update your payment method to avoid interruption.\n          \u003c/Text\u003e\n          \n          \u003cButton href={updatePaymentUrl} style={{ backgroundColor: '#dc2626' }}\u003e\n            Update Payment Method\n          \u003c/Button\u003e\n          \n          \u003cText style={{ fontSize: '14px', color: '#666' }}\u003e\n            If you've already updated your payment info, you can ignore this email.\n          \u003c/Text\u003e\n        \u003c/Container\u003e\n      \u003c/Body\u003e\n    \u003c/Html\u003e\n  )\n}\n```\n\n### 3. Welcome Email\n```tsx\n// emails/welcome.tsx\nexport function WelcomeEmail({ firstName }: Props) {\n  return (\n    \u003cHtml\u003e\n      \u003cBody\u003e\n        \u003cContainer\u003e\n          \u003cHeading\u003eWelcome to egghead!\u003c/Heading\u003e\n          \n          \u003cText\u003eHey {firstName},\u003c/Text\u003e\n          \n          \u003cText\u003e\n            Thanks for joining egghead. Here's how to get started:\n          \u003c/Text\u003e\n          \n          \u003cul\u003e\n            \u003cli\u003eBrowse our \u003cLink href=\"https://egghead.io/q\"\u003ecourse catalog\u003c/Link\u003e\u003c/li\u003e\n            \u003cli\u003eCheck out \u003cLink href=\"https://egghead.io/q/topic:react\"\u003eReact courses\u003c/Link\u003e\u003c/li\u003e\n            \u003cli\u003eSet up your \u003cLink href=\"https://egghead.io/user/profile\"\u003eprofile\u003c/Link\u003e\u003c/li\u003e\n          \u003c/ul\u003e\n          \n          \u003cButton href=\"https://egghead.io/q\"\u003e\n            Start Learning\n          \u003c/Button\u003e\n        \u003c/Container\u003e\n      \u003c/Body\u003e\n    \u003c/Html\u003e\n  )\n}\n```\n\n### 4. Pro Welcome Email\n```tsx\n// emails/pro-welcome.tsx\nexport function ProWelcomeEmail({ firstName, planName }: Props) {\n  return (\n    \u003cHtml\u003e\n      \u003cBody\u003e\n        \u003cContainer\u003e\n          \u003cHeading\u003eWelcome to egghead Pro!\u003c/Heading\u003e\n          \n          \u003cText\u003eHey {firstName},\u003c/Text\u003e\n          \n          \u003cText\u003e\n            You now have unlimited access to every course on egghead. \n            Here's what's included with your {planName} membership:\n          \u003c/Text\u003e\n          \n          \u003cul\u003e\n            \u003cli\u003e420+ courses from industry experts\u003c/li\u003e\n            \u003cli\u003e5,000+ video lessons\u003c/li\u003e\n            \u003cli\u003eDownloadable resources and transcripts\u003c/li\u003e\n            \u003cli\u003eTrack your progress across devices\u003c/li\u003e\n          \u003c/ul\u003e\n          \n          \u003cButton href=\"https://egghead.io/q\"\u003e\n            Start Learning Now\n          \u003c/Button\u003e\n          \n          \u003cText style={{ fontSize: '14px', color: '#666' }}\u003e\n            Pro tip: Use the search to find exactly what you need, or browse \n            by topic to discover new skills.\n          \u003c/Text\u003e\n        \u003c/Container\u003e\n      \u003c/Body\u003e\n    \u003c/Html\u003e\n  )\n}\n```\n\n### 5. Inngest Triggers\n\n```typescript\n// inngest/functions/email/subscription-emails.ts\nexport const sendRenewalReminder = inngest.createFunction(\n  { id: 'send-renewal-reminder' },\n  { event: 'subscription/renewal.upcoming' },\n  async ({ event, step }) =\u003e {\n    const { subscriptionId } = event.data\n    \n    const subscription = await step.run('get-subscription', () =\u003e\n      getSubscriptionWithUser(subscriptionId)\n    )\n    \n    await step.run('send-email', () =\u003e\n      resend.emails.send({\n        from: 'egghead \u003cbilling@egghead.io\u003e',\n        to: subscription.user.email,\n        subject: 'Your egghead subscription renews soon',\n        react: RenewalReminderEmail({\n          firstName: subscription.user.name?.split(' ')[0],\n          renewalDate: format(subscription.currentPeriodEnd, 'MMMM d, yyyy'),\n          amount: (subscription.price / 100).toFixed(2),\n          planName: subscription.planName,\n          manageUrl: `${process.env.NEXT_PUBLIC_URL}/user/subscription`,\n        }),\n      })\n    )\n  }\n)\n\nexport const sendProWelcome = inngest.createFunction(\n  { id: 'send-pro-welcome' },\n  { event: 'subscription/created' },\n  async ({ event, step }) =\u003e {\n    const { userId, planName } = event.data\n    \n    const user = await step.run('get-user', () =\u003e getUserById(userId))\n    \n    await step.run('send-email', () =\u003e\n      resend.emails.send({\n        from: 'egghead \u003chello@egghead.io\u003e',\n        to: user.email,\n        subject: 'Welcome to egghead Pro!',\n        react: ProWelcomeEmail({\n          firstName: user.name?.split(' ')[0],\n          planName,\n        }),\n      })\n    )\n  }\n)\n```\n\n## Files to Create\n- `apps/egghead/src/emails/renewal-reminder.tsx`\n- `apps/egghead/src/emails/failed-payment.tsx`\n- `apps/egghead/src/emails/welcome.tsx`\n- `apps/egghead/src/emails/pro-welcome.tsx`\n- `apps/egghead/src/inngest/functions/email/subscription-emails.ts`\n\n## Acceptance Criteria\n- [ ] All 4 email templates render correctly\n- [ ] Renewal reminder sent 7 days before renewal\n- [ ] Failed payment email sent immediately on payment failure\n- [ ] Welcome email sent on signup\n- [ ] Pro welcome email sent on subscription creation\n- [ ] Unsubscribe link in all marketing emails\n- [ ] Track open/click rates via Resend dashboard","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:29:31.576866-08:00","updated_at":"2025-12-11T12:02:32.675875-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.4","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T09:29:31.577181-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qk0.5","title":"Migrate remaining transactional mailers (17 total)","description":"Migrate all remaining Rails mailers (17 total) to Resend.\n\n## Context\n\nRails has 17 mailers. We've covered MagicSignIn, Renewal, and Welcome. This task covers the rest.\n\n## Rails Mailer Inventory\n\n```bash\n# From egghead-rails/app/mailers/\n‚îú‚îÄ‚îÄ application_mailer.rb          # Base class\n‚îú‚îÄ‚îÄ broadcast_mailer.rb            # Marketing broadcasts ‚Üí Customer.io (not Resend)\n‚îú‚îÄ‚îÄ gift_mailer.rb                 # Gift subscription emails\n‚îú‚îÄ‚îÄ instructor_mailer.rb           # Instructor notifications\n‚îú‚îÄ‚îÄ magic_sign_in_mailer.rb        # ‚úÖ Done (qk0.3)\n‚îú‚îÄ‚îÄ notification_mailer.rb         # Generic notifications\n‚îú‚îÄ‚îÄ renewal_mailer.rb              # ‚úÖ Done (qk0.4)\n‚îú‚îÄ‚îÄ support_mailer.rb              # Support ticket notifications\n‚îú‚îÄ‚îÄ team_mailer.rb                 # Team invite emails\n‚îú‚îÄ‚îÄ user_mailer.rb                 # User-related emails\n‚îî‚îÄ‚îÄ welcome_mailer.rb              # ‚úÖ Done (qk0.4)\n```\n\n## Priority Tiers\n\n### Tier 1: Critical (must have for launch)\n1. **GiftMailer** - Gift purchase, redemption, expiration\n2. **TeamMailer** - Team invites (if keeping team features)\n3. **UserMailer** - Password reset, email change confirmation\n\n### Tier 2: Important (should have)\n4. **InstructorMailer** - Payout notifications, content published\n5. **NotificationMailer** - Generic system notifications\n6. **SupportMailer** - Ticket created, resolved\n\n### Tier 3: Defer (can wait)\n7. **BroadcastMailer** - Move to Customer.io entirely\n\n## Implementation\n\n### GiftMailer\n```tsx\n// emails/gift-purchased.tsx\nexport function GiftPurchasedEmail({ \n  buyerName, \n  recipientEmail, \n  giftCode,\n  expiresAt,\n  personalMessage,\n}: Props) {\n  return (\n    \u003cHtml\u003e\n      \u003cBody\u003e\n        \u003cContainer\u003e\n          \u003cHeading\u003eYour egghead gift is ready!\u003c/Heading\u003e\n          \u003cText\u003e\n            Thanks for purchasing an egghead Pro gift subscription.\n          \u003c/Text\u003e\n          \u003cText\u003e\n            \u003cstrong\u003eGift Code:\u003c/strong\u003e {giftCode}\n          \u003c/Text\u003e\n          \u003cText\u003e\n            \u003cstrong\u003eRecipient:\u003c/strong\u003e {recipientEmail}\n          \u003c/Text\u003e\n          {personalMessage \u0026\u0026 (\n            \u003cText\u003e\u003cstrong\u003eYour message:\u003c/strong\u003e {personalMessage}\u003c/Text\u003e\n          )}\n          \u003cText\u003e\n            The recipient will receive an email with instructions to redeem.\n            This gift expires on {expiresAt}.\n          \u003c/Text\u003e\n        \u003c/Container\u003e\n      \u003c/Body\u003e\n    \u003c/Html\u003e\n  )\n}\n\n// emails/gift-received.tsx\nexport function GiftReceivedEmail({\n  recipientName,\n  senderName,\n  giftCode,\n  redeemUrl,\n  personalMessage,\n}: Props) {\n  return (\n    \u003cHtml\u003e\n      \u003cBody\u003e\n        \u003cContainer\u003e\n          \u003cHeading\u003eYou've received an egghead Pro gift!\u003c/Heading\u003e\n          \u003cText\u003e\n            {senderName} has gifted you a subscription to egghead Pro.\n          \u003c/Text\u003e\n          {personalMessage \u0026\u0026 (\n            \u003cText style={{ fontStyle: 'italic' }}\u003e\"{personalMessage}\"\u003c/Text\u003e\n          )}\n          \u003cButton href={redeemUrl}\u003e\n            Redeem Your Gift\n          \u003c/Button\u003e\n          \u003cText style={{ fontSize: '14px', color: '#666' }}\u003e\n            Or use code: \u003cstrong\u003e{giftCode}\u003c/strong\u003e\n          \u003c/Text\u003e\n        \u003c/Container\u003e\n      \u003c/Body\u003e\n    \u003c/Html\u003e\n  )\n}\n```\n\n### TeamMailer\n```tsx\n// emails/team-invite.tsx\nexport function TeamInviteEmail({\n  inviterName,\n  teamName,\n  inviteUrl,\n}: Props) {\n  return (\n    \u003cHtml\u003e\n      \u003cBody\u003e\n        \u003cContainer\u003e\n          \u003cHeading\u003eYou're invited to join {teamName} on egghead\u003c/Heading\u003e\n          \u003cText\u003e\n            {inviterName} has invited you to join their team on egghead.\n          \u003c/Text\u003e\n          \u003cText\u003e\n            As a team member, you'll have full access to egghead Pro.\n          \u003c/Text\u003e\n          \u003cButton href={inviteUrl}\u003e\n            Accept Invitation\n          \u003c/Button\u003e\n        \u003c/Container\u003e\n      \u003c/Body\u003e\n    \u003c/Html\u003e\n  )\n}\n```\n\n### UserMailer\n```tsx\n// emails/password-reset.tsx (NextAuth handles this, but custom template)\nexport function PasswordResetEmail({\n  firstName,\n  resetUrl,\n}: Props) {\n  return (\n    \u003cHtml\u003e\n      \u003cBody\u003e\n        \u003cContainer\u003e\n          \u003cHeading\u003eReset your password\u003c/Heading\u003e\n          \u003cText\u003eHey {firstName},\u003c/Text\u003e\n          \u003cText\u003e\n            We received a request to reset your egghead password.\n          \u003c/Text\u003e\n          \u003cButton href={resetUrl}\u003e\n            Reset Password\n          \u003c/Button\u003e\n          \u003cText style={{ fontSize: '14px', color: '#666' }}\u003e\n            This link expires in 1 hour. If you didn't request this, \n            you can safely ignore this email.\n          \u003c/Text\u003e\n        \u003c/Container\u003e\n      \u003c/Body\u003e\n    \u003c/Html\u003e\n  )\n}\n\n// emails/email-change.tsx\nexport function EmailChangeEmail({\n  firstName,\n  newEmail,\n  confirmUrl,\n}: Props) {\n  return (\n    \u003cHtml\u003e\n      \u003cBody\u003e\n        \u003cContainer\u003e\n          \u003cHeading\u003eConfirm your new email\u003c/Heading\u003e\n          \u003cText\u003eHey {firstName},\u003c/Text\u003e\n          \u003cText\u003e\n            You requested to change your email to \u003cstrong\u003e{newEmail}\u003c/strong\u003e.\n          \u003c/Text\u003e\n          \u003cButton href={confirmUrl}\u003e\n            Confirm Email Change\n          \u003c/Button\u003e\n          \u003cText style={{ fontSize: '14px', color: '#666' }}\u003e\n            If you didn't request this, please contact support immediately.\n          \u003c/Text\u003e\n        \u003c/Container\u003e\n      \u003c/Body\u003e\n    \u003c/Html\u003e\n  )\n}\n```\n\n### InstructorMailer\n```tsx\n// emails/instructor-payout.tsx\nexport function InstructorPayoutEmail({\n  instructorName,\n  amount,\n  period,\n  breakdownUrl,\n}: Props) {\n  return (\n    \u003cHtml\u003e\n      \u003cBody\u003e\n        \u003cContainer\u003e\n          \u003cHeading\u003eYour egghead payout is ready\u003c/Heading\u003e\n          \u003cText\u003eHey {instructorName},\u003c/Text\u003e\n          \u003cText\u003e\n            Your revenue share for {period} has been calculated: \n            \u003cstrong\u003e${amount}\u003c/strong\u003e\n          \u003c/Text\u003e\n          \u003cButton href={breakdownUrl}\u003e\n            View Breakdown\n          \u003c/Button\u003e\n        \u003c/Container\u003e\n      \u003c/Body\u003e\n    \u003c/Html\u003e\n  )\n}\n```\n\n## Email Registry\n\n```typescript\n// lib/email/registry.ts\nexport const emailTemplates = {\n  // Auth\n  'magic-sign-in': MagicSignInEmail,\n  'password-reset': PasswordResetEmail,\n  'email-change': EmailChangeEmail,\n  \n  // Subscription\n  'welcome': WelcomeEmail,\n  'pro-welcome': ProWelcomeEmail,\n  'renewal-reminder': RenewalReminderEmail,\n  'failed-payment': FailedPaymentEmail,\n  \n  // Gift\n  'gift-purchased': GiftPurchasedEmail,\n  'gift-received': GiftReceivedEmail,\n  'gift-expiring': GiftExpiringEmail,\n  \n  // Team\n  'team-invite': TeamInviteEmail,\n  'team-member-added': TeamMemberAddedEmail,\n  \n  // Instructor\n  'instructor-payout': InstructorPayoutEmail,\n  'content-published': ContentPublishedEmail,\n} as const\n```\n\n## Files to Create\n- `apps/egghead/src/emails/gift-*.tsx` (3 templates)\n- `apps/egghead/src/emails/team-*.tsx` (2 templates)\n- `apps/egghead/src/emails/password-reset.tsx`\n- `apps/egghead/src/emails/email-change.tsx`\n- `apps/egghead/src/emails/instructor-*.tsx` (2 templates)\n- `apps/egghead/src/lib/email/registry.ts`\n- `apps/egghead/src/lib/email/send.ts` (unified send function)\n\n## Acceptance Criteria\n- [ ] All Tier 1 emails implemented and tested\n- [ ] All Tier 2 emails implemented\n- [ ] Email registry for easy lookup\n- [ ] Consistent styling across all templates\n- [ ] Plain text fallbacks for all emails\n- [ ] Preview available via `pnpm email:dev`\n- [ ] Integration tests for critical email flows","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:29:31.608944-08:00","updated_at":"2025-12-11T12:02:58.350894-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.5","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T09:29:31.609281-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qk0.6","title":"E2E: Test magic link email flow end-to-end","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:31.641619-08:00","updated_at":"2025-12-11T09:29:31.641619-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.6","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T09:29:31.641925-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qk0.7","title":"[HUMAN] Verify Customer.io events + email delivery","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:31.674304-08:00","updated_at":"2025-12-11T09:29:31.674304-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.7","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T09:29:31.674624-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qk0.8","title":"Audit Rails Mailers","description":"**Objective:** Complete inventory of all 17 Rails mailers with categorization and trigger analysis.\n\n**Tasks:**\n1. Inventory all mailers in `egghead-rails/app/mailers/`\n2. For each mailer, document:\n   - File path and location\n   - All email methods (e.g., `magic_sign_in_email`, `gift_notification`)\n   - Trigger conditions (controller actions, background jobs)\n   - Current template paths (erb/text/html)\n   - Dependencies (models, helpers, decorators)\n3. Categorize each mailer:\n   - **Postmark**: Transactional, immediate delivery\n   - **Customer.io**: Drip campaigns, sequences, automation\n   - **SKIP**: Deprecated features or unnecessary\n4. Priority assignment (P0-P3) based on business criticality\n5. Note any mailers with complex logic (multi-part, attachments, dynamic content)\n\n**Files:**\n- Source: `egghead-rails/app/mailers/`\n- Output: `reports/MAILER-AUDIT.md`\n\n**Acceptance Criteria:**\n- [ ] All 17 mailers documented with full metadata\n- [ ] Categorization complete (Postmark/Customer.io/SKIP)\n- [ ] Trigger conditions documented for each method\n- [ ] Priority assignments match business requirements\n- [ ] Report includes examples of complex cases (if any)\n- [ ] Template paths mapped for migration reference\n\n**Estimated Effort:** 4 hours","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T11:21:58.715203-08:00","updated_at":"2025-12-11T11:21:58.715203-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.8","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T11:21:58.715589-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qk0.9","title":"Build Customer.io Event Mapping","description":"**Objective:** Define Customer.io event schema for all mailers targeting campaign automation.\n\n**Tasks:**\n1. Map Rails mailer triggers to Customer.io events:\n   - GiftMailer ‚Üí `gift.received`, `gift.claimed`\n   - RenewalMailer ‚Üí `subscription.renewal_reminder`, `subscription.renewal_failed`\n   - SequenceMailer ‚Üí `sequence.started`, `sequence.step_completed`\n   - ReferralMailer ‚Üí `referral.sent`, `referral.converted`\n2. Define event schema for each:\n   - **Properties**: user_id, email, trigger_context\n   - **Metadata**: course_id, purchase_id, sequence_name, etc.\n   - **Timestamps**: event_time, scheduled_time (for campaigns)\n3. Document naming convention:\n   - Format: `{domain}.{action}` (e.g., `gift.received`)\n   - Snake_case, no abbreviations\n   - Namespace by business domain\n4. Identify Customer.io segments/campaigns needed:\n   - Onboarding sequences\n   - Renewal reminder cadence\n   - Gift notification workflow\n   - Referral incentive campaigns\n\n**Files:**\n- Output: `reports/CUSTOMERIO-EVENTS.md`\n- Reference: `egghead-rails/app/mailers/` (for trigger logic)\n\n**Acceptance Criteria:**\n- [ ] All Customer.io mailers mapped to events\n- [ ] Event schemas defined with properties + metadata\n- [ ] Naming convention documented and consistent\n- [ ] Campaign workflows outlined (when applicable)\n- [ ] Examples provided for each event type\n- [ ] Schema versioning strategy defined\n\n**Dependencies:**\n- Requires: migrate-egghead-qk0.1 (Mailer audit complete)\n\n**Estimated Effort:** 6 hours","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T11:22:08.178032-08:00","updated_at":"2025-12-11T11:22:08.178032-08:00","dependencies":[{"issue_id":"migrate-egghead-qk0.9","depends_on_id":"migrate-egghead-qk0","type":"parent-child","created_at":"2025-12-11T11:22:08.178445-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qqu","title":"Phase 3: Cron Jobs Migration (17 Sidekiq ‚Üí Inngest)","description":"Port 17 Rails Sidekiq-Cron jobs to Inngest. Critical jobs: StripeReconciler (catches missed webhooks), RefreshSitemap (SEO), GiftExpiration, LessonPublisher. Gate: Human decision on which jobs to port vs deprecate, sitemap E2E test passes.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:29:20.601044-08:00","updated_at":"2025-12-11T10:26:31.563372-08:00","closed_at":"2025-12-11T10:26:31.563372-08:00"}
{"id":"migrate-egghead-qqu.1","title":"Port StripeReconciler to Inngest (daily, catches missed webhooks)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:20.636382-08:00","updated_at":"2025-12-11T12:00:12.759559-08:00","closed_at":"2025-12-11T12:00:12.759559-08:00","dependencies":[{"issue_id":"migrate-egghead-qqu.1","depends_on_id":"migrate-egghead-qqu","type":"parent-child","created_at":"2025-12-11T09:29:20.636744-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qqu.2","title":"Port GiftExpirationWorker to Inngest (daily)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T09:29:20.672322-08:00","updated_at":"2025-12-11T12:00:12.947468-08:00","closed_at":"2025-12-11T12:00:12.947468-08:00","dependencies":[{"issue_id":"migrate-egghead-qqu.2","depends_on_id":"migrate-egghead-qqu","type":"parent-child","created_at":"2025-12-11T09:29:20.672698-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qqu.3","title":"Port RefreshSitemap to Inngest (4-hourly, SEO critical)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:20.705406-08:00","updated_at":"2025-12-11T12:00:13.605722-08:00","closed_at":"2025-12-11T12:00:13.605722-08:00","dependencies":[{"issue_id":"migrate-egghead-qqu.3","depends_on_id":"migrate-egghead-qqu","type":"parent-child","created_at":"2025-12-11T09:29:20.705759-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qqu.4","title":"Port LessonPublishWorker to Inngest (10-min scheduled publishing)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T09:29:20.738575-08:00","updated_at":"2025-12-11T12:00:14.059197-08:00","closed_at":"2025-12-11T12:00:14.059197-08:00","dependencies":[{"issue_id":"migrate-egghead-qqu.4","depends_on_id":"migrate-egghead-qqu","type":"parent-child","created_at":"2025-12-11T09:29:20.738915-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qqu.5","title":"Port SignInTokenCleaner to Inngest (1-min magic link cleanup)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T09:29:20.767602-08:00","updated_at":"2025-12-11T12:00:14.627536-08:00","closed_at":"2025-12-11T12:00:14.627536-08:00","dependencies":[{"issue_id":"migrate-egghead-qqu.5","depends_on_id":"migrate-egghead-qqu","type":"parent-child","created_at":"2025-12-11T09:29:20.767918-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qqu.6","title":"Port RenewalReminder + ranking jobs to Inngest","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T09:29:20.797941-08:00","updated_at":"2025-12-11T12:00:15.202019-08:00","closed_at":"2025-12-11T12:00:15.202019-08:00","dependencies":[{"issue_id":"migrate-egghead-qqu.6","depends_on_id":"migrate-egghead-qqu","type":"parent-child","created_at":"2025-12-11T09:29:20.798257-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qqu.7","title":"E2E: Verify sitemap generates correctly with all URLs","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:20.829602-08:00","updated_at":"2025-12-11T12:00:15.783736-08:00","closed_at":"2025-12-11T12:00:15.783736-08:00","dependencies":[{"issue_id":"migrate-egghead-qqu.7","depends_on_id":"migrate-egghead-qqu","type":"parent-child","created_at":"2025-12-11T09:29:20.830618-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qqu.8","title":"[HUMAN] Decide which cron jobs to port vs deprecate (17 total)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:20.865622-08:00","updated_at":"2025-12-11T12:00:16.385798-08:00","closed_at":"2025-12-11T12:00:16.385798-08:00","dependencies":[{"issue_id":"migrate-egghead-qqu.8","depends_on_id":"migrate-egghead-qqu","type":"parent-child","created_at":"2025-12-11T09:29:20.866017-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-qrj","title":"Execute video migration: 152 gap lessons to Mux","description":"**Execute the video migration using the scripts created in epic ddl.**\n\n## Prerequisites\n- [x] Scripts created (ddl epic)\n- [x] 146 gap lessons in SQLite\n- [ ] Mux credentials available\n- [ ] DATABASE_URL for Rails backfill\n\n## Execution Steps\n\n### 1. Upload to Mux (~3 min)\n```bash\ncd download-egghead\nMUX_TOKEN_ID=xxx MUX_TOKEN_SECRET=xxx node send-to-mux.mjs\n```\n\n### 2. Verify uploads\n```bash\nnode check-assets.mjs\n```\n\n### 3. Backfill Rails with Mux URLs\n```bash\nDATABASE_URL=xxx MUX_TOKEN_ID=xxx MUX_TOKEN_SECRET=xxx node backfill-rails-mux-urls.mjs\n```\n\n### 4. Verify in egghead-next\n- Pick 3 random gap lessons\n- Confirm video plays from Mux (check network tab for stream.mux.com)\n\n## Success Criteria\n- [ ] All 152 videos have mux_asset_id in SQLite\n- [ ] All 152 lessons have Mux HLS URL in Rails\n- [ ] Video playback works in egghead-next\n\n## Rollback\nIf anything breaks, videos continue serving from CloudFront (no user impact).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T08:04:57.632796-08:00","updated_at":"2025-12-12T08:05:47.703892-08:00","closed_at":"2025-12-12T08:05:47.703892-08:00"}
{"id":"migrate-egghead-r52","title":"Phase 5: UI Components + Full E2E Click Matrix","description":"Build all UI components with shadcn/ui: video player (Mux, NOT xstate), lesson/course pages, search (Typesense), pricing, subscription management. Configure SEO-critical URL redirects. Gate: Full click-test matrix passes, LLM exploratory testing finds no critical issues.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:29:44.727937-08:00","updated_at":"2025-12-12T09:25:57.251755-08:00","closed_at":"2025-12-12T09:25:57.251755-08:00"}
{"id":"migrate-egghead-r52.1","title":"Build Mux video player component (NOT porting xstate complexity)","description":"Build Mux video player component using Coursebuilder's existing pattern - NOT porting xstate complexity.\n\n## Reference Implementation\n- `course-builder/apps/ai-hero/src/app/(content)/_components/video-player-overlay.tsx`\n- `course-builder/packages/ui/hooks/use-video-player-overlay.tsx`\n\n## Approach\nUse the ai-hero overlay pattern with `useReducer` (4 states: COMPLETED, BLOCKED, HIDDEN, LOADING). NOT the xstate 14-state machine from egghead-next.\n\n## Components to Build\n1. **EggheadVideoPlayer** - wrapper around MuxPlayer\n2. **CompletionOverlay** - \"Mark Complete\" button, confetti, next lesson\n3. **SoftBlockOverlay** - for non-subscribers (preview mode)\n4. **PricingWidget** - embedded pricing for gated content\n\n## Features\n- Play/pause/seek controls (native Mux)\n- Completion tracking via `setProgressForResource`\n- Soft block after 30s for non-subscribers\n- Next/previous lesson navigation\n\n## NOT Implementing\n- Playback speed (can add later)\n- Captions UI (Mux handles natively)\n- Bookmarks\n- Any xstate dependencies\n\n## Files\n- `course-builder/apps/egghead/src/components/video-player/index.tsx`\n- `course-builder/apps/egghead/src/components/video-player/overlays.tsx`\n- `course-builder/apps/egghead/src/hooks/use-egghead-player.ts`\n\n## Acceptance Criteria\n- [ ] Video plays using MuxPlayer\n- [ ] Completion tracking works\n- [ ] Soft block triggers for non-subscribers\n- [ ] Overlay states work correctly\n- [ ] Next/prev navigation functional","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:44.761435-08:00","updated_at":"2025-12-11T11:22:14.089553-08:00","dependencies":[{"issue_id":"migrate-egghead-r52.1","depends_on_id":"migrate-egghead-r52","type":"parent-child","created_at":"2025-12-11T09:29:44.76176-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-r52.10","title":"[HUMAN] UI review + full E2E suite must be green","description":"","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:45.055971-08:00","updated_at":"2025-12-11T09:29:45.055971-08:00","dependencies":[{"issue_id":"migrate-egghead-r52.10","depends_on_id":"migrate-egghead-r52","type":"parent-child","created_at":"2025-12-11T09:29:45.056276-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-r52.11","title":"Build simple video player using ai-hero overlay pattern","description":"Build egghead video player using Coursebuilder's existing pattern - NOT the xstate 14-state machine from egghead-next.\n\n**Reference implementation:**\n- `course-builder/apps/ai-hero/src/app/(content)/_components/video-player-overlay.tsx`\n- `course-builder/packages/ui/hooks/use-video-player-overlay.tsx`\n\n**Pattern:**\n1. `useReducer` with 4 states: COMPLETED, BLOCKED, HIDDEN, LOADING\n2. MuxPlayer component (already in CB)\n3. Overlay components for: completion, soft block, pricing widget\n4. Progress tracking via `setProgressForResource`\n\n**DO NOT PORT:**\n- xstate lesson-machine.ts (14 states, complex)\n- Any xstate dependencies\n\n**Deliverables:**\n- Video player component for lessons\n- Completion overlay with \"next lesson\" navigation\n- Soft block overlay for non-subscribers\n- Progress tracking integration","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:26:46.352578-08:00","updated_at":"2025-12-11T10:26:46.352578-08:00","dependencies":[{"issue_id":"migrate-egghead-r52.11","depends_on_id":"migrate-egghead-r52","type":"parent-child","created_at":"2025-12-11T10:26:46.352982-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-r52.2","title":"Build lesson view page with player, transcript, navigation","description":"Build lesson view page with video player, transcript, and navigation.\n\n## Route\n`/lessons/[slug]`\n\n## Data Fetching\nQuery ContentResource by slug type='lesson':\n```typescript\nconst lesson = await getContentResource(slug)\nconst course = await getParentResource(lesson.id) // for navigation\n```\n\n## Page Structure\n```tsx\n\u003cLessonPage\u003e\n  \u003cVideoPlayerSection\u003e\n    \u003cEggheadVideoPlayer /\u003e\n  \u003c/VideoPlayerSection\u003e\n  \n  \u003cLessonMeta\u003e\n    \u003ch1\u003e{lesson.title}\u003c/h1\u003e\n    \u003cInstructorInfo instructor={lesson.instructor} /\u003e\n    \u003cLessonStats duration={lesson.duration} completedBy={...} /\u003e\n  \u003c/LessonMeta\u003e\n  \n  \u003cLessonNavigation\u003e\n    \u003cPreviousLesson /\u003e\n    \u003cCourseBreadcrumb course={course} /\u003e\n    \u003cNextLesson /\u003e\n  \u003c/LessonNavigation\u003e\n  \n  \u003cTranscript content={lesson.transcript} /\u003e\n  \n  \u003cRelatedContent lessons={...} /\u003e\n\u003c/LessonPage\u003e\n```\n\n## Components\n- `EggheadVideoPlayer` (from r52.1)\n- `LessonMeta` - title, instructor, stats\n- `LessonNavigation` - prev/next, breadcrumb\n- `Transcript` - collapsible transcript with timestamps\n- `RelatedContent` - other lessons in course\n\n## Progress Tracking\n- Load user progress on mount\n- Update progress on video completion\n- Show completion badge if already completed\n\n## Files\n- `course-builder/apps/egghead/src/app/lessons/[slug]/page.tsx`\n- `course-builder/apps/egghead/src/components/lesson/meta.tsx`\n- `course-builder/apps/egghead/src/components/lesson/navigation.tsx`\n- `course-builder/apps/egghead/src/components/lesson/transcript.tsx`\n\n## Acceptance Criteria\n- [ ] Lesson page renders with video player\n- [ ] Transcript displays with timestamps\n- [ ] Prev/next navigation works\n- [ ] Progress tracking updates on completion\n- [ ] Related content shows\n- [ ] Mobile responsive\n- [ ] SEO meta tags populated","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:44.794589-08:00","updated_at":"2025-12-11T11:22:23.198959-08:00","dependencies":[{"issue_id":"migrate-egghead-r52.2","depends_on_id":"migrate-egghead-r52","type":"parent-child","created_at":"2025-12-11T09:29:44.79491-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-r52.3","title":"Build course view page with lesson list, progress indicators","description":"Build course view page with lesson list and progress indicators.\n\n## Route\n`/courses/[slug]`\n\n## Data Fetching\n```typescript\nconst course = await getContentResource(slug, { \n  where: { type: 'course' },\n  include: { lessons: true }\n})\nconst userProgress = await getUserProgress(userId, course.id)\n```\n\n## Page Structure\n```tsx\n\u003cCoursePage\u003e\n  \u003cCourseHeader\u003e\n    \u003ch1\u003e{course.title}\u003c/h1\u003e\n    \u003cCourseImage src={course.image} /\u003e\n    \u003cCourseDescription\u003e{course.description}\u003c/CourseDescription\u003e\n    \u003cInstructorCard instructor={course.instructor} /\u003e\n    \u003cCourseStats\u003e\n      \u003cStat label=\"Lessons\" value={course.lessonCount} /\u003e\n      \u003cStat label=\"Duration\" value={course.totalDuration} /\u003e\n      \u003cStat label=\"Progress\" value={progressPercent} /\u003e\n    \u003c/CourseStats\u003e\n  \u003c/CourseHeader\u003e\n  \n  \u003cProgressBar percent={progressPercent} /\u003e\n  \n  \u003cLessonList\u003e\n    {lessons.map(lesson =\u003e (\n      \u003cLessonCard \n        lesson={lesson} \n        completed={userProgress[lesson.id]?.completed}\n        duration={lesson.duration}\n      /\u003e\n    ))}\n  \u003c/LessonList\u003e\n  \n  \u003cCourseSidebar\u003e\n    \u003cRelatedCourses /\u003e\n    \u003cCTAWidget /\u003e {/* if not subscribed */}\n  \u003c/CourseSidebar\u003e\n\u003c/CoursePage\u003e\n```\n\n## Components\n- `CourseHeader` - title, image, description, instructor\n- `ProgressBar` - visual progress indicator\n- `LessonList` - ordered list with completion checkmarks\n- `LessonCard` - title, duration, play button, completion badge\n- `CourseSidebar` - related courses, CTA\n\n## Progress Calculation\n```typescript\nconst progressPercent = (completedLessons / totalLessons) * 100\n```\n\n## Files\n- `course-builder/apps/egghead/src/app/courses/[slug]/page.tsx`\n- `course-builder/apps/egghead/src/components/course/header.tsx`\n- `course-builder/apps/egghead/src/components/course/lesson-list.tsx`\n- `course-builder/apps/egghead/src/components/course/lesson-card.tsx`\n\n## Acceptance Criteria\n- [ ] Course page renders with all lessons\n- [ ] Progress bar shows correct percentage\n- [ ] Lesson completion badges display\n- [ ] Click lesson ‚Üí navigate to lesson page\n- [ ] Instructor info displays\n- [ ] Related courses show\n- [ ] Mobile responsive\n- [ ] SEO meta tags populated","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:44.824754-08:00","updated_at":"2025-12-11T11:22:31.933953-08:00","dependencies":[{"issue_id":"migrate-egghead-r52.3","depends_on_id":"migrate-egghead-r52","type":"parent-child","created_at":"2025-12-11T09:29:44.825036-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-r52.4","title":"Build search UI (Typesense + InstantSearch) - /q/[[...all]] route","description":"Build search UI using Typesense + InstantSearch.\n\n## Route\n`/q/[[...all]]`\n\nDynamic route for topic combinations (SEO critical - massive sitemap):\n- `/q` - all content\n- `/q/react` - single topic\n- `/q/react/typescript` - topic combination\n- `/q/react/typescript/testing` - multi-topic\n\n## Typesense Integration\nUse existing Typesense instance from egghead-next:\n- Collection: `content_production`\n- Fields: title, description, topics, instructor, type (course/lesson)\n- Facets: topics, instructor, type, duration\n\n## Components (Port from egghead-next)\nReference: `egghead-next/src/components/search/`\n\n```tsx\n\u003cSearchPage\u003e\n  \u003cSearchBox /\u003e {/* InstantSearch.SearchBox */}\n  \n  \u003cSearchFilters\u003e\n    \u003cRefinementList attribute=\"topics\" /\u003e \n    \u003cRefinementList attribute=\"instructor\" /\u003e\n    \u003cRangeInput attribute=\"duration\" /\u003e\n    \u003cToggleRefinement attribute=\"type\" /\u003e\n  \u003c/SearchFilters\u003e\n  \n  \u003cSearchResults\u003e\n    \u003cHits hitComponent={ContentCard} /\u003e\n    \u003cPagination /\u003e\n  \u003c/SearchResults\u003e\n  \n  \u003cSearchStats /\u003e {/* \"42 results in 12ms\" */}\n\u003c/SearchPage\u003e\n```\n\n## InstantSearch Setup\n```typescript\nimport TypesenseInstantSearchAdapter from 'typesense-instantsearch-adapter'\n\nconst adapter = new TypesenseInstantSearchAdapter({\n  server: {\n    apiKey: process.env.NEXT_PUBLIC_TYPESENSE_API_KEY,\n    nodes: [{\n      host: process.env.NEXT_PUBLIC_TYPESENSE_HOST,\n      port: 443,\n      protocol: 'https'\n    }]\n  },\n  additionalSearchParameters: {\n    query_by: 'title,description,topics'\n  }\n})\n```\n\n## URL State Management\nInstantSearch routing for SEO:\n- Query params: `?q=search+term\u0026topics=react,typescript`\n- Preserve on navigation\n- SSR initial state\n\n## Files\n- `course-builder/apps/egghead/src/app/q/[[...all]]/page.tsx`\n- `course-builder/apps/egghead/src/components/search/search-box.tsx`\n- `course-builder/apps/egghead/src/components/search/filters.tsx`\n- `course-builder/apps/egghead/src/components/search/results.tsx`\n- `course-builder/apps/egghead/src/lib/typesense.ts`\n\n## Acceptance Criteria\n- [ ] Search works with Typesense\n- [ ] Filters update results\n- [ ] Topic combinations generate correct URLs\n- [ ] Results show courses + lessons\n- [ ] Pagination works\n- [ ] Mobile responsive\n- [ ] SSR for initial results\n- [ ] URL state preserved\n- [ ] Fast (\u003c 100ms queries)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:44.85552-08:00","updated_at":"2025-12-11T11:22:44.337349-08:00","dependencies":[{"issue_id":"migrate-egghead-r52.4","depends_on_id":"migrate-egghead-r52","type":"parent-child","created_at":"2025-12-11T09:29:44.855788-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-r52.5","title":"Build pricing page with Stripe checkout integration","description":"Build pricing page with Stripe checkout integration.\n\n## Route\n`/pricing`\n\n## Pricing Structure\nFrom existing egghead:\n- **Monthly Pro**: $19/month\n- **Yearly Pro**: $190/year (save $38)\n- **Team**: Custom pricing (contact sales)\n\n## Page Structure\n```tsx\n\u003cPricingPage\u003e\n  \u003cHero\u003e\n    \u003ch1\u003eChoose Your Plan\u003c/h1\u003e\n    \u003cp\u003eUnlimited access to all courses and lessons\u003c/p\u003e\n  \u003c/Hero\u003e\n  \n  \u003cPricingToggle\u003e {/* monthly/yearly */}\n    \u003cSwitch value={billingInterval} onChange={setBillingInterval} /\u003e\n  \u003c/PricingToggle\u003e\n  \n  \u003cPricingCards\u003e\n    \u003cPricingCard\n      name=\"Free\"\n      price={0}\n      features={['Preview lessons', 'Community access']}\n      cta=\"Get Started\"\n    /\u003e\n    \n    \u003cPricingCard\n      name=\"Pro\"\n      price={billingInterval === 'month' ? 19 : 190}\n      interval={billingInterval}\n      features={[\n        'Unlimited course access',\n        'Download lessons',\n        'Transcripts',\n        'Support priority'\n      ]}\n      cta=\"Start Learning\"\n      highlighted\n    /\u003e\n    \n    \u003cPricingCard\n      name=\"Team\"\n      price=\"Custom\"\n      features={[\n        'Everything in Pro',\n        'Team analytics',\n        'Centralized billing',\n        'Priority support'\n      ]}\n      cta=\"Contact Sales\"\n    /\u003e\n  \u003c/PricingCards\u003e\n  \n  \u003cFAQ /\u003e\n  \u003cSocialProof /\u003e {/* testimonials */}\n\u003c/PricingPage\u003e\n```\n\n## Stripe Checkout Integration\n```typescript\nasync function handleCheckout(priceId: string) {\n  const response = await fetch('/api/stripe/create-checkout', {\n    method: 'POST',\n    body: JSON.stringify({ priceId })\n  })\n  const { url } = await response.json()\n  window.location.href = url // redirect to Stripe\n}\n```\n\n## API Route\n```typescript\n// /api/stripe/create-checkout\nconst session = await stripe.checkout.sessions.create({\n  customer: user.stripeCustomerId,\n  line_items: [{ price: priceId, quantity: 1 }],\n  mode: 'subscription',\n  success_url: `${origin}/welcome?session_id={CHECKOUT_SESSION_ID}`,\n  cancel_url: `${origin}/pricing`\n})\n\nreturn { url: session.url }\n```\n\n## Files\n- `course-builder/apps/egghead/src/app/pricing/page.tsx`\n- `course-builder/apps/egghead/src/components/pricing/pricing-card.tsx`\n- `course-builder/apps/egghead/src/components/pricing/faq.tsx`\n- `course-builder/apps/egghead/src/app/api/stripe/create-checkout/route.ts`\n- `course-builder/apps/egghead/src/app/welcome/page.tsx` (post-checkout)\n\n## Acceptance Criteria\n- [ ] Pricing page displays\n- [ ] Monthly/yearly toggle works\n- [ ] Click \"Start Learning\" ‚Üí Stripe checkout\n- [ ] Success redirect to /welcome\n- [ ] Cancel redirect to /pricing\n- [ ] Team CTA goes to contact form\n- [ ] Mobile responsive\n- [ ] SEO meta tags populated","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:44.888115-08:00","updated_at":"2025-12-11T11:22:56.702635-08:00","dependencies":[{"issue_id":"migrate-egghead-r52.5","depends_on_id":"migrate-egghead-r52","type":"parent-child","created_at":"2025-12-11T09:29:44.888472-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-r52.6","title":"Build subscription management page","description":"Build subscription management page.\n\n## Route\n`/profile/subscription`\n\n## Protected Route\nRequires authentication - redirect to `/login` if not authed.\n\n## Page Structure\n```tsx\n\u003cSubscriptionPage\u003e\n  \u003cCurrentPlan\u003e\n    \u003ch2\u003eYour Subscription\u003c/h2\u003e\n    \u003cBadge\u003e{subscription.status}\u003c/Badge\u003e {/* active/canceled/past_due */}\n    \n    \u003cPlanDetails\u003e\n      \u003cdiv\u003ePlan: {subscription.planName}\u003c/div\u003e {/* Pro Monthly */}\n      \u003cdiv\u003ePrice: ${subscription.amount / 100}/{subscription.interval}\u003c/div\u003e\n      \u003cdiv\u003eNext billing: {formatDate(subscription.currentPeriodEnd)}\u003c/div\u003e\n    \u003c/PlanDetails\u003e\n    \n    {subscription.cancelAtPeriodEnd \u0026\u0026 (\n      \u003cAlert variant=\"warning\"\u003e\n        Subscription will cancel on {formatDate(subscription.currentPeriodEnd)}\n      \u003c/Alert\u003e\n    )}\n  \u003c/CurrentPlan\u003e\n  \n  \u003cBillingHistory\u003e\n    \u003ch3\u003eInvoices\u003c/h3\u003e\n    \u003cInvoiceList invoices={invoices} /\u003e\n  \u003c/BillingHistory\u003e\n  \n  \u003cManageActions\u003e\n    \u003cButton onClick={openCustomerPortal}\u003eUpdate Payment Method\u003c/Button\u003e\n    \u003cButton onClick={openCustomerPortal}\u003eView Invoices\u003c/Button\u003e\n    \n    {!subscription.cancelAtPeriodEnd \u0026\u0026 (\n      \u003cButton variant=\"destructive\" onClick={handleCancel}\u003e\n        Cancel Subscription\n      \u003c/Button\u003e\n    )}\n    \n    {subscription.cancelAtPeriodEnd \u0026\u0026 (\n      \u003cButton onClick={handleReactivate}\u003e\n        Reactivate Subscription\n      \u003c/Button\u003e\n    )}\n  \u003c/ManageActions\u003e\n\u003c/SubscriptionPage\u003e\n```\n\n## Stripe Customer Portal\nUse Stripe's hosted customer portal for:\n- Update payment method\n- View/download invoices\n- Change billing email\n\n```typescript\nasync function openCustomerPortal() {\n  const response = await fetch('/api/stripe/create-portal-session', {\n    method: 'POST'\n  })\n  const { url } = await response.json()\n  window.location.href = url\n}\n```\n\n## Cancel Flow\n```typescript\nasync function handleCancel() {\n  if (!confirm('Cancel subscription? You\\'ll have access until the end of the billing period.')) {\n    return\n  }\n  \n  await fetch('/api/stripe/cancel-subscription', {\n    method: 'POST',\n    body: JSON.stringify({ subscriptionId: subscription.id })\n  })\n  \n  router.refresh() // refetch subscription\n}\n```\n\n## API Routes\n```typescript\n// /api/stripe/create-portal-session\nconst session = await stripe.billingPortal.sessions.create({\n  customer: user.stripeCustomerId,\n  return_url: `${origin}/profile/subscription`\n})\n\n// /api/stripe/cancel-subscription\nawait stripe.subscriptions.update(subscriptionId, {\n  cancel_at_period_end: true\n})\n\n// /api/stripe/reactivate-subscription\nawait stripe.subscriptions.update(subscriptionId, {\n  cancel_at_period_end: false\n})\n```\n\n## Files\n- `course-builder/apps/egghead/src/app/profile/subscription/page.tsx`\n- `course-builder/apps/egghead/src/components/subscription/current-plan.tsx`\n- `course-builder/apps/egghead/src/components/subscription/invoice-list.tsx`\n- `course-builder/apps/egghead/src/app/api/stripe/create-portal-session/route.ts`\n- `course-builder/apps/egghead/src/app/api/stripe/cancel-subscription/route.ts`\n- `course-builder/apps/egghead/src/app/api/stripe/reactivate-subscription/route.ts`\n\n## Acceptance Criteria\n- [ ] Shows current subscription status\n- [ ] Displays next billing date\n- [ ] Customer portal link works\n- [ ] Cancel flow works\n- [ ] Reactivate flow works\n- [ ] Shows cancellation notice\n- [ ] Invoice list displays\n- [ ] Mobile responsive\n- [ ] Protected route (auth required)","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:29:44.920105-08:00","updated_at":"2025-12-11T11:23:09.799581-08:00","dependencies":[{"issue_id":"migrate-egghead-r52.6","depends_on_id":"migrate-egghead-r52","type":"parent-child","created_at":"2025-12-11T09:29:44.920412-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-r52.7","title":"Configure URL redirects (SEO critical) in next.config","description":"Configure URL redirects (SEO critical) in next.config\n\nCOMPREHENSIVE REDIRECT MAP:\n\n```typescript\n// Instructors (134)\n/i/:slug -\u003e /instructors/:slug (301)\n/i/:slug/rss.xml -\u003e /instructors/:slug/rss (301)\n\n// Legacy content\n/playlists/:slug -\u003e /courses/:slug (301)\n/s/:slug -\u003e /courses/:slug (301)\n/browse/:topic -\u003e /q/:topic (301)\n\n// User routes\n/user -\u003e /profile (301)\n/user/:path* -\u003e /profile/:path* (301)\n\n// Deprecated content\n/lessons/:slug (missing video) -\u003e /gone (301)\n```\n\nMUST PRESERVE (no redirect needed):\n- /lessons/:slug (5,132)\n- /courses/:slug (420)\n- /q/[...params] (massive sitemap)\n\nSee epic migrate-egghead-34t for SEO safety details.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:44.953077-08:00","updated_at":"2025-12-11T09:54:20.808233-08:00","dependencies":[{"issue_id":"migrate-egghead-r52.7","depends_on_id":"migrate-egghead-r52","type":"parent-child","created_at":"2025-12-11T09:29:44.95352-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-r52.8","title":"E2E: Full click-test matrix (all critical user flows)","description":"E2E: Full click-test matrix covering all critical user flows.\n\n## Test Matrix\n\nDefine critical user journeys that MUST work:\n\n### 1. Content Discovery ‚Üí Watch Flow (Free User)\n- [ ] Homepage ‚Üí Browse courses\n- [ ] Click course ‚Üí Course page loads\n- [ ] Click lesson ‚Üí Lesson page loads\n- [ ] Video plays (preview mode)\n- [ ] Soft block appears after 30s\n- [ ] Click \"Upgrade\" ‚Üí Pricing page\n\n### 2. Content Discovery ‚Üí Watch Flow (Pro User)\n- [ ] Login with GitHub OAuth\n- [ ] Homepage ‚Üí Browse courses\n- [ ] Click course ‚Üí Course page loads with progress\n- [ ] Click lesson ‚Üí Lesson page loads\n- [ ] Video plays (no block)\n- [ ] Mark complete ‚Üí Progress updates\n- [ ] Next lesson navigation works\n\n### 3. Search ‚Üí Filter ‚Üí Watch Flow\n- [ ] Navigate to /q\n- [ ] Enter search term\n- [ ] Apply topic filter\n- [ ] Results update\n- [ ] Click result ‚Üí Content loads\n- [ ] URL reflects search state\n\n### 4. Pricing ‚Üí Checkout ‚Üí Access Flow\n- [ ] Navigate to /pricing\n- [ ] Toggle monthly/yearly\n- [ ] Click \"Start Learning\"\n- [ ] Stripe checkout loads\n- [ ] Complete payment (test mode)\n- [ ] Redirect to /welcome\n- [ ] Access pro content immediately\n\n### 5. Subscription Management Flow\n- [ ] Login as pro user\n- [ ] Navigate to /profile/subscription\n- [ ] View current plan\n- [ ] Open customer portal\n- [ ] Update payment method (Stripe portal)\n- [ ] Return to app\n- [ ] Cancel subscription\n- [ ] Verify cancellation notice\n\n### 6. Progress Tracking Flow\n- [ ] Login as pro user\n- [ ] Start course\n- [ ] Complete lesson 1\n- [ ] Navigate away\n- [ ] Return to course page\n- [ ] Progress shows 1/N complete\n- [ ] Resume from next lesson\n\n### 7. Mobile Responsive Flow\n- [ ] Repeat flows 1-3 on mobile viewport\n- [ ] Verify touch interactions work\n- [ ] Verify video player works on mobile\n\n## Test Implementation (Playwright)\n\n```typescript\n// e2e/critical-paths/content-discovery.e2e.ts\ntest('free user can preview content and hits paywall', async ({ page }) =\u003e {\n  await page.goto('/')\n  await page.click('[data-testid=\"browse-courses\"]')\n  await page.click('[data-testid=\"course-card\"]:first-child')\n  \n  // Course page\n  await expect(page.locator('h1')).toBeVisible()\n  await page.click('[data-testid=\"lesson-card\"]:first-child')\n  \n  // Lesson page - video plays\n  await page.waitForSelector('[data-testid=\"video-player\"]')\n  await expect(page.locator('video')).toBeVisible()\n  \n  // Wait for soft block\n  await page.waitForTimeout(31000)\n  await expect(page.locator('[data-testid=\"paywall\"]')).toBeVisible()\n  \n  // Click upgrade\n  await page.click('[data-testid=\"upgrade-cta\"]')\n  await expect(page).toHaveURL('/pricing')\n})\n```\n\n## Files\n- `course-builder/apps/egghead/e2e/critical-paths/content-discovery.e2e.ts`\n- `course-builder/apps/egghead/e2e/critical-paths/search-flow.e2e.ts`\n- `course-builder/apps/egghead/e2e/critical-paths/checkout-flow.e2e.ts`\n- `course-builder/apps/egghead/e2e/critical-paths/subscription-management.e2e.ts`\n- `course-builder/apps/egghead/e2e/critical-paths/progress-tracking.e2e.ts`\n\n## Test Data Setup\nUse `auth.setup.ts` to create:\n- Free user (no subscription)\n- Pro user (active subscription)\n- Stripe test mode for checkout\n\n## Acceptance Criteria\n- [ ] All 7 flows pass on desktop\n- [ ] All 3 mobile flows pass\n- [ ] Tests run in \u003c 10 minutes total\n- [ ] No flaky tests (3 runs, all pass)\n- [ ] Screenshots captured on failure","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:29:44.987845-08:00","updated_at":"2025-12-11T11:23:27.451753-08:00","dependencies":[{"issue_id":"migrate-egghead-r52.8","depends_on_id":"migrate-egghead-r52","type":"parent-child","created_at":"2025-12-11T09:29:44.988212-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-r52.9","title":"E2E: LLM agent exploratory testing","description":"E2E: LLM agent exploratory testing to find issues humans miss.\n\n## Approach\n\nUse Claude/GPT to explore the app autonomously and report:\n- Broken links\n- UI bugs (layout, responsive issues)\n- Accessibility problems\n- Edge cases (empty states, errors)\n- UX friction points\n\n## LLM Testing Agent Prompt\n\n```\nYou are testing egghead.io's new Coursebuilder-based platform.\n\nYour mission: Find bugs, broken links, and UX issues.\n\nInstructions:\n1. Start at the homepage\n2. Explore all major sections: courses, lessons, search, pricing, profile\n3. Test as both:\n   - Free user (no auth)\n   - Pro user (authenticated, active subscription)\n4. Click every link you can find\n5. Try edge cases: empty search, invalid URLs, missing content\n6. Test mobile viewport (375px width)\n7. Check accessibility: keyboard navigation, screen reader labels\n\nFor each issue found, report:\n- URL where issue occurs\n- Steps to reproduce\n- Expected behavior\n- Actual behavior\n- Severity: critical/high/medium/low\n- Screenshot if applicable\n\nCritical issues to look for:\n- 404s or broken links\n- Paywall bypasses\n- Auth failures\n- Video player not loading\n- Progress not saving\n- Pricing/checkout errors\n- Mobile layout breaks\n```\n\n## Execution\n\n### Option A: Manual (Low-Tech)\n1. Share staging URL with Claude/GPT\n2. Paste prompt\n3. Agent navigates manually, reports findings\n4. Human triages and files beads\n\n### Option B: Automated (Browser Automation)\n```typescript\n// e2e/llm-exploratory/agent.ts\nimport { openai } from '@/lib/openai'\nimport { chromium } from 'playwright'\n\nasync function llmExplore() {\n  const browser = await chromium.launch({ headless: false })\n  const page = await browser.newPage()\n  \n  const findings: Issue[] = []\n  \n  // LLM decides what to click next\n  for (let i = 0; i \u003c 50; i++) {\n    const screenshot = await page.screenshot()\n    const html = await page.content()\n    \n    const decision = await openai.chat.completions.create({\n      model: 'gpt-4o',\n      messages: [\n        { role: 'system', content: EXPLORER_PROMPT },\n        { \n          role: 'user', \n          content: [\n            { type: 'text', text: `Current URL: ${page.url()}` },\n            { type: 'text', text: `Visible links: ${await getLinks(page)}` },\n            { type: 'image_url', image_url: { url: `data:image/png;base64,${screenshot.toString('base64')}` } }\n          ]\n        }\n      ]\n    })\n    \n    const action = JSON.parse(decision.choices[0].message.content)\n    \n    if (action.type === 'click') {\n      await page.click(action.selector)\n    } else if (action.type === 'report_issue') {\n      findings.push(action.issue)\n    } else if (action.type === 'done') {\n      break\n    }\n    \n    await page.waitForTimeout(1000)\n  }\n  \n  return findings\n}\n```\n\n## Output Document\n\n`reports/LLM-EXPLORATORY-RESULTS.md`:\n\n```markdown\n# LLM Exploratory Testing Results\n\n**Date:** 2025-01-XX\n**Agent:** Claude Sonnet 4 / GPT-4o\n**Duration:** XX minutes\n**Pages Explored:** XX\n\n## Summary\n- Critical issues: X\n- High priority: X\n- Medium priority: X\n- Low priority: X\n\n## Critical Issues\n\n### 1. Paywall bypass via direct lesson URL\n**URL:** /lessons/intro-to-react\n**Repro:**\n1. Navigate to lesson URL while logged out\n2. Video plays without restriction\n3. No paywall appears\n\n**Expected:** Soft block after 30s\n**Actual:** Full access without subscription\n**Severity:** Critical\n\n...\n\n## Accessibility Issues\n...\n\n## Mobile Issues\n...\n```\n\n## Integration with Beads\n\nFor each critical/high issue found:\n```typescript\nbeads_create({\n  title: issue.title,\n  description: issue.description,\n  type: 'bug',\n  priority: issue.severity === 'critical' ? 3 : 2\n})\n```\n\n## Files\n- `course-builder/apps/egghead/e2e/llm-exploratory/agent.ts`\n- `course-builder/apps/egghead/e2e/llm-exploratory/prompts.ts`\n- `reports/LLM-EXPLORATORY-RESULTS.md`\n\n## Acceptance Criteria\n- [ ] LLM explores all major sections\n- [ ] Findings document generated\n- [ ] No critical issues found (or all fixed)\n- [ ] High-priority issues triaged\n- [ ] Beads created for actionable items","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:29:45.022635-08:00","updated_at":"2025-12-11T11:23:51.192414-08:00","dependencies":[{"issue_id":"migrate-egghead-r52.9","depends_on_id":"migrate-egghead-r52","type":"parent-child","created_at":"2025-12-11T09:29:45.022981-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-sr4","title":"[HUMAN] Approve UI Architecture","description":"**HARD STOP - Agent must not proceed past this point without human approval**\n\n## Gate: Before Phase 5 (UI Components)\n\n### What Needs Review\n1. Component architecture (shadcn/ui based)\n2. Video player approach (NOT porting xstate complexity)\n3. Search UI (Typesense + InstantSearch)\n4. Route structure and redirects\n5. State management approach\n\n### Artifacts to Present\n- [ ] Component inventory with CB equivalents\n- [ ] Video player design (simple, Mux-native)\n- [ ] Search UI mockup/design\n- [ ] Route mapping (egghead URLs ‚Üí CB routes)\n- [ ] Redirect strategy\n\n### Approval Criteria\n- shadcn/ui centric, not porting egghead-next complexity\n- Video player is simple (no xstate)\n- All legacy URLs have redirects\n- Mobile responsive\n\n### How to Proceed\nAgent presents architecture ‚Üí Human reviews ‚Üí Human marks this bead closed with approval note ‚Üí Agent continues to implementation","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T10:53:51.640798-08:00","updated_at":"2025-12-11T10:53:51.640798-08:00"}
{"id":"migrate-egghead-test-custom-123","title":"Test Custom ID","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T09:19:44.669958-08:00","updated_at":"2025-12-12T09:19:49.694079-08:00","closed_at":"2025-12-12T09:19:49.694079-08:00"}
{"id":"migrate-egghead-tkd","title":"Essential Cron Jobs (Inngest)","description":"Port ESSENTIAL Sidekiq cron jobs to Inngest. Not all 17 - just the ones that break the site.\n\nEssential jobs:\n- StripeReconciler (daily) - catches webhook failures\n- GiftExpirationWorker (daily) - gifts must expire\n- RefreshSitemap (4h) - SEO critical\n- SignInTokenCleaner (1min) - magic links pile up\n- LessonPublishWorker (10min) - scheduled content\n\nSkip for now:\n- Report workers (daily/weekly/monthly) - nice to have\n- Ranker workers - can rebuild later\n- Podcast sync - low priority","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T09:53:51.704278-08:00","updated_at":"2025-12-12T09:25:57.201533-08:00","closed_at":"2025-12-12T09:25:57.201533-08:00"}
{"id":"migrate-egghead-tkd.1","title":"Port StripeReconciler to Inngest cron (daily)","description":"## Context\n\nPort the **StripeReconciler** daily background job from Rails/Sidekiq to Coursebuilder Inngest. This cron job runs daily at 11 PM Chicago time (`0 23 * * * America/Chicago`) to reconcile Stripe transactions with local database records.\n\n### What It Does\n\nThe StripeReconciler performs critical financial reconciliation:\n\n1. **Processes Stripe Charges** (last 24 hours)\n   - Fetches up to 5,000 charges from Stripe API\n   - Creates `Transaction` records for subscription payments\n   - Handles gift purchases separately (creates `Gift` + `Transaction`)\n   - Tracks suspicious subscriptions (charged but cancelled)\n\n2. **Processes Stripe Invoice Items** (last 24 hours)\n   - Finds unbilled invoice items\n   - Creates and pays invoices for active subscriptions\n   - Prevents unbilled charges from accumulating\n\n3. **Admin Notifications**\n   - Sends email digest if transactions created or suspicious subscriptions found\n   - Critical for financial oversight\n\n### Why This Matters\n\n- Ensures billing data stays in sync between Stripe and local DB\n- Catches edge cases where webhooks failed/missed\n- Provides audit trail via `Transaction` records\n- Alerts admins to anomalies (charged cancelled subscriptions)\n\n---\n\n## Files to Reference\n\n### Rails Implementation\n- `egghead-rails/app/workers/stripe_reconciler.rb` (lines 1-185) - Main worker logic\n- `egghead-rails/app/services/stripe_service.rb` - Stripe API wrapper methods\n- `egghead-rails/config/schedule.yml` (line 30-32) - Cron schedule config\n- `egghead-rails/app/models/transaction.rb` - Transaction model\n- `egghead-rails/app/models/subscription.rb` - Legacy subscription model\n- `egghead-rails/app/models/gift.rb` - Gift model\n\n### Coursebuilder Target\n- `course-builder/apps/egghead/src/inngest/inngest.config.ts` - Where to register new function\n- `course-builder/apps/ai-hero/src/inngest/functions/send-workshop-access-emails.ts` (line 18-23) - **Reference cron pattern**: `inngest.createFunction({ id, name }, { cron: 'TIME' }, handler)`\n- `course-builder/packages/core/src/inngest/stripe/` - Existing Stripe webhook handlers (context for Stripe SDK usage)\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/` - DB schemas for Organization, Subscription, etc.\n\n### Schema Mapping\n- `reports/COURSEBUILDER_SCHEMA_ANALYSIS.md` - Rails ‚Üí Coursebuilder table mapping\n- `reports/STRIPE_WEBHOOK_MIGRATION.md` - Stripe integration patterns\n\n---\n\n## Implementation Details\n\n### 1. Create Inngest Cron Function\n\n**File**: `course-builder/apps/egghead/src/inngest/functions/stripe-reconciler.ts`\n\n```typescript\nimport { inngest } from '@/inngest/inngest.server'\nimport { db } from '@/db'\nimport Stripe from 'stripe'\n\nexport const stripeReconciler = inngest.createFunction(\n  {\n    id: 'stripe-reconciler',\n    name: 'Reconcile Stripe Transactions Daily',\n  },\n  { cron: '0 23 * * * America/Chicago' }, // 11 PM Chicago (same as Rails)\n  async ({ event, step }) =\u003e {\n    // Implementation here\n  }\n)\n```\n\n### 2. Core Logic Steps\n\nUse Inngest `step.run()` for each phase:\n\n```typescript\n// Step 1: Fetch charges from last 24 hours\nconst charges = await step.run('fetch-stripe-charges', async () =\u003e {\n  const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!)\n  const yesterday = Math.floor(Date.now() / 1000) - 86400\n  const now = Math.floor(Date.now() / 1000)\n  \n  return stripe.charges.list({\n    limit: 100,\n    created: { gte: yesterday, lt: now }\n  })\n  // Iterate with auto_paging_iter for \u003e100 charges (see Rails iterate_items pattern)\n})\n\n// Step 2: Process each charge\nawait step.run('process-charges', async () =\u003e {\n  for (const charge of charges) {\n    if (charge.status !== 'succeeded') continue\n    \n    // Check if gift purchase\n    if (charge.metadata?.gift) {\n      await processGift(charge)\n      continue\n    }\n    \n    // Regular subscription charge\n    await processSubscriptionCharge(charge)\n  }\n})\n\n// Step 3: Process invoice items (similar pattern)\n// Step 4: Send admin notification if needed\n```\n\n### 3. Schema Translation Gotchas\n\n| Rails Concept | Coursebuilder Equivalent | Notes |\n|---------------|--------------------------|-------|\n| `Subscription.find_by_stripe_customer_id(id)` | Query `MerchantCustomer` ‚Üí `Organization` ‚Üí `Subscription` | Multi-table join required |\n| `Transaction.stripe_id` | May need new field or use `Purchase.merchantChargeId` | Check schema first |\n| `subscription.plan` | `Subscription.productId` reference | Different foreign key |\n| `Gift.stripe_id` | Same model name, verify schema exists in CB | May need migration |\n\n### 4. Stripe SDK Usage\n\n- Use `step.run()` for each Stripe API call (retry on transient failures)\n- Batch charges/invoice items with `auto_paging_iter` for \u003e100 results\n- Set `maxRetries` in Stripe client config\n- Log liberally using `await log.info()` pattern from Coursebuilder\n\n### 5. Admin Notifications\n\n- Port `AdminMailer.stripe_reconciliation` to Coursebuilder email system\n- Use `sendAnEmail()` pattern from existing functions\n- Include summary: transactions created, suspicious subscriptions, errors\n\n---\n\n## Acceptance Criteria\n\n- [ ] Inngest function runs daily at 11 PM Chicago time\n- [ ] Fetches last 24 hours of Stripe charges and invoice items\n- [ ] Creates Transaction/Purchase records for new charges (dedupe by `stripe_id`)\n- [ ] Handles gift purchases separately\n- [ ] Identifies suspicious subscriptions (charged but cancelled)\n- [ ] Sends admin email digest with summary\n- [ ] Logs execution metrics (charges processed, transactions created, errors)\n- [ ] Handles Stripe API pagination (\u003e100 charges)\n- [ ] Retries transient failures (rate limits, network errors)\n- [ ] Test locally with Inngest Dev Server: `npx inngest-cli@latest dev`\n- [ ] Verify no duplicate transactions created on re-runs\n\n---\n\n## Dependencies\n\n**Must complete BEFORE starting this task:**\n\n1. ‚úÖ Schema analysis complete (`COURSEBUILDER_SCHEMA_ANALYSIS.md` exists)\n2. ‚è≥ `Transaction` model exists in Coursebuilder (or equivalent `Purchase` with `merchantChargeId`)\n3. ‚è≥ `Gift` model migrated to Coursebuilder schema\n4. ‚è≥ Stripe environment variables configured (`STRIPE_SECRET_KEY`)\n5. ‚è≥ Admin email sending configured in Coursebuilder\n\n**Blockers to check:**\n- Does Coursebuilder have a `Transaction` table? Or should we use `Purchase`?\n- Is `Gift` model already migrated? (check `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/`)\n\n---\n\n## Testing Strategy\n\n1. **Local Dev**: Use Inngest Dev Server (`npx inngest-cli dev`)\n2. **Manual Trigger**: Send test event via Inngest UI to trigger function\n3. **Stripe Test Mode**: Create test charges in Stripe dashboard\n4. **Verify**:\n   - Check DB for new Transaction/Purchase records\n   - Verify no duplicates on re-run (idempotency via `stripe_id`)\n   - Confirm admin email sent with correct summary\n5. **Production**: Deploy and monitor first run via Inngest dashboard\n\n---\n\n## Notes\n\n- **Idempotency**: Use `Transaction.exists?(stripe_id: balance_transaction.id)` pattern before creating\n- **Time zones**: Rails uses `America/Chicago`, keep same for consistency\n- **Pagination**: Rails processes max 5,000 charges - maintain same limit or document increase\n- **Error handling**: Log errors, don't fail entire job if one charge fails\n- **Monitoring**: Add Inngest metrics/logging for financial reconciliation visibility","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:51.739-08:00","updated_at":"2025-12-11T11:04:30.533302-08:00","dependencies":[{"issue_id":"migrate-egghead-tkd.1","depends_on_id":"migrate-egghead-tkd","type":"parent-child","created_at":"2025-12-11T09:53:51.739353-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-tkd.10","title":"Migrate instructor data to ContentContribution","description":"Populate ContentContribution table with egghead instructor ‚Üí lesson mappings.\n\n**Data to migrate:**\n1. Rails `Instructor` ‚Üí CB `User` (may already exist from user migration)\n2. Rails `Lesson.instructor_id` ‚Üí `ContentContribution.userId`\n3. Rails `Lesson.id` ‚Üí `ContentContribution.contentId`\n4. Rails `InstructorRevenueSplit.percentage` ‚Üí `ContentContribution.metadata.percentageSplit`\n\n**ContributionTypes to create:**\n- `instructor` (primary, default 50% split)\n- `co-instructor` (split evenly among co-instructors)\n- `mentor` (% of mentee revenue)\n\n**Handle:**\n- Co-instructors (lesson_coinstructors table)\n- Mentor relationships (instructor_revenue_splits with credit_to_instructor_id)\n- Revenue share percentages per instructor\n\n**Script location:** `apps/egghead/src/scripts/migrate-instructor-contributions.ts`","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:32:47.939592-08:00","updated_at":"2025-12-11T10:32:47.939592-08:00","dependencies":[{"issue_id":"migrate-egghead-tkd.10","depends_on_id":"migrate-egghead-tkd","type":"parent-child","created_at":"2025-12-11T10:32:47.93993-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-tkd.11","title":"Build monthly revenue share Inngest function","description":"Inngest cron function to calculate and record monthly instructor payouts.\n\n**Trigger:** `cron: '0 0 1 * *'` (1st of month at midnight)\n\n**Steps:**\n1. Get period (previous month)\n2. Query total poolable revenue from transactions\n3. Query LessonProgress joined with ContentContribution\n4. Calculate per-instructor segments and amounts\n5. Insert ContributorRevenueSplit records\n6. Send instructor report emails (for amounts \u003e= $20)\n\n**See migrate-egghead-tkd.7 for full implementation code.**\n\n**Location:** `apps/egghead/src/inngest/functions/monthly-revenue-share.ts`\n\n**Testing:**\n- Unit test calculation logic\n- Integration test with sample data\n- Validate against historical Rails payouts","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:32:51.851218-08:00","updated_at":"2025-12-11T10:32:51.851218-08:00","dependencies":[{"issue_id":"migrate-egghead-tkd.11","depends_on_id":"migrate-egghead-tkd","type":"parent-child","created_at":"2025-12-11T10:32:51.851583-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-tkd.12","title":"Port AccountSubscriptionRenewalWorker to Inngest","description":"Daily job to send renewal reminder emails to subscribers.\n\n**Rails source:** `app/workers/account_subscription_renewal_worker.rb`\n**Schedule:** Daily at 10 minutes past midnight\n\n**Functionality:**\n- Find subscriptions expiring in X days\n- Send reminder email via Customer.io or Resend\n- Track which reminders have been sent (avoid duplicates)\n\n**Inngest function:** `apps/egghead/src/inngest/functions/subscription-renewal-reminders.ts`","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T10:32:54.936184-08:00","updated_at":"2025-12-11T10:32:54.936184-08:00","dependencies":[{"issue_id":"migrate-egghead-tkd.12","depends_on_id":"migrate-egghead-tkd","type":"parent-child","created_at":"2025-12-11T10:32:54.936573-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-tkd.2","title":"Port GiftExpirationWorker to Inngest cron (daily)","description":"## Context\n\nPort the **GiftExpirationWorker** daily background job from Rails/Sidekiq to Coursebuilder Inngest. This cron job runs daily at 12:15 AM Chicago time (`15 0 * * * America/Chicago`) to manage gift subscription lifecycles.\n\n### What It Does\n\nThe GiftExpirationWorker handles two critical gift subscription workflows:\n\n1. **Notify Owners of Impending Expiration**\n   - Finds gift subscriptions expiring in 7 days\n   - Sends reminder emails to gift recipients\n   - Uses 7-day window to avoid duplicate reminders\n   - Different email for renewals vs expirations (based on `cancel_at_period_end`)\n\n2. **Update Expired Gift Subscriptions**\n   - Finds gift subscriptions that have expired\n   - Disables the subscription\n   - Removes access permissions\n   - Notifies the owner their gift has expired\n\n### Why This Matters\n\n- **User Experience**: Gift recipients get 7-day advance notice before losing access\n- **Access Control**: Prevents expired gifts from retaining Pro access\n- **Revenue**: Renewal reminders encourage conversions to paid subscriptions\n- **Data Integrity**: Keeps subscription status in sync with expiration dates\n\n---\n\n## Files to Reference\n\n### Rails Implementation\n- `egghead-rails/app/workers/gift_expiration_worker.rb` (lines 1-8) - Thin worker wrapper\n- `egghead-rails/app/models/gift/monitor.rb` (lines 1-44) - **Core logic here**\n- `egghead-rails/app/models/gift/expiration.rb` - Handles reminder sending and disabling\n- `egghead-rails/app/models/gift.rb` (lines 1-41) - Gift model with duration logic\n- `egghead-rails/app/models/account_subscription.rb` - Subscription scopes (`.gift`, `.expiring`, `.expired`)\n- `egghead-rails/config/schedule.yml` (line 6-8) - Cron schedule config\n\n### Coursebuilder Target\n- `course-builder/apps/egghead/src/inngest/inngest.config.ts` - Where to register new function\n- `course-builder/apps/ai-hero/src/inngest/functions/send-workshop-access-emails.ts` (line 18-23) - **Reference cron pattern**: `inngest.createFunction({ id, name }, { cron: 'TIME' }, handler)`\n- `course-builder/packages/adapter-drizzle/src/lib/mysql/schemas/` - DB schemas for Subscription, Organization, User\n- `course-builder/packages/core/src/lib/` - Email sending utilities\n\n### Schema Mapping\n- `reports/COURSEBUILDER_SCHEMA_ANALYSIS.md` - Rails ‚Üí Coursebuilder table mapping (see `AccountSubscription` ‚Üí `Subscription` + `MerchantSubscription`)\n- Gift subscriptions in Rails have `gift: true` flag - need to verify Coursebuilder equivalent\n\n---\n\n## Implementation Details\n\n### 1. Create Inngest Cron Function\n\n**File**: `course-builder/apps/egghead/src/inngest/functions/gift-expiration-monitor.ts`\n\n```typescript\nimport { inngest } from '@/inngest/inngest.server'\nimport { db } from '@/db'\nimport { sendAnEmail } from '@/utils/send-an-email'\n\nexport const giftExpirationMonitor = inngest.createFunction(\n  {\n    id: 'gift-expiration-monitor',\n    name: 'Monitor Gift Subscription Expirations',\n  },\n  { cron: '15 0 * * * America/Chicago' }, // 12:15 AM Chicago (same as Rails)\n  async ({ event, step }) =\u003e {\n    // Implementation here\n  }\n)\n```\n\n### 2. Core Logic Steps\n\nUse Inngest `step.run()` for each phase:\n\n```typescript\n// Step 1: Notify owners of impending expiration (7 days out)\nconst remindersResult = await step.run('send-expiration-reminders', async () =\u003e {\n  // Find gift subscriptions expiring in 7 days\n  const sevenDaysFromNow = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)\n  const startOfDay = new Date(sevenDaysFromNow.setUTCHours(0, 0, 0, 0))\n  const endOfDay = new Date(sevenDaysFromNow.setUTCHours(23, 59, 59, 999))\n  \n  const expiringGifts = await db.query.subscriptions.findMany({\n    where: and(\n      eq(subscriptions.status, 'active'),\n      eq(subscriptions.fields.gift, true), // Check if 'gift' flag exists\n      gte(subscriptions.currentPeriodEnd, startOfDay.getTime() / 1000),\n      lte(subscriptions.currentPeriodEnd, endOfDay.getTime() / 1000)\n    ),\n    with: { user: true, organization: true }\n  })\n  \n  let remindersSent = 0\n  for (const subscription of expiringGifts) {\n    // Send reminder email (renewal vs expiration based on cancelAtPeriodEnd)\n    await sendGiftExpirationReminder(subscription)\n    remindersSent++\n  }\n  \n  return { remindersSent, giftsChecked: expiringGifts.length }\n})\n\n// Step 2: Disable expired gift subscriptions\nconst expiredResult = await step.run('disable-expired-gifts', async () =\u003e {\n  const now = Math.floor(Date.now() / 1000)\n  \n  const expiredGifts = await db.query.subscriptions.findMany({\n    where: and(\n      eq(subscriptions.status, 'active'),\n      eq(subscriptions.fields.gift, true),\n      eq(subscriptions.cancelAtPeriodEnd, true),\n      lt(subscriptions.currentPeriodEnd, now)\n    ),\n    with: { user: true }\n  })\n  \n  let subscriptionsDisabled = 0\n  for (const subscription of expiredGifts) {\n    // Disable subscription + remove access\n    await disableGiftSubscription(subscription)\n    subscriptionsDisabled++\n  }\n  \n  return { subscriptionsDisabled, giftsChecked: expiredGifts.length }\n})\n\n// Step 3: Log summary\nawait log.info('Gift expiration monitoring complete', {\n  remindersSent: remindersResult.remindersSent,\n  subscriptionsDisabled: expiredResult.subscriptionsDisabled,\n})\n```\n\n### 3. Schema Translation Gotchas\n\n| Rails Concept | Coursebuilder Equivalent | Notes |\n|---------------|--------------------------|-------|\n| `AccountSubscription.gift` scope | `subscriptions.fields.gift = true` OR custom flag | **Verify gift flagging in CB schema** |\n| `AccountSubscription.expiring` | `currentPeriodEnd BETWEEN 7days_start AND 7days_end` | Custom query with date math |\n| `AccountSubscription.expired` | `currentPeriodEnd \u003c NOW() AND cancelAtPeriodEnd = true` | Combine conditions |\n| `Gift::Expiration.queue_reminder!` | `sendAnEmail()` with gift expiration template | Need to create email component |\n| `Gift::Expiration.disable_subscription!` | Update `subscriptions.status = 'canceled'` + remove entitlements | Multi-table update |\n\n### 4. Gift Detection Strategy\n\n**Option A**: Use `subscription.fields.gift = true` (if migrated)\n**Option B**: Query `Gift` table for `account_subscription_id` reference\n**Option C**: Check `MerchantSubscription.metadata` for gift flag\n\n**ACTION**: Verify which approach Coursebuilder uses before implementing.\n\n### 5. Email Templates Needed\n\nCreate two React Email components:\n\n1. **Gift Expiration Reminder** (7 days before)\n   - Subject: \"Your egghead gift subscription expires in 7 days\"\n   - CTA: Upgrade to paid subscription\n   \n2. **Gift Renewal Reminder** (if `cancelAtPeriodEnd = false`)\n   - Subject: \"Your egghead gift subscription renews in 7 days\"\n   - Info: Automatic renewal details\n\n3. **Gift Expired Notification**\n   - Subject: \"Your egghead gift subscription has ended\"\n   - CTA: Purchase new subscription\n\n### 6. Access Removal Logic\n\nWhen disabling gift subscription:\n```typescript\n// 1. Update subscription status\nawait db.update(subscriptions)\n  .set({ status: 'canceled', updatedAt: new Date() })\n  .where(eq(subscriptions.id, subscription.id))\n\n// 2. Remove Pro entitlements\nawait db.delete(entitlements)\n  .where(and(\n    eq(entitlements.userId, subscription.userId),\n    eq(entitlements.sourceType, 'subscription'),\n    eq(entitlements.sourceId, subscription.id)\n  ))\n\n// 3. Send notification email\n```\n\n---\n\n## Acceptance Criteria\n\n- [ ] Inngest function runs daily at 12:15 AM Chicago time\n- [ ] Identifies gift subscriptions expiring in exactly 7 days (24-hour window)\n- [ ] Sends expiration reminder emails (different content for renewals)\n- [ ] Finds gift subscriptions that expired yesterday\n- [ ] Disables expired subscriptions (status = 'canceled')\n- [ ] Removes Pro access entitlements for expired gifts\n- [ ] Sends expiration notification emails to affected users\n- [ ] Logs execution metrics (reminders sent, subscriptions disabled)\n- [ ] No duplicate reminders sent (7-day window prevents re-sending)\n- [ ] Test locally with Inngest Dev Server: `npx inngest-cli@latest dev`\n- [ ] Verify idempotency (re-running doesn't send duplicate emails)\n\n---\n\n## Dependencies\n\n**Must complete BEFORE starting this task:**\n\n1. ‚úÖ Schema analysis complete (`COURSEBUILDER_SCHEMA_ANALYSIS.md` exists)\n2. ‚è≥ Gift flagging mechanism in Coursebuilder (verify `subscription.fields.gift` or `Gift` table exists)\n3. ‚è≥ Email templates created (gift expiration, renewal, expired)\n4. ‚è≥ Email sending configured in Coursebuilder (`sendAnEmail` works)\n5. ‚è≥ Entitlements system migrated (for access removal)\n\n**Blockers to check:**\n- How are gift subscriptions identified in Coursebuilder? (`fields.gift`? Separate table?)\n- What's the entitlements removal pattern? (see existing examples)\n\n---\n\n## Testing Strategy\n\n1. **Local Dev**: Use Inngest Dev Server (`npx inngest-cli dev`)\n2. **Manual Trigger**: Send test event via Inngest UI\n3. **Test Data Setup**:\n   - Create gift subscription expiring in 7 days\n   - Create gift subscription expired yesterday\n   - Verify emails sent\n   - Verify subscription disabled + access removed\n4. **Edge Cases**:\n   - Gift expiring in 6 days (should skip)\n   - Gift expiring in 8 days (should skip)\n   - Already disabled gift (should skip)\n   - Gift without user email (error handling)\n5. **Production**: Deploy and monitor first run via Inngest dashboard\n\n---\n\n## Notes\n\n- **7-day window**: Rails uses `[7.days.from_now.beginning_of_day, 7.days.from_now.end_of_day]` to avoid duplicate reminders - maintain same logic\n- **Time zones**: Rails uses `America/Chicago`, keep same for consistency\n- **Renewal vs Expiration**: Check `cancelAtPeriodEnd` flag to determine email content\n- **Gift duration**: Default 12 months (`duration_months || 12`)\n- **Error handling**: Log errors, don't fail entire job if one gift fails\n- **Monitoring**: Add Inngest metrics for gift lifecycle tracking\n- **Email templates**: Reuse Coursebuilder's existing email component patterns (see `send-workshop-access-emails.ts` for reference)","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-11T09:53:51.777292-08:00","updated_at":"2025-12-11T11:05:15.727614-08:00","dependencies":[{"issue_id":"migrate-egghead-tkd.2","depends_on_id":"migrate-egghead-tkd","type":"parent-child","created_at":"2025-12-11T09:53:51.777601-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-tkd.3","title":"Port RefreshSitemap to Inngest cron (every 4h)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:51.81391-08:00","updated_at":"2025-12-11T09:53:51.81391-08:00","dependencies":[{"issue_id":"migrate-egghead-tkd.3","depends_on_id":"migrate-egghead-tkd","type":"parent-child","created_at":"2025-12-11T09:53:51.814239-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-tkd.4","title":"Port SignInTokenCleaner to Inngest cron (every minute)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:51.851468-08:00","updated_at":"2025-12-11T09:53:51.851468-08:00","dependencies":[{"issue_id":"migrate-egghead-tkd.4","depends_on_id":"migrate-egghead-tkd","type":"parent-child","created_at":"2025-12-11T09:53:51.851806-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-tkd.5","title":"Port LessonPublishWorker to Inngest cron (every 10min)","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T09:53:51.886776-08:00","updated_at":"2025-12-11T09:53:51.886776-08:00","dependencies":[{"issue_id":"migrate-egghead-tkd.5","depends_on_id":"migrate-egghead-tkd","type":"parent-child","created_at":"2025-12-11T09:53:51.887086-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-tkd.6","title":"Port AccountSubscriptionRenewalWorker (daily renewal reminders)","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T09:53:51.91783-08:00","updated_at":"2025-12-11T09:53:51.91783-08:00","dependencies":[{"issue_id":"migrate-egghead-tkd.6","depends_on_id":"migrate-egghead-tkd","type":"parent-child","created_at":"2025-12-11T09:53:51.918141-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-tkd.7","title":"Investigate royalty calculation - entitlement-based approach viable?","description":"## Investigation Complete - REVISED APPROACH\n\n### Decision: Build New System on CB Schema, Don't Port Rails\n\nThe Rails revenue share system uses Plutus double-entry accounting with 600+ lines of complex SQL. Instead of porting, we'll build a simpler system using existing Coursebuilder schemas.\n\n### Existing CB Tables We'll Use\n\n```\nContentContribution\n‚îú‚îÄ‚îÄ userId (instructor)\n‚îú‚îÄ‚îÄ contentId (lesson)\n‚îú‚îÄ‚îÄ contributionTypeId ('instructor', 'co-instructor', 'mentor')\n‚îú‚îÄ‚îÄ metadata: { percentageSplit: 0.50, ... }\n‚îî‚îÄ‚îÄ active\n\nContributionType\n‚îú‚îÄ‚îÄ slug: 'instructor' | 'co-instructor' | 'mentor' | 'affiliate'\n‚îú‚îÄ‚îÄ name\n‚îî‚îÄ‚îÄ description\n\nLessonProgress (view tracking)\n‚îú‚îÄ‚îÄ userId (viewer)\n‚îú‚îÄ‚îÄ lessonId\n‚îú‚îÄ‚îÄ completedAt\n‚îî‚îÄ‚îÄ createdAt\n\nEntitlement\n‚îú‚îÄ‚îÄ userId | organizationId\n‚îú‚îÄ‚îÄ entitlementType: 'pro_access' | 'contributor_revenue_share'\n‚îú‚îÄ‚îÄ sourceType: 'SUBSCRIPTION' | 'PURCHASE'\n‚îú‚îÄ‚îÄ sourceId\n‚îú‚îÄ‚îÄ metadata: { ... }\n‚îî‚îÄ‚îÄ expiresAt\n```\n\n### New Table Needed: ContributorRevenueSplit\n\n```typescript\n// Add to commerce schemas\nexport function getContributorRevenueSplitSchema(mysqlTable: MySqlTableFn) {\n  return mysqlTable('ContributorRevenueSplit', {\n    id: varchar('id', { length: 191 }).notNull().primaryKey(),\n    \n    // Who gets paid\n    userId: varchar('userId', { length: 191 }).notNull(),\n    \n    // What period\n    periodStart: timestamp('periodStart', { mode: 'date', fsp: 3 }).notNull(),\n    periodEnd: timestamp('periodEnd', { mode: 'date', fsp: 3 }).notNull(),\n    \n    // Calculation inputs\n    totalRevenue: decimal('totalRevenue', { precision: 10, scale: 2 }).notNull(),\n    totalSegments: int('totalSegments').notNull(),\n    userSegments: int('userSegments').notNull(),\n    percentageSplit: decimal('percentageSplit', { precision: 5, scale: 4 }).notNull(),\n    \n    // Result\n    amount: decimal('amount', { precision: 10, scale: 2 }).notNull(),\n    \n    // Status\n    status: varchar('status', { length: 50 }).default('pending').notNull(), // pending | paid | held\n    paidAt: timestamp('paidAt', { mode: 'date', fsp: 3 }),\n    \n    // Audit trail\n    metadata: json('metadata').$type\u003c{\n      lessonBreakdown?: Record\u003cstring, number\u003e, // lessonId -\u003e segments\n      calculationVersion?: string,\n      notes?: string,\n    }\u003e().default({}),\n    \n    createdAt: timestamp('createdAt', { mode: 'date', fsp: 3 }).defaultNow(),\n    updatedAt: timestamp('updatedAt', { mode: 'date', fsp: 3 }).defaultNow(),\n  }, (table) =\u003e ({\n    userIdIdx: index('userId_idx').on(table.userId),\n    periodIdx: index('period_idx').on(table.periodStart, table.periodEnd),\n    statusIdx: index('status_idx').on(table.status),\n  }))\n}\n```\n\n### Monthly Revenue Share Inngest Function\n\n```typescript\n// inngest/functions/monthly-revenue-share.ts\nexport const monthlyRevenueShare = inngest.createFunction(\n  { id: 'monthly-revenue-share' },\n  { cron: '0 0 1 * *' }, // 1st of month\n  async ({ step }) =\u003e {\n    const period = await step.run('get-period', () =\u003e {\n      const now = new Date()\n      return {\n        start: startOfMonth(subMonths(now, 1)),\n        end: endOfMonth(subMonths(now, 1)),\n      }\n    })\n\n    // 1. Get total revenue for period\n    const totalRevenue = await step.run('get-revenue', () =\u003e\n      db.select({ amount: sum(transactions.amount) })\n        .from(transactions)\n        .where(and(\n          gte(transactions.createdAt, period.start),\n          lte(transactions.createdAt, period.end),\n          eq(transactions.pool, true) // Only poolable revenue\n        ))\n    )\n\n    // 2. Get lesson views with instructor attribution\n    const viewsByInstructor = await step.run('get-views', () =\u003e\n      db.select({\n        lessonId: lessonProgress.lessonId,\n        instructorId: contentContributions.userId,\n        percentageSplit: sql`JSON_EXTRACT(${contentContributions.metadata}, '$.percentageSplit')`,\n        viewCount: count(),\n      })\n      .from(lessonProgress)\n      .innerJoin(contentContributions, \n        eq(lessonProgress.lessonId, contentContributions.contentId))\n      .innerJoin(contributionTypes,\n        eq(contentContributions.contributionTypeId, contributionTypes.id))\n      .where(and(\n        gte(lessonProgress.completedAt, period.start),\n        lte(lessonProgress.completedAt, period.end),\n        eq(contributionTypes.slug, 'instructor'),\n        eq(contentContributions.active, true),\n      ))\n      .groupBy(lessonProgress.lessonId, contentContributions.userId)\n    )\n\n    // 3. Calculate totals and per-instructor amounts\n    const totalViews = viewsByInstructor.reduce((sum, v) =\u003e sum + v.viewCount, 0)\n    const valuePerView = totalRevenue / totalViews\n\n    // 4. Group by instructor and calculate payouts\n    const payouts = await step.run('calculate-payouts', () =\u003e {\n      const byInstructor = new Map()\n      \n      for (const view of viewsByInstructor) {\n        const current = byInstructor.get(view.instructorId) || { \n          segments: 0, \n          breakdown: {} \n        }\n        const split = view.percentageSplit || 0.5 // default 50%\n        const segments = view.viewCount * split\n        \n        current.segments += segments\n        current.breakdown[view.lessonId] = segments\n        byInstructor.set(view.instructorId, current)\n      }\n      \n      return Array.from(byInstructor.entries()).map(([instructorId, data]) =\u003e ({\n        userId: instructorId,\n        userSegments: data.segments,\n        amount: data.segments * valuePerView,\n        lessonBreakdown: data.breakdown,\n      }))\n    })\n\n    // 5. Insert revenue split records\n    await step.run('insert-splits', () =\u003e\n      db.insert(contributorRevenueSplits).values(\n        payouts.map(p =\u003e ({\n          id: createId(),\n          userId: p.userId,\n          periodStart: period.start,\n          periodEnd: period.end,\n          totalRevenue,\n          totalSegments: totalViews,\n          userSegments: p.userSegments,\n          percentageSplit: p.userSegments / totalViews,\n          amount: p.amount,\n          status: p.amount \u003e= 100 ? 'pending' : 'held', // Min payout threshold\n          metadata: { lessonBreakdown: p.lessonBreakdown },\n        }))\n      )\n    )\n\n    // 6. Send notification emails\n    await step.run('send-emails', async () =\u003e {\n      for (const payout of payouts.filter(p =\u003e p.amount \u003e= 20)) {\n        await inngest.send({\n          name: 'email/instructor-monthly-report',\n          data: { userId: payout.userId, periodStart: period.start },\n        })\n      }\n    })\n\n    return { processed: payouts.length, totalPaid: payouts.reduce((s, p) =\u003e s + p.amount, 0) }\n  }\n)\n```\n\n### Migration Path\n\n1. **Add ContributorRevenueSplit table** to CB schema\n2. **Populate ContentContribution** for all egghead instructors\n   - Map Rails `Instructor` ‚Üí CB `User`\n   - Map Rails `Lesson.instructor_id` ‚Üí `ContentContribution`\n   - Set `metadata.percentageSplit` from `InstructorRevenueSplit`\n3. **Add ContributionTypes**: 'instructor', 'co-instructor', 'mentor'\n4. **Build Inngest function** (above)\n5. **Backfill historical splits** (optional, for reporting continuity)\n\n### What We're NOT Porting\n\n- ‚ùå Plutus double-entry accounting\n- ‚ùå Per-series liability accounts\n- ‚ùå Rollup entries\n- ‚ùå Sellable-specific calculations (egghead doesn't use these)\n- ‚ùå Wildcard revenue splits (simplify to explicit contributions)\n\n### What We're Keeping\n\n- ‚úÖ View-based revenue share (fair for subscription model)\n- ‚úÖ Co-instructor splits\n- ‚úÖ Minimum payout threshold ($100)\n- ‚úÖ Monthly calculation cycle\n- ‚úÖ Instructor email reports\n\n### Advances (Deferred)\n\nThe Rails system supports \"advances\" (pre-paying instructors against future earnings). This is complex and rarely used. **Defer to post-migration** - can add `advanceBalance` to User or separate table if needed.\n\n### Effort Estimate\n\n- Schema addition: 0.5 day\n- ContentContribution migration: 0.5 day  \n- Inngest function: 1 day\n- Testing with historical data: 1 day\n- **Total: 3 days**\n\n### Files Reference\n\n**Rails (for data migration):**\n- `app/models/instructor.rb` - instructor data\n- `app/models/instructor_revenue_split.rb` - percentage splits\n- `app/models/lesson.rb` - lesson ‚Üí instructor mapping\n\n**Coursebuilder (to modify):**\n- `packages/adapter-drizzle/src/lib/mysql/schemas/commerce/` - add ContributorRevenueSplit\n- `apps/egghead/src/inngest/` - add monthly-revenue-share function","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T10:26:36.456359-08:00","updated_at":"2025-12-11T10:32:36.717643-08:00","closed_at":"2025-12-11T10:32:36.717643-08:00","dependencies":[{"issue_id":"migrate-egghead-tkd.7","depends_on_id":"migrate-egghead-tkd","type":"parent-child","created_at":"2025-12-11T10:26:36.456742-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-tkd.8","title":"Audit cron workers - which are truly essential?","description":"## Audit Complete\n\n### All 17 Rails Cron Jobs Analyzed\n\n| Job | Schedule | Verdict | Reason |\n|-----|----------|---------|--------|\n| **StripeReconciler** | Daily 11pm | **PORT** | Catches missed webhooks - critical |\n| **GiftExpirationWorker** | Daily | **PORT** | Gift subscriptions must expire |\n| **MonthlyReportWorker** | 1st of month | **PORT** | Revenue share - see tkd.7 |\n| **LessonPublishWorker** | Every 10min | **SKIP** | CB doesn't have scheduled publishing yet, can add later |\n| **RefreshSitemap** | Every 4h | **SKIP** | CB uses Next.js native sitemap.ts - generates on-demand |\n| **SignInTokenCleaner** | Every minute | **SKIP** | CB handles via session expiry, tokens have TTL |\n| **PlaylistRanker** | 2x daily | **DEFER** | Nice-to-have, can rebuild ranking logic later |\n| **TagRanker** | Daily | **DEFER** | Nice-to-have, can rebuild later |\n| **AccountSubscriptionRenewalWorker** | Daily | **PORT** | Renewal reminder emails - good UX |\n| **DailyReportWorker** | Daily | **SKIP** | Admin convenience only |\n| **WeeklyReportWorker** | Weekly | **SKIP** | Empty/dead code |\n| **DailyMemberPromptEmailWorker** | Daily | **SKIP** | Marketing email, can add later |\n| **SamlProviderExpiration** | Daily | **DEFER** | Only ~15 enterprise accounts |\n| **RunHourlySummaryTables** | Hourly | **SKIP** | Analytics aggregation, rebuild if needed |\n| **SyncPodcastsWorker** | Every 10min | **SKIP** | Low priority |\n| **SellablePurchasesDigestWorker** | Daily | **SKIP** | Admin digest |\n| **CleanUnusedParityCoupons** | Daily | **SKIP** | Cleanup, can add later |\n\n### Essential Jobs to Port (4)\n1. **StripeReconciler** - Already in tkd.1\n2. **GiftExpirationWorker** - Already in tkd.2\n3. **MonthlyReportWorker** - Covered by tkd.7\n4. **AccountSubscriptionRenewalWorker** - NEW - add subtask\n\n### Summary\n- **PORT NOW:** 4 jobs\n- **DEFER:** 3 jobs (rankers, SAML)\n- **SKIP:** 10 jobs (handled by CB, dead code, or low priority)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T10:26:41.475033-08:00","updated_at":"2025-12-11T10:32:39.7545-08:00","closed_at":"2025-12-11T10:32:39.7545-08:00","dependencies":[{"issue_id":"migrate-egghead-tkd.8","depends_on_id":"migrate-egghead-tkd","type":"parent-child","created_at":"2025-12-11T10:26:41.475417-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-tkd.9","title":"Add ContributorRevenueSplit schema to Coursebuilder","description":"Add new table to track monthly instructor payouts.\n\n**Location:** `packages/adapter-drizzle/src/lib/mysql/schemas/commerce/contributor-revenue-split.ts`\n\n**Schema:** See migrate-egghead-tkd.7 description for full schema definition.\n\n**Key fields:**\n- userId, periodStart, periodEnd\n- totalRevenue, totalSegments, userSegments\n- percentageSplit, amount\n- status (pending/paid/held)\n- metadata (lessonBreakdown, calculationVersion)\n\n**Also add:**\n- Relations to User\n- Export from index\n- Migration file","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:32:42.768009-08:00","updated_at":"2025-12-11T10:32:42.768009-08:00","dependencies":[{"issue_id":"migrate-egghead-tkd.9","depends_on_id":"migrate-egghead-tkd","type":"parent-child","created_at":"2025-12-11T10:32:42.768407-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-u6b","title":"UI Migration Exploration: egghead-next ‚Üí Coursebuilder","description":"Research and document UI feature mapping from egghead-next to course-builder/apps/egghead. Analyze: user/account management, subscriptions, search, content gating, lessons, posts, courses.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T08:43:03.422922-08:00","updated_at":"2025-12-11T08:47:54.790181-08:00","closed_at":"2025-12-11T08:47:54.790181-08:00"}
{"id":"migrate-egghead-u6b.1","title":"Analyze egghead-next: User \u0026 Account Management","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T08:43:03.461063-08:00","updated_at":"2025-12-11T08:46:24.663845-08:00","closed_at":"2025-12-11T08:46:24.663845-08:00","dependencies":[{"issue_id":"migrate-egghead-u6b.1","depends_on_id":"migrate-egghead-u6b","type":"parent-child","created_at":"2025-12-11T08:43:03.461422-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-u6b.2","title":"Analyze egghead-next: Subscription \u0026 Payment UI","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T08:43:03.504616-08:00","updated_at":"2025-12-11T08:46:25.464998-08:00","closed_at":"2025-12-11T08:46:25.464998-08:00","dependencies":[{"issue_id":"migrate-egghead-u6b.2","depends_on_id":"migrate-egghead-u6b","type":"parent-child","created_at":"2025-12-11T08:43:03.504977-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-u6b.3","title":"Analyze egghead-next: Search Implementation","description":"Analyzed egghead-next search implementation - Typesense-powered InstantSearch with comprehensive filtering and curated landing pages","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T08:43:03.538367-08:00","updated_at":"2025-12-11T08:46:26.242576-08:00","closed_at":"2025-12-11T08:46:26.242576-08:00","dependencies":[{"issue_id":"migrate-egghead-u6b.3","depends_on_id":"migrate-egghead-u6b","type":"parent-child","created_at":"2025-12-11T08:43:03.538733-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-u6b.4","title":"Analyze egghead-next: Content Types (lessons, posts, courses)","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T08:43:03.571718-08:00","updated_at":"2025-12-11T08:46:27.183109-08:00","closed_at":"2025-12-11T08:46:27.183109-08:00","dependencies":[{"issue_id":"migrate-egghead-u6b.4","depends_on_id":"migrate-egghead-u6b","type":"parent-child","created_at":"2025-12-11T08:43:03.572035-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-u6b.5","title":"Analyze Coursebuilder: Existing egghead app features","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T08:43:03.605111-08:00","updated_at":"2025-12-11T08:46:28.225209-08:00","closed_at":"2025-12-11T08:46:28.225209-08:00","dependencies":[{"issue_id":"migrate-egghead-u6b.5","depends_on_id":"migrate-egghead-u6b","type":"parent-child","created_at":"2025-12-11T08:43:03.605444-08:00","created_by":"daemon"}]}
{"id":"migrate-egghead-u6b.6","title":"Synthesize: Gap analysis and migration roadmap","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-11T08:43:03.640611-08:00","updated_at":"2025-12-11T08:47:53.296487-08:00","closed_at":"2025-12-11T08:47:53.296487-08:00","dependencies":[{"issue_id":"migrate-egghead-u6b.6","depends_on_id":"migrate-egghead-u6b","type":"parent-child","created_at":"2025-12-11T08:43:03.640955-08:00","created_by":"daemon"}]}
